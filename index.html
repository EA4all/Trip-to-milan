<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Debug Firestore - trip-to-milan</title>
</head>
<body>
  <h1>בדיקות Firebase / Firestore (trip-to-milan)</h1>
  <pre id="out" style="white-space:pre-wrap;background:#f6f6f6;padding:10px;border:1px solid #ddd"></pre>

  <script type="module">
    const out = msg => {
      console.log(msg);
      document.getElementById('out').textContent += msg + "\n";
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD47-qHc8vmGQt4n4LluKW64LEMB-UYrfk",
      authDomain: "trip-to-milan.firebaseapp.com",
      projectId: "trip-to-milan",
      storageBucket: "trip-to-milan.firebasestorage.app",
      messagingSenderId: "305191186184",
      appId: "1:305191186184:web:fff1488b64a06942dfc6bd",
      measurementId: "G-P17LYZJ2H0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    out("[STATUS] מאתחל Firebase (projectId=" + firebaseConfig.projectId + ")");
    out("Firebase initialized — projectId: " + firebaseConfig.projectId + " storageBucket: " + firebaseConfig.storageBucket);

    // TripId / collection
    let tripId = window.location.hash.replace('#','') || 'trip_' + Math.random().toString(36).substring(2,8);
    window.location.hash = tripId;
    const collection = "milantrip";
    out("Using tripId: " + tripId + " collection: " + collection);

    signInAnonymously(auth)
      .then(() => out("[STATUS] signInAnonymously OK"))
      .catch(err => out("[ERROR] Anonymous sign-in failed: " + (err && err.message)));

    onAuthStateChanged(auth, async (user) => {
      out("onAuthStateChanged => uid=" + (user ? user.uid : "no-user"));
      if (!user) return;

      try {
        const idToken = await user.getIdToken();
        out("got idToken (truncated): " + idToken.substring(0,40) + "...");

        // ניסיון קריאה ע״י SDK
        out("Trying getDoc via SDK...");
        try {
          const ref = doc(db, collection, tripId);
          const snap = await getDoc(ref);
          if (snap.exists()) {
            out("SDK getDoc OK, data: " + JSON.stringify(snap.data()));
          } else {
            out("SDK getDoc: document NOT FOUND (but DB might exist).");
          }
        } catch (sdkErr) {
          out("SDK getDoc ERROR: " + (sdkErr && sdkErr.message));
        }

        // ניסיון REST GET עם Authorization
        const restUrl = `https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/${collection}/${tripId}`;
        out("Trying REST GET (with Authorization): " + restUrl);
        try {
          const r = await fetch(restUrl, {
            method: "GET",
            headers: { "Authorization": "Bearer " + idToken }
          });
          const text = await r.text();
          out("REST GET status: " + r.status + "  body: " + text);
        } catch (err) {
          out("REST GET (with Authorization) failed: " + err);
        }

        // ניסיון REST GET עם ?key=APIKEY (לבדיקות)
        const restUrlKey = restUrl + `?key=${firebaseConfig.apiKey}`;
        out("Trying REST GET (with ?key=): " + restUrlKey);
        try {
          const r2 = await fetch(restUrlKey);
          const text2 = await r2.text();
          out("REST GET with key status: " + r2.status + "  body: " + text2);
        } catch (err) {
          out("REST GET (with key) failed: " + err);
        }

      } catch(e) {
        out("[ERROR] failed to get idToken: " + e);
      }
    });
  </script>
</body>
</html>
