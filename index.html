<!DOCTYPE html>
<html lang="he" dir="rtl" class="scroll-smooth dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×ª×•×›× ×™×ª ×˜×™×•×œ ×©×™×ª×•×¤×™×ª ×œ××™×œ×× ×• (v1.1)</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœˆï¸</text></svg>">
  <meta name="description" content="×“×©×‘×•×¨×“ ××™× ×˜×¨××§×˜×™×‘×™ ×•×©×™×ª×•×¤×™ ×œ×ª×›× ×•×Ÿ ×—×•×¤×©×” ×‘××™×œ×× ×•: ×œ×•×– ×™×•××™, ××¤×•×ª, ××–×’ ××•×•×™×¨, ×¡×™×›×•× ×˜×™×•×œ ×—×›×, ××¢×§×‘ ×ª×§×¦×™×‘ ×•×¢×•×“." />
  <meta name="theme-color" content="#1d4ed8">
  <link rel="manifest" href="manifest.json">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Assistant', 'ui-sans-serif', 'system-ui'],
          },
          colors: {
            brand: {
              50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
              400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a'
            }
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
  <!-- LeafletJS for Live Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
#video-container {
    height: 50vh; /* × ×¡×” ×œ×ª×¤×•×¡ 50% ××’×•×‘×” ×”××¡×š */
    max-height: 400px; /* ××‘×œ ×œ× ×™×•×ª×¨ ×-400 ×¤×™×§×¡×œ×™× */
    min-height: 250px; /* ×•×œ× ×¤×—×•×ª ×-250 ×¤×™×§×¡×œ×™× */
}
    #video-container canvas.drawingBuffer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
.image-viewer-modal .modal {
    /* ×”×•×¤×›×™× ××ª ×”××¡×’×¨×ª ×œ×©×§×•×¤×” ×›×“×™ ×œ×ª×ª ×ª×—×•×©×” ×©×œ ×—×œ×œ ×¤×ª×•×— */
    background: transparent;
    box-shadow: none;
    padding: 0;
    width: 100%;
    height: 100%;
    display: flex; /* ×××§××™× ××ª ×”×ª××•× ×” ×©×‘×ª×•×›×” ×‘×“×™×•×§ ×‘××¨×›×– */
    align-items: center;
    justify-content: center;
}
.image-viewer-modal img {
    /* ××’×‘×™×œ×™× ××ª ×’×•×“×œ ×”×ª××•× ×” ×œ×’×•×“×œ ×”××¡×š ×¤×—×•×ª ×©×•×œ×™×™× ×§×˜× ×™× */
    max-width: 95vw;
    max-height: 95vh;
    width: auto;
    height: auto;
    border-radius: 0.5rem; /* ×¢×™×’×•×œ ×¤×™× ×•×ª ×¢×“×™×Ÿ */
    /* ×”×¦×œ×œ×” ×“×¨××˜×™×ª ×›×“×™ ×œ×”×§×¤×™×¥ ××ª ×”×ª××•× ×” ××”×¨×§×¢ ×”×›×”×” */
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}
.image-viewer-close-btn {
    /* ×××§××™× ××ª ×”×›×¤×ª×•×¨ ×‘×¤×™× ×” ×”×™×× ×™×ª ×”×¢×œ×™×•× ×” ×©×œ ×›×œ ×”××¡×š, ×œ× ×©×œ ×”××¡×’×¨×ª */
    position: fixed;
    top: 20px;
    right: 20px;
    /* ×”×’×“×œ×” ×•×¢×™×¦×•×‘ ××—×“×© ×œ× ×¨××•×ª ××§×¡×™××œ×™×ª */
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    background-color: rgba(0, 0, 0, 0.6);
    border: 2px solid white;
    color: white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    z-index: 110;
    transition: transform 0.2s ease, background-color 0.2s ease;
}
.image-viewer-close-btn:hover {
    transform: scale(1.1);
    background-color: rgba(0, 0, 0, 0.9);
}
    :root{
      --bg: #f9fafb; --fg:#1f2937; --card:#ffffff; --muted:#6b7280;
      --btn:#1d4ed8; --btn-h:#1e40af; --brd:#e5e7eb;
      --header-bg: rgba(255,255,255,0.9);
      --heading-font: 'Assistant', sans-serif;
    }
    .dark{
      --bg:#0b1220; --fg:#e5e7eb; --card:#0f172a; --muted:#9ca3af;
      --btn:#2563eb; --btn-h:#1d4ed8; --brd:#1f2937;
      --header-bg: rgba(11,18,32,0.8);
    }
    
   html { 
  scroll-padding-top: 80px; 
  overflow-x: hidden; /* Add this line */
}
body {
  background:var(--bg); 
  color:var(--fg); 
  font-family:Assistant,ui-sans-serif,system-ui; 
  overflow-x: hidden; /* Keep this line */
}
    h2, h3 { font-family: var(--heading-font); }
    #site-header { background-color: var(--header-bg); }
    
    .dark input, .dark textarea, .dark select {
        background-color: #1f2937;
        color: var(--fg);
        border-color: #374151;
    }
    .dark input::placeholder, .dark textarea::placeholder { color: var(--muted); }

    .btn{display:inline-flex;align-items:center;gap:.5rem;justify-content:center;border-radius:0.75rem;
         font-weight:600;font-size:.9rem;padding:.5rem .85rem;transition:.2s;border:1px solid transparent}
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .btn-primary{background:var(--btn);color:#fff;}
    .btn-primary:hover{background:var(--btn-h)}
    .btn-ghost{background:transparent;border-color:var(--brd);color:var(--fg);}
    .btn-ghost:hover{background:rgba(0,0,0,.04)}
    .dark .btn-ghost:hover{background:rgba(255,255,255,.06)}
    .tab-button{padding:.5rem .75rem;font-weight:700;border-bottom:2px solid transparent;border-radius:.5rem .5rem 0 0;}
    .tab-active{color:var(--btn);background:var(--card);border-color:var(--btn)}
    #gemini-tabs-nav .tab-button { border-color: transparent; }
    #gemini-tabs-nav .tab-active { border-color: var(--btn); color: var(--btn); }

    .content-section{display:none}
    .content-section.active{display:block}
    .thumb{width:100%;height:14rem;object-fit:cover}
    .logo{width:56px;height:56px;border-radius:.75rem;border:1px solid var(--brd);object-fit:contain;background:#fff}
    
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 100;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-backdrop.flex { display: flex; }
.modal {
    background: var(--card); color: var(--fg);
    width: 90%; max-width: 500px; border-radius: 1rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    display: flex; flex-direction: column; max-height: 80vh;
    overflow-y: auto; /* <-- ×”×•×¡×£ ×©×•×¨×” ×–×• */
}
    .image-carousel { position: relative; flex-shrink:0; width:100%; }
    @media (min-width: 768px) { .image-carousel { width: 33.333333%; } }
    .image-carousel button {
      position: absolute; top: 50%; transform: translateY(-50%);
      background-color: rgba(0,0,0,0.4); color: white;
      border: none; border-radius: 50%;
      width: 32px; height: 32px;
      cursor: pointer; transition: background-color 0.2s;
    }
    .image-carousel button:hover { background-color: rgba(0,0,0,0.7); }
    .carousel-prev { left: 8px; }
    .carousel-next { right: 8px; }

    .countdown-number { font-size: 1.5rem; line-height: 1; }
    .countdown-label { font-size: 0.75rem; }

    .floating-submenu {
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
    }
    .floating-submenu.active {
        transform: translateY(0);
        opacity: 1;
        pointer-events: auto;
    }

    .delete-btn {
        position: absolute; top: 4px; right: 4px;
        background-color: rgba(239, 68, 68, 0.7);
        color: white; border-radius: 50%;
        width: 24px; height: 24px;
        border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.2s; z-index: 10;
    }
    .relative:hover .delete-btn { opacity: 1; }
    
    #live-location-map {
        height: 350px;
        border-radius: 1rem;
        border: 1px solid var(--brd);
    }
    .leaflet-popup-content-wrapper {
        background: var(--card);
        color: var(--fg);
    }
    .leaflet-popup-tip {
        background: var(--card);
    }


    @media print {
        body * { visibility: hidden; }
        #plan, #plan * { visibility: visible; }
        #plan { position: absolute; left: 0; top: 0; width: 100%; }
        #plan details { page-break-inside: avoid; }
        #plan summary, .nav-link, .btn, header, main > section:not(#plan), #floating-nav-container, .day-actions { display: none !important; }
        #plan details[open] > div { display: block !important; }
        #plan-content-container { padding: 0 !important; }
        h2 { font-size: 24px !important; }
        #plan details {
            box-shadow: none !important;
            border: 1px solid #ccc;
            margin-bottom: 1rem;
        }
    }


    @media (max-width: 767px) {
      body { padding-bottom: 70px; } /* Add padding for floating nav */
      .responsive-table thead { display: none; }
      .responsive-table tr {
        display: block; margin-bottom: 1rem; border: 1px solid var(--brd);
        border-radius: 0.75rem; padding: 1rem;
      }
      .responsive-table td {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.5rem 0; border-bottom: 1px solid var(--brd);
      }
      .responsive-table td:last-child { border-bottom: none; }
      .responsive-table td::before {
        content: attr(data-label); font-weight: 600; margin-right: 1rem;
      }
      .responsive-table .logo-cell { justify-content: center; padding-bottom: 1rem; }
      .responsive-table .logo-cell::before { display: none; }
    }
    .modal-backdrop.flex { animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="dark:bg-gray-900 dark:text-gray-100">

  <header id="site-header" class="backdrop-blur shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <span class="inline-block w-2 h-6 rounded bg-brand-700"></span>
          <h1 class="text-xl md:text-2xl font-bold text-brand-800 dark:text-brand-300">×”×—×•×¤×©×” ×‘××™×œ×× ×•</h1>
        </div>
        <div class="hidden md:flex md:items-center md:gap-1 flex-wrap">
          <a href="#overview" class="nav-link px-3 py-2 rounded-md text-sm font-medium">×¡×§×™×¨×”</a>
          <a href="#plan" class="nav-link px-3 py-2 rounded-md text-sm font-medium">×ª×•×›× ×™×ª</a>
          <a href="#suggestions" class="nav-link px-3 py-2 rounded-md text-sm font-medium">×”×¦×¢×•×ª</a>
          <a href="#kosher" class="nav-link px-3 py-2 rounded-md text-sm font-medium">××•×›×œ ×›×©×¨</a>
          <a href="#tools" class="nav-link px-3 py-2 rounded-md text-sm font-medium">×›×œ×™×</a>
        </div>
        <div class="flex items-center gap-2">
            <div id="sync-status" class="text-xs text-gray-400 flex items-center gap-2" title="××ª×—×‘×¨...">
                <i class="fa-solid fa-cloud text-yellow-500"></i> <span class="hidden sm:inline">××ª×—×‘×¨...</span>
            </div>
            <button id="theme-toggle" class="btn btn-ghost" aria-label="×”×—×œ×¤×ª ××¦×‘"><i class="fa-solid fa-sun"></i></button>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto p-4 sm:p-6 lg:p-8">

    <section id="overview" class="my-12 scroll-mt-24">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">×¡×§×™×¨×” ×›×œ×œ×™×ª</h2>
        <div class="flex gap-2 flex-wrap justify-center">
            <button id="share-btn" class="btn btn-primary"><i class="fa-solid fa-share-alt mr-2"></i>×©×ª×£ ×ª×•×›× ×™×ª</button>
            <button id="gemini-btn" class="btn btn-primary"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>×©××œ ××ª Gemini</button>
            <button id="show-tip-btn" class="btn btn-primary"><i class="fa-solid fa-lightbulb mr-2"></i>×˜×™×¤ ×™×•××™</button>
            <button id="create-summary-btn" class="btn btn-primary bg-green-600 hover:bg-green-700"><i class="fa-solid fa-book-open mr-2"></i>×¦×•×¨ ×¡×™×›×•× ×˜×™×•×œ</button>
          <button id="lookup-site-btn" class="btn btn-primary bg-purple-600 hover:bg-purple-700"><i class="fa-solid fa-magnifying-glass mr-2"></i>×–×™×”×•×™ ××ª×¨×™×</button>
        </div>
      </div>
      <div id="overview-cards" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
      <div class="flex gap-2 justify-center mb-6">
   
</div>
    </section>

    <section id="plan" class="my-12 scroll-mt-24">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">×ª×•×›× ×™×ª ×”×˜×™×•×œ ×”×™×•××™×ª</h2>
        <div class="flex gap-2 flex-wrap justify-center day-actions">
            <button id="collapse-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-compress mr-1"></i>×›×•×•×¥ ×”×›×œ</button>
            <button id="expand-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-expand mr-1"></i>×”×¨×—×‘ ×”×›×œ</button>
            <button id="print-btn" class="btn btn-ghost btn-sm"><i class="fa-solid fa-print mr-1"></i>×”×“×¤×¡ ×ª×•×›× ×™×ª</button>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-950 p-2 sm:p-6 rounded-2xl shadow-lg">
        <div class="border-b border-gray-200 dark:border-gray-800 mb-6">
          <nav class="-mb-px flex flex-wrap justify-center gap-2 sm:gap-4" aria-label="Tabs" id="day-tabs-nav"></nav>
        </div>
        <div id="plan-content-container"></div>
      </div>
    </section>
    
    <section id="suggestions" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">×××’×¨ ×”×¦×¢×•×ª</h2>
        <div class="text-center">
            <button id="toggle-suggestions-btn" class="btn btn-primary">×”×¦×’ ×”×¦×¢×•×ª × ×•×¡×¤×•×ª</button>
        </div>
        <div id="suggestions-container" class="hidden mt-6 bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
            <div id="suggestions-table-container"></div>
        </div>
    </section>

    <section id="kosher" class="my-12 scroll-mt-24">
      <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">×”××“×¨×™×š ×”×§×•×œ×™× ×¨×™ ×”×›×©×¨</h2>
<div class="text-center flex flex-wrap justify-center gap-2">
    <button id="toggle-kosher-btn" class="btn btn-primary">×”×¦×’ ××“×¨×™×š ×›×©×¨×•×ª</button>
    <button id="scan-kosher-barcode-btn" class="btn btn-primary bg-green-600 hover:bg-green-700">
        <i class="fa-solid fa-barcode mr-2"></i> ×¡×¨×•×§ ×‘×¨×§×•×“ (×›×©×¨×•×ª)
    </button>
  <button id="birkat-hamazon-btn" class="btn btn-primary bg-yellow-600 hover:bg-yellow-700">
    <i class="fa-solid fa-bread-slice mr-2"></i> ×‘×¨×›×ª ×”××–×•×Ÿ
</button>
  <button id="bracha-achrona-btn" class="btn btn-primary bg-blue-800 hover:bg-blue-900">
    <i class="fa-solid fa-pray mr-2"></i> ×‘×¨×›×” ××—×¨×•× ×”
</button>
</div>
      <div id="kosher-container" class="hidden mt-6">
        <div class="bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
          <p id="kosher-subtitle" class="text-center mb-6 text-gray-600 dark:text-gray-400">×¨×™×›×•×– ×”××¤×©×¨×•×™×•×ª ×‘×©×›×•× ×•×ª Bande Nere ×•â€‘Washington.</p>
          <div id="kosher-filters" class="mb-4 flex flex-wrap gap-2 justify-center"></div>
          <div id="kosher-results"></div>
        </div>
      </div>
    </section>

    <section id="tools" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">×›×œ×™× ×•××™×“×¢ ×©×™××•×©×™</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div id="scrapbook-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg md:col-span-2 lg:col-span-3">
    <details>
        <summary class="text-xl font-bold cursor-pointer"><i class="fa-solid fa-book-open mr-2"></i>×¡×§×¨××¤×‘×•×§ - ×™×•××Ÿ ×”×˜×™×•×œ</summary>
        <div id="scrapbook-container" class="space-y-8 mt-4 pt-4 border-t dark:border-gray-700">
            <p class="text-center">×˜×•×¢×Ÿ ×™×•××Ÿ...</p>
        </div>
    </details>
</div>
<div id="metro-helper-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg md:col-span-2 lg:col-span-3">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-train-subway mr-2"></i>×¢×•×–×¨ ×§×•×•×™ ××˜×¨×•</h3>
    <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-1">
            <p class="text-sm mb-2">×œ×—×¥ ×¢×œ ×§×• ×›×“×™ ×œ×¨××•×ª ×ª×—× ×•×ª ×•××˜×¨×§×¦×™×•×ª ××¨×›×–×™×•×ª:</p>
            <div id="metro-lines-container" class="flex flex-wrap gap-2">
                </div>
            <div id="metro-line-info" class="mt-4 text-sm space-y-2 max-h-60 overflow-y-auto pr-2">
                </div>
        </div>
<div class="md:col-span-2">
    <img id="metro-map-image" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/Milano_-_mappa_rete_metropolitana_%28schematica%29.svg/1200px-Milano_-_mappa_rete_metropolitana_%28schematica%29.svg.png" alt="××¤×ª ×”××˜×¨×• ×©×œ ××™×œ×× ×•" class="rounded-lg w-full h-full object-contain cursor-pointer transition-transform hover:scale-105">
</div>
    </div>
</div>
          
          <div id="pass-calculator-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg md:col-span-2 lg:col-span-3">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-calculator mr-2"></i>××—×©×‘×•×Ÿ ×›×“××™×•×ª Pass</h3>
    <div class="grid md:grid-cols-2 gap-6">
        <div>
            <h4 class="font-semibold mb-2">1. ×¡×× ×• ××ª ×”××˜×¨×§×¦×™×•×ª ×©××ª× ××ª×›× × ×™× ×œ×‘×§×¨:</h4>
            <div id="pass-attractions-list" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2">
                </div>
        </div>
        <div>
            <h4 class="font-semibold mb-2">2. ×”×©×•×•××” ×•×—×™×©×•×‘:</h4>
            <div id="pass-options-info" class="text-sm space-y-2">
                </div>
            <button id="calculate-pass-btn" class="btn btn-primary w-full mt-4">×—×©×‘ ×›×“××™×•×ª</button>
            <div id="pass-result" class="mt-4 p-3 bg-gray-50 dark:bg-gray-900 rounded-lg text-center font-bold">
                ...
            </div>
        </div>
    </div>
</div>

<div id="utility-finder-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-map-signs mr-2"></i>×—×™×¤×•×© ××”×™×¨ (×¤×ª×•×— ×¢×›×©×™×•)</h3>
    <div class="grid grid-cols-1 gap-2">
      <button class="btn btn-primary" onclick="findNearbyAttractions()">
    <i class="fa-solid fa-star w-4"></i> ××¦× ××˜×¨×§×¦×™×•×ª ×§×¨×•×‘×•×ª
</button>
        <button class="btn btn-primary" onclick="window.findUtility('bagno pubblico', '×©×™×¨×•×ª×™× ×¦×™×‘×•×¨×™×™×')">
            <i class="fa-solid fa-restroom w-4"></i> ××¦× ×©×™×¨×•×ª×™×
        </button>
        <button class="btn btn-primary" onclick="window.findUtility('farmacia', '×‘×™×ª ××¨×§×—×ª')">
            <i class="fa-solid fa-pills w-4"></i> ××¦× ×‘×™×ª ××¨×§×—×ª
        </button>
        <button class="btn btn-primary" onclick="window.findUtility('bancomat', '×›×¡×¤×•××˜')">
            <i class="fa-solid fa-money-bill w-4"></i> ××¦× ×›×¡×¤×•××˜
        </button>
        <button class="btn btn-primary" onclick="window.findUtility('bureau de change', '×”××¨×ª ×›×¡×¤×™×')">
            <i class="fa-solid fa-coins w-4"></i> ××¦× Change
        </button>
      <button class="btn btn-primary" onclick="window.findUtility('sinagoga', '×‘×ª×™ ×›× ×¡×ª')">
           <i class="fa-solid fa-synagogue w-4"></i> ××¦× ×‘×™×ª ×›× ×¡×ª
        </button>
    </div>
</div>
            
            <div id="live-location-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-3">
                <h3 class="text-xl font-bold mb-3 text-center"><i class="fa-solid fa-map-location-dot mr-2"></i>××¤×ª ××™×§×•× ×—×™</h3>
                <div class="text-center">
                    <p class="mb-4">×›×œ ××©×ª××© ×¢× ×”×œ×™× ×§ ×™×›×•×œ ×œ×¨××•×ª ××ª ××™×§×•× ×”××˜×™×™×œ×™× ×‘×–××Ÿ ×××ª. ×¨×§ ×”××˜×™×™×œ×™× ×¦×¨×™×›×™× ×œ×œ×—×•×¥ ×¢×œ "×©×ª×£ ××™×§×•×".</p>
                    <div id="live-location-map" class="mb-4"></div>
                    <div class="flex flex-col sm:flex-row gap-2 justify-center">
                        <button id="toggle-location-sharing-btn" class="btn btn-primary"><i class="fa-solid fa-tower-broadcast mr-2"></i>×”×¤×¢×œ ×©×™×ª×•×£ ××™×§×•×</button>
                        <input type="text" id="user-name-input" placeholder="×”×›× ×¡ ××ª ×©××š (×œ×–×™×”×•×™)" class="p-2 rounded-lg border text-center">
                    </div>
                    <p id="location-status" class="text-xs text-gray-500 mt-2 h-4"></p>
                </div>
            </div>

            <div id="transport-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-3">
                <h3 class="text-xl font-bold mb-3 text-center"><i class="fa-solid fa-bus mr-2"></i>××“×¨×™×š ×ª×—×‘×•×¨×”</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-bold text-brand-800 dark:text-brand-200 mb-3">×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª (ATM)</h4>
                        <ul class="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                            <li><span class="font-semibold">××™×¤×” ×§×•× ×™×:</span> ×‘××›×•× ×•×ª ×”××•×˜×•××˜×™×•×ª ×‘×›×œ ×ª×—× ×ª ××˜×¨×•, ×‘×§×™×•×¡×§×™× (Tabacchi), ××• ×‘××¤×œ×™×§×¦×™×” ×”×¨×©××™×ª <a href="https://www.atm.it/it/Pagine/default.aspx" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">ATM Milano</a>.</li>
                            <li><span class="font-semibold">×”××œ×¦×”:</span> ×›×¨×˜×™×¡ ×œ-3 ×™××™× (72 ×©×¢×•×ª) ×”×•× ×”××©×ª×œ× ×‘×™×•×ª×¨ ×œ×©×”×™×™×” ×©×œ×›×.</li>
                        </ul>
                        <div class="relative h-[280px] mt-4">
                            <canvas id="transportChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-brand-800 dark:text-brand-200 mb-3">×¨×›×‘×•×ª ×œ×˜×™×•×œ×™ ×™×•×</h4>
                        <ul class="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                            <li><span class="font-semibold">××™×¤×” ×§×•× ×™×:</span> ××•××œ×¥ ×œ×”×–××™×Ÿ ××¨××© ×‘××™× ×˜×¨× ×˜ ×›×“×™ ×œ×”×‘×˜×™×— ××§×•× ×•××—×™×¨ ×˜×•×‘.</li>
                            <li><span class="font-semibold">××ª×¨×™× ××•××œ×¦×™×:</span> <a href="https://www.trenitalia.com/en.html" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">Trenitalia</a> (×¨×©××™) ××• <a href="https://www.italotreno.it/en" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">Italo</a> (×¤×¨×˜×™).</li>
                            <li><span class="font-semibold">×ª×—× ×ª ×™×¦×™××”:</span> ×›×œ ×”×¨×›×‘×•×ª ×œ××’××™× ×™×•×¦××•×ª ××ª×—× ×ª **Milano Centrale**.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
<div id="weather-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-1">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-cloud-sun mr-2"></i>××–×’ ××•×•×™×¨</h3>
    <div id="weather-forecast" class="space-y-3"><p>×˜×•×¢×Ÿ ×ª×—×–×™×ª...</p></div>
    <div id="weather-alert-box" class="mt-4"></div>
    <div id="weather-attire-recommendation" class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700 text-sm text-center"></div>
</div>
            <div id="budget-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 md:col-span-2 lg:col-span-2">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-euro-sign mr-2"></i>××¢×§×‘ ×ª×§×¦×™×‘</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow">
                    <div>
                        <div class="mb-4">
                            <label for="total-budget" class="block text-sm font-medium">×ª×§×¦×™×‘ ×›×œ×œ×™ (â‚¬)</label>
                            <input type="number" id="total-budget" placeholder="×”×–×Ÿ ×ª×§×¦×™×‘" class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white">
                        </div>
                        <form id="expense-form" class="space-y-3">
                            <input type="text" id="expense-desc" placeholder="×ª×™××•×¨ ×”×”×•×¦××”" class="w-full p-2 rounded-xl border" required>
                             <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="expense-amount" placeholder="×¡×›×•× (â‚¬)" class="w-full p-2 rounded-xl border" required>
                                <select id="expense-category" class="w-full p-2 rounded-xl border" required>
                                    <option value="">×§×˜×’×•×¨×™×”</option>
                                    <option value="××•×›×œ">××•×›×œ</option>
                                    <option value="×§× ×™×•×ª">×§× ×™×•×ª</option>
                                    <option value="×ª×—×‘×•×¨×”">×ª×—×‘×•×¨×”</option>
                                    <option value="××˜×¨×§×¦×™×•×ª">××˜×¨×§×¦×™×•×ª</option>
                                    <option value="××—×¨">××—×¨</option>
                                </select>
                             </div>
                            <button type="submit" class="btn btn-primary w-full">×”×•×¡×£ ×”×•×¦××”</button>
              <button type="button" id="scan-receipt-btn" class="btn btn-ghost w-full">
    <i class="fa-solid fa-camera mr-2"></i>×¡×¨×•×§ ×§×‘×œ×”
</button>

               
                            
                        </form>
                        <button id="calculate-estimated-btn" class="btn btn-primary w-full mt-2"><i class="fa-solid fa-calculator mr-2"></i>×—×©×‘ ×¢×œ×•×ª ××©×•×¢×¨×ª ×œ××˜×¨×§×¦×™×•×ª</button>
                        <div id="expense-list" class="text-sm my-4 flex-grow max-h-40 overflow-y-auto pr-2"></div>
                        <div class="mt-auto pt-3 border-t font-bold space-y-2 text-md">
                             <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span>×¢×œ×•×ª ××©×•×¢×¨×ª</span>
                                    <input type="checkbox" id="include-estimated-costs" checked class="w-4 h-4 rounded text-brand-600 focus:ring-brand-500" title="×›×œ×•×œ ×‘×—×™×©×•×‘ ×”×™×ª×¨×”">
                                </div>
                                <span id="estimated-costs">0.00â‚¬</span>
                            </div>
                            <div class="flex justify-between text-red-600 dark:text-red-400"><span>×”×•×¦××•×ª ×‘×¤×•×¢×œ:</span> <span id="total-expenses">0.00</span>â‚¬</div>
                            <div class="flex justify-between text-green-600 dark:text-green-400"><span>×™×ª×¨×”:</span> <span id="budget-balance">0.00</span>â‚¬</div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center min-h-[200px]">
                        <div class="relative w-full h-full max-h-[250px]">
                            <canvas id="budget-chart"></canvas>
                        </div>
                        <div id="budget-chart-placeholder" class="hidden text-center text-gray-400 text-sm">×”×•×¡×™×¤×• ×”×•×¦××•×ª ×›×“×™ ×œ×¨××•×ª ××ª ×”×ª×¨×©×™×</div>
                        <div id="budget-chart-legend" class="mt-4 w-full space-y-1"></div>
                    </div>
                </div>
            </div>
            <div id="checklist-section-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-1">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-list-check mr-2"></i>×¦'×§-×œ×™×¡×˜</h3>
                <form id="add-checklist-item-form" class="grid sm:grid-cols-3 gap-2 mb-4">
                    <input type="text" id="new-item-text" placeholder="×¤×¨×™×˜ ×—×“×©" class="sm:col-span-2 w-full p-2 rounded-lg border" required>
                    <select id="category-select" class="w-full p-2 rounded-lg border"></select>
                    <input type="text" id="new-category-text" placeholder="×§×˜×’×•×¨×™×” ×—×“×©×” (××•×¤×¦×™×•× ×œ×™)" class="sm:col-span-2 w-full p-2 rounded-lg border">
                    <button type="submit" class="btn btn-primary">×”×•×¡×£</button>
                </form>
                <div id="checklist-container" class="space-y-4 max-h-96 overflow-y-auto"></div>
            </div>
            <div id="translator-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 lg:col-span-1">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-language mr-2"></i>×ª×¨×’×•××•×Ÿ</h3>
                <div class="text-xs text-center text-gray-500 mb-2" id="lang-direction-label">×¢×‘×¨×™×ª <i class="fa-solid fa-arrow-right-long"></i> ××™×˜×œ×§×™×ª</div>
<form id="dictionary-form" class="grid grid-cols-6 gap-2 mb-3">
   <input type="text" id="dictionary-input" placeholder="×”×§×œ×“ ×œ×ª×¨×’×•×..." class="col-span-6 w-full p-2 rounded-lg border">

   <button type="button" id="swap-lang-btn" class="btn btn-ghost" title="×”×—×œ×£ ×©×¤×•×ª"><i class="fa-solid fa-exchange-alt"></i></button>
   <button type="submit" class="btn btn-primary col-span-2">×ª×¨×’×</button>
   <button type="button" id="translate-upload-btn" class="btn btn-ghost" title="×”×¢×œ×” ×ª××•× ×”"><i class="fa-solid fa-file-image"></i></button>
   <button type="button" id="translate-camera-btn" class="btn btn-ghost" title="×¤×ª×— ××¦×œ××”"><i class="fa-solid fa-camera"></i></button>
   <input type="file" id="image-translate-upload" class="hidden" accept="image/*">

   <button type="button" id="voice-translate-he-btn" class="btn btn-primary col-span-3"><i class="fa-solid fa-microphone"></i> ×“×‘×¨ ×‘×¢×‘×¨×™×ª</button>
   <button type="button" id="voice-translate-it-btn" class="btn btn-ghost col-span-3"><i class="fa-solid fa-microphone"></i> Parla Italiano</button>
</form>
                <div id="translation-result-container" class="mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[60px] text-center flex items-center justify-center gap-3">
                   <span class="text-gray-500">×”×ª×¨×’×•× ×™×•×¤×™×¢ ×›××Ÿ...</span>
                </div>
              <div class="mt-4 pt-3 border-t dark:border-gray-700 flex justify-end">
    <button id="translator-tts-settings-btn" class="btn btn-ghost btn-sm"><i class="fa-solid fa-cog mr-2"></i> ×”×’×“×¨ ×§×•×œ</button>
</div>

<div id="translation-history" class="mt-3 pt-3 border-t text-xs space-y-2 max-h-24 overflow-y-auto">
    <div class="text-center text-gray-400">×”×™×¡×˜×•×¨×™×™×ª ×ª×¨×’×•××™×</div>
</div>
           </div>
           <div id="converter-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 lg:col-span-1">
             <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-right-left mr-2"></i>×××™×¨ ××˜×‘×¢</h3>
             <div class="space-y-4">
                 <div>
                     <label for="eur-input" class="block text-sm font-medium">××™×¨×• (â‚¬)</label>
                     <input type="number" id="eur-input" placeholder="EUR" class="w-full p-2 mt-1 rounded-xl border">
                 </div>
                 <div>
                     <label for="ils-input" class="block text-sm font-medium">×©×§×œ (â‚ª)</label>
                     <input type="number" id="ils-input" placeholder="ILS" class="w-full p-2 mt-1 rounded-xl border">
                 </div>
             </div>
             <p id="exchange-rate-display" class="text-xs text-gray-500 mt-auto pt-3 text-center">×˜×•×¢×Ÿ ×©×¢×¨ ×—×œ×™×¤×™×Ÿ...</p>
         </div>
         <div id="safety-warnings-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-1">
            <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-triangle-exclamation mr-2"></i>××–×”×¨×•×ª ×•×¢×“×›×•× ×™×</h3>
            <div id="safety-warnings-content" class="text-sm space-y-2 max-h-48 overflow-y-auto">×˜×•×¢×Ÿ ××™×“×¢...</div>
            <button id="refresh-warnings-btn" class="btn btn-ghost w-full mt-3">×¨×¢× ×Ÿ ××™×“×¢</button>
        </div>
        <div id="customs-info-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 md:col-span-2 lg:col-span-2">
            <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-suitcase-rolling mr-2"></i>××™×“×¢ ×¢×œ ××›×¡ ×•×›×‘×•×“×”</h3>
            <div class="text-sm space-y-2">
                <p><b><i class="fa-solid fa-right-to-bracket"></i> ××›×¡ ×‘×›× ×™×¡×” ×œ××™×˜×œ×™×” (×œ× ×•×¡×¢, ××—×•×¥ ×œ××™×—×•×“):</b></p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 text-xs">
                    <li><b>×˜×‘×§:</b> 200 ×¡×™×’×¨×™×•×ª ××• 50 ×¡×™×’×¨×™×.</li>
                    <li><b>××œ×›×•×”×•×œ:</b> 1 ×œ×™×˜×¨ ×©×œ ××œ×›×•×”×•×œ ××¢×œ 22% (×›××• ×•×•×“×§×”) ××• 2 ×œ×™×˜×¨ ×™×™×Ÿ.</li>
                    <li><b>××–×•××Ÿ:</b> ×™×© ×œ×”×¦×”×™×¨ ×¢×œ ×¡×›×•××™× ××¢×œ 10,000 ××™×¨×•.</li>
                    <li><b>××™×¡×•×¨×™×:</b> ××¡×•×¨ ×œ×”×›× ×™×¡ ××•×¦×¨×™ ×‘×©×¨ ×•×—×œ×‘ ××—×•×¥ ×œ××™×—×•×“ ×”××™×¨×•×¤×™.</li>
                </ul>
                <p class="mt-3"><b><i class="fa-solid fa-left-to-bracket"></i> ××›×¡ ×‘×—×–×¨×” ×œ×™×©×¨××œ (×œ× ×•×¡×¢):</b></p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 text-xs">
                    <li><b>×¤×˜×•×¨ ××™×©×™:</b> × ×™×ª×Ÿ ×œ×”×›× ×™×¡ ××ª× ×•×ª ×•×—×¤×¦×™× ××™×©×™×™× ×‘×©×•×•×™ ×›×•×œ×œ ×©×œ ×¢×“ 200$ ×œ× ×•×¡×¢ (××¢×œ ×’×™×œ ×©× ×ª×™×™×).</li>
                    <li><b>××–×•×Ÿ:</b> ×¢×“ 3 ×§"×’ ××–×•×Ÿ, ×‘×ª× ××™ ×©×›×œ ×¤×¨×™×˜ ×œ× ×©×•×§×œ ×™×•×ª×¨ ×-1 ×§"×’.</li>
                    <li><b>×˜×‘×§ (××¢×œ ×’×™×œ 18):</b> 200 ×¡×™×’×¨×™×•×ª (×¤Ö¿×§×˜ ××—×“) ××• 250 ×’×¨× ××•×¦×¨×™ ×˜×‘×§ ××—×¨×™×.</li>
                    <li><b>××œ×›×•×”×•×œ (××¢×œ ×’×™×œ 18):</b> 1 ×œ×™×˜×¨ ×©×œ ××©×§×” ×—×¨×™×£ ×•-2 ×œ×™×˜×¨ ×™×™×Ÿ.</li>
                    <li><b>×—×©×•×‘:</b> ×”×¤×˜×•×¨ ×”×•× ××™×©×™ ×•×œ× × ×™×ª×Ÿ ×œ×¦×‘×™×¨×” ×œ××¡×¤×¨ ×× ×©×™×.</li>
                </ul>
            </div>
        </div>
        </div>
    </section>
    <section id="documents-and-gallery" class="my-12 scroll-mt-24 grid md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4"><i class="fa-solid fa-folder-open mr-2"></i>×ª×™×§ ××¡××›×™×</h2>
            <input type="file" id="document-upload" multiple class="hidden">
            <button id="document-upload-btn" class="btn btn-primary w-full mb-4">×”×¢×œ×” ××¡××›×™×</button>
            <div id="documents-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
        <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4"><i class="fa-solid fa-images mr-2"></i>×’×œ×¨×™×™×ª ×ª××•× ×•×ª</h2>
            <input type="file" id="image-upload" multiple accept="image/*" class="hidden">
            <button id="image-upload-btn" class="btn btn-primary w-full mb-4">×”×¢×œ×” ×ª××•× ×•×ª</button>
            <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
    </section>

  </main>
  <div id="lightbox-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[200]" style="display: none;">
    <img id="lightbox-image" src="" alt="×ª×¦×•×’×” ××•×’×“×œ×ª" class="max-w-[95vw] max-h-[95vh] rounded-lg shadow-2xl">
    <button id="lightbox-close-btn" class="absolute top-5 right-5 text-white text-4xl font-bold">&times;</button>
</div>

  
 
  <div id="select-day-for-upload-modal" class="modal-backdrop">
  <div class="modal">
    	  <div class="p-4 border-b"><h3 class="text-lg font-bold">×œ××™×–×” ×™×•× ×œ×©×™×™×š ××ª ×”×ª××•× ×•×ª?</h3></div>
      <div id="modal-upload-day-options" class="p-4 grid grid-cols-2 gap-3"></div>
      <div class="p-4 border-t flex justify-end">
          <button onclick="window.closeModal()" class="btn btn-ghost">×‘×™×˜×•×œ</button>
      </div>
  </div>
</div>
  <div id="add-to-day-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b"><h3 class="text-lg font-bold">×”×•×¡×£ ×¤×¢×™×œ×•×ª ×œ×™×•×...</h3></div>
        <div id="modal-day-options" class="p-4 grid grid-cols-2 gap-3"></div>
        <div class="p-4 border-t flex justify-end">
            <button onclick="window.closeModal()" class="btn btn-ghost">×‘×™×˜×•×œ</button>
        </div>
    </div>
  </div>

<div id="camera-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 id="camera-title" class="text-lg font-bold">××¦×œ××”</h3>
            <button id="camera-close-btn" class="text-2xl">Ã—</button>
        </div>

<div class="p-4 relative" id="video-container">
    <canvas id="camera-canvas" class="hidden"></canvas>
</div>

        <div id="main-controls-container" class="border-t">
            <div id="barcode-status-container" class="p-2 text-center">
                <span id="barcode-status-display" class="text-sm text-gray-400">×”××ª×Ÿ ×œ×”×¤×¢×œ×ª ×”××¦×œ××”...</span>
            </div>
            <div class="p-4 flex justify-around items-center gap-4">
                <button id="torch-btn" class="btn btn-ghost rounded-full w-12 h-12 text-xl" title="×¤× ×¡">
                    <i class="fa-solid fa-lightbulb"></i>
                </button>
                <button id="capture-btn" class="btn btn-primary rounded-full w-16 h-16 text-2xl border-4 border-white dark:border-gray-900 ring-2 ring-brand-500" title="×¦×œ×">
                    <i class="fa-solid fa-camera"></i>
                </button>
                <button id="upload-receipt-btn" class="btn btn-ghost rounded-full w-12 h-12 text-xl" title="×”×¢×œ×” ×§×•×‘×¥">
                    <i class="fa-solid fa-upload"></i>
                </button>
                <input type="file" id="receipt-file-input" class="hidden" accept="image/*">
            </div>
            <div class="p-2 border-t flex justify-center items-center gap-4">
                <button id="zoom-out-btn" class="btn btn-ghost" title="×”×§×˜×Ÿ"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
                <span id="zoom-level" class="font-mono text-sm">1.0x</span>
                <button id="zoom-in-btn" class="btn btn-ghost" title="×”×’×“×œ"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
            </div>
          <!-- ××¦×‘ ×¡×¨×™×§×” -->
<div id="scan-mode-selector" style="text-align:center; margin-top:10px;">
  <button class="scan-mode-btn active" onclick="cameraManager.setScanMode('auto', this)">ğŸ¤– ××•×˜×•××˜×™</button>
  <button class="scan-mode-btn" onclick="cameraManager.setScanMode('home', this)">ğŸ  ×‘×™×ª</button>
  <button class="scan-mode-btn" onclick="cameraManager.setScanMode('super', this)">ğŸ¬ ×¡×•×¤×¨</button>
  <button class="scan-mode-btn" onclick="cameraManager.setScanMode('outdoor', this)">â˜€ï¸ ×—×•×¥</button>
</div>

<style>
  .scan-mode-btn {
    background: #333;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 6px 10px;
    margin: 0 3px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
  }
  .scan-mode-btn.active {
    background: #e53935;
    color: #fff;
    font-weight: bold;
  }
  .scan-mode-btn:hover {
    background: #555;
  }
</style>

        </div>
    </div>
</div>

<div id="alert-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 id="alert-modal-title" class="text-lg font-bold"></h3>
            <div class="flex items-center gap-2">
                <button id="alert-modal-tts-settings-btn" class="btn btn-ghost btn-sm" title="×”×’×“×¨×•×ª ×§×•×œ"><i class="fa-solid fa-cog"></i></button>
                <button id="alert-modal-copy-btn" class="btn btn-ghost btn-sm hidden"><i class="fa-solid fa-copy mr-1"></i>×”×¢×ª×§</button>
            </div>
        </div>
        <div id="alert-modal-message" class="p-6 whitespace-pre-wrap max-h-[50vh] overflow-y-auto"></div>
        
        <div id="alert-modal-tts-controls" class="p-4 border-t flex justify-center items-center gap-3">
            <button id="alert-modal-play-pause" class="btn btn-primary" style="display: none;"><i class="fa-solid fa-play mr-1"></i> ×”×¤×¢×œ</button>
            <button id="alert-modal-stop" class="btn btn-ghost" style="display: none;"><i class="fa-solid fa-stop mr-1"></i> ×¢×¦×•×¨</button>
        </div>
        <div class="p-4 border-t flex justify-end">
            <button id="alert-modal-close" class="btn btn-primary">×”×‘× ×ª×™</button>
        </div>
    </div>
</div>
    <div id="gemini-modal" class="modal-backdrop">
      <div class="modal">
          <div class="p-4 border-b flex justify-between items-center">
              <h3 class="text-lg font-bold">×©××œ ××ª Gemini</h3>
              <button id="gemini-close-btn" class="text-2xl">Ã—</button>
          </div>
          <div class="border-b border-gray-200 dark:border-gray-800">
              <nav class="-mb-px flex justify-center gap-4" id="gemini-tabs-nav">
                  <button class="py-3 px-4 font-semibold border-b-2 tab-button tab-active" data-content="gemini-advisor-tab">×™×•×¢×¥ ×—×›×</button>
                  <button class="py-3 px-4 font-semibold border-b-2 tab-button" data-content="gemini-free-text-tab">×©××œ×” ×—×•×¤×©×™×ª</button>
              </nav>
          </div>
          <div class="p-4 flex-grow overflow-y-auto flex flex-col">
              <!-- Smart Advisor Tab -->
              <div id="gemini-advisor-tab" class="content-section active text-center">
                  <p class="mb-4">×§×‘×œ ×”××œ×¦×” ×—×›××” ×•××•×ª×××ª ××™×©×™×ª ×¢×œ ×¡××š ×”×©×¢×”, ××–×’ ×”××•×•×™×¨ ×•×”×ª×§×¦×™×‘ ×©×œ×š.</p>
                  <button id="get-smart-advice-btn" class="btn btn-primary"><i class="fa-solid fa-robot mr-2"></i>×ª×Ÿ ×œ×™ ×”××œ×¦×” ×—×›××”</button>
              </div>
              <!-- Free Text Tab -->
              <div id="gemini-free-text-tab" class="content-section">
                  <label for="gemini-prompt" class="block text-sm font-medium mb-1">×”×›× ×¡ ×©××œ×” ××• ×‘×§×©×”:</label>
                  <textarea id="gemini-prompt" class="w-full p-2 rounded-lg border bg-white dark:bg-gray-800" rows="3" placeholder="×œ×“×•×’××”: ×ª×Ÿ ×œ×™ 3 ×”×¦×¢×•×ª ×œ××¡×¢×“×•×ª ×¨×•×× ×˜×™×•×ª ×‘×¢×¨×‘ ×‘××–×•×¨ × ×‘×™×œ×™."></textarea>
                   <button id="gemini-submit-btn" class="btn btn-primary w-full mt-2">×©×œ×— ×©××™×œ×ª×”</button>
              </div>
              
              <div class="mt-4 flex-grow flex flex-col">
                  <h4 class="font-semibold mb-2">×ª×©×•×‘×”:</h4>
                  <div id="gemini-response" class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[100px] whitespace-pre-wrap flex-grow"></div>
              </div>
          </div>
      </div>
    </div>
<div id="daily-tip-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex items-center gap-3">
            <i class="fa-solid fa-lightbulb text-yellow-400 text-xl"></i>
            <h3 class="text-lg font-bold">×˜×™×¤ ×”×™×•× ×œ××˜×™×™×œ</h3>
        </div>
        <div id="daily-tip-body" class="p-6 whitespace-pre-wrap">×˜×•×¢×Ÿ ×˜×™×¤...</div>
        <div class="p-4 border-t flex justify-end">
            <button id="daily-tip-close" class="btn btn-primary">×”×‘× ×ª×™</button>
        </div>
    </div>
</div>
  <div id="voice-settings-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-bold"><i class="fa-solid fa-volume-high mr-2"></i> ×”×’×“×¨×•×ª ×§×•×œ (TTS)</h3>
            <button id="voice-settings-close-btn" class="text-2xl">Ã—</button>
        </div>
        <div class="p-6">
           <p class="text-sm text-gray-500 mb-4">×‘×—×¨ ××ª ×”×§×•×œ ×”×× ×•×©×™ ×”××•×¢×“×£ ×¢×œ×™×š ×©×™×©××© ×œ×”×§×¨××ª ××“×¨×™×›×™× ×§×•×œ×™×™× ×•×¡×™×›×•××™× ×™×•××™×™×.</p>

            <label for="global-voice-select" class="block text-sm font-medium mb-1">×‘×—×¨ ×§×•×œ (WaveNet ××•××œ×¥ ×œ××™×›×•×ª):</label>
            <select id="global-voice-select" class="w-full p-2 rounded-lg border bg-white dark:bg-gray-800">
                <option value="he-IL-Wavenet-A">WaveNet A</option>
                <option value="he-IL-Wavenet-B">WaveNet B (×–×›×¨)</option>
                <option value="he-IL-Wavenet-C">WaveNet C (× ×§×‘×”)</option>
                <option value="he-IL-Wavenet-D">WaveNet D (×–×›×¨)</option>
                <option value="he-IL-Standard-A">Standard A (× ×§×‘×”)</option>
                <option value="he-IL-Standard-B">Standard B (×–×›×¨)</option>
                <option value="he-IL-Standard-C">Standard C (× ×§×‘×”)</option>
                <option value="he-IL-Wavenet-D">WaveNet D (×–×›×¨ - ××•××œ×¥)</option>
 </select>
 <p id="voice-test-status" class="mt-4 text-center text-xs text-gray-500">×œ×—×¥ ×¢×œ ×”×§×•×œ ×›×“×™ ×œ×©××•×¢ ×“×•×’××”.</p>
        </div>
    </div>
</div>



  <div id="floating-nav-container" class="md:hidden fixed bottom-0 left-0 right-0 z-40">
      <div id="plan-submenu" class="floating-submenu fixed bottom-[68px] left-0 right-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm p-2 rounded-t-2xl">
          <div class="grid grid-cols-3 gap-2 text-center text-sm" id="plan-submenu-links">
              </div>
      </div>
<div id="tools-submenu" class="floating-submenu fixed bottom-[68px] left-0 right-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm p-2 rounded-t-2xl">
    <div id="tools-submenu-links" class="grid grid-cols-3 gap-2 text-center text-sm">
        </div>
</div>

      <nav id="floating-nav" class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.1)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.3)] rounded-t-2xl">
        <div class="flex justify-around p-2 text-gray-700 dark:text-gray-300">
            <button id="floating-plan-btn" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-calendar-days fa-lg"></i>
                <span>×ª×•×›× ×™×ª</span>
            </button>
            <a href="#kosher" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-utensils fa-lg"></i>
                <span>×›×©×¨</span>
            </a>
            <button id="floating-tools-btn" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-screwdriver-wrench fa-lg"></i>
                <span>×›×œ×™×</span>
            </button>
        </div>
      </nav>
  </div>
  
  
  <script type="module">

// ==========================================================================
// --- ××¨×›×™×˜×§×˜×•×¨×ª ××¦×œ××” ×—×“×©×” (×’×¨×¡×” 8 - ×ª×™×§×•×Ÿ ×–×•×) 
// ==========================================================================
const cameraManager = {
    stream: null,
    videoTrack: null,
    videoElement: null,
    mode: null,
    isDetecting: false,
    
    // ×”×•×¡×¤×ª ××©×ª× ×™× ×œ× ×™×”×•×œ ××¦×‘ ×”×–×•×
    zoomCapabilities: null,
    currentZoom: 1,
    
    async open(mode) {
        if (this.stream) this.stop();
        this.mode = mode;
        this.isDetecting = false;

        try {
            document.getElementById('video-container').innerHTML = `
                <video id="camera-feed" class="w-full h-full object-cover bg-black rounded-lg" playsinline autoplay></video>
                <canvas id="camera-canvas" class="hidden"></canvas>`;
            this.videoElement = document.getElementById('camera-feed');

            this.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' }, torch: false, width: { ideal: 1280 }, height: { ideal: 720 }, zoom: true } });
            this.videoElement.srcObject = this.stream;
            
            await new Promise(resolve => { this.videoElement.onloadedmetadata = resolve; });

            this.videoTrack = this.stream.getVideoTracks()[0];
            if (!this.videoTrack) throw new Error("No video track found");
            
            document.getElementById('camera-modal').classList.add('flex');
            
            // --- ×ª×™×§×•×Ÿ: ×©××™×¨×ª ×™×›×•×œ×•×ª ×”×–×•× ×•×”××¦×‘ ×”× ×•×›×—×™ ---
            const caps = this.videoTrack.getCapabilities();
            if (caps.zoom) {
                this.zoomCapabilities = caps.zoom;
                this.currentZoom = this.videoTrack.getSettings().zoom || 1;
            } else {
                this.zoomCapabilities = null;
                this.currentZoom = 1;
            }
            this.updateZoomUI(); // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×” ×”×¨××©×•× ×™×ª

            return this.videoElement;

        } catch (err) {
            console.error('Camera Manager Open Error:', err);
            this.stop();
            showAlert('×©×’×™××ª ××¦×œ××”', '×œ× × ×™×ª×Ÿ ×”×™×” ×œ×”×¤×¢×™×œ ××ª ×”××¦×œ××”. ×× × ×•×“× ×©×”×¢× ×§×ª ×”×¨×©××•×ª ××ª××™××•×ª ×œ×“×¤×“×¤×Ÿ.');
            return null;
        }
    },

stop() {
    this.isDetecting = false;
    
    // *** ×”×ª×™×§×•×Ÿ ×”×§×¨×™×˜×™ ××ª×—×™×œ ×›××Ÿ ***
    // ×× ×¡×” ×œ×¢×¦×•×¨ ××ª Quagga ×¨×§ ×× ×”×•× ×§×™×™× (typeof) ×•××•× ×¢ ××ª ×©×’×™××ª TypeError 
    // ×¢×œ ×™×“×™ ×©×™××•×© ×‘-try/catch ×¡×‘×™×‘ ×”×¢×¦×™×¨×” ×©×œ Quagga.
    if (typeof Quagga !== 'undefined' && Quagga.initialized) {
        try {
            Quagga.stop();
            Quagga.offDetected();
        } catch (e) {
            // ×”×ª×¢×œ× ××©×’×™××ª TypeError ×‘-Quagga.stop() ×× ×”××¦×‘ ×¤× ×™××™ ×©×’×•×™
            console.warn("WARN: Ignored Quagga.stop() error, likely due to internal state cleanup:", e.message);
        }
    }

    if (this.stream) {
        this.stream.getTracks().forEach(track => track.stop());
    }
    // Reset all state properties
    this.stream = null;
    this.videoTrack = null;
    this.mode = null;
    this.zoomCapabilities = null;
    this.currentZoom = 1;
    
    document.getElementById('camera-modal').classList.remove('flex');
},
    updateZoomUI() {
        document.getElementById('zoom-level').textContent = `${this.currentZoom.toFixed(1)}x`;
    },

    async changeZoom(direction) {
        if (!this.zoomCapabilities) return;
        
        this.currentZoom += direction * (this.zoomCapabilities.step || 0.1);
        this.currentZoom = Math.max(this.zoomCapabilities.min, Math.min(this.currentZoom, this.zoomCapabilities.max));
        
        try {
            await this.videoTrack.applyConstraints({ advanced: [{ zoom: this.currentZoom }] });
            this.updateZoomUI();
        } catch (err) {
            console.error("Zoom failed:", err);
        }
    },
    async toggleTorch() {
        const caps = this.videoTrack?.getCapabilities();
        if (!caps?.torch) {
            showAlert('×¤× ×¡ ×œ× × ×ª××š', '× ×¨××” ×©×”××›×©×™×¨ ××• ×”×“×¤×“×¤×Ÿ ××™× × ×ª×•××›×™× ×‘×©×œ×™×˜×” ×¢×œ ×”×¤× ×¡.');
            return;
        }
        try {
            const currentTorchState = this.videoTrack.getSettings().torch || false;
            await this.videoTrack.applyConstraints({ advanced: [{ torch: !currentTorchState }] });
            document.getElementById('torch-btn').classList.toggle('text-yellow-400', !currentTorchState);
        } catch (err) {
            console.error('Error controlling torch:', err);
        }
    }
    // *** ×›××Ÿ ×”×•×¡×¤×ª ×”×¤×¡×™×§ ×”×—×¡×¨ ***
    ,
async startBarcodeDetection(showDebug = true) {
    if (typeof Quagga === 'undefined') {
        showAlert('×©×’×™××”', '×¡×¤×¨×™×™×ª QuaggaJS ×œ× × ×˜×¢× ×” ×›×¨××•×™.');
        return;
    }

    this.isDetecting = true;
    const videoContainer = document.getElementById('video-container');
    const statusDisplay = document.getElementById('barcode-status-display');
    statusDisplay.textContent = '×××ª×—×œ ×¡×¨×™×§×”...';

    try { Quagga.stop(); Quagga.offDetected(); Quagga.offProcessed(); } catch {}

    const video = document.getElementById('camera-feed');
    if (!video) {
        showAlert('×©×’×™××”', '×œ× × ××¦××” ××¦×œ××” ×¤×¢×™×œ×”.');
        return;
    }

    // ğŸŸ¥ ×§×• ××™×§×•×“ ××“×•×
    let focusLine = document.getElementById('focus-line');
    if (!focusLine) {
        focusLine = document.createElement('div');
        focusLine.id = 'focus-line';
        Object.assign(focusLine.style, {
            position: 'absolute',
            top: '50%',
            left: '0',
            width: '100%',
            height: '2px',
            background: 'red',
            opacity: '0.8',
            transform: 'translateY(-50%)',
            animation: 'scanLine 1.5s infinite alternate ease-in-out',
            zIndex: '10'
        });
        videoContainer.appendChild(focusLine);

        const style = document.createElement('style');
        style.textContent = `
        @keyframes scanLine {
            0% { opacity: 0.8; transform: translateY(-50%) scaleY(1); }
            50% { opacity: 0.3; transform: translateY(-50%) scaleY(1.2); }
            100% { opacity: 0.8; transform: translateY(-50%) scaleY(1); }
        }`;
        document.head.appendChild(style);
    }

    // ğŸŸ¦ ×ª×™×‘×ª debug ××•×¤×¦×™×•× ×œ×™×ª
    let debugBox = document.getElementById('barcode-debug');
    if (showDebug) {
        if (!debugBox) {
            debugBox = document.createElement('div');
            debugBox.id = 'barcode-debug';
            Object.assign(debugBox.style, {
                position: 'absolute',
                bottom: '8px',
                left: '50%',
                transform: 'translateX(-50%)',
                background: 'rgba(0,0,0,0.6)',
                color: 'white',
                fontSize: '14px',
                padding: '4px 10px',
                borderRadius: '6px',
                zIndex: '20',
                fontFamily: 'monospace',
                opacity: '0.85'
            });
            videoContainer.appendChild(debugBox);
        }
        debugBox.textContent = '';
    }

    // âš™ï¸ ×§×•× ×¤×™×’ ×—×“×© ×¢× ×©×™×¤×•×¨×™ ×¨×–×•×œ×•×¦×™×”, fps, ×•×¤×™×œ×˜×¨×™×
    const config = {
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: videoContainer,
            constraints: {
                facingMode: "environment",
                frameRate: { ideal: 30, min: 15 },
                width: { ideal: 1280, min: 640 },
                height: { ideal: 720, min: 480 }
            },
            area: { top: "20%", right: "10%", left: "10%", bottom: "20%" }
        },
        locator: { patchSize: "medium", halfSample: false },
        decoder: {
            readers: [
                "ean_reader",
                "ean_8_reader",
                "upc_reader",
                "upc_e_reader",
                "code_128_reader",
                "code_39_reader",
                "code_93_reader"
            ],
            multiple: false
        },
        locate: true,
        frequency: 5,
        numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2
    };

    let detectionTimeout;
    let lastCode = null;
    let sameCount = 0;

    const runScanner = () => {
        Quagga.start();
        statusDisplay.textContent = '×›×•×•×Ÿ ××ª ×”×‘×¨×§×•×“ ×œ×§×• ×”××“×•×...';

        detectionTimeout = setTimeout(() => {
            if (this.isDetecting) {
                this.isDetecting = false;
                Quagga.stop();
                const line = document.getElementById('focus-line');
                if (line) line.remove();
                if (debugBox) debugBox.remove();
                statusDisplay.textContent = 'âŒ ×œ× ×–×•×”×” ×‘×¨×§×•×“';
                showAlert('×œ× ×–×•×”×”', '×œ× × ××¦× ×‘×¨×§×•×“. × ×¡×” ×©×•×‘ ××§×¨×•×‘ ×™×•×ª×¨ ××• ×¢× ×ª××•×¨×” ×˜×•×‘×”.');
                this.stop();
            }
        }, 12000);

        // ×¢×™×‘×•×“ ×•×—×“×•×“ ×ª××•× ×” (contrast + sharpen)
        Quagga.onProcessed((result) => {
            const ctx = Quagga.canvas.ctx.image;
            const canvas = Quagga.canvas.dom.image;
            if (ctx && canvas) {
                try {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        const factor = 1.3;
                        data[i] = Math.min(255, (data[i] - avg) * factor + avg);
                        data[i+1] = Math.min(255, (data[i+1] - avg) * factor + avg);
                        data[i+2] = Math.min(255, (data[i+2] - avg) * factor + avg);
                    }
                    ctx.putImageData(imageData, 0, 0);
                } catch {}
            }

            // ×¦×™×•×¨ ××¡×’×¨×•×ª ×–×™×”×•×™
            const overlayCtx = Quagga.canvas.ctx.overlay;
            const overlayCanvas = Quagga.canvas.dom.overlay;
            if (overlayCtx && overlayCanvas) {
                overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                if (result?.boxes) {
                    result.boxes
                        .filter(b => b !== result.box)
                        .forEach(box => Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, overlayCtx, { color: "green", lineWidth: 2 }));
                }
                if (result?.box) {
                    Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, overlayCtx, { color: "blue", lineWidth: 3 });
                }
            }

            if (showDebug && result?.codeResult?.code) {
                debugBox.textContent = `××–×”×” ××¤×©×¨×™: ${result.codeResult.code}`;
            }
        });

        // ğŸ” ×–×™×”×•×™ ×¡×•×¤×™
        Quagga.onDetected((result) => {
            if (!this.isDetecting) return;
            const code = result.codeResult?.code;
            if (!code || code.length < 8) return;

            if (showDebug) debugBox.textContent = `â†³ ${code}`;

            if (code === lastCode) sameCount++;
            else { lastCode = code; sameCount = 1; }

            if (sameCount < 1) return; // ×“×•×¨×© ×©×œ×•×© ×§×¨×™××•×ª ×–×”×•×ª

            clearTimeout(detectionTimeout);
            this.isDetecting = false;
            statusDisplay.textContent = `âœ… ×‘×¨×§×•×“ ×–×•×”×”: ${code}`;
            navigator.vibrate?.(100);

            const line = document.getElementById('focus-line');
            if (line) line.remove();
            if (debugBox) debugBox.remove();

            Quagga.offDetected();
            Quagga.stop();

            setTimeout(() => {
                this.stop();
                window.checkKosherStatus(code);
            }, 600);
        });
    };

    // ×”×¤×¢×œ×ª Quagga ×¢× fallback ×œ×¨×–×•×œ×•×¦×™×” × ××•×›×” ×‘××™×“×ª ×”×¦×•×¨×š
    Quagga.init(config, (err) => {
        if (err) {
            console.warn("Quagga Init Error, fallback:", err);
            config.inputStream.constraints.width = { ideal: 640 };
            config.inputStream.constraints.height = { ideal: 480 };
            Quagga.init(config, (err2) => {
                if (err2) {
                    console.error("Quagga Init Failed:", err2);
                    statusDisplay.textContent = '×©×’×™××” ×‘××ª×—×•×œ ×”×¡×•×¨×§.';
                    return;
                }
                runScanner();
            });
        } else {
            runScanner();
        }
    });
}

}; // <-- ×”×¡×•×’×¨ ×”×–×” ×¡×•×’×¨ ××ª ×›×œ ×”××•×‘×™×™×§×˜ cameraManager

window.cameraManager = cameraManager;

    cameraManager.setScanMode = function(mode, btn) {
    this.scanMode = mode;

    // ×”×¡×¨×ª ×”×“×’×©×” ××›×¤×ª×•×¨×™× ××—×¨×™×
    document.querySelectorAll('.scan-mode-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');

    const statusDisplay = document.getElementById('barcode-status-display');
    let desc = '';
    switch(mode) {
        case 'home': desc = 'ğŸ  ××¦×‘ ×‘×™×ª - ×ª××•×¨×” ×—×œ×©×”, ×“×™×•×§ ×’×‘×•×”'; break;
        case 'super': desc = 'ğŸ¬ ××¦×‘ ×¡×•×¤×¨ - ×ª××•×¨×” ×—×–×§×” / ×¤×œ×•×¨×¡× ×˜'; break;
        case 'outdoor': desc = 'â˜€ï¸ ××¦×‘ ×—×•×¥ - ××•×¨ ×—×–×§ ×¢× ×”×—×–×¨×™ ××•×¨'; break;
        default: desc = 'ğŸ¤– ××¦×‘ ××•×˜×•××˜×™ - ×”×ª×××” ××•×˜×•××˜×™×ª ×œ×¤×™ ×ª××•×¨×”'; break;
    }
    statusDisplay.textContent = desc;
};


// --------------------------------------------------------
// ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×›×©×¨×•×ª ×“×¨×š OpenFoodFacts
// --------------------------------------------------------
window.checkKosherStatus = async function (barcode) {
    const statusDisplay = document.getElementById('barcode-status-display');
    statusDisplay.textContent = '×‘×•×“×§ × ×ª×•× ×™×...';

    try {
        const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
        const data = await response.json();

        if (data.status === 1) {
            const p = data.product;
            const productName = p.product_name_he || p.product_name || '××•×¦×¨ ×œ×œ× ×©×';
            const image = p.image_front_small_url || '';
            const kosherTags = (p.labels_tags || []).filter(tag => tag.includes('kosher'));
            const isKosher = kosherTags.length > 0;

            let message = `
                <div class="text-center space-y-3">
                    ${image ? `<img src="${image}" alt="××•×¦×¨" class="mx-auto rounded-lg max-h-40">` : ''}
                    <div class="font-bold text-lg">${productName}</div>
                    <div>${isKosher ? 'âœ… ×™×™×ª×›×Ÿ ×©××•×¦×¨ ×–×” ×›×©×¨' : 'âš ï¸ ×œ× × ××¦× ××™×“×¢ ×¢×œ ×›×©×¨×•×ª'}</div>
                    <a href="https://world.openfoodfacts.org/product/${barcode}" target="_blank" class="text-blue-600 underline">×¦×¤×” ×‘×¤×¨×˜×™× ×”××œ××™×</a>
                </div>
            `;

            showAlert('×ª×•×¦××ª ×”×¡×¨×™×§×”', message);
        } else {
            showAlert('×œ× × ××¦×', `×œ× × ××¦× ××•×¦×¨ ×¢× ×‘×¨×§×•×“ ${barcode} ×‘×××’×¨.`);
        }
    } catch (err) {
        console.error('OpenFoodFacts API Error:', err);
        showAlert('×©×’×™××”', '×œ× × ×™×ª×Ÿ ×”×™×” ×œ×’×©×ª ×œ×××’×¨ ×”××™×“×¢.');
    }
};

   
// --- ×¡×•×£ Camera Manager ---
    
    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc, enableIndexedDbPersistence, collection, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    console.log("LOG: Script start. Initializing variables.");
// ==========================================================================
// --- ××¢×¨×›×ª TTS ×•×—×™×‘×•×¨×™× ×—×“×©×” ×•×××•×—×“×ª ---
// ==========================================================================

// 1. ×× ×”×œ ×”×§×•×œ (TTS) ×”××¨×›×–×™
const ttsManager = {
    audio: null, utterance: null, isPlaying: false, isPaused: false,

async speak(text, useApi = true, lang = 'he-IL') {
    this.stop();
    if (!text) { console.error("TTS Error: No text provided."); return; }

    const characterLimit = 4800;
    if (useApi && text.length < characterLimit) {
        // ... (×”×—×œ×§ ×©×œ ×”-API × ×©××¨ ×œ×œ× ×©×™× ×•×™) ...
        const apiKey = "AIzaSyDzQFz_abwcxSwq8VhHCQS-HcsYk_Qug-I";
        const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`;
        const selectedVoice = document.getElementById("global-voice-select")?.value || "he-IL-Wavenet-D";
        try {
            const response = await fetch(url, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    input: { text },
                    voice: { languageCode: lang, name: selectedVoice },
                    audioConfig: { audioEncoding: "MP3" }
                })
            });
            const data = await response.json();
            if (!data.audioContent) throw new Error("No audio content");
            this.audio = new Audio("data:audio/mp3;base64," + data.audioContent);
            this.audio.play();
            this.isPlaying = true;
            this.updateUI();
            this.audio.onended = () => this.stop();
        } catch (err) {
            console.error("Google TTS API failed, falling back to local TTS:", err);
            this.speak(text, false, lang);
        }
    } else {
        // --- ×ª×™×§×•×Ÿ: ×”×•×¡×¤×ª ×œ×•×’×™×§×ª ×—×™×ª×•×š ×œ×˜×§×¡×˜×™× ××¨×•×›×™× ---
        if (!('speechSynthesis' in window)) { showAlert('×©×’×™××”', '×”×“×¤×“×¤×Ÿ ××™× ×• ×ª×•××š ×‘×”×§×¨××ª ×˜×§×¡×˜.'); return; }
        
        const chunks = text.match(/[\s\S]{1,200}/g) || []; // ×—×•×ª×š ××ª ×”×˜×§×¡×˜ ×œ×—×œ×§×™× ×©×œ 200 ×ª×•×•×™×
        let chunkIndex = 0;

        const speakChunk = () => {
            if (chunkIndex >= chunks.length) {
                this.stop();
                return;
            }
            this.utterance = new SpeechSynthesisUtterance(chunks[chunkIndex]);
            this.utterance.lang = lang;
            const voices = speechSynthesis.getVoices() || [];
            const selectedVoiceName = document.getElementById("global-voice-select")?.value;
            if(selectedVoiceName) this.utterance.voice = voices.find(v => v.name === selectedVoiceName);
            
            this.utterance.onend = () => {
                chunkIndex++;
                speakChunk(); // ×§×¨× ×œ×—×œ×§ ×”×‘×
            };
            speechSynthesis.speak(this.utterance);
        };
        
        speakChunk(); // ×”×ª×—×œ ×œ×§×¨×•× ××ª ×”×—×œ×§ ×”×¨××©×•×Ÿ
        this.isPlaying = true;
        this.updateUI();
        // --- ×¡×•×£ ×”×ª×™×§×•×Ÿ ---
    }
},
    togglePause() {
        if (!this.isPlaying && !this.isPaused) return;
        if (this.audio) {
            if (this.isPaused) this.audio.play(); else this.audio.pause();
        } else if (this.utterance) {
            if (this.isPaused) speechSynthesis.resume(); else speechSynthesis.pause();
        }
        this.isPaused = !this.isPaused;
        this.updateUI();
    },
stop() {
    if (this.audio) {
        this.audio.pause();
        this.audio.currentTime = 0;
        this.audio.src = ''; // -> ×× ×§×” ××ª ×”××©××‘ ×œ×—×œ×•×˜×™×Ÿ
    }
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
    }
    this.audio = null;
    this.utterance = null;
    this.isPlaying = false;
    this.isPaused = false;
    this.updateUI();
},
    updateUI() {
        const playPauseBtn = document.getElementById('alert-modal-play-pause');
        const stopBtn = document.getElementById('alert-modal-stop');
        if (!playPauseBtn || !stopBtn) return;
        if (this.isPlaying || this.isPaused) {
            stopBtn.style.display = 'flex';
            playPauseBtn.innerHTML = this.isPaused ? '<i class="fa-solid fa-play mr-1"></i> ×”××©×š' : '<i class="fa-solid fa-pause mr-1"></i> ×”×©×”×”';
        } else {
            playPauseBtn.innerHTML = '<i class="fa-solid fa-play mr-1"></i> ×”×©××¢';
            stopBtn.style.display = 'none';
        }
    }
};
window.ttsManager = ttsManager; 
console.log("LOG: ttsManager exposed globally."); 
// 2. ×¤×•× ×§×¦×™×™×ª showAlert ×”××¢×•×“×›× ×ª
function showAlert(title, message, speechOptions = null) {
    ttsManager.stop(); // ×¢×¦×•×¨ ×›×œ × ×™×’×•×Ÿ ×§×•×“× ×‘×¤×ª×™×—×ª ×—×œ×•×Ÿ ×—×“×©
    const modal = document.getElementById('alert-modal');
    document.getElementById('alert-modal-title').textContent = title;
    document.getElementById('alert-modal-message').innerHTML = message;
    const playPauseBtn = document.getElementById('alert-modal-play-pause');
    const stopBtn = document.getElementById('alert-modal-stop');

    playPauseBtn.onclick = null;
    stopBtn.onclick = null;

    if (speechOptions && speechOptions.text) {
        playPauseBtn.style.display = 'flex';
        playPauseBtn.onclick = () => {
            if (ttsManager.isPlaying || ttsManager.isPaused) {
                ttsManager.togglePause();
            } else {
                ttsManager.speak(speechOptions.text, speechOptions.useApi, speechOptions.lang);
            }
        };
        stopBtn.onclick = () => ttsManager.stop();
    } else {
        playPauseBtn.style.display = 'none';
    }
    ttsManager.updateUI();
    modal.classList.add('flex');
}

// 3. ×¤×•× ×§×¦×™×•×ª ××¢×˜×¤×ª ×—×“×©×•×ª
function showBrachaAchronaOptions() {
    const message = `<div class="grid grid-cols-1 gap-2">
        <button onclick="window.playBracha('boreiNefashot')" class="btn btn-primary">×‘×•×¨× × ×¤×©×•×ª</button>
        <button onclick="window.playBracha('alHaMichya')" class="btn btn-primary">×¢×œ ×”××—×™×”</button>
        <button onclick="window.playBracha('alHaGefen')" class="btn btn-primary">×¢×œ ×”×’×¤×Ÿ</button>
        <button onclick="window.playBracha('alHaEtz')" class="btn btn-primary">×¢×œ ×”×¢×¥</button>
    </div>`;
    showAlert('×‘×—×¨ ×‘×¨×›×” ××—×¨×•× ×”', message);
}
window.playBracha = (brachaKey) => {
    const titleMap = { boreiNefashot: '×‘×¨×›×ª ×‘×•×¨× × ×¤×©×•×ª', alHaMichya: '×‘×¨×›×ª ×¢×œ ×”××—×™×”', alHaGefen: '×‘×¨×›×ª ×¢×œ ×”×’×¤×Ÿ', alHaEtz: '×‘×¨×›×ª ×¢×œ ×”×¢×¥' };
    const text = hebrewPrayers[brachaKey].replace(/<[^>]*>?/gm, '');
    showAlert(titleMap[brachaKey], hebrewPrayers[brachaKey], { text, useApi: true });
};
async function getAudioGuide(placeName) {
    showLoading('××›×™×Ÿ ××“×¨×™×š ×§×•×œ×™...', `×”××¢×¨×›×ª ××™×™×¦×¨×ª ××“×¨×™×š ×¢×œ ${placeName}.`);
    const prompt = `×¦×•×¨ ××“×¨×™×š ×§×•×œ×™ ××¤×•×¨×˜ ×•×ª××¦×™×ª×™ ×¢×œ ${placeName} ×‘××™×œ×× ×•. ×”××“×¨×™×š ×¦×¨×™×š ×œ×”×™×•×ª ×›×ª×•×‘ ×‘×¢×‘×¨×™×ª ×‘×¨×•×¨×”, ×‘×˜×•×Ÿ ×™×“×™×“×•×ª×™ ×•××¢× ×™×™×Ÿ, ×‘××•×¨×š ×©×œ ×›-1000 ×ª×•×•×™×.`;
    const scriptText = await callGemini({ contents: [{ parts: [{ text: prompt }] }] });
    hideLoading();
    showAlert(`××“×¨×™×š ×§×•×œ×™: ${placeName}`, scriptText, { text: scriptText, useApi: true });
}
async function generateDailySummary(dayId) {
    const dayData = localTripData.plan[dayId];
    if (!dayData) return;
    showLoading(`××›×™×Ÿ ×¤×•×“×§××¡×˜ ×™×•××™...`, `××¡×›× ××ª ×™×•× ${dayData.name}.`);
    const placesNames = dayData.activities.map(p => p.name).join(', ');
    const prompt = `××ª×” ×§×¨×™×™×Ÿ ×¤×•×“×§××¡×˜. ×›×ª×•×‘ ×¤×•×“×§××¡×˜ ×§×¦×¨ (×›-800 ×ª×•×•×™×) ×‘×¢×‘×¨×™×ª ×”××¡×›× ××ª ×™×•× ${dayData.name} ×‘×˜×™×•×œ. ×”×ª×—×œ ×‘××©×¤×˜: "×©×œ×•× ×œ×›×•×œ× ×•×‘×¨×•×›×™× ×”×‘××™× ×œ×¡×™×›×•× ×”×™×•××™ ×©×œ× ×•!" ×•×¡×›× ××ª ×”×™×¢×“×™× ×”××¨×›×–×™×™× ×©×”×™×•: ${placesNames}.`;
    const podcastScript = await callGemini({ contents: [{ parts: [{ text: prompt }] }] });
    hideLoading();
    showAlert(`×¡×™×›×•× ×™×•××™: ${dayData.name}`, podcastScript, { text: podcastScript, useApi: true });
}
// ×”×“×‘×§ ××ª ×›×œ ×”×§×˜×¢ ×”×‘× ×‘×§×•×“ ×©×œ×š

window.startRecognition = startRecognition;
    // --- UTILS ---
    const $ = (s, p = document) => p.querySelector(s);
    const $$ = (s, p = document) => Array.from(p.querySelectorAll(s));
    function toRad(x) { return x * Math.PI / 180; }
    function haversineKm(lat1, lon1, lat2, lon2) {
        if ([lat1, lon1, lat2, lon2].some(c => c === undefined || c === null)) return NaN;
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.asin(Math.sqrt(a));
        return R * c;
    }
    function formatKm(km) { return isNaN(km) ? '' : `(${km.toFixed(1)} ×§×´×)`; }
    function minsForMode(km, mode) {
        if (isNaN(km)) return 15;
        if (mode === 'walk') { const speed = 4.5; return Math.max(8, (km / speed) * 60); }
        if (mode === 'drive') { const speed = 25; return Math.max(10, (km / speed) * 60); }
        if (mode === 'transit') { const speed = 18; return Math.max(12, (km / speed) * 60 + 5); }
        return 15;
    }
    function formatMin(min) {
        min = Math.round(min);
        if (min < 60) return `${min} ×“×§×³`;
        const h = Math.floor(min / 60);
        const m = min % 60;
        return `${h} ×©×³ ${m} ×“×³`;
    }
    const fmtBold = (t) => (t || '').replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-brand-700 dark:text-brand-300">$1<\/strong>');
    const placeholderLogoUrl = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&size=80&rounded=true&background=e0e7ff&color=1e40af`;
    
// --- Global State ---
let db, auth, tripDocRef, locationsColRef;
let cameraMode = 'translate';
let activeVideoTrack = null;
let localTripData = {};
let budgetChartInstance = null;
let cameraStream = null;
let eurToIlsRate = 4.0; // Default rate
let userCoords = null;
let isFirebaseConnected = false; // ×”×’×“×¨×ª Firebase ×ª×§×™× ×”
let translationHistory = JSON.parse(localStorage.getItem('milanTripTranslationHistory')) || [];
let lastWeatherAPIData = null;
let geminiChatHistory = []; // ××©×ª× ×” ×”×©×™×—×” ×”×—×“×©
let activeAudio = null; // ××©×ª× ×” ×’×œ×•×‘×œ×™ ×©×™×—×–×™×§ ××ª ××•×‘×™×™×§×˜ ×”-Audio ×”× ×•×›×—×™
let lastScannedBarcode = null; // ××©×ª× ×” ×—×“×© ×œ××—×¡×•×Ÿ ×”×‘×¨×§×•×“ ×©×–×•×”×”
let activeLocalUtterance = null
// --- Live Location State ---
let liveMap;
let userMarkers = {};
let watchingLocation = false;
let watchId = null;
let currentUserId = null;
let zoomInBtn, zoomOutBtn, zoomLevelDisplay;
let currentZoom = 1;
let zoomCapabilities = null;
console.log("LOG: Global variables and utility functions defined.");
//-----------------------------------------------------------


    // --- DATA ---
const attractions = {
  duomo: { name: "×§×ª×“×¨×œ×ª ×”×“×•××•××•", isOutdoor: false, type: 'attraction', address: "Piazza del Duomo, 20122 Milano MI, Italy", img: ["https://www.metailimbaolam.com/wp-content/uploads/2020/08/italy-4695974_1280.jpg"], tickets: "https://www.duomomilano.it/en/buy-tickets/", description: "×”×œ×‘ ×”×¤×•×¢× ×©×œ ××™×œ×× ×•. ×—×•×‘×” ×œ×¢×œ×•×ª ×œ×’×’ ×œ×ª×¦×¤×™×ª ×¤× ×•×¨××™×ª ××¨×”×™×‘×” ×¢×œ ×”×¢×™×¨.", coords: { lat: 45.4642, lon: 9.1916 }, cost: 20, hours: "×›×œ ×™×•×, 09:00-19:00" },
  sanSiro: { name: "××¦×˜×“×™×•×Ÿ ×¡×Ÿ ×¡×™×¨×•", isOutdoor: true, type: 'attraction', address: "Piazzale Angelo Moratti, 20151 Milano MI, Italy", img: ["https://www.xn--4dbkkmip.co.il/wp-content/uploads/2023/05/san-siro-1940307_640.jpg"], tickets: "https://www.sansirostadium.com/en/stadium-tour-museum/", description: "××§×“×© ×”×›×“×•×¨×’×œ ×©×œ ××™×œ×× ×•, ×‘×™×ª×Ÿ ×©×œ ××™×œ××Ÿ ×•××™× ×˜×¨. ××•××œ×¥ ×œ×¡×™×•×¨ ××• ×œ××©×—×§.", coords: { lat: 45.4780, lon: 9.1238 }, cost: 30, hours: "×›×œ ×™×•×, 09:30-19:00 (××©×ª× ×” ×‘×™××™ ××©×—×§)" },
  primark: { name: "×¤×¨×™×™×××¨×§ (×•×™×” ×˜×•×¨×™× ×•)", isOutdoor: false, type: 'attraction', address: "Via Torino, 45, 20123 Milano MI, Italy", img: ["https://www.shutterstock.com/image-photo/bordeaux-france-07-17-2024-260nw-2490117199.jpg"], info: "https://www.primark.com/it/it/negozi/milano/via-torino-45", description: "×¡× ×™×£ ×”×“×’×œ ×”×¢× ×§ ×©×œ ×¨×©×ª ×”××•×¤× ×” ×”×–×•×œ×”, ×’×Ÿ ×¢×“×Ÿ ×œ×—×•×‘×‘×™ ×§× ×™×•×ª.", coords: { lat: 45.4623, lon: 9.1861 }, cost: 0, hours: "×›×œ ×™×•×, 09:00-22:00" },
  como: { name: "××’× ×§×•××•", isOutdoor: true, type: 'attraction', address: "Varenna, Italy", img: ["https://www.travelonatimebudget.co.uk/wp-content/uploads/2022/01/varenna-dp.jpg"], description: "×™×•× ×˜×™×•×œ ×œ××—×“ ×”××’××™× ×”×™×¤×™× ×‘××™×˜×œ×™×”. ××•××œ×¥ ×œ×‘×§×¨ ×‘×¢×™×™×¨×•×ª ×•××¨× ×” ×•×‘×œ××’'×™×•.", coords: { lat: 45.9863, lon: 9.2816 }, cost: 15 },
  berninaExpress: { name: "×¨×›×‘×ª ×‘×¨× ×™× ×” ×œ××œ×¤×™×", isOutdoor: true, type: 'attraction', address: "Tirano, Italy", img: ["https://www.civitatis.com/f/italia/milan/excursion-alpes-suizos-589x392.jpg"], tickets: "https://www.rhb.ch/en/panoramic-trains/bernina-express", description: "× ×¡×™×¢×ª ×¨×›×‘×ª ×¤× ×•×¨××™×ª ××“×”×™××” ×“×¨×š ×”×¨×™ ×”××œ×¤×™× ×œ×©×•×•×™×¥.", coords: { lat: 46.4914, lon: 9.8683 }, cost: 70 },
  laScala: { name: "×ª×™××˜×¨×•×Ÿ ×œ×” ×¡×§××œ×”", isOutdoor: false, type: 'attraction', address: "Via Filodrammatici, 2, 20121 Milano MI, Italy", img: ["https://www.hakolal.co.il/wp-content/uploads/2018/10/La-Scala.jpg"], tickets: "https://www.teatroallascala.org/en/visit-the-theatre/visits-to-the-theatre-museum.html", description: "××—×“ ××‘×ª×™ ×”××•×¤×¨×” ×”××¤×•×¨×¡××™× ×•×”×™×•×§×¨×ª×™×™× ×‘×¢×•×œ×.", coords: { lat: 45.4675, lon: 9.1895 }, cost: 12, hours: "××•×–×™××•×Ÿ: ×›×œ ×™×•×, 09:30-17:30" },
  navigli: { name: "×¨×•×‘×¢ × ×‘×™×œ×™", isOutdoor: true, type: 'attraction', address: "Ripa di Porta Ticinese, 20143 Milano MI, Italy", description: "×¨×•×‘×¢ ×”×ª×¢×œ×•×ª ×”××§×¡×™× ×©×œ ××™×œ×× ×•, ××•×©×œ× ×œ×©×¢×•×ª ×”×¢×¨×‘ ×•×œ××¤×¨×˜×™×‘×•.", coords: { lat: 45.4516, lon: 9.1758 }, cost: 0 },
  ilCentro: { name: "×§× ×™×•×Ÿ Il Centro", isOutdoor: false, type: 'attraction', address: "Via Giuseppe Eugenio Luraghi, 11, 20044 Arese MI, Italy", img: ["https://architizer-prod.imgix.net/media/1461230538313IL_CENTRO_WEB_RESOLUTION_231.JPG"], info: "https://centroilcentro.it/en/", description: "××—×“ ×”×§× ×™×•× ×™× ×”×’×“×•×œ×™× ×‘××™×¨×•×¤×”, × ××¦× ××—×•×¥ ×œ××™×œ×× ×•.", coords: { lat: 45.5654, lon: 9.0681 }, cost: 5, hours: "×›×œ ×™×•×, 09:00-22:00" },
  sforza: { name: "×˜×™×¨×ª ×¡×¤×•×¨×¦×”", isOutdoor: false, type: 'attraction', address: "Piazza Castello, 20121 Milano MI, Italy", description: "××¦×•×“×” ×”×™×¡×˜×•×¨×™×ª ××¨×©×™××” ×¢× ××¡×¤×¨ ××•×–×™××•× ×™× ×•×’×œ×¨×™×•×ª ××× ×•×ª.", info: "https://www.milanocastello.it/en", coords: { lat: 45.4705, lon: 9.1794 }, cost: 5, hours: "×—×¦×¨×•×ª: 07:00-19:30. ××•×–×™××•× ×™×: ×’'-×', 10:00-17:30 (×¡×’×•×¨ ×‘×‘')" },
  brera: { name: "×¨×•×‘×¢ ×‘×¨×¨×”", isOutdoor: true, type: 'attraction', address: "Via Brera, Milan", description: "×¨×•×‘×¢ ×”××× ×™× ×”×¦×™×•×¨×™, '×”××•× ××¨×˜×¨ ×©×œ ××™×œ×× ×•', ××œ× ×‘×¡××˜××•×ª, ×’×œ×¨×™×•×ª ×•×‘×•×˜×™×§×™×.", coords: { lat: 45.4719, lon: 9.1879 }, cost: 0 },
  lastSupper: { name: "×”×¡×¢×•×“×” ×”××—×¨×•× ×”", isOutdoor: false, type: 'attraction', address: "Piazza di Santa Maria delle Grazie, 2, 20123 Milano MI", description: "×¦×™×•×¨ ×”×§×™×¨ ×”××¤×•×¨×¡× ×©×œ ×“×” ×•×™× ×¦'×™. ×—×•×‘×” ×œ×”×–××™×Ÿ ×›×¨×˜×™×¡×™× ×—×•×“×©×™× ××¨××©!", tickets: "https://cenacolovinciano.org/en/", coords: { lat: 45.4659, lon: 9.1711 }, cost: 15, hours: "×’'-×', 08:15-19:00 (×¡×’×•×¨ ×‘×‘')" },
  galleriaVittorio: { name: "×’×œ×¨×™×™×ª ×•×™×˜×•×¨×™×• ××× ×•××œ×”", isOutdoor: false, type: 'attraction', address: "Piazza del Duomo, 20123 Milano MI", description: "××¨×›×– ×§× ×™×•×ª ×”×™×¡×˜×•×¨×™ ×•××¤×•××¨, ×¢× ×—× ×•×™×•×ª ×™×•×§×¨×”, ×‘×ª×™ ×§×¤×” ×•××¡×¢×“×•×ª.", coords: { lat: 45.4656, lon: 9.1905 }, cost: 0, hours: "×¤×ª×•×— 24/7 (×—× ×•×™×•×ª ×‘×©×¢×•×ª ××©×ª× ×•×ª)" },
  pinacotecaBrera: { name: "×¤×™× ×§×•×˜×§×” ×“×™ ×‘×¨×¨×”", isOutdoor: false, type: 'attraction', address: "Via Brera, 28, 20121 Milano MI", description: "××—×“ ××’×œ×¨×™×•×ª ×”××× ×•×ª ×”×—×©×•×‘×•×ª ×‘××™×˜×œ×™×”, ××ª××§×“ ×‘×¦×™×•×¨ ××™×˜×œ×§×™.", tickets: "https://pinacotecabrera.org/en/visit/", coords: { lat: 45.4719, lon: 9.1879 }, cost: 15, hours: "×’'-×', 08:30-19:15 (×¡×’×•×¨ ×‘×‘')" },
  parcoSempione: { name: "×¤××¨×§ ×¡××¤×™×•× ×”", isOutdoor: true, type: 'attraction', address: "Piazza Sempione, 20154 Milano MI", description: "×”×¨×™××” ×”×™×¨×•×§×” ×”×’×“×•×œ×” ×©×œ ××™×œ×× ×•, ×××—×•×¨×™ ×˜×™×¨×ª ×¡×¤×•×¨×¦×”. ××•×©×œ× ×œ×”×™×¨×’×¢×•×ª.", coords: { lat: 45.4723, lon: 9.1725 }, cost: 0, hours: "×›×œ ×™×•×, 06:30-21:00" },
  quadrilateroDellaModa: { name: "××¨×•×‘×¢ ×”××•×¤× ×”", isOutdoor: true, type: 'attraction', address: "Via Monte Napoleone, 20121 Milano MI, Italy", description: "×¨×•×‘×¢ ×”×§× ×™×•×ª ×”×™×•×§×¨×ª×™ ×©×œ ××™×œ×× ×•, ×‘×™×ª ×œ××•×ª×’×™ ×”××•×¤× ×” ×”×’×“×•×œ×™× ×‘×¢×•×œ×.", coords: { lat: 45.4688, lon: 9.1950 }, cost: 0 },
  daVinciMuseum: { name: "××•×–×™××•×Ÿ ×”××“×¢ ×“×” ×•×™× ×¦'×™", isOutdoor: false, type: 'attraction', address: "Via San Vittore, 21, 20123 Milano MI, Italy", description: "××•×–×™××•×Ÿ ×”××“×¢ ×•×”×˜×›× ×•×œ×•×’×™×” ×”×’×“×•×œ ×‘××™×˜×œ×™×”, ××•×§×“×© ×œ×“×” ×•×™× ×¦'×™ ×›×××¦×™×.", tickets: "https://www.museoscienza.org/en/visit/tickets", coords: { lat: 45.4627, lon: 9.1715 }, cost: 10, hours: "×’'-×•' 09:30-17:00, ×©'-×' 09:30-18:30 (×¡×’×•×¨ ×‘×‘')" },
  boscoVerticale: { name: "×‘×•×¡×§×• ×•×¨×˜×™×§×œ×”", isOutdoor: true, type: 'attraction', address: "Via Gaetano de Castillia, 11, 20124 Milano MI", description: "×¦××“ ××’×“×œ×™ ××’×•×¨×™× ×—×“×©× ×™×™× ×”××›×•×¡×™× ×‘××œ×¤×™ ×¢×¦×™× ×•×¦××—×™×. ×¤×œ× ××¨×›×™×˜×§×˜×•× ×™.", coords: { lat: 45.4855, lon: 9.1901 }, cost: 0 },
  cimiteroMonumentale: { name: "×‘×™×ª ×”×§×‘×¨×•×ª ×”××•× ×•×× ×˜×œ×™", isOutdoor: true, type: 'attraction', address: "Piazzale Cimitero Monumentale, 20154 Milano MI", description: "×‘×™×ª ×§×‘×¨×•×ª ×©×”×•× ×’× ××•×–×™××•×Ÿ ×¤×ª×•×—, ×¢× ×¤×¡×œ×™× ×•××‘× ×™× ××¨×›×™×˜×§×˜×•× ×™×™× ××¨×©×™××™×.", coords: { lat: 45.485, lon: 9.178 }, cost: 0, hours: "×’'-×' 08:00-18:00 (×¡×’×•×¨ ×‘×‘')" },
  museoNovecento: { name: "××•×–×™××•×Ÿ × ×•×‘×¦'× ×˜×•", isOutdoor: false, type: 'attraction', address: "Piazza del Duomo, 8, 20123 Milano MI", description: "××•×–×™××•×Ÿ ×œ××× ×•×ª ×”×××” ×”-20 ×”×××•×§× ×‘×›×™×›×¨ ×”×“×•××•××•, ×¢× ×ª×¦×¤×™×ª ×™×¤×” ×¢×œ ×”×§×ª×“×¨×œ×”.", tickets: "https://www.museodelnovecento.org/en/ biglietti-e-ingressi", coords: { lat: 45.463, lon: 9.190 }, cost: 10, hours: "×’'-×' 10:00-19:30 (×¡×’×•×¨ ×‘×‘')" },
  santAmbrogio: { name: "×‘×–×™×œ×™×§×ª ×¡× ×˜'×××‘×¨×•×’'×•", isOutdoor: false, type: 'attraction', address: "Piazza Sant'Ambrogio, 15, 20123 Milano MI", description: "××—×ª ×”×›× ×¡×™×•×ª ×”×¢×ª×™×§×•×ª ×•×”×—×©×•×‘×•×ª ×‘××™×œ×× ×•, ×“×•×’××” ××¨×”×™×‘×” ×œ××“×¨×™×›×œ×•×ª ×¨×•×× ×¡×§×™×ª.", coords: { lat: 45.462, lon: 9.173 }, cost: 0 },
  sanMaurizio: { name: "×›× ×¡×™×™×ª ×¡×Ÿ ×××•×¨×™×¦×™×•", isOutdoor: false, type: 'attraction', address: "Corso Magenta, 15, 20123 Milano MI", description: "××›×•× ×” '×”×§×¤×œ×” ×”×¡×™×¡×˜×™× ×™×ª ×©×œ ××™×œ×× ×•' ×‘×–×›×•×ª ×¦×™×•×¨×™ ×”×§×™×¨ ×”××“×”×™××™× ×©××›×¡×™× ××•×ª×” ×œ×—×œ×•×˜×™×Ÿ.", tickets: "https://www.museoarcheologicomilano.it/en/collezioni/san-maurizio-al-monastero-maggiore", coords: { lat: 45.465, lon: 9.176 }, cost: 0, hours: "×’'-×' 10:00-17:30 (×¡×’×•×¨ ×‘×‘')" },
  piazzaMercanti: { name: "×¤×™××¦×” ×“×™×™ ××¨×§× ×˜×™", isOutdoor: true, type: 'attraction', address: "Piazza dei Mercanti, 20123 Milano MI", description: "×›×™×›×¨ ×™××™-×‘×™× ×™×™××™×ª ×§×¡×•××” ×•× ×¡×ª×¨×ª, ×“×§×•×ª ×”×œ×™×›×” ××”×“×•××•××•.", coords: { lat: 45.465, lon: 9.188 }, cost: 0 },
  leonardoVineyard: { name: "×”×›×¨× ×©×œ ×œ××•× ×¨×“×•", isOutdoor: true, type: 'attraction', address: "Corso Magenta, 65, 20123 Milano MI", description: "×©×—×–×•×¨ ×©×œ ×”×›×¨× ×©×”×™×” ×©×™×™×š ×œ×œ××•× ×¨×“×• ×“×” ×•×™× ×¦'×™, ××•×œ '×”×¡×¢×•×“×” ×”××—×¨×•× ×”'.", tickets: "https://www.vignadileonardo.com/en/", coords: { lat: 45.466, lon: 9.170 }, cost: 10, hours: "×’'-×' 09:00-18:00 (×¡×’×•×¨ ×‘×‘')" },
  piazzaGaeAulenti: { name: "×¤×™××¦×” ×’××” ×××•×œ× ×˜×™", isOutdoor: true, type: 'attraction', address: "Piazza Gae Aulenti, 20124 Milano MI", description: "×”×œ×‘ ×”×¤×•×¢× ×©×œ ××™×œ×× ×• ×”××•×“×¨× ×™×ª. ×›×™×›×¨ ×¢×ª×™×“× ×™×ª ××•×§×¤×ª ×’×•×¨×“×™ ×©×—×§×™×.", coords: { lat: 45.483, lon: 9.191 }, cost: 0 },
  corsoComo: { name: "10 ×§×•×¨×¡×• ×§×•××•", isOutdoor: false, type: 'attraction', address: "Corso Como, 10, 20154 Milano MI", description: "××ª×—× ×§×•× ×¡×¤×˜ ×”××©×œ×‘ ××•×¤× ×”, ×¢×™×¦×•×‘ ×•××× ×•×ª. ×—×•×•×™×ª ×§× ×™×•×ª ×•×‘×™×œ×•×™ ×™×™×—×•×“×™×ª.", coords: { lat: 45.482, lon: 9.189 }, cost: 0 },
  triennale: { name: "××•×–×™××•×Ÿ ×”×¢×™×¦×•×‘ ×˜×¨×™×× ×œ×”", isOutdoor: false, type: 'attraction', address: "Viale Emilio Alemagna, 6, 20121 Milano MI", description: "××•×–×™××•×Ÿ ×‘×™× ×œ××•××™ ×”××•×§×“×© ×œ×¢×™×¦×•×‘, ××“×¨×™×›×œ×•×ª ×•××× ×•×ª ×—×–×•×ª×™×ª ×‘×¤××¨×§ ×¡××¤×™×•× ×”.", tickets: "https://triennale.org/en/tickets", coords: { lat: 45.470, lon: 9.168 }, cost: 15, hours: "×’'-×' 11:00-20:00 (×¡×’×•×¨ ×‘×‘')" },
  colonneSanLorenzo: { name: "×¢××•×“×™ ×¡×Ÿ ×œ×•×¨× ×¦×•", isOutdoor: true, type: 'attraction', address: "Corso di Porta Ticinese, 39, 20123 Milano MI", description: "×©×¨×™×“×™× ×¨×•××™×™× ×¢×ª×™×§×™× ×©×”×¤×›×• ×œ××§×•× ××¤×’×© ×¤×•×¤×•×œ×¨×™ ×•×ª×•×¡×¡ ×‘×¢×¨×‘.", coords: { lat: 45.458, lon: 9.181 }, cost: 0 },
  qcTermemilano: { name: "QC Termemilano", isOutdoor: false, type: 'attraction', address: "Piazzale Medaglie D'Oro, 2, 20135 Milano MI", tickets: "https://www.qcterme.com/en/milano/qc-termemilano", description: "×¡×¤× ×•××¨×—×¦××•×ª ×™×•×§×¨×ª×™×™× ×‘×œ×‘ ×”×¢×™×¨, ×—×•×•×™×” ××•×©×œ××ª ×©×œ ×¤×™× ×•×§ ×•×¨×’×™×¢×”.", coords: { lat: 45.4523, lon: 9.2004 }, cost: 60, hours: "×›×œ ×™×•×, 09:00-23:00" },
  interStore: { name: "×—× ×•×ª ×”×“×’×œ ×©×œ ××™× ×˜×¨", isOutdoor: false, type: 'attraction', address: "Galleria Passarella, 2, 20122 Milano MI", info: "https://store.inter.it/", description: "×—× ×•×ª ×”×“×’×œ ×”×¨×©××™×ª ×©×œ ×§×‘×•×¦×ª ×”×›×“×•×¨×’×œ ××™× ×˜×¨ ××™×œ×× ×•, ×‘×œ×‘ ××–×•×¨ ×”×§× ×™×•×ª.", coords: { lat: 45.465, lon: 9.194 }, cost: 0, hours: "×›×œ ×™×•× 10:00-19:30" },
  casaMilan: { name: "×§××–×” ××™×œ××Ÿ (××•×–×™××•×Ÿ ×•×—× ×•×ª)", isOutdoor: false, type: 'attraction', address: "Via Aldo Rossi, 8, 20149 Milano MI", tickets: "https://www.acmilan.com/en/club/casa-milan", description: "×”××˜×” ×”×¨××©×™ ×©×œ ×§×‘×•×¦×ª ××™×œ××Ÿ, ×›×•×œ×œ ××•×–×™××•×Ÿ ××•× ×“×• ××™×œ××Ÿ, ×—× ×•×ª ×¨×©××™×ª ×•××¡×¢×“×”.", coords: { lat: 45.489, lon: 9.155 }, cost: 15, hours: "×›×œ ×™×•× 10:00-19:00" },
  torreBranca: { name: "××’×“×œ ×‘×¨×× ×§×”", isOutdoor: true, type: 'attraction', address: "Viale Luigi Camoens, 2, 20121 Milano MI", info: "http://www.museobranca.it/torre-branca-parco-sempione-milano/", description: "××’×“×œ ×ª×¦×¤×™×ª ×‘×¤××¨×§ ×¡××¤×™×•× ×” ×”××¦×™×¢ × ×•×£ ×¤× ×•×¨××™ ××¨×”×™×‘ ×©×œ ××™×œ×× ×•.", coords: { lat: 45.472, lon: 9.171 }, cost: 6, hours: "××©×ª× ×” ×œ×¤×™ ×¢×•× ×”, ×‘×“×§×• ×‘××ª×¨" },
  pinacotecaAmbrosiana: { name: "×¤×™× ×§×•×˜×§×” ×××‘×¨×•×–×™×× ×”", isOutdoor: false, type: 'attraction', address: "Piazza Pio XI, 2, 20123 Milano MI", tickets: "https://www.ambrosiana.it/", description: "×’×œ×¨×™×™×ª ××× ×•×ª ×•×¡×¤×¨×™×™×” ×”×™×¡×˜×•×¨×™×ª ×”××›×™×œ×” ×™×¦×™×¨×•×ª ××•×¤×ª ×©×œ ×§××¨××•×•×’'×• ×•×“×” ×•×™× ×¦'×™.", coords: { lat: 45.464, lon: 9.186 }, cost: 15, hours: "×’'-×' 10:00-18:00 (×¡×’×•×¨ ×‘×‘')" }
};
    
    const kosherData = {
      restaurants: [
        { name: "Denzel", type: 'dining', style: "×‘×©×¨×™", logo: "https://static.wixstatic.com/media/c6595a_0d9d7bb6473548d69681f09d18ff4247.png", address: "Via Giorgio Washington, 9, 20146 Milano MI", phone: "+390248519326", website: "https://www.denzel.it/", hours: "×'-×”' 12:00-15:00, 19:00-23:00; ×•' 12:00-15:00", coords: { lat: 45.4654, lon: 9.1555 } },
        { name: "Ba'Ghetto", type: 'dining', style: "×‘×©×¨×™", address: "Via Sardegna, 45, 20146 Milano MI", phone: "+39024694643", website: "https://www.baghetto.com/en/", hours: "×'-×”' 12:00-15:00, 19:00-23:00; ×•' 12:00-15:00", coords: { lat: 45.4665, lon: 9.1461 } },
        { name: "Re Salomone", type: 'dining', style: "×‘×©×¨×™", address: "Via Sardegna, 42, 20146 Milano MI", phone: "+39024694643", website: "https://www.resalomone.it/", hours: "×'-×”' 12:00-14:30, 19:00-23:00; ×•' 12:00-14:30", coords: { lat: 45.4665, lon: 9.1458 } },
        { name: "La's Kebab", type: 'dining', style: "×‘×©×¨×™", address: "Viale Misurata, 19, 20146 Milano MI", phone: "+393288865576", website: "https://laskebab.eatbu.com/", hours: "×'-×”' 12:00-15:00, 18:00-23:00", coords: { lat: 45.4586, lon: 9.1517 } },
        { name: "Carmel", type: 'dining', style: "×—×œ×‘×™", address: "Viale S. Gimignano, 10, 20146 Milano MI", phone: "+3902416368", website: "https://carmelkosher.it/", hours: "×'-×”' 12:00-15:00, 19:00-22:30", coords: { lat: 45.4593, lon: 9.1328 } },
        { name: "MyKafe", type: 'dining', style: "×—×œ×‘×™", logo: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/11/a2/1f/a2/my-kafe.jpg", address: "Via Luigi Soderini, 44, 20146 Milano MI", phone: "+390238232748", website: "https://www.instagram.com/mykafe2020/", hours: "×'-×”' 07:30-19:30; ×•' 07:30-16:00", coords: { lat: 45.4578, lon: 9.1337 } },
        { name: "Bet-El", type: 'dining', style: "×—×œ×‘×™", address: "Viale S. Gimignano, 2, 20146 Milano MI", phone: "+39024151336", website: "http://www.betelkosher.com/", hours: "×'-×”' 12:00-14:30, 19:00-22:30", coords: { lat: 45.4607, lon: 9.1352 } },
        { name: "Snubar", type: 'dining', style: "×¤×œ××¤×œ/×©×•×•××¨××”", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQmYC-lcBrFV75_D371aWkrfk7yd1Qu3kEIcw&s", address: "Via Leone Tolstoi, 2, 20146 Milano MI", phone: "+39024236963", website: "https://www.snubar.it/it/", hours: "×'-×”' 12:00-22:00", coords: { lat: 45.4568, lon: 9.1565 } },
        { name: "Presto", type: 'dining', style: "×˜×™×™×§-××•×•×™", address: "Via delle Forze Armate, 13, 20147 Milano MI", phone: "+39024045598", website: "https://www.presto-kosher.com/", hours: "×'-×”' 10:00-20:00; ×•' 09:00-15:00", coords: { lat: 45.4667, lon: 9.1292 } },
      ],
      markets: [
        { name: "Kosher Paradise", type: 'dining', style: "××¨×›×•×œ", address: "Viale S. Gimignano, 13, 20146 Milano MI", phone: "+39024122855", website: "https://www.kosherparadise.it/", hours: "×'-×”' 09:00-19:30; ×•' 09:00-15:00", coords: { lat: 45.4589, lon: 9.1325 } },
        { name: "Denzel's Sweet Bakery", type: 'dining', style: "×××¤×™×™×”", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVt6hxH7niOmeBunCjNdpow7Y_PfseIBonPQ&s", address: "Via Soderini, 55, 20146 Milano MI", phone: "+39024125166", website: "https://www.denzel.it/bakery", hours: "×'-×”' 07:30-19:30; ×•' 07:30-15:00", coords: { lat: 45.4570, lon: 9.1329 } },
        { name: "Kosher King", type: 'dining', style: "××¨×›×•×œ", address: "Piazza Napoli, 15, 20146 Milano MI", phone: "+390242296773", website: "https://www.facebook.com/kosherkingmilan/", hours: "×'-×”' 08:30-19:30; ×•' 08:30-16:00", coords: { lat: 45.4563, lon: 9.1492 } },
      ]
    };
    
    const dailyTips = [
      "×–×›×¨×• ×œ×ª×§×£ ××ª ×›×¨×˜×™×¡ ×”×ª×—×‘×•×¨×” ×”×¦×™×‘×•×¨×™×ª ×©×œ×›× ×‘××›×•× ×•×ª ×”×¦×”×•×‘×•×ª ×œ×¤× ×™ ×›×œ × ×¡×™×¢×” ×‘××˜×¨×•, ××•×˜×•×‘×•×¡ ××• ×˜×¨×× ×›×“×™ ×œ×× ×•×¢ ×§× ×¡×•×ª.",
      "××¤×¨×˜×™×‘×• (Aperitivo) ×”×•× ×× ×”×’ ××™×˜×œ×§×™ ×¤×•×¤×•×œ×¨×™. ×‘×™×Ÿ 18:00 ×œ-21:00, ×©×œ××• ×¢×œ ××©×§×” ×•×§×‘×œ×• ×’×™×©×” ×—×•×¤×©×™×ª ×œ××–× ×•×Ÿ ××›×•×œ ×›×¤×™ ×™×›×•×œ×ª×š. ×¨×•×‘×¢ × ×‘×™×œ×™ ×”×•× ××§×•× ××¢×•×œ×” ×œ×—×•×•×ª ×–××ª.",
      "'Coperto' ×”×•× ×—×™×•×‘ ×©×™×¨×•×ª ×§×‘×•×¢ ×©×¨×•×‘ ×”××¡×¢×“×•×ª ××•×¡×™×¤×•×ª ×œ×—×©×‘×•×Ÿ. ×–×” ×œ× ×˜×™×¤, ××œ× ×ª×©×œ×•× ×¢×œ ×”×©×™×¨×•×ª ×•×”×œ×—×. ×˜×™×¤ × ×•×¡×£ ××™× ×• ×—×•×‘×” ××š ××•×¢×¨×š.",
      "×”×¨×‘×” ××•×–×™××•× ×™× ×•×›× ×¡×™×•×ª ×“×•×¨×©×™× ×œ×‘×•×© ×¦× ×•×¢ (×›×ª×¤×™×™× ×•×‘×¨×›×™×™× ××›×•×¡×•×ª). ×›×“××™ ×œ×”×—×–×™×§ ×¦×¢×™×£ ×§×œ ×‘×ª×™×§ ×œ××§×¨×” ×”×¦×•×¨×š.",
      "××™× ××”×‘×¨×– ×‘××™×œ×× ×• ×‘×˜×•×—×™× ×•×˜×•×‘×™× ×œ×©×ª×™×™×”. ×—×¤×©×• ×‘×¨×–×™×•×ª ×¦×™×‘×•×¨×™×•×ª (fontanelle) ×›×“×™ ×œ××œ× ××ª ×‘×§×‘×•×§ ×”××™× ×©×œ×›× ×•×œ×—×¡×•×š ×›×¡×£.",
      "×× ××ª× ××ª×›× × ×™× ×œ×¨××•×ª ××ª '×”×¡×¢×•×“×” ×”××—×¨×•× ×”' ×©×œ ×“×” ×•×™× ×¦'×™, ×—×•×‘×” ×œ×”×–××™×Ÿ ×›×¨×˜×™×¡×™× ×‘××™× ×˜×¨× ×˜ ××¡×¤×¨ ×—×•×“×©×™× ××¨××©. ×”×›× ×™×¡×” ××•×’×‘×œ×ª ×××•×“."
    ];

    const tripMeta = {
        flights: {
            inbound: { date: '2025-11-23', flight: 'LY381', departureTime: '07:30', arrivalTime: '11:15', terminal: '3', baggage: '×˜×¨×•×œ×™ ×¢×“ 8 ×§"×’' },
            outbound: { date: '2025-11-26', flight: 'LY382', departureTime: '18:00', arrivalTime: '22:15', terminal: '1 (MXP)', baggage: '××–×•×•×“×” 23 ×§"×’ + ×˜×¨×•×œ×™ 8 ×§"×’' }
        },
        hotel: {
            name: 'Hotel Glam Milano', phone: '+39 02 839 840', tel: 'tel:+3902839840', address: 'Piazza Duca d\'Aosta, 4/6, 20124 Milano MI'
        },
        contacts: {
            emergency: { name: '×—×™×¨×•× (×›×œ×œ×™)', phone: '112', tel: 'tel:112' },
            embassy: { name: '×©×’×¨×™×¨×•×ª ×™×©×¨××œ', phone: '+39 06 3619 8500', tel: 'tel:+390636198500' }
        }
    };
const hebrewPrayers = {
        // --- ×ª×¤×™×œ×ª ×”×“×¨×š --- (××“×•× ×™×™) - ×œ×œ× ×©×™× ×•×™
       tefilatHaderech: "×™Ö°×”Ö´×™ ×¨Ö¸×¦×•Ö¹×Ÿ ×Ö´×œÖ¼Ö°×¤Ö¸× Ö¶×™×šÖ¸ ××“×•× ×™×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×•Öµ××œÖ¹×”Öµ×™ ×Ö²×‘×•Ö¹×ªÖµ×™× ×•Ö¼, ×©×Ö¶×ªÖ¼×•Ö¹×œÖ´×™×›Öµ× ×•Ö¼ ×œÖ°×©×Ö¸×œ×•Ö¹×, ×•Ö°×ªÖ·×¦Ö°×¢Ö´×™×“Öµ× ×•Ö¼ ×œÖ°×©×Ö¸×œ×•Ö¹×, ×•Ö°×ªÖ´×¡Ö°×Ö°×›Öµ× ×•Ö¼ ×œÖ°×©×Ö¸×œ×•Ö¹×, ×•Ö°×ªÖ·×’Ö¼Ö´×™×¢Öµ× ×•Ö¼ ×œÖ´×Ö°×—×•Ö¹×– ×—Ö¶×¤Ö°×¦Öµ× ×•Ö¼ ×œÖ°×—Ö·×™Ö¼Ö´×™× ×•Ö¼×œÖ°×©×‚Ö´×Ö°×—Ö¸×” ×•Ö¼×œÖ°×©×Ö¸×œ×•Ö¹×, ×•Ö°×ªÖ·×—Ö°×–Ö´×™×¨Öµ× ×•Ö¼ ×œÖ°×©×Ö¸×œ×•Ö¹×. ×•Ö°×ªÖ·×¦Ö¼Ö´×™×œÖµ× ×•Ö¼ ×Ö´×›Ö¼Ö·×£ ×›Ö¼Ö¹×œ ××•Ö¹×™Öµ×‘ ×•Ö°××•Ö¹×¨Öµ×‘ ×‘Ö¼Ö·×“Ö¼Ö¶×¨Ö¶×šÖ°, ×•Ö¼×Ö´×›Ö¼Ö¹×œ ×Ö´×™× Öµ×™ ×¤Ö¼Ö»×¨Ö°×¢Ö¸× Ö»×™Ö¼×•Ö¹×ª ×”Ö·×Ö¼Ö´×ªÖ°×¨Ö·×’Ö¼Ö°×©××•Ö¹×ª ×œÖ¸×‘Ö¹× ×œÖ¸×¢×•Ö¹×œÖ¸×, ×•Ö°×ªÖ´×©×Ö°×œÖ·×— ×‘Ö¼Ö°×¨Ö¸×›Ö¸×” ×‘Ö¼Ö°×Ö·×¢Ö²×©×‚Öµ×” ×™Ö¸×“Öµ×™× ×•Ö¼, ×•Ö°×ªÖ´×ªÖ¼Öµ×Ÿ ×—Öµ×Ÿ ×•Ö¸×—Ö¶×¡Ö¶×“ ×•Ö°×¨Ö·×—Ö²×Ö´×™× ×‘Ö¼Ö°×¢Öµ×™× Ö¶×™×šÖ¸ ×•Ö¼×‘Ö°×¢Öµ×™× Öµ×™ ×›Ö¹×œ ×¨×•Ö¹×Öµ×™× ×•Ö¼, ×•Ö°×ªÖ´×©×Ö°×Ö·×¢ ×§×•Ö¹×œ ×ªÖ¼Ö·×—Ö²× ×•Ö¼× Öµ×™× ×•Ö¼, ×›Ö¼Ö´×™ ×Öµ×œ ×©××•Ö¹×Öµ×¢Ö· ×ªÖ¼Ö°×¤Ö´×œÖ¼Ö¸×” ×•Ö°×ªÖ·×—Ö²× ×•Ö¼×Ÿ ×Ö¸×ªÖ¼Ö¸×”. ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ××“×•× ×™×™, ×©××•Ö¹×Öµ×¢Ö· ×ªÖ¼Ö°×¤Ö´×œÖ¼Ö¸×”.",
        
        // --- ×‘×¨×›×•×ª ××—×¨×•× ×•×ª ---
        // 1. ×‘×•×¨× × ×¤×©×•×ª (××“×•× ×™×™) - ×œ×œ× ×©×™× ×•×™
        boreiNefashot: "×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ××“×•× ×™×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×Ö¶×œÖ¶×šÖ° ×”Ö¸×¢×•Ö¹×œÖ¸×, ×‘Ö¼×•Ö¹×¨Öµ× × Ö°×¤Ö¸×©××•Ö¹×ª ×¨Ö·×‘Ö¼×•Ö¹×ª ×•Ö°×—Ö¶×¡Ö°×¨×•Ö¹× Ö¸×Ÿ, ×¢Ö·×œ ×›Ö¼Ö¹×œ ×Ö·×” ×©×Ö¶×‘Ö¼Ö¸×¨Ö¸××ªÖ¸ ×œÖ°×”Ö·×—Ö²×™×•Ö¹×ª ×‘Ö¼Ö¸×”Ö¶× × Ö¶×¤Ö¶×©× ×›Ö¼Ö¹×œ ×—Ö¸×™. ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×—Ö·×™ ×”Ö¸×¢×•Ö¹×œÖ¸×Ö´×™×.",
        
        // 2. ××¢×™×Ÿ ×©×œ×•×© - ×¢×œ ×”××—×™×” (× ×•×¡×— ×¢×“×•×ª ×”××–×¨×—, ××¤×•×¦×œ)
        alHaMichya: "×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×Ö¶×œÖ¶×šÖ° ×”Ö¸×¢×•Ö¹×œÖ¸×, ×¢Ö·×œ ×”Ö·×Ö´×—Ö°×™Ö¸×” ×•Ö°×¢Ö·×œ ×”Ö·×›Ö¼Ö·×œÖ°×›Ö¼Ö¸×œÖ¸×”, ×•Ö°×¢Ö·×œ ×ªÖ¼Ö°× ×•Ö¼×‘Ö·×ª ×”Ö·×©Ö¼×‚Ö¸×“Ö¶×” ×•Ö°×¢Ö·×œ ×Ö¶×¨Ö¶×¥ ×—Ö¶×Ö°×“Ö¼Ö¸×” ×˜×•Ö¹×‘Ö¸×” ×•Ö¼×¨Ö°×—Ö¸×‘Ö¸×” ×©×Ö¶×¨Ö¸×¦Ö´×™×ªÖ¸ ×•Ö°×”Ö´× Ö°×—Ö·×œÖ°×ªÖ¼Ö¸ ×œÖ·×Ö²×‘×•Ö¹×ªÖµ×™× ×•Ö¼ ×œÖ¶×Ö±×›Ö¹×œ ×Ö´×¤Ö¼Ö´×¨Ö°×™Ö¸×”Ö¼ ×•Ö°×œÖ´×©×‚Ö°×‘Ö¼Ö¹×¢Ö· ×Ö´×˜Ö¼×•Ö¼×‘Ö¸×”Ö¼. ×¨Ö·×—Öµ× ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×¢Ö¸×œÖµ×™× ×•Ö¼ ×•Ö°×¢Ö·×œ ×™Ö´×©×‚Ö°×¨Ö¸×Öµ×œ ×¢Ö·×Ö¼Ö¸×šÖ° ×•Ö°×¢Ö·×œ ×™Ö°×¨×•Ö¼×©×Ö¸×œÖ·×™Ö´× ×¢Ö´×™×¨Ö¸×šÖ° ×•Ö°×¢Ö·×œ ×”Ö·×¨ ×¦Ö´×™Ö¼×•Ö¹×Ÿ ×Ö´×©×Ö°×›Ö¼Ö·×Ÿ ×›Ö¼Ö°×‘×•Ö¹×“Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×Ö´×–Ö°×‘Ö¼Ö¸×—Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×”Öµ×™×›Ö¸×œÖ¸×šÖ°. ×•Ö¼×‘Ö°× Öµ×” ×™Ö°×¨×•Ö¼×©×Ö¸×œÖ·×™Ö´× ×¢Ö´×™×¨ ×”Ö·×§Ö¼Ö¹×“Ö¶×©× ×‘Ö¼Ö´×Ö°×”Öµ×¨Ö¸×” ×‘Ö°×™Ö¸×Öµ×™× ×•Ö¼. ×•Ö°×”Ö·×¢Ö²×œÖµ× ×•Ö¼ ×œÖ°×ª×•Ö¹×›Ö¸×”Ö¼. ×•Ö°×©×‚Ö·×Ö¼Ö°×—Öµ× ×•Ö¼ ×‘Ö¼Ö°×‘Ö´× Ö°×™Ö¸× Ö¸×”Ö¼ ×•Ö¼× Ö°×‘Ö¸×¨Ö°×›Ö¸×šÖ° ×¢Ö¸×œÖ¶×™×”Ö¸ ×‘Ö¼Ö´×§Ö°×“Ö»×©Ö¼×Ö¸×” ×•Ö¼×‘Ö°×˜Ö¸×”Ö³×¨Ö¸×”. ×›Ö¼Ö´×™ ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™ ×˜×•Ö¹×‘ ×•Ö¼×Öµ×˜Ö´×™×‘ ×œÖ·×›Ö¼Ö¹×œ ×•Ö°× ×•Ö¹×“Ö¶×” ×œÖ°×šÖ¸ ×¢Ö·×œ ×”Ö¸×Ö¸×¨Ö¶×¥ ×•Ö°×¢Ö·×œ ×”Ö·×Ö¼Ö´×—Ö°×™Ö¸×” ×•Ö°×¢Ö·×œ ×”Ö·×›Ö¼Ö·×œÖ°×›Ö¼Ö¸×œÖ¸×”. ×‘Ö¸Ö¼×¨×•Ö¼×šÖ° ×Ö·×ªÖ¸Ö¼×” ×Ö²×“Ö¹× Ö¸×™, ×¢Ö·×œ ×”Ö¸×Ö¸×¨Ö¶×¥ ×•Ö°×¢Ö·×œ ×”Ö·×Ö´Ö¼×—Ö°×™Ö¸×”.",
        // 3. ××¢×™×Ÿ ×©×œ×•×© - ×¢×œ ×”×’×¤×Ÿ (× ×•×¡×— ×¢×“×•×ª ×”××–×¨×—, ××¤×•×¦×œ)
        alHaGefen: "×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×Ö¶×œÖ¶×šÖ° ×”Ö¸×¢×•Ö¹×œÖ¸×, ×¢Ö·×œ ×”Ö·×’Ö¼Ö¶×¤Ö¶×Ÿ ×•Ö°×¢Ö·×œ ×¤Ö¼Ö°×¨Ö´×™ ×”Ö·×’Ö¼Ö¶×¤Ö¶×Ÿ, ×•Ö°×¢Ö·×œ ×ªÖ¼Ö°× ×•Ö¼×‘Ö·×ª ×”Ö·×©Ö¼×‚Ö¸×“Ö¶×” ×•Ö°×¢Ö·×œ ×Ö¶×¨Ö¶×¥ ×—Ö¶×Ö°×“Ö¼Ö¸×” ×˜×•Ö¹×‘Ö¸×” ×•Ö¼×¨Ö°×—Ö¸×‘Ö¸×” ×©×Ö¶×¨Ö¸×¦Ö´×™×ªÖ¸ ×•Ö°×”Ö´× Ö°×—Ö·×œÖ°×ªÖ¼Ö¸ ×œÖ·×Ö²×‘×•Ö¹×ªÖµ×™× ×•Ö¼ ×œÖ¶×Ö±×›Ö¹×œ ×Ö´×¤Ö¼Ö´×¨Ö°×™Ö¸×”Ö¼ ×•Ö°×œÖ´×©×‚Ö°×‘Ö¼Ö¹×¢Ö· ×Ö´×˜Ö¼×•Ö¼×‘Ö¸×”Ö¼. ×¨Ö·×—Öµ× ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×¢Ö¸×œÖµ×™× ×•Ö¼ ×•Ö°×¢Ö·×œ ×™Ö´×©×‚Ö°×¨Ö¸×Öµ×œ ×¢Ö·×Ö¼Ö¸×šÖ° ×•Ö°×¢Ö·×œ ×™Ö°×¨×•Ö¼×©×Ö¸×œÖ·×™Ö´× ×¢Ö´×™×¨Ö¸×šÖ° ×•Ö°×¢Ö·×œ ×”Ö·×¨ ×¦Ö´×™Ö¼×•Ö¹×Ÿ ×Ö´×©×Ö°×›Ö¼Ö·×Ÿ ×›Ö¼Ö°×‘×•Ö¹×“Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×Ö´×–Ö°×‘Ö¼Ö¸×—Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×”Öµ×™×›Ö¸×œÖ¸×šÖ°. ×•Ö¼×‘Ö°× Öµ×” ×™Ö°×¨×•Ö¼×©×Ö¸×œÖ·×™Ö´× ×¢Ö´×™×¨ ×”Ö·×§Ö¼Ö¹×“Ö¶×©× ×‘Ö¼Ö´×Ö°×”Öµ×¨Ö¸×” ×‘Ö°×™Ö¸×Öµ×™× ×•Ö¼. ×•Ö°×”Ö·×¢Ö²×œÖµ× ×•Ö¼ ×œÖ°×ª×•Ö¹×›Ö¸×”Ö¼. ×•Ö°×©×‚Ö·×Ö¼Ö°×—Öµ× ×•Ö¼ ×‘Ö¼Ö°×‘Ö´× Ö°×™Ö¸× Ö¸×”Ö¼ ×•Ö¼× Ö°×‘Ö¸×¨Ö°×›Ö¸×šÖ° ×¢Ö¸×œÖ¶×™×”Ö¸ ×‘Ö¼Ö´×§Ö°×“Ö»×©Ö¼×Ö¸×” ×•Ö¼×‘Ö°×˜Ö¸×”Ö³×¨Ö¸×”. ×›Ö¼Ö´×™ ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™ ×˜×•Ö¹×‘ ×•Ö¼×Öµ×˜Ö´×™×‘ ×œÖ·×›Ö¼Ö¹×œ ×•Ö°× ×•Ö¹×“Ö¶×” ×œÖ°×šÖ¸ ×¢Ö·×œ ×”Ö¸×Ö¸×¨Ö¶×¥ ×•Ö°×¢Ö·×œ ×¤Ö¼Ö°×¨Ö´×™ ×”Ö·×’Ö¼Ö¶×¤Ö¶×Ÿ. ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™, ×¢Ö·×œ ×”Ö¸×Ö¸×¨Ö¶×¥ ×•Ö°×¢Ö·×œ ×¤Ö¼Ö°×¨Ö´×™ ×”Ö·×’Ö¼Ö¶×¤Ö¶×Ÿ.",
        // 4. ××¢×™×Ÿ ×©×œ×•×© - ×¢×œ ×”×¢×¥ (× ×•×¡×— ×¢×“×•×ª ×”××–×¨×—, ××¤×•×¦×œ)
        alHaEtz: "×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×Ö¶×œÖ¶×šÖ° ×”Ö¸×¢×•Ö¹×œÖ¸×, ×¢Ö·×œ ×”Ö¸×¢Öµ×¥ ×•Ö°×¢Ö·×œ ×¤Ö¼Ö°×¨Ö´×™ ×”Ö¸×¢Öµ×¥, ×•Ö°×¢Ö·×œ ×ªÖ¼Ö°× ×•Ö¼×‘Ö·×ª ×”Ö·×©Ö¼×‚Ö¸×“Ö¶×” ×•Ö°×¢Ö·×œ ×Ö¶×¨Ö¶×¥ ×—Ö¶×Ö°×“Ö¼Ö¸×” ×˜×•Ö¹×‘Ö¸×” ×•Ö¼×¨Ö°×—Ö¸×‘Ö¸×” ×©×Ö¶×¨Ö¸×¦Ö´×™×ªÖ¸ ×•Ö°×”Ö´× Ö°×—Ö·×œÖ°×ªÖ¼Ö¸ ×œÖ·×Ö²×‘×•Ö¹×ªÖµ×™× ×•Ö¼ ×œÖ¶×Ö±×›Ö¹×œ ×Ö´×¤Ö¼Ö´×¨Ö°×™Ö¸×”Ö¼ ×•Ö°×œÖ´×©×‚Ö°×‘Ö¼Ö¹×¢Ö· ×Ö´×˜Ö¼×•Ö¼×‘Ö¸×”Ö¼. ×¨Ö·×—Öµ× ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×¢Ö¸×œÖµ×™× ×•Ö¼ ×•Ö°×¢Ö·×œ ×™Ö´×©×‚Ö°×¨Ö¸×Öµ×œ ×¢Ö·×Ö¼Ö¸×šÖ° ×•Ö°×¢Ö·×œ ×™Ö°×¨×•Ö¼×©×Ö¸×œÖ·×™Ö´× ×¢Ö´×™×¨Ö¸×šÖ° ×•Ö°×¢Ö·×œ ×”Ö·×¨ ×¦Ö´×™Ö¼×•Ö¹×Ÿ ×Ö´×©×Ö°×›Ö¼Ö·×Ÿ ×›Ö¼Ö°×‘×•Ö¹×“Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×Ö´×–Ö°×‘Ö¼Ö¸×—Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×”Öµ×™×›Ö¸×œÖ¸×šÖ°. ×•Ö¼×‘Ö°× Öµ×” ×™Ö°×¨×•Ö¼×©×Ö¸×œÖ·×™Ö´× ×¢Ö´×™×¨ ×”Ö·×§Ö¼Ö¹×“Ö¶×©× ×‘Ö¼Ö´×Ö°×”Öµ×¨Ö¸×” ×‘Ö°×™Ö¸×Öµ×™× ×•Ö¼. ×•Ö°×”Ö·×¢Ö²×œÖµ× ×•Ö¼ ×œÖ°×ª×•Ö¹×›Ö¸×”Ö¼. ×•Ö°×©×‚Ö·×Ö¼Ö°×—Öµ× ×•Ö¼ ×‘Ö¼Ö°×‘Ö´× Ö°×™Ö¸× Ö¸×”Ö¼ ×•Ö¼× Ö°×‘Ö¸×¨Ö°×›Ö¸×šÖ° ×¢Ö¸×œÖ¶×™×”Ö¸ ×‘Ö¼Ö´×§Ö°×“Ö»×©Ö¼×Ö¸×” ×•Ö¼×‘Ö°×˜Ö¸×”Ö³×¨Ö¸×”. ×›Ö¼Ö´×™ ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™ ×˜×•Ö¹×‘ ×•Ö¼×Öµ×˜Ö´×™×‘ ×œÖ·×›Ö¼Ö¹×œ ×•Ö°× ×•Ö¹×“Ö¶×” ×œÖ°×šÖ¸ ×¢Ö·×œ ×”Ö¸×Ö¸×¨Ö¶×¥ ×•Ö°×¢Ö·×œ ×”Ö·×¤Ö¼Öµ×¨×•Ö¹×ª. ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™, ×¢Ö·×œ ×”Ö¸×Ö¸×¨Ö¶×¥ ×•Ö°×¢Ö·×œ ×”Ö·×¤Ö¼Öµ×¨×•Ö¹×ª.",

        // 5. ×‘×¨×›×ª ×”××–×•×Ÿ - × ×•×¡×— ×¢×“×•×ª ×”××–×¨×— (××œ× ×•××“×•×™×§)
        birkatHaMazon: `
        <h4 class="font-bold text-lg text-blue-700">×‘×¨×›×ª ×”××–×•×Ÿ (×¢×“×•×ª ×”××–×¨×— - × ×•×¡×— ××œ×)</h4>
        ×œÖ·×Ö°× Ö·×¦Ö¼Öµ×—Ö· ×‘Ö¼Ö´× Ö°×’Ö´×™× Ö¹×ª ×Ö´×–Ö°××•Ö¹×¨ ×©×Ö´×™×¨: ×Ö±×œÖ¹×”Ö´×™× ×™Ö°×—Ö¸× Ö¼Öµ× ×•Ö¼ ×•Ö´×™×‘Ö¸×¨Ö°×›Öµ× ×•Ö¼. ×™Ö¸×Öµ×¨ ×¤Ö¼Ö¸× Ö¸×™×• ×Ö´×ªÖ¼Ö¸× ×•Ö¼ ×¡Ö¶×œÖ¸×”: ×œÖ¸×“Ö·×¢Ö·×ª ×‘Ö¼Ö¸×Ö¸×¨Ö¶×¥ ×“Ö¼Ö·×¨Ö°×›Ö¼Ö¶×šÖ¸. ×‘Ö¼Ö°×›Ö¹×œ-×’Ö¼×•Ö¹×™Ö´× ×™Ö°×©××•Ö¼×¢Ö¸×ªÖ¶×šÖ¸: ×™×•Ö¹×“×•Ö¼×šÖ¸ ×¢Ö·×Ö¼Ö´×™× ×Ö±×œÖ¹×”Ö´×™×. ×™×•Ö¹×“×•Ö¼×šÖ¸ ×¢Ö·×Ö¼Ö´×™× ×›Ö¼Ö»×œÖ¼Ö¸×: ×™Ö´×©×‚Ö°×Ö°×—×•Ö¼ ×•Ö´×™×¨Ö·× Ö¼Ö°× ×•Ö¼ ×œÖ°×Ö»×Ö¼Ö´×™× ×›Ö¼Ö´×™-×ªÖ´×©×Ö°×¤Ö¼Ö¹×˜ ×¢Ö·×Ö¼Ö´×™× ×Ö´×™×©×Ö¹×¨. ×•Ö¼×œÖ°×Ö»×Ö¼Ö´×™× ×‘Ö¼Ö¸×Ö¸×¨Ö¶×¥ ×ªÖ¼Ö·× Ö°×—Öµ× ×¡Ö¶×œÖ¸×”: ×™×•Ö¹×“×•Ö¼×šÖ¸ ×¢Ö·×Ö¼Ö´×™× ×Ö±×œÖ¹×”Ö´×™×. ×™×•Ö¹×“×•Ö¼×šÖ¸ ×¢Ö·×Ö¼Ö´×™× ×›Ö¼Ö»×œÖ¼Ö¸×: ×Ö¶×¨Ö¶×¥ × Ö¸×ªÖ°× Ö¸×” ×™Ö°×‘×•Ö¼×œÖ¸×”Ö¼. ×™Ö°×‘Ö¸×¨Ö°×›Öµ× ×•Ö¼ ×Ö±×œÖ¹×”Ö´×™× ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼: ×™Ö°×‘Ö¸×¨Ö°×›Öµ× ×•Ö¼ ×Ö±×œÖ¹×”Ö´×™×. ×•Ö°×™Ö´×™×¨Ö°××•Ö¼ ××•Ö¹×ª×•Ö¹ ×›Ö¼Ö¸×œ-×Ö·×¤Ö°×¡Öµ×™-×Ö¸×¨Ö¶×¥:
        <hr class="my-2">
        ×Ö²×‘Ö¸×¨Ö°×›Ö¸×” ×Ö¶×ª-×Ö²×“Ö¹× Ö¸×™ ×‘Ö¼Ö°×›Ö¹×œ-×¢Öµ×ª. ×ªÖ¼Ö¸×Ö´×™×“ ×ªÖ¼Ö°×”Ö´×œÖ¼Ö¸×ª×•Ö¹ ×‘Ö¼Ö°×¤Ö´×™: ×¡×•Ö¹×£ ×“Ö¼Ö¸×‘Ö¸×¨ ×”Ö·×›Ö¼Ö¹×œ × Ö´×©×Ö°×Ö¸×¢. ×Ö¶×ª-×”Ö¸×Ö±×œÖ¹×”Ö´×™× ×™Ö°×¨Ö¸× ×•Ö°×Ö¶×ª-×Ö´×¦Ö°×•Ö¹×ªÖ¸×™×• ×©×Ö°××•Ö¹×¨, ×›Ö¼Ö´×™-×–Ö¶×” ×›Ö¼Ö¸×œ-×”Ö¸×Ö¸×“Ö¸×: ×ªÖ¼Ö°×”Ö´×œÖ¼Ö·×ª ×Ö²×“Ö¹× Ö¸×™ ×™Ö°×“Ö·×‘Ö¼Ö¶×¨ ×¤Ö¼Ö´×™. ×•Ö´×™×‘Ö¸×¨Öµ×šÖ° ×›Ö¼Ö¸×œ-×‘Ö¼Ö¸×©×‚Ö¸×¨ ×©×Öµ× ×§Ö¸×“Ö°×©××•Ö¹ ×œÖ°×¢×•Ö¹×œÖ¸× ×•Ö¸×¢Ö¶×“: ×•Ö·×Ö²× Ö·×—Ö°× ×•Ö¼ × Ö°×‘Ö¸×¨Öµ×šÖ° ×™Ö¸×”Ö¼ ×Öµ×¢Ö·×ªÖ¼Ö¸×” ×•Ö°×¢Ö·×“-×¢×•Ö¹×œÖ¸× ×”Ö·×œÖ°×œ×•Ö¼×™Ö¸×”Ö¼: ×•Ö·×™Ö°×“Ö·×‘Ö¼Öµ×¨ ×Öµ×œÖ·×™, ×–Ö¶×” ×”Ö·×©Ö¼×Ö»×œÖ°×—Ö¸×Ÿ ×Ö²×©×Ö¶×¨ ×œÖ´×¤Ö°× Öµ×™ ×Ö²×“Ö¹× Ö¸×™:
        . ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™, ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×Ö¶×œÖ¶×šÖ° ×”Ö¸×¢×•Ö¹×œÖ¸×, ×”Ö¸×Öµ×œ ×”Ö·×–Ö¼Ö¸×Ÿ ××•Ö¹×ªÖ¸× ×•Ö¼ ×•Ö°×Ö¶×ª ×”Ö¸×¢×•Ö¹×œÖ¸× ×›Ö¼Ö»×œÖ¼×•Ö¹ ×‘Ö¼Ö°×˜×•Ö¼×‘×•Ö¹ ×‘Ö¼Ö°×—Öµ×Ÿ ×‘Ö¼Ö°×—Ö¶×¡Ö¶×“ ×‘Ö¼Ö°×¨Ö¶×•Ö·×— ×•Ö¼×‘Ö°×¨Ö·×—Ö²×Ö´×™× ×¨Ö·×‘Ö¼Ö´×™×. × Ö¹×ªÖµ×Ÿ ×œÖ¶×—Ö¶× ×œÖ°×›Ö¹×œ-×‘Ö¼Ö¸×©×‚Ö¸×¨. ×›Ö¼Ö´×™ ×œÖ°×¢×•Ö¹×œÖ¸× ×—Ö·×¡Ö°×“Ö¼×•Ö¹: ×•Ö¼×‘Ö°×˜×•Ö¼×‘×•Ö¹ ×”Ö·×’Ö¼Ö¸×“×•Ö¹×œ ×ªÖ¼Ö¸×Ö´×™×“ ×œÖ¹× ×—Ö¸×¡Ö·×¨ ×œÖ¸× ×•Ö¼ ×•Ö°×Ö·×œ ×™Ö¶×—Ö°×¡Ö·×¨ ×œÖ¸× ×•Ö¼ ×Ö¸×–×•Ö¹×Ÿ ×ªÖ¼Ö¸×Ö´×™×“ ×œÖ°×¢×•Ö¹×œÖ¸× ×•Ö¸×¢Ö¶×“. ×›Ö¼Ö´×™ ×”×•Ö¼× ×Öµ×œ ×–Ö¸×Ÿ ×•Ö¼×Ö°×¤Ö·×¨Ö°× Öµ×¡ ×œÖ·×›Ö¼Ö¹×œ ×•Ö°×©×Ö»×œÖ°×—Ö¸× ×•Ö¹ ×¢Ö¸×¨×•Ö¼×šÖ° ×œÖ·×›Ö¼Ö¹×œ ×•Ö°×”Ö´×ªÖ°×§Ö´×™×Ÿ ×Ö´×—Ö°×™Ö¸×” ×•Ö¼×Ö¸×–×•Ö¹×Ÿ ×œÖ°×›Ö¹×œ-×‘Ö¼Ö°×¨Ö´×™Ö¼×•Ö¹×ªÖ¸×™×• ×Ö²×©×Ö¶×¨ ×‘Ö¼Ö¸×¨Ö¸× ×‘Ö°×¨Ö·×—Ö²×Ö¸×™×• ×•Ö¼×‘Ö°×¨×•Ö¹×‘ ×—Ö²×¡Ö¸×“Ö¸×™×• ×›Ö¼Ö¸×Ö¸××•Ö¼×¨. ×¤Ö¼×•Ö¹×ªÖµ×—Ö· ×Ö¶×ª-×™Ö¸×“Ö¶×šÖ¸. ×•Ö¼×Ö·×©×‚Ö°×‘Ö¼Ö´×™×¢Ö· ×œÖ°×›Ö¹×œ-×—Ö·×™ ×¨Ö¸×¦×•Ö¹×Ÿ: ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™, ×”Ö·×–Ö¼Ö¸×Ÿ ×Ö¶×ª ×”Ö·×›Ö¼Ö¹×œ:
        
        × ×•Ö¹×“Ö¶×” ×œÖ¼Ö°×šÖ¸ ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×¢Ö·×œ ×©×Ö¶×”Ö´× Ö°×—Ö·×œÖ°×ªÖ¼Ö¸ ×œÖ·×Ö²×‘×•Ö¹×ªÖµ×™× ×•Ö¼ ×Ö¶×¨Ö¶×¥ ×—Ö¶×Ö°×“Ö¼Ö¸×” ×˜×•Ö¹×‘Ö¸×” ×•Ö¼×¨Ö°×—Ö¸×‘Ö¸×”. ×¢Ö·×œ ×©×Ö¶×”×•Ö¹×¦Öµ××ªÖ¸× ×•Ö¼ ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×Öµ×Ö¶×¨Ö¶×¥ ×Ö´×¦Ö°×¨Ö·×™Ö´× ×•Ö¼×¤Ö°×“Ö´×™×ªÖ¸× ×•Ö¼ ×Ö´×‘Ö¼Öµ×™×ª ×¢Ö²×‘Ö¸×“Ö´×™×. ×•Ö°×¢Ö·×œ ×‘Ö¼Ö°×¨Ö´×™×ªÖ°×šÖ¸ ×©×Ö¶×—Ö¸×ªÖ·×Ö°×ªÖ¼Ö¸ ×‘Ö¼Ö´×‘Ö°×©×‚Ö¸×¨Öµ× ×•Ö¼. ×•Ö°×¢Ö·×œ ×ªÖ¼×•Ö¹×¨Ö¸×ªÖ°×šÖ¸ ×©×Ö¶×œÖ¼Ö´×Ö¼Ö·×“Ö°×ªÖ¼Ö¸× ×•Ö¼. ×•Ö°×¢Ö·×œ ×—Ö»×§Ö¼Öµ×™ ×¨Ö°×¦×•Ö¹× Ö¸×šÖ° ×©×Ö¶×”×•Ö¹×“Ö·×¢Ö°×ªÖ¼Ö¸× ×•Ö¼. ×•Ö°×¢Ö·×œ ×—Ö·×™Ö¼Ö´×™× ×•Ö¼×Ö¸×–×•Ö¹×Ÿ ×©×Ö¶×Ö·×ªÖ¼Ö¸×” ×–Ö¸×Ÿ ×•Ö¼×Ö°×¤Ö·×¨Ö°× Öµ×¡ ××•Ö¹×ªÖ¸× ×•Ö¼: ×•Ö°×¢Ö·×œ ×”Ö·×›Ö¼Ö¹×œ ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×Ö²× Ö·×—Ö°× ×•Ö¼ ××•Ö¹×“Ö´×™× ×œÖ¸×šÖ° ×•Ö¼×Ö°×‘Ö¸×¨Ö°×›Ö´×™× ×Ö¶×ª ×©×Ö°×Ö¸×šÖ° ×›Ö¼Ö¸×Ö¸××•Ö¼×¨ ×•Ö°×Ö¸×›Ö·×œÖ°×ªÖ¼Ö¸ ×•Ö°×©×‚Ö¸×‘Ö¸×¢Ö°×ªÖ¼Ö¸. ×•Ö¼×‘Öµ×¨Ö·×›Ö°×ªÖ¼Ö¸ ×Ö¶×ª-×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Ö¶×™×šÖ¸ ×¢Ö·×œ-×”Ö¸×Ö¸×¨Ö¶×¥ ×”Ö·×˜Ö¼Ö¹×‘Ö¸×” ×Ö²×©×Ö¶×¨ × Ö¸×ªÖ·×Ÿ-×œÖ¸×šÖ°: ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™, ×¢Ö·×œ ×”Ö¸×Ö¸×¨Ö¶×¥ ×•Ö°×¢Ö·×œ ×”Ö·×Ö¼Ö¸×–×•Ö¹×Ÿ:

        ×¨Ö·×—Öµ× ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×¢Ö¸×œÖµ×™× ×•Ö¼ ×•Ö°×¢Ö·×œ ×™Ö´×©×‚Ö°×¨Ö¸×Öµ×œ ×¢Ö·×Ö¼Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×™Ö°×¨×•Ö¼×©×Ö¸×œÖ·×™Ö´× ×¢Ö´×™×¨Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×”Ö·×¨ ×¦Ö´×™Ö¼×•Ö¹×Ÿ ×Ö´×©×Ö°×›Ö¼Ö·×Ÿ ×›Ö¼Ö°×‘×•Ö¹×“Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×”Öµ×™×›Ö¸×œÖ¸×šÖ°. ×•Ö°×¢Ö·×œ ×Ö°×¢×•Ö¹× Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×“Ö¼Ö°×‘Ö´×™×¨Ö¸×šÖ°. ×•Ö°×¢Ö·×œ ×”Ö·×‘Ö¼Ö·×™Ö´×ª ×”Ö·×’Ö¼Ö¸×“×•Ö¹×œ ×•Ö°×”Ö·×§Ö¼Ö¸×“×•Ö¹×©× ×©×Ö¶× Ö¼Ö´×§Ö°×¨Ö¸× ×©×Ö´×Ö°×šÖ¸ ×¢Ö¸×œÖ¸×™×•. ×Ö¸×‘Ö´×™× ×•Ö¼ ×¨Ö°×¢Öµ× ×•Ö¼ ×–×•Ö¼× Öµ× ×•Ö¼. ×¤Ö¼Ö·×¨Ö°× Ö°×¡Öµ× ×•Ö¼. ×›Ö¼Ö·×œÖ°×›Ö¼Ö°×œÖµ× ×•Ö¼. ×”Ö·×¨Ö°×•Ö´×™×—Öµ× ×•Ö¼ ×”Ö·×¨Ö°×•Ö·×— ×œÖ¸× ×•Ö¼ ×Ö°×”Öµ×¨Ö¸×” ×Ö´×›Ö¼Ö¸×œ-×¦Ö¸×¨×•Ö¹×ªÖµ×™× ×•Ö¼. ×•Ö°× Ö¸× ×Ö·×œ ×ªÖ¼Ö·×¦Ö°×¨Ö´×™×›Öµ× ×•Ö¼ ×Ö²×“Ö¹× Ö¸×™ ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×œÖ´×™×“Öµ×™ ×Ö·×ªÖ¼Ö°× ×•Ö¹×ª ×‘Ö¼Ö¸×©×‚Ö¸×¨ ×•Ö¸×“Ö¸×. ×•Ö°×œÖ¹× ×œÖ´×™×“Öµ×™ ×”Ö·×œÖ°×•Ö¸×Ö¸×ªÖ¸×. ×Ö¶×œÖ¼Ö¸× ×œÖ°×™Ö¸×“Ö°×šÖ¸ ×”Ö·×Ö¼Ö°×œÖµ×Ö¸×” ×•Ö°×”Ö¸×¨Ö°×—Ö¸×‘Ö¸×”. ×”Ö¸×¢Ö²×©×Ö´×™×¨Ö¸×” ×•Ö°×”Ö·×¤Ö¼Ö°×ª×•Ö¼×—Ö¸×”. ×™Ö°×”Ö´×™ ×¨Ö¸×¦×•Ö¹×Ÿ ×©×Ö¶×œÖ¼× × Öµ×‘×•Ö¹×©× ×‘Ö¼Ö¸×¢×•Ö¹×œÖ¸× ×”Ö·×–Ö¼Ö¶×”. ×•Ö°×œÖ¹× × Ö´×›Ö¼Ö¸×œÖµ× ×œÖ°×¢×•Ö¹×œÖ¸× ×”Ö·×‘Ö¼Ö¸×. ×•Ö¼×Ö·×œÖ°×›×•Ö¼×ª ×‘Ö¼Öµ×™×ª ×“Ö¼Ö¸×•Ö´×“ ×Ö°×©×Ö´×™×—Ö¸×šÖ° ×ªÖ¼Ö·×—Ö²×–Ö´×™×¨Ö¶× Ö¼Ö¸×” ×œÖ´×Ö°×§×•Ö¹×Ö¸×”Ö¼ ×‘Ö¼Ö´×Ö°×”Öµ×¨Ö¸×” ×‘Ö°×™Ö¸×Öµ×™× ×•Ö¼: ×•Ö°×ªÖ´×‘Ö°× Ö¶×” ×™Ö°×¨×•Ö¼×©×Ö¸×œÖ·×™Ö´× ×¢Ö´×™×¨Ö¸×šÖ° ×‘Ö¼Ö´×Ö°×”Öµ×¨Ö¸×” ×‘Ö°×™Ö¸×Öµ×™× ×•Ö¼: ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™, ×‘Ö¼×•Ö¹× Öµ×” ×™Ö°×¨×•Ö¼×©×Ö¸×œÖ¸×™Ö´×:

        ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×Ö·×ªÖ¼Ö¸×” ×Ö²×“Ö¹× Ö¸×™, ×Ö±×œÖ¹×”Öµ×™× ×•Ö¼ ×Ö¶×œÖ¶×šÖ° ×”Ö¸×¢×•Ö¹×œÖ¸×, ×”Ö¸×Öµ×œ ×Ö¸×‘Ö´×™× ×•Ö¼ ×Ö·×œÖ°×›Ö¼Öµ× ×•Ö¼ ×Ö·×“Ö¼Ö´×™×¨Öµ× ×•Ö¼. ×‘Ö¼×•Ö¹×¨Ö°×Öµ× ×•Ö¼. ×’Ö¼×•Ö¹×Ö²×œÖµ× ×•Ö¼. ×§Ö°×“×•Ö¹×©×Öµ× ×•Ö¼. ×§Ö°×“×•Ö¹×©× ×™Ö·×¢Ö²×§Ö¹×‘. ×¨×•Ö¹×¢Öµ× ×•Ö¼ ×¨×•Ö¹×¢Öµ×” ×™Ö´×©×‚Ö°×¨Ö¸×Öµ×œ. ×”Ö·×Ö¼Ö¶×œÖ¶×šÖ° ×”Ö·×˜Ö¼×•Ö¹×‘ ×•Ö°×”Ö·×Ö¼Öµ×˜Ö´×™×‘ ×œÖ·×›Ö¼Ö¹×œ. ×©×Ö¶×‘Ö¼Ö°×›Ö¹×œ-×™×•Ö¹× ×•Ö¸×™×•Ö¹× ×”×•Ö¼× ×”Öµ×˜Ö´×™×‘ ×œÖ¸× ×•Ö¼. ×”×•Ö¼× ×Öµ×˜Ö´×™×‘ ×œÖ¸× ×•Ö¼. ×”×•Ö¼× ×™Öµ×™×˜Ö´×™×‘ ×œÖ¸× ×•Ö¼. ×”×•Ö¼× ×’Ö°×Ö¸×œÖ¸× ×•Ö¼. ×”×•Ö¼× ×’×•Ö¹×Ö°×œÖµ× ×•Ö¼. ×”×•Ö¼× ×™Ö´×’Ö°×Ö°×œÖµ× ×•Ö¼ ×œÖ¸×¢Ö·×“ ×—Öµ×Ÿ ×•Ö¸×—Ö¶×¡Ö¶×“ ×•Ö°×¨Ö·×—Ö²×Ö´×™× ×•Ö°×¨Ö¶×•Ö·×— ×•Ö°×”Ö·×¦Ö¼Ö¸×œÖ¸×” ×•Ö°×›Ö¹×œ-×˜×•Ö¹×‘:
        ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×©×Ö°×ªÖ¼Ö·×‘Ö¼Ö·×— ×¢Ö·×œ ×›Ö¼Ö´×¡Ö¼Öµ× ×›Ö°×‘×•Ö¹×“×•Ö¹: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×©×Ö°×ªÖ¼Ö·×‘Ö¼Ö·×— ×‘Ö¼Ö·×©Ö¼×Ö¸×Ö·×™Ö´× ×•Ö¼×‘Ö¸×Ö¸×¨Ö¶×¥: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×©×Ö°×ªÖ¼Ö·×‘Ö¼Ö·×— ×‘Ö¼Ö¸× ×•Ö¼ ×œÖ°×“×•Ö¹×¨ ×“Ö¼×•Ö¹×¨Ö´×™×: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×§Ö¶×¨Ö¶×Ÿ ×œÖ°×¢Ö·×Ö¼×•Ö¹ ×™Ö¸×¨Ö´×™×: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×ªÖ°×¤Ö¼Ö¸×Ö·×¨ ×‘Ö¼Ö¸× ×•Ö¼ ×œÖ°× Ö¶×¦Ö·×— × Ö°×¦Ö¸×—Ö´×™×: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö°×¤Ö·×¨Ö°× Ö°×¡Öµ× ×•Ö¼ ×‘Ö¼Ö°×›Ö¸×‘×•Ö¹×“ ×•Ö°×œÖ¹× ×‘Ö°×‘Ö´×–Ö¼×•Ö¼×™, ×‘Ö¼Ö°×”Ö¶×ªÖ¼Öµ×¨ ×•Ö°×œÖ¹× ×‘Ö°×Ö´×¡Ö¼×•Ö¼×¨, ×‘Ö¼Ö°× Ö·×—Ö·×ª ×•Ö°×œÖ¹× ×‘Ö°×¦Ö¸×¢Ö·×¨: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×ªÖ¼Öµ×Ÿ ×©×Ö¸×œ×•Ö¹× ×‘Ö¼Öµ×™× Öµ×™× ×•Ö¼: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×©×Ö°×œÖ·×— ×‘Ö¼Ö°×¨Ö¸×›Ö¸×” ×¨Ö°×•Ö¸×—Ö¸×” ×•Ö°×”Ö·×¦Ö°×œÖ¸×—Ö¸×” ×‘Ö¼Ö°×›Ö¹×œ-×Ö·×¢Ö²×©×‚Öµ×” ×™Ö¸×“Öµ×™× ×•Ö¼: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö·×¦Ö°×œÖ´×™×—Ö· ×Ö¶×ª ×“Ö¼Ö°×¨Ö¸×›Öµ×™× ×•Ö¼: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×©×Ö°×‘Ö¼Ö¹×¨ ×¢×•Ö¹×œ ×’Ö¼Ö¸×œ×•Ö¼×ª ×Ö°×”Öµ×¨Ö¸×” ×Öµ×¢Ö·×œ ×¦Ö·×•Ö¼Ö¸××¨Öµ× ×•Ö¼: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™×•Ö¹×œÖ´×™×›Öµ× ×•Ö¼ ×Ö°×”Öµ×¨Ö¸×” ×§×•Ö¹×Ö°×Ö´×™Ö¼×•Ö¼×ª ×œÖ°×Ö·×¨Ö°×¦Öµ× ×•Ö¼: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×¨Ö°×¤Ö¼Ö¸×Öµ× ×•Ö¼ ×¨Ö°×¤×•Ö¼×Ö¸×” ×©×Ö°×œÖµ×Ö¸×” ×¨Ö°×¤×•Ö¼×Ö·×ª ×”Ö·× Ö¼Ö¶×¤Ö¶×©× ×•Ö¼×¨Ö°×¤×•Ö¼×Ö·×ª ×”Ö·×’Ö¼×•Ö¼×£: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×¤Ö°×ªÖ¼Ö·×— ×œÖ¸× ×•Ö¼ ×Ö¶×ª ×™Ö¸×“×•Ö¹ ×”Ö¸×¨Ö°×—Ö¸×‘Ö¸×”: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö°×‘Ö¸×¨Öµ×šÖ° ×›Ö¼Ö¸×œ ×Ö¶×—Ö¸×“ ×•Ö°×Ö¶×—Ö¸×“ ×Ö´×Ö¼Ö¶× Ö¼×•Ö¼ ×‘Ö¼Ö´×©×Ö°××•Ö¹ ×”Ö·×’Ö¼Ö¸×“×•Ö¹×œ ×›Ö¼Ö°××•Ö¹ ×©×Ö¶× Ö¼Ö´×ªÖ°×‘Ö¼Ö¸×¨Ö°×›×•Ö¼ ×Ö²×‘×•Ö¹×ªÖµ×™× ×•Ö¼ ×Ö·×‘Ö°×¨Ö¸×”Ö¸× ×™Ö´×¦Ö°×—Ö¸×§ ×•Ö°×™Ö·×¢Ö²×§Ö¹×‘ ×‘Ö¼Ö·×›Ö¼Ö¹×œ ×Ö´×›Ö¼Ö¹×œ ×›Ö¼Ö¹×œ. ×›Ö¼Öµ×Ÿ ×™Ö°×‘Ö¸×¨Öµ×šÖ° ××•Ö¹×ªÖ¸× ×•Ö¼ ×™Ö·×—Ö·×“ ×‘Ö¼Ö°×¨Ö¸×›Ö¸×” ×©×Ö°×œÖµ×Ö¸×”. ×•Ö°×›Öµ×Ÿ ×™Ö°×”Ö´×™ ×¨Ö¸×¦×•Ö¹×Ÿ ×•Ö°× Ö¹××Ö·×¨ ×Ö¸×Öµ×Ÿ: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×¤Ö°×¨×•Ö¹×©×‚ ×¢Ö¸×œÖµ×™× ×•Ö¼ ×¡Ö»×›Ö¼Ö·×ª ×©×Ö°×œ×•Ö¹××•Ö¹: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö´×˜Ö¼Ö·×¢ ×ªÖ¼×•Ö¹×¨Ö¸×ª×•Ö¹ ×•Ö°×Ö·×”Ö²×‘Ö¸×ª×•Ö¹ ×‘Ö¼Ö°×œÖ´×‘Ö¼Öµ× ×•Ö¼ ×•Ö°×ªÖ´×”Ö°×™Ö¶×” ×™Ö´×¨Ö°×Ö¸×ª×•Ö¹ ×¢Ö·×œ ×¤Ö¼Ö¸× Öµ×™× ×•Ö¼ ×œÖ°×‘Ö´×œÖ°×ªÖ¼Ö´×™ × Ö¶×—Ö±×˜Ö¸×. ×•Ö°×™Ö´×”Ö°×™×•Ö¼ ×›Ö¹×œ-×Ö·×¢Ö²×©×‚Öµ×™× ×•Ö¼ ×œÖ°×©×Öµ× ×©×Ö¸×Ö¸×™Ö´×: ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö°×‘Ö¸×¨Öµ×šÖ° ×Ö¶×ª ×”Ö·×©Ö¼×Ö»×œÖ°×—Ö¸×Ÿ ×”Ö·×–Ö¼Ö¶×” ×©×Ö¶×Ö¸×›Ö·×œÖ°× ×•Ö¼ ×¢Ö¸×œÖ¸×™×•... ×”Ö¸×¨Ö·×—Ö²×Ö¸×Ÿ ×”×•Ö¼× ×™Ö°×‘Ö¸×¨Öµ×šÖ° ×Ö¶×ª ×‘Ö¼Ö·×¢Ö·×œ ×”Ö·×‘Ö¼Ö·×™Ö´×ª ×”Ö·×–Ö¼Ö¶×”... ×Ö·×’Ö°×“Ö¼Ö´×™×œ ×™Ö°×©××•Ö¼×¢×•Ö¹×ª ×Ö·×œÖ°×›Ö¼×•Ö¹. ×•Ö°×¢Ö¹×©×‚Ö¶×”-×—Ö¶×¡Ö¶×“ ×œÖ´×Ö°×©×Ö´×™×—×•Ö¹ ×œÖ°×“Ö¸×•Ö´×“ ×•Ö¼×œÖ°×–Ö·×¨Ö°×¢×•Ö¹ ×¢Ö·×“-×¢×•Ö¹×œÖ¸×: ×›Ö¼Ö°×¤Ö´×™×¨Ö´×™× ×¨Ö¸×©××•Ö¼ ×•Ö°×¨Ö¸×¢Öµ×‘×•Ö¼. ×•Ö°×“×¨Ö°×©×Öµ×™ ×Ö²×“Ö¹× Ö¸×™ ×œÖ¹×-×™Ö·×—Ö°×¡Ö°×¨×•Ö¼ ×›Ö¹×œ-×˜×•Ö¹×‘: × Ö·×¢Ö·×¨ ×”Ö¸×™Ö´×™×ªÖ´×™ ×’Ö¼Ö·×-×–Ö¸×§Ö·× Ö°×ªÖ¼Ö´×™ ×•Ö°×œÖ¹×-×¨Ö¸×Ö´×™×ªÖ´×™ ×¦Ö·×“Ö¼Ö´×™×§ × Ö¶×¢Ö±×–Ö¸×‘. ×•Ö°×–Ö·×¨Ö°×¢×•Ö¹ ×Ö°×‘Ö·×§Ö¼Ö¶×©×-×œÖ¸×—Ö¶×: ×›Ö¼Ö¸×œ-×”Ö·×™Ö¼×•Ö¹× ×—×•Ö¹× Öµ×Ÿ ×•Ö¼×Ö·×œÖ°×•Ö¶×”. ×•Ö°×–Ö·×¨Ö°×¢×•Ö¹ ×œÖ´×‘Ö°×¨Ö¸×›Ö¸×”: ×Ö·×” ×©Ö¼×Ö¶×Ö¸×›Ö·×œÖ°× ×•Ö¼ ×™Ö´×”Ö°×™Ö¶×” ×œÖ°×©×‚Ö¸×‘Ö°×¢Ö¸×”. ×•Ö¼×Ö·×” ×©Ö¼×Ö¶×©Ö¼×Ö¸×ªÖ´×™× ×•Ö¼ ×™Ö´×”Ö°×™Ö¶×” ×œÖ´×¨Ö°×¤×•Ö¼×Ö¸×”. ×•Ö¼×Ö·×” ×©Ö¼×Ö¶×”×•Ö¹×ªÖ·×¨Ö°× ×•Ö¼ ×™Ö´×”Ö°×™Ö¶×” ×œÖ´×‘Ö°×¨Ö¸×›Ö¸×”... ×‘Ö¼Ö°×¨×•Ö¼×›Ö´×™× ×Ö·×ªÖ¼Ö¶× ×œÖ·×Ö²×“Ö¹× Ö¸×™. ×¢Ö¹×©×‚Öµ×” ×©×Ö¸×Ö·×™Ö´× ×•Ö¸×Ö¸×¨Ö¶×¥: ×‘Ö¼Ö¸×¨×•Ö¼×šÖ° ×”Ö·×’Ö¼Ö¶×‘Ö¶×¨ ×Ö²×©×Ö¶×¨ ×™Ö´×‘Ö°×˜Ö·×— ×‘Ö¼Ö·×Ö²×“Ö¹× Ö¸×™... ×Ö²×“Ö¹× Ö¸×™ ×¢Ö¹×– ×œÖ°×¢Ö·×Ö¼×•Ö¹ ×™Ö´×ªÖ¼Öµ×Ÿ. ×Ö²×“Ö¹× Ö¸×™ ×™Ö°×‘Ö¸×¨Öµ×šÖ° ×Ö¶×ª-×¢Ö·×Ö¼×•Ö¹ ×‘Ö·×©Ö¼×Ö¸×œ×•Ö¹×. ×¢×•Ö¹×©×‚Ö¶×” ×©×Ö¸×œ×•Ö¹× ×‘Ö¼Ö´×Ö°×¨×•Ö¹×Ö¸×™×• ×”×•Ö¼× ×‘Ö°×¨Ö·×—Ö²×Ö¸×™×• ×™Ö·×¢Ö²×©×‚Ö¶×” ×©×Ö¸×œ×•Ö¹× ×¢Ö¸×œÖµ×™× ×•Ö¼ ×•Ö°×¢Ö·×œ ×›Ö¼Ö¸×œ-×¢Ö·×Ö¼×•Ö¹ ×™Ö´×©×‚Ö°×¨Ö¸×Öµ×œ ×•Ö°×Ö´×Ö°×¨×•Ö¼ ×Ö¸×Öµ×Ÿ:
        `,

        // --- ×ª×¤×™×œ×•×ª ×™×•××™×•×ª (× ×•×¡×— ×§×¦×¨ ×‘×œ×‘×“) - ×œ×œ× ×©×™× ×•×™
        shacharit: "×–××Ÿ ×ª×¤×™×œ×ª ×©×—×¨×™×ª",
        mincha: "×–××Ÿ ×ª×¤×™×œ×ª ×× ×—×”",
        arvit: "×–××Ÿ ×ª×¤×™×œ×ª ×¢×¨×‘×™×ª"
    };
    let currentLang = 'he-it'; // he-it or it-he

    console.log("LOG: Static data (attractions, kosher, etc.) loaded.");

    function getInitialTripData() {
        console.log("LOG: getInitialTripData() called. Generating default trip structure.");
        const initialPlanKeys = ['duomo', 'primark', 'sanSiro', 'como', 'berninaExpress', 'laScala', 'navigli', 'ilCentro'];
        return {
            plan: {
                day1: { name: "×™×•× 1: ×“×•××•××• ×•×“×¨×‘×™", transport: 'walk', activities: [
                    { id: 'duomo_1', time: "×‘×•×§×¨", ...attractions.duomo },
                    { id: 'primark_1', time: "×¦×”×¨×™×™×", ...attractions.primark },
                    { id: 'sanSiro_1', time: "×¢×¨×‘", ...attractions.sanSiro }
                ]},
                day2: { name: "×™×•× 2: ××’××™× ×•× ×‘×™×œ×™", transport: 'transit', activities: [
                    { id: 'como_1', time: "×™×•× ×©×œ×", ...attractions.como },
                    { id: 'navigli_1', time: "×¢×¨×‘", ...attractions.navigli },
                ]},
                day3: { name: "×™×•× 3: ×”××œ×¤×™× ×”×©×•×•×™×¦×¨×™×™×", transport: 'drive', activities: [
                    { id: 'berninaExpress_1', time: "×™×•× ×©×œ×", ...attractions.berninaExpress },
                ]},
                day4: { name: "×™×•× 4: ×ª×¨×‘×•×ª ×•×§× ×™×•×ª", transport: 'transit', activities: [
                    { id: 'laScala_1', time: "×‘×•×§×¨", ...attractions.laScala },
                    { id: 'ilCentro_1', time: "×¦×”×¨×™×™×", ...attractions.ilCentro }
                ]}
            },
            suggestions: Object.entries(attractions)
                .filter(([key]) => !initialPlanKeys.includes(key))
                .map(([key, value]) => ({...value, id: key})),
            checklist: [
                { id: 'cat1', category: '××¡××›×™×', items: [{ id: 'c1', text: '×“×¨×›×•×Ÿ', done: true }, { id: 'c2', text: '×›×¨×˜×™×¡×™ ×˜×™×¡×”', done: false }] },
                { id: 'cat2', category: '×‘×™×’×•×“', items: [{ id: 'c3', text: '××¢×™×œ ×’×©×', done: false }] },
                { id: 'cat3', category: '××œ×§×˜×¨×•× ×™×§×”', items: [{ id: 'c4', text: '××˜×¢×Ÿ × ×™×™×“', done: true }, { id: 'c5', text: '××ª×× ×œ×—×©××œ', done: false }] }
            ],
            totalBudget: 1500, expenses: [], documents: [], gallery: [], journal: {},
            theme: 'dark',
            settings: { includeEstimatedCostsInBalance: true }
        };
    }

    // --- MODAL ---
    let activityToModify = null;
    const modal = $('#add-to-day-modal');
    async function openAddToDayModal(activityId, type = 'suggestion') {
        console.log(`LOG: openAddToDayModal called for activityId: ${activityId}, type: ${type}`);
        if (type === 'suggestion') {
            activityToModify = localTripData.suggestions.find(s => s.id === activityId);
        } else {
            const allKosher = [...kosherData.restaurants, ...kosherData.markets];
            activityToModify = allKosher.find(k => k.name === activityId);
            if(activityToModify) activityToModify.id = activityId;
        }
        
        if (!activityToModify) {
            console.error(`ERROR: Could not find activity to modify with id: ${activityId}`);
            return;
        }

        const opts = $('#modal-day-options');
        opts.innerHTML = Object.entries(localTripData.plan).sort((a,b) => a[0].localeCompare(b[0])).map(([dayId, dayData]) => 
            `<button class="btn btn-primary" onclick="window.addActivityToDay('${dayId}', '${type}')">${dayData.name}</button>`
        ).join('');
        modal.classList.add('flex');
    };
    window.closeModal = () => {
        console.log("LOG: closeModal called.");
        $$('.modal-backdrop').forEach(m => m.classList.remove('flex'));
    };
    window.addActivityToDay = async (dayId, type) => {
        console.log(`LOG: addActivityToDay called for dayId: ${dayId}, type: ${type}`);
        const day = localTripData.plan[dayId];
        if (day && activityToModify) {
            const newActivity = { ...activityToModify, time: "×–××Ÿ ×’××™×©", id: (activityToModify.id || activityToModify.name) + '_' + Date.now() };
            day.activities.push(newActivity);
            
            let newSuggestions = localTripData.suggestions;
            if (type === 'suggestion') {
                newSuggestions = localTripData.suggestions.filter(s => s.id !== activityToModify.id);
            }
            
            console.log("LOG: Updating Firestore with new plan and suggestions.");
            await updateDoc(tripDocRef, {
                plan: localTripData.plan,
                suggestions: newSuggestions
            });
        }
        closeModal();
    };
    window.openAddToDayModal = openAddToDayModal;


// helper ×©××¢×“×›×Ÿ ×›×¤×ª×•×¨×™ ×”××•×“×œ (××•×¡×“×¨ ×œ×©×™××•×© ×‘-showAlert)



    
    function openTipModal() {
    console.log("LOG: openTipModal called.");
    const tip = dailyTips[Math.floor(Math.random() * dailyTips.length)];
    $('#daily-tip-body').textContent = tip;
    $('#daily-tip-modal').classList.add('flex');
}
    function showDailyTip() {
        console.log("LOG: showDailyTip called, checking if tip should be displayed.");
        const lastTipDate = localStorage.getItem('lastTipDate');
        const today = new Date().toISOString().slice(0, 10);

        if (lastTipDate !== today) {
            console.log("LOG: Displaying daily tip.");
           
            localStorage.setItem('lastTipDate', today);
        } else {
            console.log("LOG: Daily tip already shown today.");
        }
    }

    // --- RENDER FUNCTIONS ---
function renderOverview() {
    console.log("LOG: renderOverview called.");
    const { hotel, flights, contacts } = tripMeta;
    
    // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×ª×¤×™×œ×ª ×”×“×¨×š ×‘×ª×•×š ×›×¨×˜×™×¡ ×”×¡×¤×™×¨×” ×œ××—×•×¨
    const countdownHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg text-center">
        <h3 class="font-bold text-lg mb-2">×”×–××Ÿ ×©× ×•×ª×¨ ×œ×˜×™×•×œ</h3>
        <div id="countdown" class="flex flex-row-reverse justify-around font-mono"></div>
    </div>`;

    const clocksHtml = `<div class="bg-white dark:bg-gray-950 p-4 rounded-lg shadow-lg">
        <h3 class="text-xl font-bold mb-3 text-center"><i class="fa-solid fa-clock mr-2"></i>×–××Ÿ ××§×•××™</h3>
        <div class="space-y-2">
            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <span class="font-semibold text-sm">××™×œ×× ×• ğŸ‡®ğŸ‡¹</span>
                <span id="milan-time" class="font-mono text-lg font-bold">--:--:--</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <span class="font-semibold text-sm">×™×©×¨××œ ğŸ‡®ğŸ‡±</span>
                <span id="israel-time" class="font-mono text-lg font-bold">--:--:--</span>
            </div>
        </div>
        <details class="mt-2">
            <summary class="cursor-pointer text-xs text-center text-gray-500">×”×¦×’ ××ª ×–×× ×™ ×”×™×•× ×‘××™×œ×× ×•</summary>
            <div id="zmanim-container" class="text-xs pt-2 mt-2 border-t dark:border-gray-700 text-center">
                ×˜×•×¢×Ÿ ×–×× ×™×...
            </div>
        </details>
    </div>`;

    // ××™×§×•× ×›×¤×ª×•×¨ "×ª×¤×™×œ×ª ×”×“×¨×š" ×‘×ª×•×š ×›×¨×˜×™×¡ ×”×˜×™×¡×•×ª
    const flightsHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2 col-span-1 sm:col-span-2 lg:col-span-1">
        <h3 class="font-bold text-lg"><i class="fa-solid fa-plane-departure mr-2"></i>×¤×¨×˜×™ ×˜×™×¡×•×ª</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-x-4 gap-y-2 text-sm">
            <div><b class="font-semibold">×”×œ×•×š:</b> ${flights.inbound.date} | ${flights.inbound.flight}</div>
            <div><b>×”××¨××”:</b> ${flights.inbound.departureTime} | <b>× ×—×™×ª×”:</b> ${flights.inbound.arrivalTime}</div>
            <hr class="md:col-span-2 lg:col-span-1 my-1">
            <div><b class="font-semibold">×—×–×•×¨:</b> ${flights.outbound.date} | ${flights.outbound.flight}</div>
            <div><b>×”××¨××”:</b> ${flights.outbound.departureTime} | <b>× ×—×™×ª×”:</b> ${flights.outbound.arrivalTime}</div>
        </div>
        
        <div class="flex justify-center pt-2">
            <button id="tefilat-haderech-btn" class="btn btn-primary bg-blue-800 hover:bg-blue-900 text-sm">
                <i class="fa-solid fa-plane-departure mr-2"></i>×ª×¤×™×œ×ª ×”×“×¨×š
            </button>
        </div>
        
    </div>`;
    
    const hotelHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2">
        <h3 class="font-bold text-lg"><i class="fa-solid fa-hotel mr-2"></i>××œ×•×Ÿ</h3>
        <p><b>${hotel.name}</b></p>
        <div class="flex gap-2"><a href="${hotel.tel}" class="btn btn-ghost"><i class="fa fa-phone"></i> ×—×™×•×’</a><a href="https://maps.google.com/?q=${encodeURIComponent(hotel.address)}" target="_blank" class="btn btn-ghost"><i class="fa fa-map-location-dot"></i> × ×™×•×•×˜</a></div>
    </div>`;

    $('#overview-cards').innerHTML = countdownHtml + clocksHtml + flightsHtml + hotelHtml;
    startCountdown();
      const tefilatHaderechBtn = $('#tefilat-haderech-btn');
    if (tefilatHaderechBtn) {
        tefilatHaderechBtn.addEventListener('click', () => {
            const prayerText = hebrewPrayers.tefilatHaderech;
            showAlert('×ª×¤×™×œ×ª ×”×“×¨×š', prayerText, true, { text: prayerText });
        });
    }
}
    function startCountdown() {
        console.log("LOG: startCountdown called.");
        const targetDate = new Date(`${tripMeta.flights.inbound.date}T00:00:00`).getTime();
        const countdownEl = $('#countdown');
        if (!countdownEl) {
            console.error("ERROR: Countdown element not found.");
            return;
        }
        
        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance < 0) {
                clearInterval(interval);
                countdownEl.innerHTML = "<div class='text-lg font-bold w-full'>×”×˜×™×•×œ ×”×ª×—×™×œ! ×ª×”× ×•!</div>";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownEl.innerHTML = `
                <div><div class="countdown-number">${days}</div><div class="countdown-label">×™××™×</div></div>
                <div><div class="countdown-number">${hours}</div><div class="countdown-label">×©×¢×•×ª</div></div>
                <div><div class="countdown-number">${minutes}</div><div class="countdown-label">×“×§×•×ª</div></div>
                <div><div class="countdown-number">${seconds}</div><div class="countdown-label">×©× ×™×•×ª</div></div>
            `;
        }, 1000);
    }

function renderAllPlans(planData) {
    console.log("LOG: renderAllPlans called.");
    if (!planData) {
        console.warn("WARN: renderAllPlans called with no planData.");
        return;
    }
    const nav = $('#day-tabs-nav'), content = $('#plan-content-container');
    const submenu = $('#plan-submenu-links');
    
    // --- START OF FIX ---
    let navHtml = '';
    let contentHtml = '';
    let submenuHtml = '';

    const sortedDays = Object.entries(planData).sort((a, b) => a[0].localeCompare(b[0]));

    // Step 1: Build all HTML strings first
    sortedDays.forEach(([dayId, dayData], i) => {
        const active = i === 0;
        navHtml += `<button class="tab-button ${active ? 'tab-active' : ''}" data-content="${dayId}">${dayData.name}</button>`;
        contentHtml += `<div id="${dayId}" class="content-section ${active ? 'active' : ''}"></div>`;
        submenuHtml += `<a href="#plan" data-day-index="${i}" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">${dayData.name.split(':')[0]}</a>`;
    });
    submenuHtml += `<a href="#suggestions" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 col-span-3">×”×¦×¢×•×ª</a>`;

    // Step 2: Set innerHTML only ONCE for each container
    nav.innerHTML = navHtml;
    content.innerHTML = contentHtml;
    submenu.innerHTML = submenuHtml;

    // Step 3: Now that all containers exist, populate them and add listeners
    sortedDays.forEach(([dayId, dayData]) => {
        renderPlanForDay(dayId, dayData);
    });
    // --- END OF FIX ---

    // Attach event listeners for tabs (this part remains the same)
    $$('#day-tabs-nav .tab-button').forEach(b => b.addEventListener('click', (e) => {
        console.log(`LOG: Day tab clicked: ${e.currentTarget.dataset.content}`);
        $$('#day-tabs-nav .tab-button').forEach(btn => btn.classList.remove('tab-active'));
        e.currentTarget.classList.add('tab-active');
        $$('#plan-content-container .content-section').forEach(s => s.classList.remove('active'));
        $(`#${e.currentTarget.dataset.content}`).classList.add('active');
    }));
    $$('#plan-submenu-links a[data-day-index]').forEach(link => {
        link.addEventListener('click', (e) => {
            const dayIndex = parseInt(e.currentTarget.dataset.dayIndex, 10);
            console.log(`LOG: Mobile day link clicked for day index: ${dayIndex}`);
            $$('#day-tabs-nav .tab-button')[dayIndex].click();
        });
    });
}
// ========================= ×”×ª×—×œ×”: ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×ª×¤×¨×™×˜×™ × ×™×•×•×˜ ××”×™×¨ =========================
function renderMobileNavSubmenus() {
    const toolsContainer = $('#tools-submenu-links');
    if (toolsContainer) {
        let toolsHtml = '<a href="#overview" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 col-span-3 font-bold text-brand-600">×—×–×•×¨ ×œ×¡×§×™×¨×”</a>';
        $$('#tools > div > div').forEach(toolElement => {
            const toolId = toolElement.id;
            const toolTitleElement = toolElement.querySelector('h3');
            if (toolId && toolTitleElement) {
                const toolTitle = toolTitleElement.textContent || '×›×œ×™';
                // ×œ×•×§×—×™× ×¨×§ ××ª ×”×˜×§×¡×˜, ×‘×œ×™ ×”××™×™×§×•×Ÿ
                const cleanTitle = toolTitleElement.childNodes.length > 1 ? toolTitleElement.lastChild.textContent.trim() : toolTitle.trim();
                toolsHtml += `<a href="#${toolId}" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">${cleanTitle}</a>`;
            }
        });
        toolsContainer.innerHTML = toolsHtml;
    }
}
// ========================= ×¡×•×£: ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×ª×¤×¨×™×˜×™ × ×™×•×•×˜ ××”×™×¨ =========================
    function renderPlanForDay(dayId, dayData) {
        console.log(`LOG: renderPlanForDay called for ${dayId}`);
        const container = $(`#${dayId}`);
        if (!container) {
            console.error(`ERROR: Container for day ${dayId} not found.`);
            return;
        }
// ×§×˜×¢ ×§×•×“ ××¢×•×“×›×Ÿ ××ª×•×š renderPlanForDay
        let content = `<div class="p-4"><div class="flex flex-wrap items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                <label class="font-semibold">××¦×‘ × ×¡×™×¢×”:</label>
                <select class="p-2 rounded-lg border bg-white dark:bg-gray-800" data-day="${dayId}" onchange="window.handleTransportChange(event)">
                    <option value="walk" ${dayData.transport === 'walk' ? 'selected' : ''}>×”×œ×™×›×”</option>
                    <option value="drive" ${dayData.transport === 'drive' ? 'selected' : ''}>×¨×›×‘/××•× ×™×ª</option>
                    <option value="transit" ${dayData.transport === 'transit' ? 'selected' : ''}>×ª×—×‘"×¦</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="window.openDayMap('${dayId}')"><i class="fa-solid fa-map-route mr-2"></i>××¤×ª ×™×•×</button>
            <button class="btn btn-ghost" onclick="window.optimizeDayRoute('${dayId}')"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>×¡×“×¨ ×œ×™ ××ª ×”×™×•×</button>
            <button class="btn btn-ghost" onclick="window.generateIcsFile('${dayId}')"><i class="fa-solid fa-calendar-plus mr-2"></i>×”×•×¡×£ ×œ×™×•××Ÿ</button>
            <button class="btn btn-primary bg-purple-600 hover:bg-purple-700" onclick="window.generateDailySummary('${dayId}')"><i class="fa-solid fa-microphone-lines mr-2"></i>×¡×™×›×•× ×™×•××™ (AI)</button>
        </div><div class="space-y-4">`;

        let previousActivity = null; 
        dayData.activities.forEach((act, i) => {
            const dist = haversineKm(previousActivity?.coords?.lat, previousActivity?.coords?.lon, act.coords?.lat, act.coords?.lon);
            const time = minsForMode(dist, dayData.transport);
            if (i > 0 && previousActivity) {
                content += `<div class="flex items-center gap-2 text-sm text-gray-500 justify-center">
                    <i class="fa-solid fa-arrow-down"></i> <span>${formatKm(dist)} / ${formatMin(time)}</span>
                </div>`;
            }
            content += renderActivityCard(dayId, act, i, dayData.activities.length, previousActivity);
            previousActivity = act;
        });
        
        content += `</div>${renderJournal(dayId, localTripData.journal ? localTripData.journal[dayId] : [])}</div>`;
        container.innerHTML = content;
        
        // Add event listener to the newly created journal form
        const journalForm = $(`#journal-form-${dayId}`);
        if (journalForm) {
            journalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                console.log(`LOG: Journal form submitted for day: ${dayId}`);
                if(!isFirebaseConnected) { 
                    showAlert('×©×’×™××ª ×¡× ×›×¨×•×Ÿ', '××™×Ÿ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.');
                    return; 
                }
                const textInput = $(`#journal-text-${dayId}`);
                const text = textInput.value.trim();
                if (text) {
                    addJournalEntry(dayId, text);
                    textInput.value = '';
                }
            });
        }
    }
    
    function renderActivityCard(dayId, activity, index, total, previousActivity) {
        const isDining = activity.type === 'dining';
        const links = [];


if (activity.type === 'attraction') {
    links.push(`<button onclick="window.getAudioGuide('${activity.name}')" class="btn btn-primary bg-purple-600 hover:bg-purple-700"><i class="fa-solid fa-headphones"></i> ××“×¨×™×š</button>`);
}
        if (activity.tickets) links.push(`<a href="${activity.tickets}" target="_blank" class="btn btn-primary"><i class="fa-solid fa-ticket"></i> ×›×¨×˜×™×¡×™×</a>`);
        if (activity.info) links.push(`<a href="${activity.info}" target="_blank" class="btn btn-ghost"><i class="fa-solid fa-circle-info"></i> ××™×“×¢</a>`);
        if (activity.address) {
            links.push(`<a href="https://waze.com/ul?q=${encodeURIComponent(activity.address)}" target="_blank" class="btn btn-ghost" title="Waze"><i class="fa-brands fa-waze"></i></a>`);
            links.push(`<a href="https://maps.google.com/?q=${encodeURIComponent(activity.address)}" target="_blank" class="btn btn-ghost" title="Google Maps"><i class="fa-brands fa-google"></i></a>`);
        }
        if (previousActivity && previousActivity.address && activity.address) {
            const transitUrl = `https://maps.google.com/?saddr=${encodeURIComponent(previousActivity.address)}&daddr=${encodeURIComponent(activity.address)}&travelmode=transit`;
            links.push(`<a href="${transitUrl}" target="_blank" class="btn btn-ghost" title="× ×™×•×•×˜ ×‘×ª×—×‘×´×¦"><i class="fa-solid fa-route"></i></a>`);
        }
        if(!isDining && activity.coords) {
             links.push(`<button onclick="window.findNearbyKosher(this)" data-lat="${activity.coords.lat}" data-lon="${activity.coords.lon}" data-name="${activity.name}" class="btn btn-ghost"><i class="fa-solid fa-utensils"></i> ××¡×¢×“×•×ª</button>`);
        }

        const imgHTML = activity.img ? `<div class="image-carousel" data-images='${JSON.stringify(activity.img)}' data-index="0">
            <img loading="lazy" src="${activity.img[0]}" alt="${activity.name}" class="thumb" onerror="this.style.display='none'">
            ${(activity.img.length || 0) > 1 ? `<button class="carousel-prev" onclick="window.navigateCarousel(this, -1)"><</button><button class="carousel-next" onclick="window.navigateCarousel(this, 1)">></button>` : ''}
        </div>` : '';
        
        const moveButtons = `
            <button class="p-1 ${index === 0 ? 'opacity-25' : ''}" ${index === 0 ? 'disabled' : ''} onclick="window.moveActivity('${dayId}', '${activity.id}', -1)"><i class="fa-solid fa-arrow-up"></i></button>
            <button class="p-1 ${index === total - 1 ? 'opacity-25' : ''}" ${index === total - 1 ? 'disabled' : ''} onclick="window.moveActivity('${dayId}', '${activity.id}', 1)"><i class="fa-solid fa-arrow-down"></i></button>
        `;

        return `<details class="bg-gray-50 dark:bg-gray-900 rounded-xl shadow-md overflow-hidden relative" open>
          <summary class="cursor-pointer list-none flex items-center justify-between p-4">
            <h4 class="font-bold text-lg">${isDining ? '<i class="fa-solid fa-utensils mr-2"></i>' : ''}${activity.time ? activity.time + ' - ' : ''}${activity.name}</h4>
            <div class="text-gray-400 flex items-center gap-2">
                ${moveButtons}
                <i class="fa-solid fa-chevron-down transition-transform"></i>
            </div>
          </summary>
          <button class="absolute top-3 left-3 text-red-500 hover:text-red-700 p-1 z-10" onclick="window.removeActivity('${dayId}', '${activity.id}')"><i class="fa-solid fa-trash"></i></button>
          <div class="flex flex-col md:flex-row border-t border-gray-100 dark:border-gray-800">
            ${imgHTML}
            <div class="p-4 md:p-5 flex-grow">
              <p class="text-gray-700 dark:text-gray-300">${fmtBold(activity.description)}</p>
              ${activity.hours ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-2"><i class="fa-solid fa-clock w-4 mr-1"></i> ${activity.hours}</p>` : ''}
              <div class="mt-4 flex flex-wrap items-center gap-2">${links.join('')}</div>
            </div>
          </div>
        </details>`;
    }
    
    function renderSuggestions(suggestions) {
        console.log("LOG: renderSuggestions called.");
        const container = $('#suggestions-table-container');
        if (!suggestions || suggestions.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500">×›×œ ×”×›×‘×•×“! ×›×œ ×”×¤×¢×™×œ×•×™×•×ª ×©×•×‘×¦×• ×‘×ª×•×›× ×™×ª.</div>`;
            return;
        }

        const tableRows = suggestions.map(s => `
            <tr class="border-b dark:border-gray-800">
                <td data-label="×©×" class="p-3 font-medium">${s.name}</td>
                <td data-label="×ª×™××•×¨" class="p-3 text-sm text-gray-600 dark:text-gray-400">${s.description}</td>
                <td data-label="×¤×¢×•×œ×•×ª" class="p-3">
                    <div class="flex flex-wrap gap-2 justify-end">
                        <button onclick="window.openAddToDayModal('${s.id}')" class="btn btn-primary btn-sm"><i class="fa-solid fa-plus"></i> ×”×•×¡×£</button>
                        <a href="https://maps.google.com/?q=${s.coords.lat},${s.coords.lon}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-solid fa-map-location-dot"></i> ××¤×”</a>
                    </div>
                </td>
            </tr>
        `).join('');

        container.innerHTML = `
            <table class="w-full text-sm responsive-table">
                <thead class="text-right bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="p-3 font-semibold">×©×</th>
                        <th class="p-3 font-semibold">×ª×™××•×¨</th>
                        <th class="p-3 font-semibold"></th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;
    }

    function isCurrentlyOpen(hoursString) {
        if (!hoursString) return false;
        
        const now = new Date();
        const timeZone = 'Europe/Rome';
        
        const milanParts = new Intl.DateTimeFormat('en-US', {
            timeZone,
            weekday: 'short',
            hour: 'numeric',
            minute: 'numeric',
            hour12: false,
        }).formatToParts(now);

        const milanDayStr = milanParts.find(p => p.type === 'weekday')?.value;
        const hourPart = milanParts.find(p => p.type === 'hour')?.value;
        const minutePart = milanParts.find(p => p.type === 'minute')?.value;
        
        if (!milanDayStr || !hourPart || !minutePart) {
             console.error("Could not determine Milan time");
             return false;
        }

        let currentHour = parseInt(hourPart, 10);
        if (currentHour === 24) currentHour = 0;

        const currentMinute = parseInt(minutePart, 10);
        
        const dayMapEn = {'Sun': 0, 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5, 'Sat': 6};
        const currentDay = dayMapEn[milanDayStr];
        const currentTimeInMinutes = currentHour * 60 + currentMinute;
        
        const dayMapHe = {'×': 0, '×‘': 1, '×’': 2, '×“': 3, '×”': 4, '×•': 5, '×©': 6};

        try {
            const dayEntries = hoursString.split(';').map(s => s.trim());
            for (const entry of dayEntries) {
                const firstSpaceIndex = entry.indexOf(' ');
                if (firstSpaceIndex === -1) continue;

                const daySpec = entry.substring(0, firstSpaceIndex);
                const timeSpec = entry.substring(firstSpaceIndex + 1);

                let applicableDays = [];
                const cleanedDaySpec = daySpec.replace(/'/g, '');
                if (cleanedDaySpec.includes('-')) {
                    const [startChar, endChar] = cleanedDaySpec.split('-');
                    const startDay = dayMapHe[startChar];
                    const endDay = dayMapHe[endChar];
                    if (startDay !== undefined && endDay !== undefined) {
                        for (let i = startDay; i <= endDay; i++) {
                            applicableDays.push(i);
                        }
                    }
                } else {
                    applicableDays = cleanedDaySpec.split(',').map(d => dayMapHe[d]).filter(d => d !== undefined);
                }
                
                const timeRanges = timeSpec.split(',').map(r => r.trim());

                for (const range of timeRanges) {
                    const [startStr, endStr] = range.split('-');
                    if (!startStr || !endStr) continue;

                    const [startH, startM] = startStr.split(':').map(Number);
                    const [endH, endM] = endStr.split(':').map(Number);
                    const startTotalMinutes = startH * 60 + (startM || 0);
                    let endTotalMinutes = endH * 60 + (endM || 0);
                    
                    if (endTotalMinutes < startTotalMinutes) { // Crosses midnight
                        const previousDay = currentDay === 0 ? 6 : currentDay - 1;
                        if (applicableDays.includes(currentDay) && currentTimeInMinutes >= startTotalMinutes) {
                            return true;
                        }
                        if (applicableDays.includes(previousDay) && currentTimeInMinutes < endTotalMinutes) {
                             return true;
                        }
                    } else { // Same day
                        if (applicableDays.includes(currentDay) && currentTimeInMinutes >= startTotalMinutes && currentTimeInMinutes < endTotalMinutes) {
                            return true;
                        }
                    }
                }
            }
        } catch (e) {
            console.error("Error parsing hours string:", hoursString, e);
            return false;
        }

        return false;
    }

    function renderKosher(filter = 'all') {
        console.log(`LOG: renderKosher called with filter: ${filter}`);
        let allKosher = [...kosherData.restaurants, ...kosherData.markets];
        
        if (userCoords) {
            allKosher.forEach(k => k.distance = haversineKm(userCoords.lat, userCoords.lon, k.coords.lat, k.coords.lon));
            allKosher.sort((a,b) => a.distance - b.distance);
        } else {
            allKosher.forEach(k => delete k.distance);
        }

        const filtered = allKosher.filter(r => {
            if (filter === 'open') return isCurrentlyOpen(r.hours);
            if (filter === 'all') return true;
            const style = r.style.toLowerCase();
            return style.includes(filter.toLowerCase());
        });

        const content = filtered.map(item => (item.style.includes('×‘×©×¨×™') || item.style.includes('×—×œ×‘×™') || item.style.includes('×¤×œ××¤×œ') || item.style.includes('×˜×™×™×§-××•×•×™') ? rowRestaurant(item) : rowMarket(item))).join('');
        $('#kosher-results').innerHTML = `<table class="min-w-full text-sm responsive-table"><tbody>${content || `<tr><td class="p-4 text-center">×œ× × ××¦××• ×ª×•×¦××•×ª.</td></tr>`}</tbody></table>`;
    }

    function renderKosherFilters() {
        console.log("LOG: renderKosherFilters called.");
        const filters = ['all', 'open', '×‘×©×¨×™', '×—×œ×‘×™', '×××¤×™×™×”', '××¨×›×•×œ'];
        const filterLabels = {'all': '×”×›×œ', 'open': '×¤×ª×•×— ×¢×›×©×™×•', '×‘×©×¨×™': '×‘×©×¨×™', '×—×œ×‘×™': '×—×œ×‘×™', '×××¤×™×™×”': '×××¤×™×™×”', '××¨×›×•×œ': '××¨×›×•×œ'};
        $('#kosher-filters').innerHTML = filters.map(f => `<button class="kosher-filter-btn btn btn-ghost" data-filter="${f}">${filterLabels[f]}</button>`).join('');
        $$('.kosher-filter-btn').forEach(btn => btn.addEventListener('click', e => {
            const currentFilter = e.target.dataset.filter;
            console.log(`LOG: Kosher filter button clicked: ${currentFilter}`);
            renderKosher(currentFilter);
            $$('.kosher-filter-btn').forEach(b => b.classList.remove('tab-active'));
            e.target.classList.add('tab-active');
        }));
        $('.kosher-filter-btn[data-filter="all"]').classList.add('tab-active');
    }

    const rowRestaurant = r => {
        const logoSrc = r.logo || placeholderLogoUrl(r.name);
        return `
        <tr class="align-top border-b dark:border-gray-800">
            <td data-label="×œ×•×’×•" class="p-3 logo-cell"><img class="logo" src="${logoSrc}" alt="${r.name}" onerror="this.onerror=null;this.src='${placeholderLogoUrl(r.name)}';"></td>
            <td data-label="×©×" class="p-3 font-medium">${r.name} <span class="text-xs font-normal text-gray-500">${r.distance ? formatKm(r.distance) : ''}</span></td>
            <td data-label="×¡×’× ×•×Ÿ" class="p-3">${r.style}</td>
            <td data-label="×©×¢×•×ª" class="p-3 text-xs">${r.hours || ''}</td>
            <td data-label="×¤×¢×•×œ×•×ª" class="p-3">
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.openAddToDayModal('${r.name}', 'kosher')" class="btn btn-primary btn-sm" title="×”×•×¡×£ ×œ×™×•×"><i class="fa-solid fa-plus"></i></button>
                    ${r.phone ? `<a title="×”×ª×§×©×¨" href="tel:${r.phone}" class="btn btn-ghost btn-sm"><i class="fa-solid fa-phone"></i></a>`:''}
                    <a title="Waze" href="https://waze.com/ul?q=${encodeURIComponent(r.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-waze"></i></a>
                    <a title="Google Maps" href="https://maps.google.com/?q=${encodeURIComponent(r.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-google"></i></a>
                    ${r.menu ? `<a href="${r.menu}" target="_blank" class="btn btn-ghost btn-sm" title="×ª×¤×¨×™×˜"><i class="fa-solid fa-utensils"></i></a>`:''}
                    ${r.website ? `<a href="${r.website}" target="_blank" class="btn btn-ghost btn-sm" title="××ª×¨"><i class="fa-solid fa-globe"></i></a>`:''}
                    ${r.instagram ? `<a title="××™× ×¡×˜×’×¨×" href="${r.instagram}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-instagram"></i></a>`:''}
                </div>
            </td>
        </tr>`;
    };
    const rowMarket = m => {
        const logoSrc = m.logo || placeholderLogoUrl(m.name);
        return `
        <tr class="align-top border-b dark:border-gray-800">
            <td data-label="×œ×•×’×•" class="p-3 logo-cell"><img class="logo" src="${logoSrc}" alt="${m.name}" onerror="this.onerror=null;this.src='${placeholderLogoUrl(m.name)}';"></td>
            <td data-label="×©×" class="p-3 font-medium">${m.name} <span class="text-xs font-normal text-gray-500">${m.distance ? formatKm(m.distance) : ''}</span></td>
            <td data-label="×¡×•×’" class="p-3">${m.style}</td>
            <td data-label="×©×¢×•×ª" class="p-3 text-xs">${m.hours || ''}</td>
            <td data-label="×¤×¢×•×œ×•×ª" class="p-3">
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.openAddToDayModal('${m.name}', 'kosher')" class="btn btn-primary btn-sm" title="×”×•×¡×£ ×œ×™×•×"><i class="fa-solid fa-plus"></i></button>
                    ${m.phone ? `<a title="×”×ª×§×©×¨" href="tel:${m.phone}" class="btn btn-ghost btn-sm"><i class="fa-solid fa-phone"></i></a>`:''}
                    <a title="Waze" href="https://waze.com/ul?q=${encodeURIComponent(m.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-waze"></i></a>
                    <a title="Google Maps" href="https://maps.google.com/?q=${encodeURIComponent(m.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-google"></i></a>
                    ${m.website ? `<a href="${m.website}" target="_blank" class="btn btn-ghost btn-sm" title="××ª×¨"><i class="fa-solid fa-globe"></i></a>`:''}
                    ${m.instagram ? `<a title="××™× ×¡×˜×’×¨×" href="${r.instagram}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-instagram"></i></a>`:''}
                </div>
            </td>
        </tr>`;
    };

    function renderChecklist(checklistData) {
        console.log("LOG: renderChecklist called.");
        const container = $('#checklist-container');
        const categorySelect = $('#category-select');
        container.innerHTML = '';
        categorySelect.innerHTML = '<option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”...</option>';
        (checklistData || []).forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat.category}">${cat.category}</option>`;
            let catHtml = `<div class="space-y-2"><h4 class="font-bold">${cat.category}</h4>`;
            (cat.items || []).forEach(item => {
                catHtml += `<label class="flex items-center gap-2">
                    <input type="checkbox" data-id="${item.id}" ${item.done ? 'checked' : ''} onchange="window.toggleChecklistItem(event)">
                    <span class="${item.done ? 'line-through text-gray-500' : ''}">${item.text}</span>
                    <button class="text-red-500 mr-auto hover:text-red-700 text-xs" onclick="window.removeChecklistItem('${cat.id}', '${item.id}')"><i class="fa-solid fa-trash"></i></button>
                </label>`;
            });
            container.innerHTML += catHtml + '</div>';
        });
    }

    async function fetchWeather() {
        console.log("LOG: fetchWeather called.");
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=45.46&longitude=9.19&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe/Berlin&forecast_days=7`);
            const data = await res.json();
            if (data.error) throw new Error(data.reason);
            lastWeatherAPIData = data; // Cache weather data
            console.log("LOG: Weather data fetched successfully.");
            checkWeatherAlerts();
             const iconMap = {
                0: 'fa-sun', 1: 'fa-cloud-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud',
                45: 'fa-smog', 48: 'fa-smog',
                51: 'fa-cloud-rain', 53: 'fa-cloud-rain', 55: 'fa-cloud-rain',
                56: 'fa-snowflake', 57: 'fa-snowflake',
                61: 'fa-cloud-showers-heavy', 63: 'fa-cloud-showers-heavy', 65: 'fa-cloud-showers-heavy',
                66: 'fa-snowflake', 67: 'fa-snowflake',
                71: 'fa-snowflake', 73: 'fa-snowflake', 75: 'fa-snowflake', 77: 'fa-snowflake',
                80: 'fa-cloud-showers-heavy', 81: 'fa-cloud-showers-heavy', 82: 'fa-cloud-showers-heavy',
                85: 'fa-snowflake', 86: 'fa-snowflake',
                95: 'fa-cloud-bolt', 96: 'fa-cloud-bolt', 99: 'fa-cloud-bolt'
            };
            $('#weather-forecast').innerHTML = data.daily.time.slice(0, 5).map((day, i) => `
                <div class="flex justify-between items-center text-sm">
                    <span>${new Date(day).toLocaleDateString('he-IL', { weekday: 'short' })}</span>
                    <span><i class="fa-solid ${iconMap[data.daily.weathercode[i]] || 'fa-question-circle'}"></i></span>
                    <span>${Math.round(data.daily.temperature_2m_min[i])}Â°/${Math.round(data.daily.temperature_2m_max[i])}Â°</span>
                </div>`).join('');
            
            const todayTempMax = data.daily.temperature_2m_max[0];
            const todayWeatherCode = data.daily.weathercode[0];
            let recommendation = '';
            if (((todayWeatherCode >= 71 && todayWeatherCode <= 86) || (todayWeatherCode >= 56 && todayWeatherCode <= 67)) && todayTempMax < 5) {
                recommendation = '×¦×¤×•×™ ×©×œ×’/××–×’ ××•×•×™×¨ ×§×¤×•×. ×”×ª×œ×‘×©×• ×—× ×××•×“!';
            } 
            else if ((todayWeatherCode >= 51 && todayWeatherCode <= 67) || (todayWeatherCode >= 80 && todayWeatherCode <= 82)) {
                recommendation = '×¦×¤×•×™ ×’×©×. ××•××œ×¥ ×œ×§×—×ª ××˜×¨×™×” ×•×¢×œ×™×•× ×™×ª.';
            } 
            else if (todayWeatherCode >= 95) {
                 recommendation = '×¦×¤×•×™×” ×¡×•×¤×ª ×¨×¢××™×. ××•××œ×¥ ×œ××¦×•× ××—×¡×”.';
            }
            else if (todayTempMax > 28) {
                recommendation = '×—×! ××•××œ×¥ ×œ×‘×•×© ×§×¦×¨, ×›×•×‘×¢ ×•×”×¨×‘×” ××™×.';
            } else if (todayTempMax > 20) {
                recommendation = '××–×’ ××•×•×™×¨ × ×¢×™×, ×œ×‘×•×© ×§×¦×¨ ××• ××¨×•×š ×•×“×§ ×™×ª××™×.';
            } else if (todayTempMax > 12) {
                recommendation = '×§×¨×™×¨, ××•××œ×¥ ×œ×‘×•×© ××¨×•×š ×•×¢×œ×™×•× ×™×ª / ×–×³×§×˜ ×§×œ.';
            } else {
                recommendation = '×§×¨, ××•××œ×¥ ×œ×”×ª×œ×‘×© ×—× ×¢× ××¢×™×œ ×•×›×•×‘×¢.';
            }
            $('#weather-attire-recommendation').innerHTML = `<i class="fa-solid fa-shirt mr-2"></i> ${recommendation}`;

        } catch (e) { 
            console.error("ERROR: Failed to fetch weather.", e);
            $('#weather-forecast').innerHTML = `<p class="text-xs text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×—×–×™×ª. ${e.message}</p>`; 
        }
    }

    async function fetchExchangeRate() {
        console.log("LOG: fetchExchangeRate called.");
        try {
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
            const data = await response.json();
            if(data && data.rates && data.rates.ILS) {
                eurToIlsRate = data.rates.ILS;
                $('#exchange-rate-display').textContent = `×©×¢×¨ × ×•×›×—×™: 1â‚¬ = ${eurToIlsRate.toFixed(3)}â‚ª`;
                console.log(`LOG: Exchange rate updated: 1 EUR = ${eurToIlsRate} ILS`);
            }
        } catch (error) {
            console.error("ERROR: Could not fetch exchange rate:", error);
             $('#exchange-rate-display').textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×©×¢×¨ ×—×œ×™×¤×™×Ÿ.';
        }
    }
    
    function renderDocuments(documents = []) {
        console.log("LOG: renderDocuments called.");
        const grid = $('#documents-grid');
        grid.innerHTML = (documents || []).map(doc => `
            <div class="relative bg-gray-100 dark:bg-gray-800 rounded-lg flex flex-col items-center justify-center p-2 text-center">
                 <a href="${doc.dataUrl}" download="${doc.name}" class="flex flex-col items-center justify-center w-full h-full">
                    <i class="fa-solid fa-file-pdf fa-3x text-red-500"></i>
                    <span class="text-xs mt-2 break-all">${doc.name}</span>
                </a>
                <button class="delete-btn" onclick="window.removeDocument('${doc.id}')">Ã—</button>
            </div>`).join('');
    }

    function renderGallery(gallery = []) {
        console.log("LOG: renderGallery called.");
        const grid = $('#gallery-grid');
        grid.innerHTML = (gallery || []).map(img => `<div class="relative aspect-square">
            <img src="${img.dataUrl}" class="w-full h-full object-cover rounded-lg">
            <button class="delete-btn" onclick="window.removeImage('${img.id}')">Ã—</button>
        </div>`).join('');
    }

    function calculateEstimatedCosts(plan) {
        let totalCost = 0;
        if (!plan) return 0;
        Object.values(plan).forEach(day => {
            (day.activities || []).forEach(activity => {
                if(activity.cost) {
                    totalCost += activity.cost;
                }
            });
        });
        return totalCost * 2; // For a couple
    }

    function renderBudget(data) {
        console.log("LOG: renderBudget called.");
        const { totalBudget = 0, expenses = [], plan, settings = { includeEstimatedCostsInBalance: true } } = data || {};
        
        const totalBudgetInput = $('#total-budget');
        if (document.activeElement !== totalBudgetInput) {
             totalBudgetInput.value = totalBudget || '';
        }

        const includeEstimated = $('#include-estimated-costs');
        includeEstimated.checked = settings.includeEstimatedCostsInBalance;

        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        const estimatedCosts = calculateEstimatedCosts(plan);
        const balance = totalBudget - totalExpenses - (includeEstimated.checked ? estimatedCosts : 0);

        $('#total-expenses').textContent = totalExpenses.toFixed(2) + 'â‚¬';
        $('#estimated-costs').textContent = estimatedCosts.toFixed(2) + 'â‚¬';
        $('#budget-balance').textContent = balance.toFixed(2) + 'â‚¬';

        $('#expense-list').innerHTML = (expenses || []).map(exp => 
            `<div class="flex justify-between items-center py-1 group">
                <span>${exp.desc} <span class="text-xs text-gray-400">${exp.category}</span></span>
                <span class="flex items-center gap-2">
                    ${exp.amount.toFixed(2)}â‚¬
                   <button class="text-red-400 hover:text-red-600 transition-opacity" onclick="window.removeExpense('${exp.id}')">
    <i class="fa-solid fa-trash-alt fa-xs"></i>
      </button>
                </span>
            </div>`
        ).join('');
        
        renderBudgetChart(expenses);
    }
    
    function renderBudgetChart(expenses) {
        const ctx = $('#budget-chart').getContext('2d');
        const placeholder = $('#budget-chart-placeholder');
        const legendContainer = $('#budget-chart-legend');
        if (!ctx) return;

        const categoryTotals = (expenses || []).reduce((acc, exp) => {
            acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
            return acc;
        }, {});

        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const backgroundColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];

        if (budgetChartInstance) {
            budgetChartInstance.destroy();
        }
        
        legendContainer.innerHTML = '';
        if (labels.length === 0) {
            placeholder.classList.remove('hidden');
            return;
        }
        placeholder.classList.add('hidden');

        budgetChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderColor: 'var(--card)',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    title: { display: false },
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Generate custom legend
        legendContainer.innerHTML = `<h4 class="text-center font-bold mb-2">×¤×™×¨×•×˜ ×”×•×¦××•×ª</h4>`;
        labels.forEach((label, index) => {
            const amount = categoryTotals[label];
            const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(0) : 0;
            const color = backgroundColors[index % backgroundColors.length];
            legendContainer.innerHTML += `
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-sm" style="background-color: ${color};"></span>
                        <span>${label}</span>
                    </div>
                    <span class="font-semibold">${amount.toFixed(2)}â‚¬ (${percentage}%)</span>
                </div>
            `;
        });
    }

    // --- NEW: Open Food Facts Lookup Function (Kosher Check) ---
async function checkKosherStatus(barcode) {
    showAlert('×‘×•×“×§ ×›×©×¨×•×ª...', `<div class="text-center"><i class="fa-solid fa-sync fa-spin fa-2x"></i><p class="mt-2">××—×¤×© ×‘×¨×§×•×“ **${barcode}** ×‘-Open Food Facts...</p></div>`);

    const url = `https://world.openfoodfacts.org/api/v2/product/${barcode}.json`;
    // --- ×”×•×¡×¤×”: ×§×™×©×•×¨ ×œ××™××•×ª ×™×“× ×™ ---
    const verificationLink = `\n\n<a href="https://world.openfoodfacts.org/product/${barcode}" target="_blank" class="text-sm text-brand-500 hover:underline">×œ×—×¥ ×›××Ÿ ×œ××™××•×ª ×™×“× ×™ ×‘-Open Food Facts</a>`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 0) {
            showAlert('×œ× × ××¦× ××•×¦×¨', `×”×‘×¨×§×•×“ **${barcode}** ×œ× × ××¦× ×‘×××’×¨.` + verificationLink);
            return;
        }

        const product = data.product;
        const productName = product.product_name_he || product.product_name_en || product.product_name || '×©× ×œ× ×™×“×•×¢';
        const labels = product.labels_tags || [];
        
        let kosherFound = labels.some(tag => tag.includes('kosher'));
        let summary = `**×©× ×”××•×¦×¨:** ${productName}\n\n`;

        if (kosherFound) {
            summary += 'âœ… **×›×©×¨×•×ª:** × ×¨××” ×©×”×ª×•×•×™×ª "×›×©×¨" ××•×¤×™×¢×” ×‘×¨×©×•××•×ª ×”××•×¦×¨.\n';
            summary += '***×©×™××• ×œ×‘!*** ×™×© ×œ×•×•×“× ×—×•×ª××ª ×›×©×¨×•×ª ××•×›×¨×ª ×¢×œ ×”××•×¦×¨ ×¢×¦××•.\n';
        } else {
            summary += 'âŒ **×›×©×¨×•×ª:** ×”×ª×•×•×™×ª "×›×©×¨" ×œ× × ××¦××” ×‘×¨×©×•××•×ª ×©×œ ××•×¦×¨ ×–×”.\n';
        }
        
        summary += verificationLink; // ×”×•×¡×¤×ª ×”×§×™×©×•×¨ ×‘×¡×•×£ ×”×”×•×“×¢×”
        
        showAlert(`×ª×•×¦××•×ª ×¡×¨×™×§×ª ×›×©×¨×•×ª`, summary, true);

    } catch (error) {
        console.error("Error in Open Food Facts lookup:", error);
        showAlert('×©×’×™××”', '×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª Open Food Facts.' + verificationLink);
    }
}

    function renderTranslationHistory() {
        console.log("LOG: renderTranslationHistory called.");
        const container = $('#translation-history');
        if (translationHistory.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400">×”×™×¡×˜×•×¨×™×™×ª ×ª×¨×’×•××™×</div>`;
            return;
        }
        container.innerHTML = translationHistory.map((item, index) => `
            <div class="p-1.5 bg-gray-100 dark:bg-gray-800 rounded-md flex justify-between items-center group">
                <div class="cursor-pointer flex-grow" onclick="window.reuseTranslation(${index})">
                    <div class="font-medium">${item.sourceText}</div>
                    <div class="text-gray-500">${item.translatedText}</div>
                </div>
                <button class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity ml-2 p-1" onclick="window.removeTranslationHistoryItem(event, ${index})">
                    <i class="fa-solid fa-trash-alt fa-xs"></i>
                </button>
            </div>
        `).join('');
    }



    // ========================= ×”×ª×—×œ×”: ×¤×•× ×§×¦×™×™×ª ×©×¢×•× ×™× =========================
function updateClocks() {
    const milanTimeEl = $('#milan-time');
    const israelTimeEl = $('#israel-time');

    if (milanTimeEl && israelTimeEl) {
        const now = new Date();
        milanTimeEl.textContent = now.toLocaleTimeString('he-IL', { timeZone: 'Europe/Rome', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        israelTimeEl.textContent = now.toLocaleTimeString('he-IL', { timeZone: 'Asia/Jerusalem', hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
}
    // ========================= ×”×ª×—×œ×”: ×¤×•× ×§×¦×™×” ×œ×©×œ×™×¤×ª ×–×× ×™ ×”×™×•× =========================
async function fetchZmanim() {
    const container = $('#zmanim-container');
    try {
        const response = await fetch('https://www.hebcal.com/zmanim?cfg=json&latitude=45.46&longitude=9.19&tzid=Europe/Rome');
        const data = await response.json();
        const formatTime = (isoTime) => new Date(isoTime).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        
        const now = new Date();
        const alos = new Date(data.times.alotHaShachar);
        const chatzot = new Date(data.times.chatzot); 
        const shkia = new Date(data.times.sunset);
        
        let tefilaRelevant = '';
        let tefilaKey = '';
        if (now >= alos && now < chatzot) {
            tefilaRelevant = '×©×—×¨×™×ª';
            tefilaKey = 'shacharit';
        } else if (now >= chatzot && now < shkia) {
            tefilaRelevant = '×× ×—×”';
            tefilaKey = 'mincha';
        } else {
            tefilaRelevant = '×¢×¨×‘×™×ª';
            tefilaKey = 'arvit';
        }
        
        // ×”×•×¤×š ××ª ×”×ª×¤×™×œ×” ×”×¨×œ×•×•× ×˜×™×ª ×œ×›×¤×ª×•×¨ ×œ×—×™×¥
        const tefilaHtml = `<div id="relevant-tefila-btn" data-tefila-key="${tefilaKey}" class="p-2 mt-3 bg-blue-50 dark:bg-blue-900 rounded-lg text-center font-bold cursor-pointer hover:bg-blue-100 transition-colors">
            <i class="fa-solid fa-hands-praying mr-2"></i> ×œ×—×¥ ×œ×¦×¤×™×™×”: ${tefilaRelevant}
        </div>`;

        container.innerHTML = tefilaHtml + `
            <div class="grid grid-cols-2 gap-1 text-right pt-2 border-t dark:border-gray-700 mt-2">
                <span>×¢×œ×•×ª ×”×©×—×¨:</span> <span class="font-semibold text-left">${formatTime(data.times.alotHaShachar)}</span>
                <span>×–×¨×™×—×”:</span> <span class="font-semibold text-left">${formatTime(data.times.sunrise)}</span>
                <span>×¡×•×£ ×–××Ÿ ×§"×©:</span> <span class="font-semibold text-left">${formatTime(data.times.sofZmanShma)}</span>
                <span>×¡×•×£ ×–××Ÿ ×ª×¤×™×œ×”:</span> <span class="font-semibold text-left">${formatTime(data.times.sofZmanTfilla)}</span>
                <span>×—×¦×•×ª ×”×™×•×:</span> <span class="font-semibold text-left">${formatTime(data.times.chatzot)}</span>
                <span>×©×§×™×¢×”:</span> <span class="font-semibold text-left">${formatTime(data.times.sunset)}</span>
            </div>
        `;
        
        // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ×›×¤×ª×•×¨ ×”×ª×¤×™×œ×” ×”×—×“×©
        const relevantTefilaBtn = $('#relevant-tefila-btn');
        if (relevantTefilaBtn) {
            relevantTefilaBtn.addEventListener('click', () => {
                const key = relevantTefilaBtn.getAttribute('data-tefila-key');
                const prayerText = hebrewPrayers[key];
                showAlert(`×–××Ÿ ×œ×ª×¤×™×œ×ª ${tefilaRelevant}`, prayerText, true, { text: prayerText });
            });
        }
    } catch (e) {
        container.innerHTML = '×©×’×™××” ×‘×˜×¢×™× ×ª ×–×× ×™×';
        console.error("Error fetching zmanim:", e);
    }
}
// ========================= ×¡×•×£: ×¤×•× ×§×¦×™×™×ª ×©×¢×•× ×™× =========================
// ========================= ×”×ª×—×œ×”: ×¤×•× ×§×¦×™×™×ª ×—×™×¤×•×© ××”×™×¨ =========================
function findUtility(query, queryHebrew) {
    // ×”×•×¡×¤×ª "open now" ×œ×—×™×¤×•×© ×›×“×™ ×œ×¡× ×Ÿ ×ª×•×¦××•×ª
    const searchQuery = `${query} open now`;

    showAlert('×××ª×¨ ××™×§×•×...', `××—×¤×© ${queryHebrew} ×©×¤×ª×•×—×™× ×›×¢×ª ×‘×§×¨×‘×ª×š...`);
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}&ll=${latitude},${longitude}`;
            window.open(url, '_blank');
            window.closeModal();
        }, () => {
            // Fallback in case of location error
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}+near+Milan+Cathedral`;
            window.open(url, '_blank');
            showAlert('×©×’×™××ª ××™×§×•×', '×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ××™×§×•××š. ×”×—×™×¤×•×© ×™×ª×‘×¦×¢ ×××¨×›×– ××™×œ×× ×•.');
        });
    } else {
        showAlert('×©×’×™××”', '×©×™×¨×•×ª×™ ××™×§×•× ××™× × × ×ª××›×™× ×‘×“×¤×“×¤×Ÿ ×–×”.');
    }
}

    // ========================= ×”×ª×—×œ×”: ×œ×•×’×™×§×” ×œ×¢×•×–×¨ ×”××˜×¨×• =========================
function initMetroHelper() {
    const metroData = {
        M1: { name: 'M1', color: '#E4001A', stops: { 'Duomo': '×§×ª×“×¨×œ×ª ×”×“×•××•××•, ×’×œ×¨×™×” ×•×™×˜×•×¨×™×•', 'Cadorna': '×˜×™×¨×ª ×¡×¤×•×¨×¦×”, ×¤××¨×§ ×¡××¤×™×•× ×”', 'San Babila': '××¨×•×‘×¢ ×”××•×¤× ×”' } },
        M2: { name: 'M2', color: '#009B4E', stops: { 'Centrale FS': '×ª×—× ×” ××¨×›×–×™×ª (×¨×›×‘×•×ª ×œ××’××™×)', 'Garibaldi FS': '×¤×™××¦×” ×’××” ×××•×œ× ×˜×™, ×‘×•×¡×§×• ×•×¨×˜×™×§×œ×”' } },
        M3: { name: 'M3', color: '#FFD200', stops: { 'Duomo': '×§×ª×“×¨×œ×ª ×”×“×•××•××•', 'Centrale FS': '×ª×—× ×” ××¨×›×–×™×ª' } },
        M5: { name: 'M5', color: '#6E2C91', stops: { 'San Siro Stadio': '××¦×˜×“×™×•×Ÿ ×¡×Ÿ ×¡×™×¨×•', 'Garibaldi FS': '×¤×™××¦×” ×’××” ×××•×œ× ×˜×™' } }
    };

    const linesContainer = $('#metro-lines-container');
    const infoContainer = $('#metro-line-info');

    Object.keys(metroData).forEach(key => {
        const line = metroData[key];
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm font-bold';
        btn.textContent = line.name;
        btn.style.backgroundColor = line.color;
        btn.style.color = '#fff';
        btn.onclick = () => {
            $$('#metro-lines-container button').forEach(b => b.classList.remove('ring-2', 'ring-offset-2', 'dark:ring-offset-gray-900', 'ring-blue-500'));
            btn.classList.add('ring-2', 'ring-offset-2', 'dark:ring-offset-gray-900', 'ring-blue-500');

            let infoHtml = `<h4 class="font-bold text-lg" style="color:${line.color};">×ª×—× ×•×ª ××¨×›×–×™×•×ª ×‘×§×• ${line.name}</h4>`;
            for(const stop in line.stops) {
                infoHtml += `<div><b class="font-semibold">${stop}:</b> ${line.stops[stop]}</div>`;
            }
            infoContainer.innerHTML = infoHtml;
        };
        linesContainer.appendChild(btn);
    });
}
// ========================= ×¡×•×£: ×œ×•×’×™×§×” ×œ×¢×•×–×¨ ×”××˜×¨×• =========================
    // ========================= ×”×ª×—×œ×”: ×œ×•×’×™×§×” ×œ×¡×§×¨××¤×‘×•×§ =========================
function renderScrapbook() {
    const container = $('#scrapbook-container');
    if (!localTripData.plan) {
        container.innerHTML = '<p class="text-center">×¢×“×™×™×Ÿ ××™×Ÿ ×ª×•×›× ×™×ª ×˜×™×•×œ.</p>';
        return;
    }

    let scrapbookHtml = '';
    const sortedDays = Object.entries(localTripData.plan).sort((a, b) => a[0].localeCompare(b[0]));

    for (const [dayId, dayData] of sortedDays) {
        const journalEntries = (localTripData.journal && localTripData.journal[dayId]) || [];
        const galleryImages = (localTripData.gallery && localTripData.gallery[dayId]) || [];

        scrapbookHtml += `
        <div class="bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2">${dayData.name}</h3>

            <h4 class="font-semibold mt-4 mb-2">×”×™×•××Ÿ ×©×œ×™:</h4>
            ${journalEntries.length > 0 ? journalEntries.map(entry => `<p class="text-sm mb-2 p-2 bg-gray-50 dark:bg-gray-900 rounded-md">${entry.text}</p>`).join('') : '<p class="text-xs text-gray-500">×œ× × ×›×ª×‘×• ×¨×©×•××•×ª ×‘×™×•××Ÿ ×œ×™×•× ×–×”.</p>'}

            <h4 class="font-semibold mt-4 mb-2">×”×ª××•× ×•×ª ×©×œ×™:</h4>
            ${galleryImages.length > 0 ? `
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    ${galleryImages.map(img => `<img src="${img.dataUrl}" class="w-full h-32 object-cover rounded-lg">`).join('')}
                </div>` : '<p class="text-xs text-gray-500">×œ× ×”×•×¢×œ×• ×ª××•× ×•×ª ×œ×™×•× ×–×”.</p>'}
        </div>
        `;
    }
    container.innerHTML = scrapbookHtml || '<p class="text-center">×”×™×•××Ÿ ×¨×™×§. ×”×ª×—×™×œ×• ×œ×”×•×¡×™×£ ×¨×©×•××•×ª ×•×ª××•× ×•×ª!</p>';
}
// ========================= ×¡×•×£: ×œ×•×’×™×§×” ×œ×¡×§×¨××¤×‘×•×§ =========================
    // ========================= ×”×ª×—×œ×”: ×¤×•× ×§×¦×™×” ×œ×”×ª×¨××•×ª ××–×’ ××•×•×™×¨ ×—×›××•×ª =========================
async function checkWeatherAlerts() {
    if (!lastWeatherAPIData || !localTripData.plan) return;

    const alertBox = $('#weather-alert-box');
    alertBox.innerHTML = ''; // × ×™×§×•×™ ×”×ª×¨××•×ª ×™×©× ×•×ª

    // ×§×•×“×™× ×©×œ ××–×’ ××•×•×™×¨ ×’×¨×•×¢ (×’×©×, ×¡×•×¤×•×ª ×¨×¢××™×)
    const badWeatherCodes = [51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99];

    // ××¦×™××ª ×”×ª××¨×™×š ×©×œ ××—×¨
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowString = tomorrow.toISOString().split('T')[0];

    // ××¦×™××ª ×”××™× ×“×§×¡ ×©×œ ××—×¨ ×‘×ª×—×–×™×ª (×‘×“×¨×š ×›×œ×œ 1)
    const tomorrowIndex = lastWeatherAPIData.daily.time.findIndex(day => day === tomorrowString);
    if (tomorrowIndex === -1) return; // ×œ× × ××¦××” ×ª×—×–×™×ª ×œ××—×¨

    const tomorrowsWeatherCode = lastWeatherAPIData.daily.weathercode[tomorrowIndex];

    // ×‘×“×™×§×” ×× ××–×’ ×”××•×•×™×¨ ×©×œ ××—×¨ ×’×¨×•×¢
    if (badWeatherCodes.includes(tomorrowsWeatherCode)) {
        // ××¦×™××ª ×”×ª×•×›× ×™×ª ×©×œ ××—×¨
        const tripStartDate = new Date(tripMeta.flights.inbound.date);
        const diffTime = Math.abs(tomorrow - tripStartDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const planKey = `day${diffDays}`;

        if (localTripData.plan[planKey]) {
            const tomorrowsPlan = localTripData.plan[planKey];
            const outdoorActivities = tomorrowsPlan.activities.filter(act => {
                const originalAttraction = attractions[act.id.split('_')[0]];
                return originalAttraction && originalAttraction.isOutdoor;
            });

            if (outdoorActivities.length > 0) {
                const activityNames = outdoorActivities.map(act => act.name).join(', ');
                const alertMessage = `
                    <div class="bg-yellow-100 dark:bg-yellow-900/30 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300 p-3 rounded-lg">
                        <p class="font-bold">×”×ª×¨××” ×—×›××” ×œ××—×¨!</p>
                        <p class="text-sm">×¦×¤×•×™ ×’×©× ××—×¨, ×•×”×ª×•×›× ×™×ª ×©×œ×›× ×›×•×œ×œ×ª ×¤×¢×™×œ×•×™×•×ª ×‘×—×•×¥ (${activityNames}). ××•×œ×™ ×›×“××™ ×œ×©×§×•×œ ×œ×”×—×œ×™×£ ××•×ª×Ÿ ×‘×¤×¢×™×œ×•×ª ×××××’×¨ ×”×”×¦×¢×•×ª.</p>
                    </div>
                `;
                alertBox.innerHTML = alertMessage;
            }
        }
    }
}
    // ========================= ×”×ª×—×œ×”: ×¤×•× ×§×¦×™×” ×œ××—×©×‘×•×Ÿ ×›×“××™×•×ª Pass =========================
function initPassCalculator() {
    const passes = {
        duomoPass: { name: 'Duomo Pass (×’×’ + ××•×–×™××•×Ÿ)', price: 20, keys: ['duomo'] },
        milanoCard: { name: 'MilanoCard (3 ×™××™×)', price: 15.50, keys: ['transport'] } // ××—×™×¨ ×ª×—×‘"×¦ ×‘×œ×‘×“
    };

    const attractionsList = $('#pass-attractions-list');
    const plannedAttractionKeys = Object.values(localTripData.plan || {}).flatMap(day => day.activities.map(act => act.id.split('_')[0]));

    let attractionsHtml = '';
    for (const key in attractions) {
        if (attractions[key].cost > 0) {
            const isChecked = plannedAttractionKeys.includes(key) ? 'checked' : '';
            attractionsHtml += `
                <label class="flex items-center gap-2">
                    <input type="checkbox" class="pass-attraction-checkbox rounded" value="${attractions[key].cost}" data-key="${key}" ${isChecked}>
                    ${attractions[key].name} (${attractions[key].cost}â‚¬)
                </label>
            `;
        }
    }
    attractionsList.innerHTML = attractionsHtml;

    let passInfoHtml = '';
    for (const passKey in passes) {
        passInfoHtml += `<div>${passes[passKey].name} - <b>${passes[passKey].price.toFixed(2)}â‚¬</b></div>`;
    }
    $('#pass-options-info').innerHTML = passInfoHtml;

    $('#calculate-pass-btn').addEventListener('click', () => {
        let individualCost = 0;
        const selectedKeys = [];
        $$('.pass-attraction-checkbox:checked').forEach(cb => {
            individualCost += parseFloat(cb.value);
            selectedKeys.push(cb.dataset.key);
        });

        // × ×•×¡×™×£ ×¢×œ×•×ª ×ª×—×‘"×¦ ×œ-3 ×™××™× ×œ×—×™×©×•×‘ ×”×›×œ×œ×™
        individualCost += passes.milanoCard.price;

        let resultHtml = `×¢×œ×•×ª ××™×©×™×ª ×›×•×œ×œ ×ª×—×‘"×¦: <b class="text-red-500">${individualCost.toFixed(2)}â‚¬</b><br><hr class="my-2">`;

        // ×‘×“×™×§×ª ×›×“××™×•×ª ×œ×“×•××•××• ×¤××¡
        let duomoRelatedCost = 0;
        if (selectedKeys.includes('duomo')) {
            duomoRelatedCost += attractions.duomo.cost;
        }
        // (× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×›××Ÿ ×¢×•×“ ××ª×¨×™× ×©×›×œ×•×œ×™× ×‘×¤××¡)

        if (duomoRelatedCost > passes.duomoPass.price) {
            resultHtml += `<span class="text-green-600">××•××œ×¥ ×œ×§× ×•×ª ××ª ×”-Duomo Pass!</span><br>`;
        } else {
            resultHtml += `<span>×¢×‘×•×¨ ×”×“×•××•Î¼Î¿, ×™×•×ª×¨ ×–×•×œ ×œ×§× ×•×ª ×›×¨×˜×™×¡ ×‘×•×“×“.</span><br>`;
        }

        $('#pass-result').innerHTML = resultHtml;
    });
}
// ========================= ×¡×•×£: ×¤×•× ×§×¦×™×” ×œ××—×©×‘×•×Ÿ ×›×“××™×•×ª Pass =========================
// ========================= ×¡×•×£: ×¤×•× ×§×¦×™×” ×œ×”×ª×¨××•×ª ××–×’ ××•×•×™×¨ ×—×›××•×ª =========================
// ========================= ×¡×•×£: ×¤×•× ×§×¦×™×” ×œ×¢×™×¦×•×‘ ××•×˜×•××˜×™ ×œ×¤×™ ×©×¢×” =========================
// ========================= ×¡×•×£: ×¤×•× ×§×¦×™×” ×œ××“×¨×™×š ×§×•×œ×™ =========================
// ========================= ×¡×•×£: ×¤×•× ×§×¦×™×™×ª ×—×™×¤×•×© ××”×™×¨ =========================
    // --- State Modifiers (Write to Firestore) ---
    async function handleTransportChange(e) {
        const dayId = e.target.dataset.day;
        const newTransportMode = e.target.value;
        console.log(`LOG: handleTransportChange called for ${dayId}, new mode: ${newTransportMode}`);
        await updateDoc(tripDocRef, { [`plan.${dayId}.transport`]: newTransportMode });
    };
    async function removeActivity(dayId, actId) {
        console.log(`LOG: removeActivity called for day ${dayId}, activity ${actId}`);
        const day = localTripData.plan[dayId];
        const activityIndex = day.activities.findIndex(a => a.id === actId);
        if (activityIndex > -1) {
            const [removedActivity] = day.activities.splice(activityIndex, 1);
            let newSuggestions = localTripData.suggestions;
            if (removedActivity.type === 'attraction') {
                 const originalId = actId.split('_')[0];
                 const originalAttraction = attractions[originalId];
                 if (originalAttraction && !newSuggestions.find(s => s.id === originalId)) {
                     newSuggestions.push({ ...originalAttraction, id: originalId });
                 }
            }
            await updateDoc(tripDocRef, {
                plan: localTripData.plan,
                suggestions: newSuggestions
            });
        }
    };
    async function moveActivity(dayId, actId, direction) {
        console.log(`LOG: moveActivity called for ${actId} in day ${dayId}, direction ${direction}`);
        const day = localTripData.plan[dayId];
        const index = day.activities.findIndex(a => a.id === actId);
        if ((direction === -1 && index > 0) || (direction === 1 && index < day.activities.length - 1)) {
            const [item] = day.activities.splice(index, 1);
            day.activities.splice(index + direction, 0, item);
            await updateDoc(tripDocRef, { [`plan.${dayId}.activities`]: day.activities });
        }
    };
    window.navigateCarousel = (btn, dir) => {
        const carousel = btn.closest('.image-carousel');
        const images = JSON.parse(carousel.dataset.images);
        let index = parseInt(carousel.dataset.index, 10);
        index = (index + dir + images.length) % images.length;
        carousel.querySelector('img').src = images[index];
        carousel.dataset.index = index;
    };
function findNearbyAttractions() {
    showAlert('×××ª×¨ ××™×§×•×...', '××—×¤×© ××˜×¨×§×¦×™×•×ª ××•××œ×¦×•×ª ×‘×§×¨×‘×ª×š...');
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            const url = `https://www.google.com/maps/search/tourist+attractions/@${latitude},${longitude},15z`;
            window.open(url, '_blank');
            window.closeModal();
        }, () => {
            showAlert('×©×’×™××ª ××™×§×•×', '×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ××™×§×•××š. ×”×—×™×¤×•×© ×™×ª×‘×¦×¢ ×××¨×›×– ××™×œ×× ×•.');
            const url = `https://www.google.com/maps/search/tourist+attractions/Duomo+di+Milano`;
            window.open(url, '_blank');
        });
    } else {
        showAlert('×©×’×™××”', '×©×™×¨×•×ª×™ ××™×§×•× ××™× × × ×ª××›×™× ×‘×“×¤×“×¤×Ÿ ×–×”.');
    }
}
// And assign it to the window object
window.findNearbyAttractions = findNearbyAttractions;
    window.findNearbyKosher = (btn) => {
        const lat = parseFloat(btn.dataset.lat), lon = parseFloat(btn.dataset.lon);
        console.log(`LOG: findNearbyKosher called for ${btn.dataset.name} at ${lat}, ${lon}`);
        $('#kosher-subtitle').innerHTML = `××¦×™×’ ××§×•××•×ª ×§×¨×•×‘×™× ×œ: <strong>${btn.dataset.name}</strong>`;
        userCoords = {lat, lon}; // Temporarily set user location
        renderKosher();
        userCoords = null; // Reset it
        $('#kosher').scrollIntoView({ behavior: 'smooth' });
        if ($('#kosher-container').classList.contains('hidden')) {
            $('#toggle-kosher-btn').click();
        }
    };
    async function toggleChecklistItem(e) {
        const itemId = e.target.dataset.id;
        const isDone = e.target.checked;
        console.log(`LOG: toggleChecklistItem called for item ${itemId}, new status: ${isDone}`);
        const labelSpan = e.target.nextElementSibling;
        if (isDone) {
            labelSpan.classList.add('line-through', 'text-gray-500');
        } else {
            labelSpan.classList.remove('line-through', 'text-gray-500');
        }

        const updatedChecklist = localTripData.checklist.map(cat => ({
            ...cat,
            items: cat.items.map(item => item.id === itemId ? { ...item, done: isDone } : item)
        }));
        if (tripDocRef) {
           await updateDoc(tripDocRef, { checklist: updatedChecklist });
        }
    };
    async function removeChecklistItem(catId, itemId) {
        console.log(`LOG: removeChecklistItem called for item ${itemId} in category ${catId}`);
        const updatedChecklist = localTripData.checklist.map(cat => {
            if (cat.id === catId) {
                return { ...cat, items: cat.items.filter(i => i.id !== itemId) };
            }
            return cat;
        }).filter(cat => cat.items.length > 0);
        await updateDoc(tripDocRef, { checklist: updatedChecklist });
    };
    
    async function removeExpense(id) {
        console.log(`LOG: removeExpense called for id ${id}`);
        const expenseToRemove = (localTripData.expenses || []).find(exp => exp.id === id);
        if (expenseToRemove) {
            await updateDoc(tripDocRef, { expenses: arrayRemove(expenseToRemove) });
        }
    };
    async function removeDocument(id) {
        console.log(`LOG: removeDocument called for id ${id}`);
        const docToRemove = (localTripData.documents || []).find(doc => doc.id === id);
        if (docToRemove) {
            await updateDoc(tripDocRef, { documents: arrayRemove(docToRemove) });
        }
    };
    async function removeImage(id) {
        console.log(`LOG: removeImage called for id ${id}`);
        const imgToRemove = (localTripData.gallery || []).find(img => img.id === id);
        if (imgToRemove) {
            await updateDoc(tripDocRef, { gallery: arrayRemove(imgToRemove) });
        }
    };
    window.reuseTranslation = (index) => {
        console.log(`LOG: Reusing translation history item at index ${index}`);
        const item = translationHistory[index];
        if (item) {
            $('#dictionary-input').value = item.sourceText;
            $('#dictionary-form').requestSubmit();
        }
    };
    window.removeTranslationHistoryItem = (event, index) => {
        event.stopPropagation(); 
        console.log(`LOG: Removing translation history item at index ${index}`);
        translationHistory.splice(index, 1);
      localStorage.setItem('milanTripTranslationHistory', JSON.stringify(translationHistory));
        renderTranslationHistory();
    };
    window.openDayMap = (dayId) => {
        console.log(`LOG: openDayMap called for ${dayId}`);
        const day = localTripData.plan[dayId];
        if (!day || !day.activities || day.activities.length === 0) {
            showAlert('××™×Ÿ ××™×§×•××™×', '××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×¢× ×›×ª×•×‘×•×ª ×‘×™×•× ×–×” ×›×“×™ ×œ×”×¦×™×’ ×¢×œ ×”××¤×”.');
            return;
        }
        const locations = day.activities
            .map(act => act.address)
            .filter(address => address); 
        
        if (locations.length < 1) {
             showAlert('××™×Ÿ ××™×§×•××™×', '××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×¢× ×›×ª×•×‘×•×ª ×‘×™×•× ×–×” ×›×“×™ ×œ×”×¦×™×’ ×¢×œ ×”××¤×”.');
             return;
        }

        const url = `https://www.google.com/maps/dir/${locations.map(encodeURIComponent).join('/')}`;
        window.open(url, '_blank');
    };

    // --- Camera Functions ---
document.getElementById('camera-close-btn').addEventListener('click', () => cameraManager.stop());
document.getElementById('torch-btn').addEventListener('click', () => cameraManager.toggleTorch());
document.getElementById('zoom-in-btn').addEventListener('click', () => cameraManager.changeZoom(1));
document.getElementById('zoom-out-btn').addEventListener('click', () => cameraManager.changeZoom(-1));

// --------------------------------------------------------------------------
// ×¤×•× ×§×¦×™×” 1: ×¡×•×¨×§ ×‘×¨×§×•×“ (Kosher)
// --------------------------------------------------------------------------
async function startKosherBarcodeScanner() {
    cameraManager.stop();
    
    $('#camera-title').textContent = '×¡×¨×™×§×ª ×›×©×¨×•×ª (×‘×¨×§×•×“)';
    $('#capture-btn').style.display = 'none';
    $('#upload-receipt-btn').style.display = 'none';
    $('#barcode-status-display').style.display = 'block';
    $('#barcode-status-display').textContent = '××¤×¢×™×œ ××¦×œ××”...';

    const video = await cameraManager.open('barcode');
    if (!video) return;

    $('#barcode-status-display').textContent = '××—×¤×© ×‘×¨×§×•×“...';
    // ×”×¤×¢×œ ××ª ×œ×•×œ××ª ×”×¡×¨×™×§×” ×”×—×“×©×”
    cameraManager.startBarcodeDetection();
}
window.startKosherBarcodeScanner = startKosherBarcodeScanner;

// --------------------------------------------------------------------------
// ×¤×•× ×§×¦×™×” 2: ×–×™×”×•×™ ××ª×¨×™× (Lookup)
// --------------------------------------------------------------------------
async function startSiteLookupCamera() {
    cameraManager.stop(); // <-- ×”×•×¡×£ ×©×•×¨×” ×–×•
    $('#camera-title').textContent = '×–×™×”×•×™ ××ª×¨×™×/××•×‘×™×™×§×˜×™×';
    $('#capture-btn').style.display = 'flex';
    $('#barcode-status-display').style.display = 'none';
    await cameraManager.open('lookup');
}

window.startSiteLookupCamera = startSiteLookupCamera;

// --------------------------------------------------------------------------
// ×¤×•× ×§×¦×™×” 3: ×¡×•×¨×§ ×§×‘×œ×•×ª (Receipt)
// --------------------------------------------------------------------------
async function startReceiptScanCamera() {
      cameraManager.stop(); // <-- ×”×•×¡×£ ×©×•×¨×” ×–×•
    $('#camera-title').textContent = '×¡×¨×™×§×ª ×§×‘×œ×”';
    $('#capture-btn').style.display = 'flex';
    $('#upload-receipt-btn').style.display = 'flex';
    $('#barcode-status-display').style.display = 'none';
    await cameraManager.open('receipt');
}
window.startReceiptScanCamera = startReceiptScanCamera;
// --------------------------------------------------------------------------
// ×¤×•× ×§×¦×™×” 4: ×ª×¨×’×•××•×Ÿ (Translate)
// --------------------------------------------------------------------------
async function startTranslateCamera() {
      cameraManager.stop(); // <-- ×”×•×¡×£ ×©×•×¨×” ×–×•
    $('#camera-title').textContent = '×ª×¨×’×•× ×ª×¤×¨×™×˜ / ×˜×§×¡×˜';
    $('#capture-btn').style.display = 'flex';
    $('#upload-receipt-btn').style.display = 'none';
    $('#barcode-status-display').style.display = 'none';
    await cameraManager.open('translate');
}
window.startTranslateCamera = startTranslateCamera;
    

function captureFrame() {
    const currentMode = cameraManager.mode;
    console.log(`Capture button pressed in mode: ${currentMode}`);

    const video = cameraManager.videoElement;
    const canvas = document.getElementById('camera-canvas');
    if (!video || !canvas) return;
    
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
    
    // ×”×¡×¨× ×• ××ª ×¡×’×™×¨×ª ×”××¦×œ××” ××›××Ÿ ×›×“×™ ×œ×©×¤×¨ ××ª ×—×•×•×™×ª ×”××©×ª××©
    
    if (currentMode === 'translate') translateImage(base64, 'image/jpeg');
    else if (currentMode === 'receipt') processReceiptImage(base64);
    else if (currentMode === 'lookup') processLookupImage(base64);
}
window.captureFrame = captureFrame;
// ×©×™× ×•×™ ×‘×¤×•× ×§×¦×™×” processReceiptImage
async function processReceiptImage(base64ImageData) {
    showAlert('××¢×‘×“ ×§×‘×œ×”...', '<div class="text-center"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p class="mt-2">×§×•×¨× ××ª ×”×¤×¨×˜×™× ××”×§×‘×œ×” ×‘×¢×–×¨×ª AI ×•××¡×•×•×’ ××ª ×”×”×•×¦××”...</p></div>');

    // *** ×”×¤×¨×•××¤×˜ ×”××¢×•×“×›×Ÿ ×“×•×¨×© ×©×“×” "category" ***
    const prompt = `You are an expert receipt-scanning AI. Analyze this image of a receipt. Your goal is to identify the final, total amount paid, the name of the store/vendor, and its correct category. Respond ONLY with a valid JSON object in the format {"amount": NUMBER, "description": "STRING", "category": "STRING"}. The category MUST be one of the following Hebrew words: "××•×›×œ", "×§× ×™×•×ª", "×ª×—×‘×•×¨×”", "××˜×¨×§×¦×™×•×ª", or "××—×¨". If you cannot reliably determine all values, return {"error": "Could not read receipt clearly"}.`;
    // ********************************************
    
    const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: 'image/jpeg', data: base64ImageData } }] }] };

    let responseText = await callGemini(payload, '', false);
    
    // ×¡×•×’×¨ ××ª ××•×“×œ ×”××¦×œ××” (×œ×œ× ×§×©×¨ ×œ×ª×•×¦××ª ×”-AI)
    stopCamera();
    
    try {
        const jsonMatch = responseText.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
             throw new Error("JSON block not found in response.");
        }
        const cleanJsonString = jsonMatch[0].trim();
        
        const result = JSON.parse(cleanJsonString);

        // ×‘×“×™×§×•×ª ×ª×§×™× ×•×ª ×œ××—×¨ × ×™×ª×•×— JSON
        if (result.error || isNaN(result.amount) || !result.category) {
            showAlert('×©×’×™××”', '×œ× ×”×¦×œ×—× ×• ×œ×§×¨×•× ××ª ×›×œ ×”×¤×¨×˜×™× (×¡×›×•×, ×ª×™××•×¨ ××• ×§×˜×’×•×¨×™×”) ××”×§×‘×œ×”. × ×¡×• ×©×•×‘ ×‘×ª××•×¨×” ×˜×•×‘×” ×™×•×ª×¨.');
            return;
        }
        
        const expenseDescEl = $('#expense-desc');
        const expenseAmountEl = $('#expense-amount');
        const expenseCategoryEl = $('#expense-category');
        const expenseFormEl = $('#expense-form');
        const submitButton = expenseFormEl.querySelector('button[type="submit"]');

        // 1. ××™×œ×•×™ ×©×“×•×ª ××‘×•×¡×¡ ×¢×œ ×¤×œ×˜ ×”-AI
        const amount = parseFloat(result.amount);
        const description = (result.description || '').trim();
        const category = result.category.trim(); // ××§×‘×œ×™× ××ª ×”×§×˜×’×•×¨×™×” ×™×©×™×¨×•×ª ××”-AI

        expenseAmountEl.value = amount.toFixed(2);
        expenseDescEl.value = description;
        
        // 2. ×”×’×“×¨×ª ×”×§×˜×’×•×¨×™×” ×©× ×©×œ×—×” ××”-AI
        expenseCategoryEl.value = category; 
        
        // 3. ×©×œ×™×—×” ××•×˜×•××˜×™×ª ×©×œ ×”×˜×•×¤×¡
        expenseFormEl.requestSubmit(submitButton);

        // 4. ×”×•×“×¢×ª ××™×©×•×¨
        showAlert('×”×•×¦××” × ×•×¡×¤×”!', `×”×•×¦××” ×©×œ **â‚¬${amount.toFixed(2)}** ×¢×‘×•×¨ **${description}** × ×•×¡×¤×” ×‘×”×¦×œ×—×” ×œ×§×˜×’×•×¨×™×™×ª **${category}**.`);
        
    } catch (e) {
        console.error("Error processing receipt:", e);
        showAlert('×©×’×™××” ×—××•×¨×”', '××™×¨×¢×” ×©×’×™××” ×‘×¢×™×‘×•×“ ×”× ×ª×•× ×™×. ×× × ×”×–×Ÿ ×™×“× ×™×ª.');
    }
}
async function processLookupImage(base64ImageData) {
    // ×”×¦×’×ª ×”×•×“×¢×ª ×˜×¢×™× ×”
    showAlert('××–×”×” ××•×‘×™×™×§×˜...', '<div class="text-center"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p class="mt-2">×× ×ª×— ××ª ×”×ª××•× ×” ×•×©×•×œ×— ×œ×–×™×”×•×™...</p></div>');
    
    const prompt = `You are an AI assistant that responds ONLY in Hebrew. Your task is to identify the landmark, artwork, or object in the provided image. Analyze the image and provide an interesting and detailed paragraph about it. Your entire response must be in Hebrew. If you cannot identify the object, respond with the single Hebrew sentence: '×œ× ×”×¦×œ×—×ª×™ ×œ×–×”×•×ª ××ª ××” ×©×‘×ª××•× ×”.'. Do not include any English words or preambles.`;
    const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: 'image/jpeg', data: base64ImageData } }] }] };
    
    // =================  ×”×ª×™×§×•×Ÿ ×›××Ÿ  =================
    // ×”×—×–×¨× ×• ××ª ×©× ×™ ×”×¤×¨××˜×¨×™× ×”×—×¡×¨×™× ×©×”×™×• ×‘×’×¨×¡×” ×©×¢×‘×“×”
    const description = await callGemini(payload, '', false);
    // ===============================================

    // ××©×ª××©×™× ×‘×§×¨×™××” ×”××¢×•×“×›× ×ª ×œ-showAlert, ×©×”×™× × ×›×•× ×”
    showAlert('×–×™×”×•×™ ××•×‘×™×™×§×˜', description, { text: description, useApi: true });
}



    // --- Gemini Calls ---
// ×§×˜×¢ ×§×•×“ ××ª×•×§×Ÿ ×•××•×•×“× ×‘×ª×•×š callGemini

   // ×—×¤×© ××ª ×”×¤×•× ×§×¦×™×” ×”××œ××” ×©×œ callGemini ×•×”×—×œ×£ ××•×ª×” ×‘×’×¨×¡×” ×–×•:

// ×—×¤×© ××ª ×”×¤×•× ×§×¦×™×” ×”××œ××” ×©×œ callGemini ×•×”×—×œ×£ ××•×ª×” ×‘×’×¨×¡×” ×–×•:

async function callGemini(payload, prompt, useSearch = false) {
    //const API_KEY = "AIzaSyB80v2xdhebJqhjyruJ5Ta0eyhJiq7DsI8"; 
    const API_KEY = "AIzaSyDzQFz_abwcxSwq8VhHCQS-HcsYk_Qug-I";
    const BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models";
    const MODEL_NAME = "gemini-2.5-flash"; 
    const FINAL_URL = `${BASE_URL}/${MODEL_NAME}:generateContent?key=${API_KEY}`;
    
    if (prompt) {
        if (payload.contents && payload.contents.length > 0 && payload.contents[0].parts) {
            payload.contents[0].parts[0].text = prompt;
        }
    }

    // *** ×ª×™×§×•×Ÿ ×¡×•×¤×™ ×•×§×¨×™×˜×™: ×©×™××•×© ×‘-tools ×‘×¨××” ×”×¢×œ×™×•× ×” ×¢× googleSearch ***
    if (useSearch) {
        // ××—×–×™×¨×™× ××ª tools ×œ×¨××” ×”×¢×œ×™×•× ×” (×›×™ config ×œ× × ×ª××š ×‘××•×“×œ ×–×”)
        payload.tools = [{ googleSearch: {} }];
        // ×× ×”×©×“×” config ×§×™×™× ××”× ×™×¡×™×•×Ÿ ×”×§×•×“× - ××•×—×§×™× ××•×ª×•
        if (payload.config) delete payload.config; 
    } else {
        // ×× ×œ× ×¦×¨×™×š ×—×™×¤×•×© - ××•×—×§×™× ××ª tools ×•××ª config (×× ×§×™×™×)
        if (payload.tools) delete payload.tools;
        if (payload.config) delete payload.config;
    }
    // *******************************************************************
    
    try {
        const response = await fetch(FINAL_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (!response.ok) {
            console.error("ERROR: Gemini API response not OK. Result:", result);
            throw new Error(result.error?.message || `×©×’×™××ª ×¨×©×ª: ${response.status}`);
        }
        
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        
        return text || "×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×” ×-Gemini.";

    } catch (error) {
        console.error("ERROR: Gemini API Error:", error);
        return `×©×’×™××”: ${error.message}`;
    }
}
// ×§×•×“ ××ª×•×§×Ÿ ×•××œ× ×©×œ speakText:



// --- ×¡×•×£ ×”×—×œ×¤×ª speakText ---
async function translateText(sourceLang, targetLang) {
    
    // ×©×™××•×© ×‘-IDs ×”× ×›×•× ×™× ××”-HTML
    const textInput = $('#dictionary-input'); 
    const resultContainer = $('#translation-result-container');
    const translateBtn = $('#dictionary-form button[type="submit"]'); 

    // ×”×’×“×¨×•×ª ×˜×¢×™× ×” ×•-disable
    translateBtn.disabled = true;
    resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
    
    const text = textInput.value.trim();
    if (text.length === 0) {
        translateBtn.disabled = false;
        resultContainer.innerHTML = '<span>×”×ª×¨×’×•× ×™×•×¤×™×¢ ×›××Ÿ...</span>';
        return;
    }

    const targetLangCode = currentLang === 'he-it' ? 'Italian' : 'Hebrew';
    const prompt = `Translate the following to ${targetLangCode}. Provide ONLY the translated text, with no additional formatting or explanations. Text to translate: "${text}"`;
    const payload = { contents: [{ parts: [{ text: "" }] }] };
    
    let responseText = await callGemini(payload, prompt, false);
    responseText = responseText.replace(/[\*\_`]/g, '').trim();

    const langCode = currentLang === 'he-it' ? 'it-IT' : 'he-IL';
    
    // 1. ×©××™×¨×” ×‘×”×™×¡×˜×•×¨×™×”
    translationHistory.unshift({ 
        sourceText: text, 
        translatedText: responseText, 
        timestamp: Date.now() 
    });
    // ×©××™×¨×” ×©×œ 10 ×”×¤×¨×™×˜×™× ×”××—×¨×•× ×™× ×‘×œ×‘×“
    translationHistory = translationHistory.slice(0, 10); 
    localStorage.setItem('milanTripTranslationHistory', JSON.stringify(translationHistory));
    renderTranslationHistory();
    
    // 2. ×™×¦×™×¨×ª ×›×¤×ª×•×¨ ×”-TTS ×”××ª×•×§×Ÿ
    const escapedText = responseText.replace(/'/g, "\\'");
    resultContainer.innerHTML = `<span>${responseText}</span> 
        <button onclick="ttsManager.speak('${escapedText}', true, '${langCode}')" 
        class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;

    translateBtn.disabled = false;
}
window.translateText = translateText;

    async function translateImage(base64ImageData, mimeType) {
        console.log(`LOG: translateImage called for mimeType: ${mimeType}`);
        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
        const targetLang = currentLang === 'he-it' ? 'Italian' : 'Hebrew';
        const prompt = `Extract any text from this image and translate it to ${targetLang}. Provide ONLY the translated text, with no additional formatting. If no text is found, respond with "×œ× × ××¦× ×˜×§×¡×˜".`;
        const payload = { contents: [{ parts: [{ text: "" }, { inlineData: { mimeType: mimeType, data: base64ImageData } }] }] };
        let responseText = await callGemini(payload, prompt, false);
        responseText = responseText.replace(/[\*\_`]/g, '').trim();
        const langCode = currentLang === 'he-it' ? 'it-IT' : 'he-IL';
        resultContainer.innerHTML = `<span>${responseText}</span> <button onclick="window.speakText('${responseText.replace(/'/g, "\\'")}', '${langCode}')" class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;
    }

async function askGeneralGemini(userPrompt) {
    console.log("LOG: askGeneralGemini called.");
    if (!userPrompt) return;

    const responseContainer = $('#gemini-response');
    const submitBtn = $('#gemini-submit-btn');
    submitBtn.disabled = true;
    responseContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ×—×•×©×‘...`;
    
    // 1. ×”×•×¡×¤×ª ×”×¤× ×™×™×” ×”× ×•×›×—×™×ª ×œ×”×™×¡×˜×•×¨×™×”
    geminiChatHistory.push({ role: "user", parts: [{ text: userPrompt }] });

    // 2. ×‘× ×™×™×ª ×”×¤×™×™×œ×•×•×“ ×”××œ×
    // × ×©×œ×— ××ª ×›×œ ×”×”×™×¡×˜×•×¨×™×” ×©×œ ×”×©×™×—×”
    const payload = { 
        contents: geminiChatHistory, // ×©×•×œ×— ××ª ×›×œ ×”×”×™×¡×˜×•×¨×™×” ×›×•×œ×œ ×”×©××œ×” ×”× ×•×›×—×™×ª
        tools: [{ "google_search_retrieval": {} }] // ××©×ª××©×™× ×‘×›×œ×™ ×—×™×¤×•×©
    };

    // ×§×•×¨××™× ×œ×¤×•× ×§×¦×™×” callGemini ×‘×œ×™ ×¤×¨×•××¤×˜ × ×•×¡×£, ×›×™ ×”-contents ×›×‘×¨ ××›×™×œ ××ª ×”×©××œ×”.
    const responseText = await callGemini(payload, '', true); // ×¢×›×©×™×• ×–×” ×©×•×œ×— useSearch=true

    // 3. ×¢×“×›×•×Ÿ ×”×”×™×¡×˜×•×¨×™×” ×¢× ×”×ª×©×•×‘×” ×©×œ Gemini
    geminiChatHistory.push({ role: "model", parts: [{ text: responseText }] });

    // 4. ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×” - × ×¦×™×’ ××ª ×›×œ ×”×©×™×—×”
    const chatDisplay = geminiChatHistory.map(entry => {
        const role = entry.role === 'user' ? '××ª×”' : 'Gemini';
        const color = entry.role === 'user' ? 'text-brand-600' : 'text-green-600';
        return `<div><strong class="${color}">${role}:</strong> ${entry.parts[0].text}</div>`;
    }).join('');

    responseContainer.innerHTML = chatDisplay;
    responseContainer.scrollTop = responseContainer.scrollHeight; // ×’×œ×™×œ×” ×œ×ª×—×ª×™×ª
    
    submitBtn.disabled = false;
}
        async function fetchSafetyWarnings() {
        console.log("LOG: fetchSafetyWarnings called.");
        const container = $('#safety-warnings-content');
        container.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ×××ª×¨ ××™×“×¢ ×¢×“×›× ×™...`;
        
        const today = new Date().toLocaleDateString('en-CA');
        const prompt = `As a safety advisor, check for any significant demonstrations, public transport strikes, or specific safety warnings for tourists in Milan, Italy, specifically for today's date: ${today}. Provide a concise summary in Hebrew. If your web search finds no specific warnings, state that clearly and mention that the information is current as of today.`;
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const responseText = await callGemini(payload, prompt, true);
        
        container.textContent = responseText;
    }
    async function generateTripSummary() {
        console.log("LOG: generateTripSummary called.");
        showAlert('×™×•×¦×¨ ×¡×™×›×•×...', '××•×¡×£ ××ª ×›×œ ×”×—×•×•×™×•×ª ×•×”× ×ª×•× ×™× ×›×“×™ ×œ×™×¦×•×¨ ×¡×™×›×•× ××™×©×™... ×–×” ×¢×©×•×™ ×œ×§×—×ª ×¨×’×¢.', false);
        
        const { plan, expenses, journal } = localTripData;
        
        let placesVisited = [];
        if(plan) {
            Object.values(plan).forEach(day => {
                (day.activities || []).forEach(act => {
                    if (!placesVisited.includes(act.name)) placesVisited.push(act.name);
                });
            });
        }
        
        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        
        let journalEntries = [];
        if (journal) {
            Object.values(journal).forEach(dayEntries => {
                (dayEntries || []).forEach(entry => journalEntries.push(entry.text));
            });
        }

        const prompt = `
            Act as a creative travel blogger writing a personal trip summary. Based on the following data from a trip to Milan, create a warm, engaging, and experiential summary in Hebrew.
            The summary should feel like a personal memory, not just a list. Use paragraphs and an enthusiastic tone.
            
            Data:
            - Places Visited: ${placesVisited.join(', ')}.
            - Total Spent: Approximately ${totalExpenses.toFixed(0)} euros.
            - Personal Journal Notes: ${journalEntries.join('; ')}.
            
            Please generate the summary now.
        `;
        
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const summaryText = await callGemini(payload, prompt, false);
        
        showAlert('×¡×™×›×•× ×”×˜×™×•×œ ×©×œ×›×!', summaryText, true);
    }

    // --- NEW PWA & Smart Features ---
    window.optimizeDayRoute = async (dayId) => {
        console.log(`LOG: optimizeDayRoute called for ${dayId}`);
        const day = localTripData.plan[dayId];
        if (!day || !day.activities || day.activities.length < 2) {
            showAlert('×œ× × ×™×ª×Ÿ ×œ×‘×¦×¢ ××•×¤×˜×™××™×–×¦×™×”', '×¦×¨×™×š ×œ×¤×—×•×ª ×©×ª×™ ×¤×¢×™×œ×•×™×•×ª ×‘×™×•× ×›×“×™ ×œ×™×™×¢×œ ××ª ×”××¡×œ×•×œ.');
            return;
        }

        showAlert('××‘×¦×¢ ××•×¤×˜×™××™×–×¦×™×”...', '××¡×“×¨ ××—×“×© ××ª ×”×¤×¢×™×œ×•×™×•×ª ×›×“×™ ×œ×—×¡×•×š ×œ×š ×–××Ÿ...');
        
        let activities = [...day.activities];
        let optimizedRoute = [activities.shift()]; // Start with the first activity
        
        while (activities.length > 0) {
            let lastPoint = optimizedRoute[optimizedRoute.length - 1];
            let nearestIndex = -1;
            let minDistance = Infinity;

            activities.forEach((activity, index) => {
                const distance = haversineKm(lastPoint.coords?.lat, lastPoint.coords?.lon, activity.coords?.lat, activity.coords?.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestIndex = index;
                }
            });

            if (nearestIndex > -1) {
                optimizedRoute.push(activities.splice(nearestIndex, 1)[0]);
            } else {
                break; 
            }
        }
        
        await updateDoc(tripDocRef, { [`plan.${dayId}.activities`]: optimizedRoute });
        showAlert('×”××¡×œ×•×œ ×¢×‘×¨ ××•×¤×˜×™××™×–×¦×™×”!', '×¡×“×¨ ×”×¤×¢×™×œ×•×™×•×ª ×¢×•×“×›×Ÿ ×œ×™×•× ×–×”.');
    };

    window.generateIcsFile = (dayId) => {
        console.log(`LOG: generateIcsFile called for ${dayId}`);
        const day = localTripData.plan[dayId];
        const dayIndex = Object.keys(localTripData.plan).sort((a,b) => a.localeCompare(b[0])).indexOf(dayId);
        const tripStartDate = new Date(tripMeta.flights.inbound.date);
        const eventDate = new Date(tripStartDate.setDate(tripStartDate.getDate() + dayIndex));
        const eventDateStr = eventDate.toISOString().split('T')[0].replace(/-/g, '');

        const timeMap = { '×‘×•×§×¨': '090000', '×¦×”×¨×™×™×': '140000', '×¢×¨×‘': '190000' };
        const durationMap = { '×‘×•×§×¨': 3, '×¦×”×¨×™×™×': 4, '×¢×¨×‘': 4 };

        let icsContent = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//MilanTrip/Planner//EN',
        ];

        day.activities.forEach(activity => {
            const startTime = timeMap[activity.time] || '120000';
            const durationHours = durationMap[activity.time] || 2;
            const startDateTime = `${eventDateStr}T${startTime}`;
            const endHour = parseInt(startTime.substring(0, 2), 10) + durationHours;
            const endDateTime = `${eventDateStr}T${String(endHour).padStart(2, '0')}0000`;

            icsContent.push(
                'BEGIN:VEVENT',
                `UID:${activity.id}@milantrip.app`,
                `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '')}Z`,
                `DTSTART;TZID=Europe/Rome:${startDateTime}`,
                `DTEND;TZID=Europe/Rome:${endDateTime}`,
                `SUMMARY:${activity.name}`,
                `DESCRIPTION:${activity.description || ''}`,
                `LOCATION:${activity.address || ''}`,
                'END:VEVENT'
            );
        });
        icsContent.push('END:VCALENDAR');

        const blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${day.name}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    async function getSmartAdvice() {
        console.log("LOG: getSmartAdvice called.");
        const responseContainer = $('#gemini-response');
        const submitBtn = $('#get-smart-advice-btn');
        submitBtn.disabled = true;
        responseContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ×”×™×•×¢×¥ ×”×—×›× ×‘×•×“×§ ××ª ×”× ×ª×•× ×™×...`;
        
        const remainingBudget = (localTripData.totalBudget || 0) - (localTripData.expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        let weatherInfo = "No weather data available.";
        if(lastWeatherAPIData) {
            weatherInfo = `Today's forecast is a high of ${lastWeatherAPIData.daily.temperature_2m_max[0]}Â°C and a low of ${lastWeatherAPIData.daily.temperature_2m_min[0]}Â°C. Weather code: ${lastWeatherAPIData.daily.weathercode[0]}.`
        }
        
        const milanTime = new Date().toLocaleTimeString('en-US', { timeZone: 'Europe/Rome', hour: '2-digit', minute: '2-digit', hour12: false });
        
        const prompt = `
            As a smart travel advisor for a trip to Milan, provide a short, actionable recommendation in Hebrew based on the following context. Be friendly and helpful.
            
            Context:
            - Current time in Milan: ${milanTime}
            - Current weather situation: ${weatherInfo} (Weather codes: 0-3=Clear/Cloudy, 51-67=Rain, 71-86=Snow, 95+=Thunderstorm)
            - Remaining trip budget: â‚¬${remainingBudget.toFixed(0)}
            
            Based on this context, what is one useful suggestion you can give me right now? For example, if it's evening and raining, suggest an indoor attraction or a specific type of restaurant. If the budget is low, suggest a free activity.
        `;

        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const advice = await callGemini(payload, prompt, false);
        responseContainer.textContent = advice;
        submitBtn.disabled = false;
    }
    // ========================= ×”×ª×—×œ×”: ×§×•×“ ×œ××¤×” ×‘××¦×‘ ×‘×”×™×¨ ×§×‘×•×¢ =========================
function initLiveMap() {
    console.log("LOG: initLiveMap called.");
    if (liveMap) return;
    liveMap = L.map('live-location-map').setView([45.4642, 9.1916], 12);

    // ×”×’×“×¨×” ×©×œ ×©×›×‘×ª ×”××¤×” ×”×‘×”×™×¨×” ×‘×œ×‘×“
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(liveMap);
}
// ========================= ×¡×•×£: ×§×•×“ ×œ××¤×” ×‘××¦×‘ ×‘×”×™×¨ ×§×‘×•×¢ =========================
    // --- LIVE LOCATION FUNCTIONS ---

    async function updateLocationInFirestore(position) {
        if (!currentUserId) return;
        const { latitude, longitude } = position.coords;
        const userName = $('#user-name-input').value.trim() || `××©×ª××© ${currentUserId.substring(0,4)}`;
        const userLocationDocRef = doc(locationsColRef, currentUserId);
        
        console.log(`LOG: Updating location for ${userName} in Firestore.`);
        await setDoc(userLocationDocRef, {
            lat: latitude,
            lng: longitude,
            name: userName,
            timestamp: serverTimestamp()
        });
        $('#location-status').textContent = `××™×§×•× ×¢×•×“×›×Ÿ: ${new Date().toLocaleTimeString()}`;
    }

    function listenForLocationUpdates() {
        console.log("LOG: Setting up listener for location updates.");
        onSnapshot(locationsColRef, (snapshot) => {
            console.log("LOG: Received location snapshot update.");
            snapshot.docs.forEach(doc => {
                const locData = doc.data();
                const uid = doc.id;
                const latLng = [locData.lat, locData.lng];
                const displayName = (uid === currentUserId) ? `××ª×” (${locData.name})` : locData.name;

                if (userMarkers[uid]) {
                    userMarkers[uid].setLatLng(latLng);
                    userMarkers[uid].getPopup().setContent(displayName);
                } else {
                    userMarkers[uid] = L.marker(latLng).addTo(liveMap)
                        .bindPopup(displayName)
                        .openPopup();
                }
            });
            // Optional: remove markers for users who are no longer sharing
            const currentUids = snapshot.docs.map(d => d.id);
            Object.keys(userMarkers).forEach(uid => {
                if (!currentUids.includes(uid)) {
                    liveMap.removeLayer(userMarkers[uid]);
                    delete userMarkers[uid];
                }
            });
        });
    }

    async function toggleLocationSharing() {
        console.log("LOG: toggleLocationSharing called.");
        const btn = $('#toggle-location-sharing-btn');
        const status = $('#location-status');
        if (watchingLocation) {
            console.log("LOG: Stopping location sharing.");
            navigator.geolocation.clearWatch(watchId);
            watchingLocation = false;
            watchId = null;
            btn.innerHTML = '<i class="fa-solid fa-tower-broadcast mr-2"></i>×”×¤×¢×œ ×©×™×ª×•×£ ××™×§×•×';
            btn.classList.remove('bg-red-600', 'hover:bg-red-700');
            status.textContent = '×©×™×ª×•×£ ××™×§×•× ×›×‘×•×™.';
            if (currentUserId) {
                const userLocationDocRef = doc(locationsColRef, currentUserId);
                await deleteDoc(userLocationDocRef);
            }
        } else {
            console.log("LOG: Starting location sharing.");
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(updateLocationInFirestore, (error) => {
                    console.error("ERROR: Error getting location:", error);
                    showAlert("×©×’×™××ª ××™×§×•×", "×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ××™×§×•××š. ×•×“× ×©××™×©×¨×ª ×”×¨×©××•×ª ××™×§×•× ×œ×“×¤×“×¤×Ÿ.");
                }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
                watchingLocation = true;
                btn.innerHTML = '<i class="fa-solid fa-stop-circle mr-2"></i>×”×¤×¡×§ ×©×™×ª×•×£ ××™×§×•×';
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                status.textContent = '××©×ª×£ ××™×§×•×...';
            } else {
                showAlert("×œ× × ×ª××š", "×”×“×¤×“×¤×Ÿ ×©×œ×š ××™× ×• ×ª×•××š ×‘×©×™×ª×•×£ ××™×§×•×.");
            }
        }
    }
    
    // --- FIX 1 & 2: REWRITTEN JOURNAL FUNCTIONS ---
    async function addJournalEntry(dayId, text) {
        console.log(`LOG: addJournalEntry called for day ${dayId}`);
        if (!tripDocRef) {
            console.error("ERROR: tripDocRef is not initialized. Cannot add journal entry.");
            return;
        }
        const newEntry = {
            id: Date.now().toString(),
            text: text,
            timestamp: new Date()
        };
        await updateDoc(tripDocRef, {
            [`journal.${dayId}`]: arrayUnion(newEntry)
        });
    }

    async function removeJournalEntry(dayId, entryId) {
        console.log(`LOG: removeJournalEntry called for entry ${entryId} in day ${dayId}`);
        if (!isFirebaseConnected) {
            showAlert('××™×Ÿ ×—×™×‘×•×¨', '×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×›×¢×ª. ×× × ×”××ª×Ÿ ×œ×¡× ×›×¨×•×Ÿ ××œ× ×¢× ×”×©×¨×ª.');
            return;
        }
        if (!tripDocRef) {
             console.error("ERROR: tripDocRef is not initialized. Cannot remove journal entry.");
            return;
        }
        
        const journalForDay = localTripData.journal?.[dayId] || [];
        
        // This is the critical part: Firestore's arrayRemove needs the *exact* object to remove.
        // We find the object in our local data based on the unique ID.
        const entryToRemove = journalForDay.find(e => e.id === entryId);

        if (entryToRemove) {
             console.log("LOG: Found entry to remove locally, attempting to remove from Firestore.");
            await updateDoc(tripDocRef, {
                [`journal.${dayId}`]: arrayRemove(entryToRemove)
            });
        } else {
            console.error("ERROR: Could not find journal entry to remove. This might happen if the data is not yet synced.");
        }
    }

    function renderJournal(dayId, entries = []) {
        console.log(`LOG: renderJournal called for day ${dayId}`);
        const getTimestampDate = (ts) => {
            if (!ts) return new Date();
            if (typeof ts.toDate === 'function') return ts.toDate(); 
            if (ts.seconds) return new Date(ts.seconds * 1000); 
            return new Date(); 
        };

        const validEntries = Array.isArray(entries) ? entries : [];
        const entriesHtml = validEntries
            .sort((a, b) => getTimestampDate(b.timestamp).getTime() - getTimestampDate(a.timestamp).getTime())
            .map(entry => {
                const dateString = getTimestampDate(entry.timestamp).toLocaleString('he-IL', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                return `
                <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg relative group">
                    <p class="text-sm whitespace-pre-wrap">${entry.text}</p>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${dateString}</div>
                    <button class="absolute top-2 left-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="window.removeJournalEntry('${dayId}', '${entry.id}')">
                        <i class="fa-solid fa-trash-alt fa-xs"></i>
                    </button>
                </div>`;
        }).join('');

        return `<div class="mt-6 border-t pt-4">
            <h4 class="font-bold text-lg mb-2">×™×•××Ÿ ××¡×¢</h4>
            <div id="journal-entries-${dayId}" class="space-y-3 mb-3">${entriesHtml}</div>
            <form id="journal-form-${dayId}" class="flex gap-2">
                <input type="text" id="journal-text-${dayId}" placeholder="×”×•×¡×£ ×—×•×•×™×” ××”×™×•×..." class="w-full p-2 rounded-lg border">
                <button type="submit" class="btn btn-primary">×©×œ×—</button>
            </form>
        </div>`;
    }
// ==========================================================
// ×”×ª×—×œ×”: ×§×•×“ ××ª×•×§×Ÿ ×•××©×•×¤×¨ ×œ×ª×¨×’×•× ×§×•×œ×™
// ==========================================================
const recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let speechRecognizer = null;
let isRecognizing = false;
let activeVoiceButton = null;

if (recognition) {
    speechRecognizer = new recognition();
    speechRecognizer.continuous = false;
    speechRecognizer.interimResults = false;

    speechRecognizer.onstart = () => {
        isRecognizing = true;
        console.log("Speech recognition started.");
        $('#translation-result-container').innerHTML = '<span>××§×©×™×‘...</span>';
    };

speechRecognizer.onend = () => {
        isRecognizing = false; // ×•×“× ×©×–×” ××ª×¢×“×›×Ÿ ×œ-false
        console.log("Speech recognition ended."); // ×”×•×¡×£ ×œ×•×’
        if (activeVoiceButton) {
            activeVoiceButton.classList.remove('text-red-500', 'animate-pulse');
            activeVoiceButton.innerHTML = activeVoiceButton.id.includes('he') ? '<i class="fa-solid fa-microphone"></i> ×“×‘×¨ ×‘×¢×‘×¨×™×ª' : '<i class="fa-solid fa-microphone"></i> Parla Italiano';
        }
        activeVoiceButton = null;
    };
    speechRecognizer.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        let errorMessage = '××™×¨×¢×” ×©×’×™××” ×‘×–×™×”×•×™';
        if (event.error === 'no-speech') {
            errorMessage = '×œ× ×–×•×”×” ×“×™×‘×•×¨. × ×¡×” ×©×•×‘.';
        } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
            errorMessage = '×”×’×™×©×” ×œ××™×§×¨×•×¤×•×Ÿ × ×—×¡××” ××• × ×“×—×ª×”.';
        }
        $('#translation-result-container').innerHTML = `<span class="text-red-500">${errorMessage}</span>`;
    };

    speechRecognizer.onresult = async (event) => {
        const spokenText = event.results[0][0].transcript;
        const sourceLang = speechRecognizer.lang;
        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ××ª×¨×’×...`;

        const targetLangFull = (sourceLang === 'he-IL') ? 'Italian' : 'Hebrew';
        const prompt = `Translate this to ${targetLangFull}. Provide ONLY the translated text: "${spokenText}"`;
        
        let translatedText = await callGemini({ contents: [{ parts: [{ text: prompt }] }] });
        translatedText = translatedText.replace(/[\*\_`\.]/g, '').trim();
        const targetLangCode = (sourceLang === 'he-IL') ? 'it-IT' : 'he-IL';
        const escapedText = translatedText.replace(/'/g, "\\'");

        // ×§×‘×¢ ×× ×œ×”×©×ª××© ×‘-API ×œ×¤×™ ×”×©×¤×”
        const useApiForPlayback = (targetLangCode === 'he-IL');

        resultContainer.innerHTML = `<span>${translatedText}</span> 
            <button onclick="ttsManager.speak('${escapedText}', ${useApiForPlayback}, '${targetLangCode}')" 
            class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;

        // × ×™×’×•×Ÿ ××•×˜×•××˜×™
        ttsManager.speak(translatedText, useApiForPlayback, targetLangCode);
    };
}

function startRecognition(langCode, button) {
    if (!speechRecognizer) {
        showAlert('×©×’×™××”', '×–×™×”×•×™ ×§×•×œ×™ ××™× ×• × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”.');
        return;
    }

    // ×× ×”×–×™×”×•×™ ×›×‘×¨ ××ª×‘×¦×¢, ××¤×¡×™×§×™× ×•×××¤×©×¨×™× ×œ×—×™×¦×” ×—×•×–×¨×ª (×”×¤×•× ×§×¦×™×” already ××˜×¤×œ×ª ×‘-isRecognizing)
    if (isRecognizing) { 
        speechRecognizer.stop();
        return;
    }
    
    try {
        // *** ×¢×¦×™×¨×” ×™×–×•××” ×œ×¤× ×™ ×”×ª×—×œ×” ×œ××§×¨×” ×©×”××¦×‘ ×œ× ××•×¤×¡ ×›×¨××•×™ (×˜×™×¤×•×œ ×‘-InvalidStateError) ***
        // ×–×”×• ×ª×™×§×•×Ÿ ×—×–×§ ×™×•×ª×¨ ×œ×‘×¢×™×” ×©× ×•×¦×¨×ª ×¢×§×‘ ×œ×—×™×¦×•×ª ××”×™×¨×•×ª.
        if (speechRecognizer.recognizing) {
             speechRecognizer.stop();
             // ××¢×‘×¨ ×™×©×™×¨ ×œ×œ×•×’×™×§×ª ×”×”×ª×—×œ×” ×”×—×“×©×”:
        }
        
        activeVoiceButton = button;
        // ×¤×™×“×‘×§ ×•×™×–×•××œ×™ ××™×™×“×™ ×œ××©×ª××©
        activeVoiceButton.innerHTML = '<i class="fa-solid fa-microphone-lines fa-beat animate-pulse"></i> ××§×œ×™×˜...';
        activeVoiceButton.classList.add('text-red-500');
        
        speechRecognizer.lang = langCode;
        speechRecognizer.start();
        // isRecognizing ×™×•×’×“×¨ ×œ-true ×‘×ª×•×š speechRecognizer.onstart
        
    } catch (e) {
        // *** ×©×™× ×•×™: ×‘×•×“×§ ×× ×”×©×’×™××” ×”×™× InvalidStateError ×•××ª×¢×œ× ××× ×” (××›×™×•×•×Ÿ ×©×”×”×§×œ×˜×” ×”×ª×—×™×œ×” ×›×‘×¨ ×‘× ×™×¡×™×•×Ÿ ×§×•×“×) ***
        // ×–×” ××•× ×¢ ××ª ××•×“×œ ×”×©×’×™××” ×”××™×•×ª×¨×ª ×›××©×¨ ×”××¢×¨×›×ª ×‘×¤×•×¢×œ ×¢×•×‘×“×ª.
        if (e.name === "InvalidStateError") {
             console.warn("WARN: Ignored InvalidStateError, assuming previous attempt succeeded or stopped.");
             return; 
        }
        
        console.error("Error starting speech recognition:", e);
        // ×¢×‘×•×¨ ×›×œ ×©×’×™××” ××—×¨×ª (×›×’×•×Ÿ ×©×’×™××ª ×”×¨×©××” ×××™×ª×™×ª), × ×¦×™×’ ××ª ×”××•×“×œ:
        showAlert('×©×’×™××ª ××™×§×¨×•×¤×•×Ÿ', '×œ× × ×™×ª×Ÿ ×”×™×” ×œ×”×¤×¢×™×œ ××ª ×”××™×§×¨×•×¤×•×Ÿ. ×× × ×•×“× ×©×”×¢× ×§×ª ×”×¨×©××•×ª ×œ×“×¤×“×¤×Ÿ.');
        
        // ××™×¤×•×¡ ×”×›×¤×ª×•×¨ ×‘××§×¨×” ×©×œ ×©×’×™××” ×××™×ª×™×ª
        if (activeVoiceButton) {
            activeVoiceButton.classList.remove('text-red-500', 'animate-pulse');
            activeVoiceButton.innerHTML = activeVoiceButton.id.includes('he') ? '<i class="fa-solid fa-microphone"></i> ×“×‘×¨ ×‘×¢×‘×¨×™×ª' : '<i class="fa-solid fa-microphone"></i> Parla Italiano';
            activeVoiceButton = null;
        }
    }
}
// ==========================================================
// ×¡×•×£: ×§×•×“ ××ª×•×§×Ÿ ×•××©×•×¤×¨ ×œ×ª×¨×’×•× ×§×•×œ×™
// ==========================================================

    // --- INIT ---
document.addEventListener('DOMContentLoaded', () => {

  const heBtn = $('#voice-translate-he-btn');
    const itBtn = $('#voice-translate-it-btn');
    
    // ×•×“× ×©-speechRecognizer ×§×™×™× ×œ×¤× ×™ ×”×•×¡×¤×ª ×”×××–×™× ×™×
    if (speechRecognizer) {
        // ×•×“× ×©××ª×” ×§×•×¨× ×œ×¤×•× ×§×¦×™×” ×©×”×’×“×¨×ª ×‘×¡×¢×™×£ 3
        heBtn.addEventListener('click', (e) => window.startRecognition('he-IL', e.currentTarget));
        itBtn.addEventListener('click', (e) => window.startRecognition('it-IT', e.currentTarget));
    } else {
        // ... (×”×§×•×“ ×”×§×™×™× ×©×œ×š ×œ×˜×™×¤×•×œ ×‘××¦×‘ ×©×‘×• ××™×Ÿ Speech Recognition)
        if (heBtn) { heBtn.disabled = true; heBtn.innerHTML = '×œ× × ×ª××š'; }
        if (itBtn) { itBtn.disabled = true; itBtn.innerHTML = 'Non supportato'; }
    }

// ×××–×™×Ÿ ×¨×©××™ ×œ×‘×¨×›×ª ×”××–×•×Ÿ - ××•×¦×’ ×§×•×“×, ×•××– ××©××™×¢ ×“×¨×š speakTextLocally
(function(){
  const birkatBtn = document.getElementById('birkat-hamazon-btn');
  if (!birkatBtn) return;
  if (birkatBtn.dataset.birkatBound) return;

  const newBtn = birkatBtn.cloneNode(true);
  birkatBtn.replaceWith(newBtn);

newBtn.addEventListener('click', () => {
    // 1. ×¢×¦×•×¨ ×›×œ ×“×™×‘×•×¨ ×§×™×™× (×—×•×‘×” ×œ×¤× ×™ ×”×¤×¢×œ×ª × ×™×’×•×Ÿ ×—×“×©)
    try { if (window.activeAudio) { window.activeAudio.pause(); window.activeAudio = null; } } catch(e){}
    try { if ('speechSynthesis' in window) window.speechSynthesis.cancel(); } catch(e){}

    const brachaHTML = hebrewPrayers.birkatHaMazon || '<div>×˜×§×¡×˜ ×”×‘×¨×›×” ×œ× ×–××™×Ÿ</div>';
    const tmp = document.createElement('div');
    tmp.innerHTML = brachaHTML;
    const brachaCleanText = (tmp.textContent || tmp.innerText || '').replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();

    // 2. ×”×©×ª××© ×‘-showAlert ×›×“×™ ×œ×”×¦×™×’ ××ª ×”××•×“×œ ×•×œ×•××¨ ×œ×• ×œ×”×¤×¢×™×œ TTS ××§×•××™
    showAlert('×‘×¨×›×ª ×”××–×•×Ÿ', brachaHTML, { 
        text: brachaCleanText, 
        localOnly: true, // ×–×” ××‘×˜×™×— TTS ×“×¤×“×¤×Ÿ + ×›×¤×ª×•×¨×™×
        lang: 'he-IL' 
    });
    
    // ××™×Ÿ ×¦×•×¨×š ×‘-setTimeout ×•-speakTextLocally, ×”-showAlert ××˜×¤×œ ×‘×–×”.
});

  newBtn.dataset.birkatBound = '1';
})();



    console.log("LOG: DOMContentLoaded event fired. Initializing app.");
     // --- ×××–×™× ×™ ×›×¤×ª×•×¨×™× ×™×”×•×“×™×™× ×—×“×©×™× ---

   

    // --- ×—×™×‘×•×¨ ×›×¤×ª×•×¨ ×¡×¨×™×§×ª ×‘×¨×§×•×“ ---


    // --- ×”×•×¡×¤×ª ×”×œ×•×’×™×§×” ×©×œ ×”×’×“×¨×•×ª ×”×§×•×œ ×•×—×™×‘×•×¨ ×”×›×¤×ª×•×¨×™× ---
    const voiceSettingsModal = $('#voice-settings-modal');
    const globalVoiceSelect = $('#global-voice-select');

    // 1. ×˜×¢×™× ×ª ×‘×—×™×¨×” ×©××•×¨×” ×•×©××™×¨×” ×‘×©×™× ×•×™
    const savedVoice = localStorage.getItem("selectedVoice");
    if (savedVoice && globalVoiceSelect) {
        globalVoiceSelect.value = savedVoice;
    }

    if (globalVoiceSelect) {
        globalVoiceSelect.addEventListener("change", (e) => {
            const selectedVoice = e.target.value;
            localStorage.setItem("selectedVoice", selectedVoice); // ×©××™×¨×”
            speakText(" ×©×œ×•×, ×–×”×• ×”×§×•×œ ×©×‘×—×¨×ª."); // ×“×•×’××ª ×§×•×œ
        });
    }

    // 2. ×¤×ª×™×—×”/×¡×’×™×¨×ª ×”××•×“×œ
    $('#voice-settings-close-btn').addEventListener('click', () => voiceSettingsModal.classList.remove('flex'));
    
    // 3. ×—×™×‘×•×¨ ×”×›×¤×ª×•×¨×™× ×œ×—×œ×•×Ÿ ×”×’×“×¨×•×ª ×”×§×•×œ (××œ×¨×˜ ×•×ª×¨×’×•××•×Ÿ)
    document.addEventListener('click', (e) => {
        if (e.target.closest('#alert-modal-tts-settings-btn')) {
            voiceSettingsModal.classList.add('flex');
        }
        if (e.target.closest('#translator-tts-settings-btn')) {
            voiceSettingsModal.classList.add('flex');
        }
    });

    // --- Expose functions to window for onclick attributes ---
    window.handleTransportChange = handleTransportChange;
    window.removeActivity = removeActivity;
    window.moveActivity = moveActivity;
    window.toggleChecklistItem = toggleChecklistItem;
    window.removeChecklistItem = removeChecklistItem;
    window.removeJournalEntry = removeJournalEntry;
    window.removeExpense = removeExpense;
    window.removeDocument = removeDocument;
    window.removeImage = removeImage;
    window.findUtility = findUtility;
    window.getAudioGuide = getAudioGuide;
    window.generateDailySummary = generateDailySummary; 
    window.askGeneralGemini = askGeneralGemini; 
    initMetroHelper();

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(registration => console.log('LOG: Service Worker registered with scope:', registration.scope))
                .catch(error => console.log('ERROR: Service Worker registration failed:', error));
        });
    }

    // --- Firebase Initialization ---
    const firebaseConfig = {
      apiKey: "AIzaSyD47-qHc8vmGQt4n4LluKW64LEMB-UYrfk",
      authDomain: "trip-to-milan.firebaseapp.com",
      projectId: "trip-to-milan",
      storageBucket: "trip-to-milan.firebasestorage.app",
      messagingSenderId: "305191186184",
      appId: "1:305191186184:web:fff1488b64a06942dfc6bd",
      measurementId: "G-P17LYZJ2H0"
    };

    const app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(err => console.warn(`WARN: Firestore persistence failed. Code: ${err.code}`));

    // --- Caching and Sharing Logic ---
    let tripId = window.location.hash.substring(1);
    if (!tripId) {
        tripId = Math.random().toString(36).substring(2, 12);
        window.location.hash = tripId;
    }
    $('#user-name-input').value = localStorage.getItem('userName') || '';

    const cachedData = localStorage.getItem(`tripData_${tripId}`);
    if (cachedData) {
        try {
            localTripData = JSON.parse(cachedData);
        } catch(e) {
            console.error("ERROR: Failed to parse cached data.", e);
            localStorage.removeItem(`tripData_${tripId}`);
        }
    }

    signInAnonymously(auth).catch(error => showAlert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×œ-Firebase", `×”×”×ª×—×‘×¨×•×ª ×”×× ×•× ×™××™×ª × ×›×©×œ×”. ${error.message}`));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        tripDocRef = doc(db, "milantrip", tripId);
        locationsColRef = collection(db, "milantrip", tripId, "locations");

        initLiveMap();
        listenForLocationUpdates();

        onSnapshot(tripDocRef, async (docSnap) => {
            if (!isFirebaseConnected) {
                const statusIcon = $('#sync-status i');
                const statusText = $('#sync-status span');
                statusIcon.classList.replace('text-yellow-500', 'text-green-500');
                statusText.textContent = '××—×•×‘×¨';
                isFirebaseConnected = true;
            }
            if (docSnap.exists()) {
                localTripData = docSnap.data();
            } else {
                localTripData = getInitialTripData();
                await setDoc(tripDocRef, localTripData);
            }
            localStorage.setItem(`tripData_${tripId}`, JSON.stringify(localTripData));

            // --- Render all components with fresh data ---
            renderAllPlans(localTripData.plan);
            renderSuggestions(localTripData.suggestions);
            renderKosher();
            renderChecklist(localTripData.checklist);
            renderBudget(localTripData);
            renderDocuments(localTripData.documents);
            renderGallery(localTripData.gallery);
            initPassCalculator();
            renderScrapbook();
        }, (error) => {
            console.error("ERROR: Firestore snapshot error:", error);
            const statusIcon = $('#sync-status i');
            const statusText = $('#sync-status span');
            statusIcon.classList.remove('text-green-500', 'text-yellow-500');
            statusIcon.classList.add('text-red-500');
            statusText.textContent = '×‘×¢×™×™×ª ×¡× ×›×¨×•×Ÿ';
        });
      }
    });

    // --- Initial Renders & Fetches ---
    console.log("LOG: Performing initial renders and fetches.");
    renderOverview();
    renderKosherFilters();
    fetchWeather();
    fetchExchangeRate();
    showDailyTip();
    fetchSafetyWarnings();
    renderTranslationHistory();
    renderMobileNavSubmenus();
    fetchZmanim();
    updateClocks();
    setInterval(updateClocks, 1000);

    const ctx = document.getElementById('transportChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: { labels: ['× ×¡×™×¢×” ×‘×•×“×“×ª', '×›×¨×˜×™×¡ ×™×•××™', '×›×¨×˜×™×¡ ×œ-3 ×™××™×'], datasets: [{ label: '×¢×œ×•×ª ×‘××™×¨×•', data: [2.20, 7.60, 15.50], backgroundColor: ['rgba(59,130,246,.6)','rgba(37,99,235,.6)','rgba(29,78,216,.6)'], borderColor: ['#3b82f6','#2563eb','#1d4ed8'], borderWidth: 1 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
    });

    // --- Event Listeners (×”×—×œ×§ ×©×—×–×¨) ---
    console.log("LOG: Adding main event listeners.");
    if ('speechSynthesis' in window) {
        if (speechSynthesis.getVoices().length === 0) {
            speechSynthesis.onvoiceschanged = () => {
                console.log("LOG: TTS voices loaded via onvoiceschanged event.");
                speechSynthesis.onvoiceschanged = null;
            };
        }
    }
    
    // --- ×××–×™× ×™ ×›×¤×ª×•×¨×™× ×›×œ×œ×™×™× ---
    $('#theme-toggle').addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        if(tripDocRef && isFirebaseConnected) updateDoc(tripDocRef, { theme: isDark ? 'dark' : 'light' });
    });

    $('#show-tip-btn').addEventListener('click', openTipModal); // ×˜×™×¤ ×™×•××™
    $('#create-summary-btn').addEventListener('click', generateTripSummary); // ×¡×™×›×•× ×˜×™×•×œ
    $('#refresh-warnings-btn').addEventListener('click', fetchSafetyWarnings);
    $('#share-btn').addEventListener('click', () => { // ×©×ª×£ ×ª×•×›× ×™×ª
        const url = window.location.href;
        if (navigator.share) {
            navigator.share({ title: '×ª×•×›× ×™×ª ×”×˜×™×•×œ ×©×œ× ×• ×œ××™×œ×× ×•', url: url });
        } else {
            navigator.clipboard.writeText(url).then(() => showAlert('×”×§×™×©×•×¨ ×”×•×¢×ª×§!', '×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—.'));
        }
    });

    $('#collapse-all').addEventListener('click', () => $$('#plan-content-container details').forEach(d => d.removeAttribute('open')));
    $('#expand-all').addEventListener('click', () => $$('#plan-content-container details').forEach(d => d.setAttribute('open', true)));
    $('#print-btn').addEventListener('click', () => window.print());

    // --- ×××–×™× ×™ ×˜×¤×¡×™× ×•×ª×§×¦×™×‘ ---
    $('#add-checklist-item-form').addEventListener('submit', async e => {
        e.preventDefault();
        if(!isFirebaseConnected) { showAlert('×©×’×™××ª ×¡× ×›×¨×•×Ÿ', '××™×Ÿ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×.'); return; }
        const text = $('#new-item-text').value.trim(); if (!text) return;
        let categoryName = $('#new-category-text').value.trim() || $('#category-select').value;
        if (!categoryName) { showAlert('×©×’×™××”', '×™×© ×œ×‘×—×•×¨ ××• ×œ×™×¦×•×¨ ×§×˜×’×•×¨×™×”.'); return; }

        let updatedChecklist = [...(localTripData.checklist || [])];
        let category = updatedChecklist.find(c => c.category === categoryName);
        if (!category) {
            category = { id: 'cat' + Date.now(), category: categoryName, items: [] };
            updatedChecklist.push(category);
        }
        category.items.push({ id: `c${Date.now()}`, text, done: false });

        await updateDoc(tripDocRef, { checklist: updatedChecklist });
        e.target.reset();
    });

    $('#expense-form').addEventListener('submit', async e => {
        e.preventDefault();
        if(!isFirebaseConnected) { showAlert('×©×’×™××ª ×¡× ×›×¨×•×Ÿ', '××™×Ÿ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×.'); return; }
        const desc = $('#expense-desc').value.trim();
        const amount = parseFloat($('#expense-amount').value);
        const category = $('#expense-category').value;
        if(desc && !isNaN(amount) && category) {
            const newExpense = {id: Date.now().toString(), desc, amount, category};
            await updateDoc(tripDocRef, { expenses: arrayUnion(newExpense) });
            e.target.reset();
        } else {
            showAlert('×©×’×™××”', '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×›×•×œ×œ ×§×˜×’×•×¨×™×”.');
        }
    });

    $('#total-budget').addEventListener('input', async e => {
        if(!isFirebaseConnected) { return; }
        const newTotalBudget = parseFloat(e.target.value) || 0;
        if (tripDocRef) await updateDoc(tripDocRef, { totalBudget: newTotalBudget });
    });

    $('#include-estimated-costs').addEventListener('change', async e => {
        if(!isFirebaseConnected) { return; }
        const include = e.target.checked;
        await updateDoc(tripDocRef, { 'settings.includeEstimatedCostsInBalance': include });
    });

    $('#calculate-estimated-btn').addEventListener('click', () => {
        const estimatedCosts = calculateEstimatedCosts(localTripData.plan);
        showAlert('×¢×œ×•×ª ××©×•×¢×¨×ª', `×”×¢×œ×•×ª ×”××©×•×¢×¨×ª ×œ××˜×¨×§×¦×™×•×ª ×‘×ª×•×›× ×™×ª ×¢×‘×•×¨ ×–×•×’ ×”×™×: â‚¬${estimatedCosts.toFixed(2)}.`);
    });
    
    $('#toggle-suggestions-btn').addEventListener('click', e => {
        const container = $('#suggestions-container');
        const isHidden = container.classList.toggle('hidden');
        e.target.textContent = isHidden ? '×”×¦×’ ×”×¦×¢×•×ª × ×•×¡×¤×•×ª' : '×”×¡×ª×¨ ×”×¦×¢×•×ª';
    });

    $('#toggle-kosher-btn').addEventListener('click', e => {
        const container = $('#kosher-container');
        const isHidden = container.classList.toggle('hidden');
        e.target.textContent = isHidden ? '×”×¦×’ ××“×¨×™×š ×›×©×¨×•×ª' : '×”×¡×ª×¨ ××“×¨×™×š ×›×©×¨×•×ª';
    });

    // --- ×××–×™× ×™ ×ª×¨×’×•× ×•××˜×‘×¢ ---
    $('#eur-input').addEventListener('input', e => {
        const eur = parseFloat(e.target.value);
        $('#ils-input').value = isNaN(eur) ? '' : (eur * eurToIlsRate).toFixed(2);
    });
    $('#ils-input').addEventListener('input', e => {
        const ils = parseFloat(e.target.value);
        $('#eur-input').value = isNaN(ils) ? '' : (ils / eurToIlsRate).toFixed(2);
    });

    $('#dictionary-form').addEventListener('submit', async e => { e.preventDefault(); const input = $('#dictionary-input').value.trim(); if (input) await translateText(input); });

    $('#swap-lang-btn').addEventListener('click', () => {
        const inputEl = $('#dictionary-input'); const labelEl = $('#lang-direction-label');
        currentLang = (currentLang === 'he-it') ? 'it-he' : 'he-it';
        inputEl.placeholder = (currentLang === 'he-it') ? '×”×§×œ×“ ××™×œ×”...' : 'Scrivi una parola...';
        labelEl.innerHTML = (currentLang === 'he-it') ? '×¢×‘×¨×™×ª <i class="fa-solid fa-arrow-right-long"></i> ××™×˜×œ×§×™×ª' : '××™×˜×œ×§×™×ª <i class="fa-solid fa-arrow-right-long"></i> ×¢×‘×¨×™×ª';
        inputEl.value = '';
    });

    // --- ×××–×™× ×™ ×”×¢×œ××ª ×§×‘×¦×™× ---
    $('#image-translate-upload').addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => { const base64String = event.target.result.split(',')[1]; translateImage(base64String, file.type); };
        reader.readAsDataURL(file);
    });

    $('#document-upload-btn').addEventListener('click', () => $('#document-upload').click());
    $('#image-upload-btn').addEventListener('click', () => {
    const opts = $('#modal-upload-day-options');
    opts.innerHTML = Object.entries(localTripData.plan).sort((a,b) => a[0].localeCompare(b[0])).map(([dayId, dayData]) => 
        `<button class="btn btn-primary" data-day-id="${dayId}">${dayData.name}</button>`
    ).join('');

    $$('#modal-upload-day-options button').forEach(btn => {
        btn.onclick = () => {
            const selectedDayId = btn.dataset.dayId;
            window.closeModal();
            $('#image-upload').setAttribute('data-day-id', selectedDayId);
            $('#image-upload').click();
        };
    });

    $('#select-day-for-upload-modal').classList.add('flex');
    });

    $('#alert-modal-copy-btn').addEventListener('click', (e) => {
        navigator.clipboard.writeText($('#alert-modal-body').textContent).then(() => {
            e.target.textContent = '×”×•×¢×ª×§!';
            setTimeout(() => e.target.innerHTML = '<i class="fa-solid fa-copy mr-1"></i>×”×¢×ª×§', 2000);
        });
    });

    $('#document-upload').addEventListener('change', (e) => {
        for (const file of e.target.files) {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const newDoc = { id: Date.now().toString(), name: file.name, dataUrl: ev.target.result };
                if (tripDocRef) await updateDoc(tripDocRef, { documents: arrayUnion(newDoc) });
            };
            reader.readAsDataURL(file);
        }
    });

    $('#image-upload').addEventListener('change', (e) => {
        const dayId = $('#image-upload').getAttribute('data-day-id');
        for (const file of e.target.files) {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const newImg = { id: Date.now().toString(), name: file.name, dataUrl: ev.target.result, dayId: dayId };
                if (tripDocRef) await updateDoc(tripDocRef, { gallery: arrayUnion(newImg) });
            };
            reader.readAsDataURL(file);
        }
    });

    // --- ×××–×™× ×™ Gemini ---
    const geminiModal = $('#gemini-modal');
    $('#gemini-btn').addEventListener('click', () => geminiModal.classList.add('flex'));
    $('#gemini-close-btn').addEventListener('click', () => geminiModal.classList.remove('flex'));
    $$('#gemini-tabs-nav .tab-button').forEach(b => b.addEventListener('click', (e) => {
        $$('#gemini-tabs-nav .tab-button').forEach(btn => btn.classList.remove('tab-active'));
        e.currentTarget.classList.add('tab-active');
        $$('#gemini-modal .content-section').forEach(s => s.classList.remove('active'));
        $(`#${e.currentTarget.dataset.content}`).classList.add('active');
    }));

    $('#get-smart-advice-btn').addEventListener('click', getSmartAdvice);
    $('#gemini-submit-btn').addEventListener('click', () => {
    const promptInput = $('#gemini-prompt');
    const userPrompt = promptInput.value.trim();
    if (userPrompt) {
        window.askGeneralGemini(userPrompt);
        promptInput.value = '';
    }
    });
    $('#gemini-close-btn').addEventListener('click', () => {
        $('#gemini-modal').classList.remove('flex');
        geminiChatHistory = [];
        $('#gemini-response').textContent = '';
        $('#gemini-prompt').value = '';
    });

    // --- ×××–×™× ×™ ×©×™×ª×•×£ ×•××¦×œ××” ---
    $('#share-btn').addEventListener('click', () => {
        const url = window.location.href;
        if (navigator.share) {
            navigator.share({ title: '×ª×•×›× ×™×ª ×”×˜×™×•×œ ×©×œ× ×• ×œ××™×œ×× ×•', url: url });
        } else {
            navigator.clipboard.writeText(url).then(() => showAlert('×”×§×™×©×•×¨ ×”×•×¢×ª×§!', '×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—.'));
        }
    });

    // --- ×××–×™× ×™ × ×™×•×•×˜ ---
    const planBtn = $('#floating-plan-btn');
    const toolsBtn = $('#floating-tools-btn');
    const planSubmenu = $('#plan-submenu');
    const toolsSubmenu = $('#tools-submenu');
    function toggleSubmenu(submenuToToggle, buttonToHighlight) {
        const isAlreadyActive = submenuToToggle && submenuToToggle.classList.contains('active');
        $$('.floating-submenu').forEach(sm => sm.classList.remove('active'));
        $$('#floating-nav button, #floating-nav a').forEach(btn => btn.classList.remove('text-brand-600'));
        if (submenuToToggle && !isAlreadyActive) {
            submenuToToggle.classList.add('active');
            buttonToHighlight.classList.add('text-brand-600');
        }
    }
    planBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSubmenu(planSubmenu, planBtn); });
    toolsBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSubmenu(toolsSubmenu, toolsBtn); });

    document.addEventListener('click', (e) => { 
        if (!e.target.closest('#floating-nav-container')) toggleSubmenu(null, null);
    });
    $$('#plan-submenu a, #tools-submenu a').forEach(link => link.addEventListener('click', () => toggleSubmenu(null, null)));

    window.addEventListener('beforeunload', () => {
        if (watchingLocation && currentUserId) deleteDoc(doc(locationsColRef, currentUserId));
    });

    // --- ×××–×™× ×™ ×¡×’×™×¨×” ---
    $('#alert-modal-close').addEventListener('click', () => $('#alert-modal').classList.remove('flex'));
    $('#daily-tip-close').addEventListener('click', () => $('#daily-tip-modal').classList.remove('flex'));
    
    // --- ×××–×™× ×™ ×§×•×œ ×§×œ×˜ (×”×™×” ×—×¡×¨) ---
// ×”×•×¡×£ ×¤×•× ×§×¦×™×•×ª ××œ×• ×‘××–×•×¨ ×”-UTILS
function showLoading(title, message) {
    // ××©×ª××© ×‘×¤×•× ×§×¦×™×™×ª showAlert ×”×§×™×™××ª ×›×“×™ ×œ×”×¦×™×’ ×”×•×“×¢×ª ×˜×¢×™× ×”.
    showAlert(title, `<div class="text-center"><i class="fa-solid fa-sync fa-spin fa-2x"></i><p class="mt-2">${message}</p></div>`);
}
window.showLoading = showLoading;

function hideLoading() {
    // ×¡×•×’×¨ ××ª ×›×œ ×”××•×“×œ×™× ××¡×•×’ backdrop, ×›×•×œ×œ ×”×˜×¢×™× ×”
    window.closeModal(); 
}
window.hideLoading = hideLoading;
    // --- ×××–×™×Ÿ ×œ×›×¤×ª×•×¨ ×”×¤×ª×™×—×” ×©×œ ×§×œ×˜ ×”×§×‘×¦×™× ---
const uploadReceiptBtn = document.getElementById('upload-receipt-btn');

if (uploadReceiptBtn) { // âœ… ×‘×“×™×§×” ×‘×˜×•×—×”: ×¤×•×ª×¨ ××ª ×©×’×™××ª ×”-Null
    uploadReceiptBtn.addEventListener('click', () => {
        // ×©×™××•×© ×‘-receiptFileInput ×©×›×‘×¨ ×”×•×’×“×¨ ×œ××¢×œ×”!
        if (receiptFileInput) {
             receiptFileInput.click();
        }
    });
}
const receiptFileInput = document.getElementById('receipt-file-input'); // ×”×¤× ×™×™×” ×œ××œ×× ×˜ ×”×§×œ×˜ ×”× ×¡×ª×¨

if (uploadReceiptBtn) { 
    uploadReceiptBtn.addEventListener('click', () => {
        if (receiptFileInput) {
             receiptFileInput.click();
        }
    });
}

  // --- ×××–×™× ×™ ×©×™×ª×•×£ ×•××¦×œ××” ---

// 1. ×–×™×”×•×™ ××ª×¨×™×/××•×‘×™×™×§×˜×™×:
$('#lookup-site-btn').addEventListener('click', window.startSiteLookupCamera);

// 2. ×ª×¨×’×•× ××¦×œ××”:
$('#translate-camera-btn').addEventListener('click', window.startTranslateCamera);
 
// 3. ×¡×¨×™×§×ª ×§×‘×œ×” (×”×›× ×¡×ª ×”×•×¦××”):
$('#scan-receipt-btn').addEventListener('click', window.startReceiptScanCamera);

// 4. ×¡×¨×™×§×ª ×‘×¨×§×•×“ (×›×©×¨×•×ª):
$('#scan-kosher-barcode-btn').addEventListener('click', window.startKosherBarcodeScanner);
  // --- ×œ×•×’×™×§×” ×—×“×©×” ×¢×‘×•×¨ ×–×•× ×”××¦×œ××” ---
    

    document.getElementById('capture-btn').addEventListener('click', captureFrame);
    document.getElementById('lookup-site-btn').addEventListener('click', startSiteLookupCamera);
    document.getElementById('translate-camera-btn').addEventListener('click', startTranslateCamera);
    document.getElementById('scan-receipt-btn').addEventListener('click', startReceiptScanCamera);
    document.getElementById('scan-kosher-barcode-btn').addEventListener('click', startKosherBarcodeScanner);
    document.getElementById('camera-close-btn').addEventListener('click', () => cameraManager.stop());
    document.getElementById('torch-btn').addEventListener('click', () => cameraManager.toggleTorch());
    document.getElementById('zoom-in-btn').addEventListener('click', () => cameraManager.changeZoom(1));
    document.getElementById('zoom-out-btn').addEventListener('click', () => cameraManager.changeZoom(-1));

    // --- ×—×™×‘×•×¨ ×›×¤×ª×•×¨×™ ××¦×œ××” ×¨××©×™×™× ---
    document.getElementById('lookup-site-btn').addEventListener('click', startSiteLookupCamera);
    document.getElementById('translate-camera-btn').addEventListener('click', startTranslateCamera);
    document.getElementById('scan-receipt-btn').addEventListener('click', startReceiptScanCamera);
    document.getElementById('scan-kosher-barcode-btn').addEventListener('click', startKosherBarcodeScanner);
    
    // --- ×—×™×‘×•×¨ ×›×¤×ª×•×¨×™ ×©×œ×™×˜×” ×‘××¦×œ××” ---
    document.getElementById('camera-close-btn').addEventListener('click', () => cameraManager.stop());
    document.getElementById('capture-btn').addEventListener('click', captureFrame);
    document.getElementById('torch-btn').addEventListener('click', () => cameraManager.toggleTorch());
    document.getElementById('zoom-in-btn').addEventListener('click', () => cameraManager.changeZoom(1));
    document.getElementById('zoom-out-btn').addEventListener('click', () => cameraManager.changeZoom(-1));

    // --- ×—×™×‘×•×¨ ×›×¤×ª×•×¨×™ ×ª×¤×™×œ×•×ª ---
document.getElementById('tefilat-haderech-btn').addEventListener('click', () => {
    const text = hebrewPrayers.tefilatHaderech.replace(/<[^>]*>?/gm, '');
    showAlert('×ª×¤×™×œ×ª ×”×“×¨×š', hebrewPrayers.tefilatHaderech, { text, useApi: true }); // <-- ×”×©×™× ×•×™ ×›××Ÿ
});
    document.getElementById('birkat-hamazon-btn').addEventListener('click', () => {
        const text = hebrewPrayers.birkatHaMazon.replace(/<[^>]*>?/gm, '');
        showAlert('×‘×¨×›×ª ×”××–×•×Ÿ', hebrewPrayers.birkatHaMazon, { text, useApi: false }); // ××¨×•×š ××“×™ ×œ-API
    });
    document.getElementById('bracha-achrona-btn').addEventListener('click', showBrachaAchronaOptions);
    // ×××–×™×Ÿ ×œ×”×©××¢×ª ×“×’×™××ª ×§×•×œ ×‘×©×™× ×•×™ ×”×’×“×¨×•×ª
    document.getElementById('global-voice-select').addEventListener('change', () => {
        ttsManager.speak("×©×œ×•×, ×–×”×• ×”×§×•×œ ×©×‘×—×¨×ª.", true, 'he-IL');
    });

  // ×•×“× ×©×”×©×•×¨×•×ª ×”××œ×” × ×¨××•×ª ×›×š ×‘×—×œ×§ ×”×ª×—×ª×•×Ÿ ×©×œ ×”×§×•×“ ×©×œ×š
heBtn.addEventListener('click', (e) => window.startRecognition('he-IL', e.currentTarget));
itBtn.addEventListener('click', (e) => window.startRecognition('it-IT', e.currentTarget));


}); // <--- ×”×¡×•×’×¨ ×”×¡×•×¤×™ ×©×œ document.addEventListener('DOMContentLoaded')
//------------


  </script>

</body>
</html>
