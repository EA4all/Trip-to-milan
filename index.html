<!DOCTYPE html>
<html lang="he" dir="rtl" class="scroll-smooth dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×ª×•×›× ×™×ª ×˜×™×•×œ ×©×™×ª×•×¤×™×ª ×œ××™×œ×× ×• (v1.1)</title>
  <meta name="description" content="×“×©×‘×•×¨×“ ××™× ×˜×¨××§×˜×™×‘×™ ×•×©×™×ª×•×¤×™ ×œ×ª×›× ×•×Ÿ ×—×•×¤×©×” ×‘××™×œ×× ×•: ×œ×•×– ×™×•××™, ××¤×•×ª, ××–×’ ××•×•×™×¨, ×¡×™×›×•× ×˜×™×•×œ ×—×›×, ××¢×§×‘ ×ª×§×¦×™×‘ ×•×¢×•×“." />
  <meta name="theme-color" content="#1d4ed8">
  <link rel="manifest" href="manifest.json">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Assistant', 'ui-sans-serif', 'system-ui'],
          },
          colors: {
            brand: {
              50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
              400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a'
            }
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- LeafletJS for Live Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
    :root{
      --bg: #f9fafb; --fg:#1f2937; --card:#ffffff; --muted:#6b7280;
      --btn:#1d4ed8; --btn-h:#1e40af; --brd:#e5e7eb;
      --header-bg: rgba(255,255,255,0.9);
      --heading-font: 'Assistant', sans-serif;
    }
    .dark{
      --bg:#0b1220; --fg:#e5e7eb; --card:#0f172a; --muted:#9ca3af;
      --btn:#2563eb; --btn-h:#1d4ed8; --brd:#1f2937;
      --header-bg: rgba(11,18,32,0.8);
    }
    
   html { 
  scroll-padding-top: 80px; 
  overflow-x: hidden; /* Add this line */
}
body {
  background:var(--bg); 
  color:var(--fg); 
  font-family:Assistant,ui-sans-serif,system-ui; 
  overflow-x: hidden; /* Keep this line */
}
    h2, h3 { font-family: var(--heading-font); }
    #site-header { background-color: var(--header-bg); }
    
    .dark input, .dark textarea, .dark select {
        background-color: #1f2937;
        color: var(--fg);
        border-color: #374151;
    }
    .dark input::placeholder, .dark textarea::placeholder { color: var(--muted); }

    .btn{display:inline-flex;align-items:center;gap:.5rem;justify-content:center;border-radius:0.75rem;
         font-weight:600;font-size:.9rem;padding:.5rem .85rem;transition:.2s;border:1px solid transparent}
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .btn-primary{background:var(--btn);color:#fff;}
    .btn-primary:hover{background:var(--btn-h)}
    .btn-ghost{background:transparent;border-color:var(--brd);color:var(--fg);}
    .btn-ghost:hover{background:rgba(0,0,0,.04)}
    .dark .btn-ghost:hover{background:rgba(255,255,255,.06)}
    .tab-button{padding:.5rem .75rem;font-weight:700;border-bottom:2px solid transparent;border-radius:.5rem .5rem 0 0;}
    .tab-active{color:var(--btn);background:var(--card);border-color:var(--btn)}
    #gemini-tabs-nav .tab-button { border-color: transparent; }
    #gemini-tabs-nav .tab-active { border-color: var(--btn); color: var(--btn); }

    .content-section{display:none}
    .content-section.active{display:block}
    .thumb{width:100%;height:14rem;object-fit:cover}
    .logo{width:56px;height:56px;border-radius:.75rem;border:1px solid var(--brd);object-fit:contain;background:#fff}
    
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 100;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-backdrop.flex { display: flex; }
    .modal {
        background: var(--card); color: var(--fg);
        width: 90%; max-width: 500px; border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        display: flex; flex-direction: column; max-height: 80vh;
    }
    .image-carousel { position: relative; flex-shrink:0; width:100%; }
    @media (min-width: 768px) { .image-carousel { width: 33.333333%; } }
    .image-carousel button {
      position: absolute; top: 50%; transform: translateY(-50%);
      background-color: rgba(0,0,0,0.4); color: white;
      border: none; border-radius: 50%;
      width: 32px; height: 32px;
      cursor: pointer; transition: background-color 0.2s;
    }
    .image-carousel button:hover { background-color: rgba(0,0,0,0.7); }
    .carousel-prev { left: 8px; }
    .carousel-next { right: 8px; }

    .countdown-number { font-size: 1.5rem; line-height: 1; }
    .countdown-label { font-size: 0.75rem; }

    .floating-submenu {
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
    }
    .floating-submenu.active {
        transform: translateY(0);
        opacity: 1;
        pointer-events: auto;
    }

    .delete-btn {
        position: absolute; top: 4px; right: 4px;
        background-color: rgba(239, 68, 68, 0.7);
        color: white; border-radius: 50%;
        width: 24px; height: 24px;
        border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.2s; z-index: 10;
    }
    .relative:hover .delete-btn { opacity: 1; }
    
    #live-location-map {
        height: 350px;
        border-radius: 1rem;
        border: 1px solid var(--brd);
    }
    .leaflet-popup-content-wrapper {
        background: var(--card);
        color: var(--fg);
    }
    .leaflet-popup-tip {
        background: var(--card);
    }


    @media print {
        body * { visibility: hidden; }
        #plan, #plan * { visibility: visible; }
        #plan { position: absolute; left: 0; top: 0; width: 100%; }
        #plan details { page-break-inside: avoid; }
        #plan summary, .nav-link, .btn, header, main > section:not(#plan), #floating-nav-container, .day-actions { display: none !important; }
        #plan details[open] > div { display: block !important; }
        #plan-content-container { padding: 0 !important; }
        h2 { font-size: 24px !important; }
        #plan details {
            box-shadow: none !important;
            border: 1px solid #ccc;
            margin-bottom: 1rem;
        }
    }


    @media (max-width: 767px) {
      body { padding-bottom: 70px; } /* Add padding for floating nav */
      .responsive-table thead { display: none; }
      .responsive-table tr {
        display: block; margin-bottom: 1rem; border: 1px solid var(--brd);
        border-radius: 0.75rem; padding: 1rem;
      }
      .responsive-table td {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.5rem 0; border-bottom: 1px solid var(--brd);
      }
      .responsive-table td:last-child { border-bottom: none; }
      .responsive-table td::before {
        content: attr(data-label); font-weight: 600; margin-right: 1rem;
      }
      .responsive-table .logo-cell { justify-content: center; padding-bottom: 1rem; }
      .responsive-table .logo-cell::before { display: none; }
    }
  </style>
</head>
<body class="dark:bg-gray-900 dark:text-gray-100">

  <header id="site-header" class="backdrop-blur shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <span class="inline-block w-2 h-6 rounded bg-brand-700"></span>
          <h1 class="text-xl md:text-2xl font-bold text-brand-800 dark:text-brand-300">×”×—×•×¤×©×” ×‘××™×œ×× ×•</h1>
        </div>
        <div class="hidden md:flex md:items-center md:gap-1 flex-wrap">
          <a href="#overview" class="nav-link px-3 py-2 rounded-md text-sm font-medium">×¡×§×™×¨×”</a>
          <a href="#plan" class="nav-link px-3 py-2 rounded-md text-sm font-medium">×ª×•×›× ×™×ª</a>
          <a href="#suggestions" class="nav-link px-3 py-2 rounded-md text-sm font-medium">×”×¦×¢×•×ª</a>
          <a href="#kosher" class="nav-link px-3 py-2 rounded-md text-sm font-medium">××•×›×œ ×›×©×¨</a>
          <a href="#tools" class="nav-link px-3 py-2 rounded-md text-sm font-medium">×›×œ×™×</a>
        </div>
        <div class="flex items-center gap-2">
            <div id="sync-status" class="text-xs text-gray-400 flex items-center gap-2" title="××ª×—×‘×¨...">
                <i class="fa-solid fa-cloud text-yellow-500"></i> <span class="hidden sm:inline">××ª×—×‘×¨...</span>
            </div>
            <button id="theme-toggle" class="btn btn-ghost" aria-label="×”×—×œ×¤×ª ××¦×‘"><i class="fa-solid fa-sun"></i></button>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto p-4 sm:p-6 lg:p-8">

    <section id="overview" class="my-12 scroll-mt-24">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">×¡×§×™×¨×” ×›×œ×œ×™×ª</h2>
        <div class="flex gap-2 flex-wrap justify-center">
            <button id="share-btn" class="btn btn-primary"><i class="fa-solid fa-share-alt mr-2"></i>×©×ª×£ ×ª×•×›× ×™×ª</button>
            <button id="gemini-btn" class="btn btn-primary"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>×©××œ ××ª Gemini</button>
            <button id="find-nearby-btn" class="btn btn-primary"><i class="fa-solid fa-location-crosshairs mr-2"></i>××¦× ××§×•××•×ª ×§×¨×•×‘×™×</button>
            <button id="show-tip-btn" class="btn btn-primary"><i class="fa-solid fa-lightbulb mr-2"></i>×˜×™×¤ ×™×•××™</button>
            <button id="create-summary-btn" class="btn btn-primary bg-green-600 hover:bg-green-700"><i class="fa-solid fa-book-open mr-2"></i>×¦×•×¨ ×¡×™×›×•× ×˜×™×•×œ</button>
        </div>
      </div>
      <div id="overview-cards" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>

    <section id="plan" class="my-12 scroll-mt-24">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">×ª×•×›× ×™×ª ×”×˜×™×•×œ ×”×™×•××™×ª</h2>
        <div class="flex gap-2 flex-wrap justify-center day-actions">
            <button id="collapse-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-compress mr-1"></i>×›×•×•×¥ ×”×›×œ</button>
            <button id="expand-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-expand mr-1"></i>×”×¨×—×‘ ×”×›×œ</button>
            <button id="print-btn" class="btn btn-ghost btn-sm"><i class="fa-solid fa-print mr-1"></i>×”×“×¤×¡ ×ª×•×›× ×™×ª</button>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-950 p-2 sm:p-6 rounded-2xl shadow-lg">
        <div class="border-b border-gray-200 dark:border-gray-800 mb-6">
          <nav class="-mb-px flex flex-wrap justify-center gap-2 sm:gap-4" aria-label="Tabs" id="day-tabs-nav"></nav>
        </div>
        <div id="plan-content-container"></div>
      </div>
    </section>
    
    <section id="suggestions" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">×××’×¨ ×”×¦×¢×•×ª</h2>
        <div class="text-center">
            <button id="toggle-suggestions-btn" class="btn btn-primary">×”×¦×’ ×”×¦×¢×•×ª × ×•×¡×¤×•×ª</button>
        </div>
        <div id="suggestions-container" class="hidden mt-6 bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
            <div id="suggestions-table-container"></div>
        </div>
    </section>

    <section id="kosher" class="my-12 scroll-mt-24">
      <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">×”××“×¨×™×š ×”×§×•×œ×™× ×¨×™ ×”×›×©×¨</h2>
      <div class="text-center">
        <button id="toggle-kosher-btn" class="btn btn-primary">×”×¦×’ ××“×¨×™×š ×›×©×¨×•×ª</button>
      </div>
      <div id="kosher-container" class="hidden mt-6">
        <div class="bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
          <p id="kosher-subtitle" class="text-center mb-6 text-gray-600 dark:text-gray-400">×¨×™×›×•×– ×”××¤×©×¨×•×™×•×ª ×‘×©×›×•× ×•×ª Bande Nere ×•â€‘Washington.</p>
          <div id="kosher-filters" class="mb-4 flex flex-wrap gap-2 justify-center"></div>
          <div id="kosher-results"></div>
        </div>
      </div>
    </section>

    <section id="tools" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">×›×œ×™× ×•××™×“×¢ ×©×™××•×©×™</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"><div id="emergency-phrases-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-book-medical mr-2"></i>×©×™×—×•×Ÿ ×—×™×¨×•×</h3>
    <details class="bg-gray-50 dark:bg-gray-900 rounded-lg">
        <summary class="cursor-pointer font-semibold p-3">
            <i class="fa-solid fa-triangle-exclamation text-red-500 w-4 mr-1"></i> ××¦×‘×™ ×—×™×¨×•×
        </summary>
        <div class="p-3 border-t dark:border-gray-700 text-sm space-y-2">
            <div><b>×× ×™ ×¦×¨×™×š ×¨×•×¤×:</b><br>Ho bisogno di un medico (<i>××•Ö¹ ×‘Ö¼Ö´×™×–×•Ö¹× Ö°×™×•Ö¹ ×“Ö´×™ ××•Ö¼×Ÿ ×Ö¶×“Ö´×™×§×•Ö¹</i>)</div>
            <div><b>××™×¤×” ×‘×™×ª ×”×—×•×œ×™×?:</b><br>Dov'Ã¨ l'ospedale? (<i>×“×•Ö¹×‘Ö¶'×” ×œ×•Ö¹×¡Ö°×¤Ö¼Ö¶×“Ö¸××œÖ¶×”?</i>)</div>
            <div><b>×ª×–××™× ×• ×××‘×•×œ× ×¡!:</b><br>Chiamate un'ambulanza! (<i>×§Ö°×™Ö¸××Ö¸××˜Ö¶×” ××•Ö¼×Ÿ-×Ö¸×Ö°×‘Ö¼×•Ö¼×œÖ¸× Ö°×¦Ö¸×”!</i>)</div>
        </div>
    </details>
    <details class="bg-gray-50 dark:bg-gray-900 rounded-lg mt-2">
        <summary class="cursor-pointer font-semibold p-3">
            <i class="fa-solid fa-handshake-angle w-4 mr-1"></i> ×›×œ×œ×™ ×•× ×™××•×¡×™×
        </summary>
        <div class="p-3 border-t dark:border-gray-700 text-sm space-y-2">
            <div><b>××¤×©×¨ ×—×©×‘×•×Ÿ ×‘×‘×§×©×”?:</b><br>Il conto, per favore (<i>×Ö´×™×œ ×§×•Ö¹× Ö°×˜×•Ö¹, ×¤Ö¼Ö¶×¨ ×¤Ö¸××‘×•Ö¹×¨Ö¶×”</i>)</div>
            <div><b>×× ×™ ×œ× ××‘×™×Ÿ:</b><br>Non capisco (<i>× ×•Ö¹×Ÿ ×§Ö¸×¤Ö¼Ö´×™×¡Ö°×§×•Ö¹</i>)</div>
            <div><b>×›××” ×–×” ×¢×•×œ×”?:</b><br>Quanto costa? (<i>×§Ö°×•Ö¸×•×× Ö°×˜×•Ö¹ ×§×•Ö¹×¡Ö°×˜Ö¸×”?</i>)</div>
        </div>
    </details>
</div>
          <div id="local-time-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-clock mr-2"></i>×–××Ÿ ××§×•××™</h3>
    <div class="space-y-3">
        <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
            <span class="font-semibold">××™×œ×× ×• ğŸ‡®ğŸ‡¹</span>
            <span id="milan-time" class="font-mono text-lg font-bold">--:--:--</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900 rounded-lg">
            <span class="font-semibold">×™×©×¨××œ ğŸ‡®ğŸ‡±</span>
            <span id="israel-time" class="font-mono text-lg font-bold">--:--:--</span>
        </div>
    </div>
</div>
        <div id="utility-finder-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-map-signs mr-2"></i>×—×™×¤×•×© ××”×™×¨ ×‘×¡×‘×™×‘×”</h3>
    <div class="grid grid-cols-1 gap-2">
        <button class="btn btn-primary" onclick="window.findUtility('bagno pubblico', '×©×™×¨×•×ª×™× ×¦×™×‘×•×¨×™×™×')">
            <i class="fa-solid fa-restroom w-4"></i> ××¦× ×©×™×¨×•×ª×™×
        </button>
        <button class="btn btn-primary" onclick="window.findUtility('farmacia', '×‘×™×ª ××¨×§×—×ª')">
            <i class="fa-solid fa-pills w-4"></i> ××¦× ×‘×™×ª ××¨×§×—×ª
        </button>
        <button class="btn btn-primary" onclick="window.findUtility('bancomat', '×›×¡×¤×•××˜')">
            <i class="fa-solid fa-money-bill w-4"></i> ××¦× ×›×¡×¤×•××˜
        </button>
    </div>
</div>  
            
            <div id="live-location-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-3">
                <h3 class="text-xl font-bold mb-3 text-center"><i class="fa-solid fa-map-location-dot mr-2"></i>××¤×ª ××™×§×•× ×—×™</h3>
                <div class="text-center">
                    <p class="mb-4">×›×œ ××©×ª××© ×¢× ×”×œ×™× ×§ ×™×›×•×œ ×œ×¨××•×ª ××ª ××™×§×•× ×”××˜×™×™×œ×™× ×‘×–××Ÿ ×××ª. ×¨×§ ×”××˜×™×™×œ×™× ×¦×¨×™×›×™× ×œ×œ×—×•×¥ ×¢×œ "×©×ª×£ ××™×§×•×".</p>
                    <div id="live-location-map" class="mb-4"></div>
                    <div class="flex flex-col sm:flex-row gap-2 justify-center">
                        <button id="toggle-location-sharing-btn" class="btn btn-primary"><i class="fa-solid fa-tower-broadcast mr-2"></i>×”×¤×¢×œ ×©×™×ª×•×£ ××™×§×•×</button>
                        <input type="text" id="user-name-input" placeholder="×”×›× ×¡ ××ª ×©××š (×œ×–×™×”×•×™)" class="p-2 rounded-lg border text-center">
                    </div>
                    <p id="location-status" class="text-xs text-gray-500 mt-2 h-4"></p>
                </div>
            </div>

            <div id="transport-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-3">
                <h3 class="text-xl font-bold mb-3 text-center"><i class="fa-solid fa-bus mr-2"></i>××“×¨×™×š ×ª×—×‘×•×¨×”</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-bold text-brand-800 dark:text-brand-200 mb-3">×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª (ATM)</h4>
                        <ul class="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                            <li><span class="font-semibold">××™×¤×” ×§×•× ×™×:</span> ×‘××›×•× ×•×ª ×”××•×˜×•××˜×™×•×ª ×‘×›×œ ×ª×—× ×ª ××˜×¨×•, ×‘×§×™×•×¡×§×™× (Tabacchi), ××• ×‘××¤×œ×™×§×¦×™×” ×”×¨×©××™×ª <a href="https://www.atm.it/it/Pagine/default.aspx" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">ATM Milano</a>.</li>
                            <li><span class="font-semibold">×”××œ×¦×”:</span> ×›×¨×˜×™×¡ ×œ-3 ×™××™× (72 ×©×¢×•×ª) ×”×•× ×”××©×ª×œ× ×‘×™×•×ª×¨ ×œ×©×”×™×™×” ×©×œ×›×.</li>
                        </ul>
                        <div class="relative h-[280px] mt-4">
                            <canvas id="transportChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-brand-800 dark:text-brand-200 mb-3">×¨×›×‘×•×ª ×œ×˜×™×•×œ×™ ×™×•×</h4>
                        <ul class="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                            <li><span class="font-semibold">××™×¤×” ×§×•× ×™×:</span> ××•××œ×¥ ×œ×”×–××™×Ÿ ××¨××© ×‘××™× ×˜×¨× ×˜ ×›×“×™ ×œ×”×‘×˜×™×— ××§×•× ×•××—×™×¨ ×˜×•×‘.</li>
                            <li><span class="font-semibold">××ª×¨×™× ××•××œ×¦×™×:</span> <a href="https://www.trenitalia.com/en.html" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">Trenitalia</a> (×¨×©××™) ××• <a href="https://www.italotreno.it/en" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">Italo</a> (×¤×¨×˜×™).</li>
                            <li><span class="font-semibold">×ª×—× ×ª ×™×¦×™××”:</span> ×›×œ ×”×¨×›×‘×•×ª ×œ××’××™× ×™×•×¦××•×ª ××ª×—× ×ª **Milano Centrale**.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div id="weather-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-1">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-cloud-sun mr-2"></i>××–×’ ××•×•×™×¨</h3>
                <div id="weather-forecast" class="space-y-3"><p>×˜×•×¢×Ÿ ×ª×—×–×™×ª...</p></div>
                <div id="weather-attire-recommendation" class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700 text-sm text-center"></div>
            </div>
            <div id="budget-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 md:col-span-2 lg:col-span-2">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-euro-sign mr-2"></i>××¢×§×‘ ×ª×§×¦×™×‘</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow">
                    <div>
                        <div class="mb-4">
                            <label for="total-budget" class="block text-sm font-medium">×ª×§×¦×™×‘ ×›×œ×œ×™ (â‚¬)</label>
                            <input type="number" id="total-budget" placeholder="×”×–×Ÿ ×ª×§×¦×™×‘" class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white">
                        </div>
                        <form id="expense-form" class="space-y-3">
                            <input type="text" id="expense-desc" placeholder="×ª×™××•×¨ ×”×”×•×¦××”" class="w-full p-2 rounded-xl border" required>
                             <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="expense-amount" placeholder="×¡×›×•× (â‚¬)" class="w-full p-2 rounded-xl border" required>
                                <select id="expense-category" class="w-full p-2 rounded-xl border" required>
                                    <option value="">×§×˜×’×•×¨×™×”</option>
                                    <option value="××•×›×œ">××•×›×œ</option>
                                    <option value="×§× ×™×•×ª">×§× ×™×•×ª</option>
                                    <option value="×ª×—×‘×•×¨×”">×ª×—×‘×•×¨×”</option>
                                    <option value="××˜×¨×§×¦×™×•×ª">××˜×¨×§×¦×™×•×ª</option>
                                    <option value="××—×¨">××—×¨</option>
                                </select>
                             </div>
                            <button type="submit" class="btn btn-primary w-full">×”×•×¡×£ ×”×•×¦××”</button>
                        </form>
                        <button id="calculate-estimated-btn" class="btn btn-primary w-full mt-2"><i class="fa-solid fa-calculator mr-2"></i>×—×©×‘ ×¢×œ×•×ª ××©×•×¢×¨×ª ×œ××˜×¨×§×¦×™×•×ª</button>
                        <div id="expense-list" class="text-sm my-4 flex-grow max-h-40 overflow-y-auto pr-2"></div>
                        <div class="mt-auto pt-3 border-t font-bold space-y-2 text-md">
                             <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span>×¢×œ×•×ª ××©×•×¢×¨×ª</span>
                                    <input type="checkbox" id="include-estimated-costs" checked class="w-4 h-4 rounded text-brand-600 focus:ring-brand-500" title="×›×œ×•×œ ×‘×—×™×©×•×‘ ×”×™×ª×¨×”">
                                </div>
                                <span id="estimated-costs">0.00â‚¬</span>
                            </div>
                            <div class="flex justify-between text-red-600 dark:text-red-400"><span>×”×•×¦××•×ª ×‘×¤×•×¢×œ:</span> <span id="total-expenses">0.00</span>â‚¬</div>
                            <div class="flex justify-between text-green-600 dark:text-green-400"><span>×™×ª×¨×”:</span> <span id="budget-balance">0.00</span>â‚¬</div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center min-h-[200px]">
                        <div class="relative w-full h-full max-h-[250px]">
                            <canvas id="budget-chart"></canvas>
                        </div>
                        <div id="budget-chart-placeholder" class="hidden text-center text-gray-400 text-sm">×”×•×¡×™×¤×• ×”×•×¦××•×ª ×›×“×™ ×œ×¨××•×ª ××ª ×”×ª×¨×©×™×</div>
                        <div id="budget-chart-legend" class="mt-4 w-full space-y-1"></div>
                    </div>
                </div>
            </div>
            <div id="checklist-section-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-1">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-list-check mr-2"></i>×¦'×§-×œ×™×¡×˜</h3>
                <form id="add-checklist-item-form" class="grid sm:grid-cols-3 gap-2 mb-4">
                    <input type="text" id="new-item-text" placeholder="×¤×¨×™×˜ ×—×“×©" class="sm:col-span-2 w-full p-2 rounded-lg border" required>
                    <select id="category-select" class="w-full p-2 rounded-lg border"></select>
                    <input type="text" id="new-category-text" placeholder="×§×˜×’×•×¨×™×” ×—×“×©×” (××•×¤×¦×™×•× ×œ×™)" class="sm:col-span-2 w-full p-2 rounded-lg border">
                    <button type="submit" class="btn btn-primary">×”×•×¡×£</button>
                </form>
                <div id="checklist-container" class="space-y-4 max-h-96 overflow-y-auto"></div>
            </div>
            <div id="translator-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 lg:col-span-1">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-language mr-2"></i>×ª×¨×’×•××•×Ÿ</h3>
                <div class="text-xs text-center text-gray-500 mb-2" id="lang-direction-label">×¢×‘×¨×™×ª <i class="fa-solid fa-arrow-right-long"></i> ××™×˜×œ×§×™×ª</div>
<form id="dictionary-form" class="grid grid-cols-6 gap-2 mb-3">
   <input type="text" id="dictionary-input" placeholder="×”×§×œ×“ ×œ×ª×¨×’×•×..." class="col-span-6 w-full p-2 rounded-lg border">

   <button type="button" id="swap-lang-btn" class="btn btn-ghost" title="×”×—×œ×£ ×©×¤×•×ª"><i class="fa-solid fa-exchange-alt"></i></button>
   <button type="submit" class="btn btn-primary col-span-2">×ª×¨×’×</button>
   <button type="button" id="translate-upload-btn" class="btn btn-ghost" title="×”×¢×œ×” ×ª××•× ×”"><i class="fa-solid fa-file-image"></i></button>
   <button type="button" id="translate-camera-btn" class="btn btn-ghost" title="×¤×ª×— ××¦×œ××”"><i class="fa-solid fa-camera"></i></button>
   <input type="file" id="image-translate-upload" class="hidden" accept="image/*">

   <button type="button" id="voice-translate-he-btn" class="btn btn-primary col-span-3"><i class="fa-solid fa-microphone"></i> ×“×‘×¨ ×‘×¢×‘×¨×™×ª</button>
   <button type="button" id="voice-translate-it-btn" class="btn btn-ghost col-span-3"><i class="fa-solid fa-microphone"></i> Parla Italiano</button>
</form>
                <div id="translation-result-container" class="mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[60px] text-center flex items-center justify-center gap-3">
                   <span class="text-gray-500">×”×ª×¨×’×•× ×™×•×¤×™×¢ ×›××Ÿ...</span>
                </div>
                <div id="translation-history" class="mt-3 pt-3 border-t text-xs space-y-2 max-h-24 overflow-y-auto">
                    <div class="text-center text-gray-400">×”×™×¡×˜×•×¨×™×™×ª ×ª×¨×’×•××™×</div>
                </div>
           </div>
           <div id="converter-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 lg:col-span-1">
             <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-right-left mr-2"></i>×××™×¨ ××˜×‘×¢</h3>
             <div class="space-y-4">
                 <div>
                     <label for="eur-input" class="block text-sm font-medium">××™×¨×• (â‚¬)</label>
                     <input type="number" id="eur-input" placeholder="EUR" class="w-full p-2 mt-1 rounded-xl border">
                 </div>
                 <div>
                     <label for="ils-input" class="block text-sm font-medium">×©×§×œ (â‚ª)</label>
                     <input type="number" id="ils-input" placeholder="ILS" class="w-full p-2 mt-1 rounded-xl border">
                 </div>
             </div>
             <p id="exchange-rate-display" class="text-xs text-gray-500 mt-auto pt-3 text-center">×˜×•×¢×Ÿ ×©×¢×¨ ×—×œ×™×¤×™×Ÿ...</p>
         </div>
         <div id="safety-warnings-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-1">
            <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-triangle-exclamation mr-2"></i>××–×”×¨×•×ª ×•×¢×“×›×•× ×™×</h3>
            <div id="safety-warnings-content" class="text-sm space-y-2 max-h-48 overflow-y-auto">×˜×•×¢×Ÿ ××™×“×¢...</div>
            <button id="refresh-warnings-btn" class="btn btn-ghost w-full mt-3">×¨×¢× ×Ÿ ××™×“×¢</button>
        </div>
        <div id="customs-info-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 md:col-span-2 lg:col-span-2">
            <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-suitcase-rolling mr-2"></i>××™×“×¢ ×¢×œ ××›×¡ ×•×›×‘×•×“×”</h3>
            <div class="text-sm space-y-2">
                <p><b><i class="fa-solid fa-right-to-bracket"></i> ××›×¡ ×‘×›× ×™×¡×” ×œ××™×˜×œ×™×” (×œ× ×•×¡×¢, ××—×•×¥ ×œ××™×—×•×“):</b></p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 text-xs">
                    <li><b>×˜×‘×§:</b> 200 ×¡×™×’×¨×™×•×ª ××• 50 ×¡×™×’×¨×™×.</li>
                    <li><b>××œ×›×•×”×•×œ:</b> 1 ×œ×™×˜×¨ ×©×œ ××œ×›×•×”×•×œ ××¢×œ 22% (×›××• ×•×•×“×§×”) ××• 2 ×œ×™×˜×¨ ×™×™×Ÿ.</li>
                    <li><b>××–×•××Ÿ:</b> ×™×© ×œ×”×¦×”×™×¨ ×¢×œ ×¡×›×•××™× ××¢×œ 10,000 ××™×¨×•.</li>
                    <li><b>××™×¡×•×¨×™×:</b> ××¡×•×¨ ×œ×”×›× ×™×¡ ××•×¦×¨×™ ×‘×©×¨ ×•×—×œ×‘ ××—×•×¥ ×œ××™×—×•×“ ×”××™×¨×•×¤×™.</li>
                </ul>
                <p class="mt-3"><b><i class="fa-solid fa-left-to-bracket"></i> ××›×¡ ×‘×—×–×¨×” ×œ×™×©×¨××œ (×œ× ×•×¡×¢):</b></p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 text-xs">
                    <li><b>×¤×˜×•×¨ ××™×©×™:</b> × ×™×ª×Ÿ ×œ×”×›× ×™×¡ ××ª× ×•×ª ×•×—×¤×¦×™× ××™×©×™×™× ×‘×©×•×•×™ ×›×•×œ×œ ×©×œ ×¢×“ 200$ ×œ× ×•×¡×¢ (××¢×œ ×’×™×œ ×©× ×ª×™×™×).</li>
                    <li><b>××–×•×Ÿ:</b> ×¢×“ 3 ×§"×’ ××–×•×Ÿ, ×‘×ª× ××™ ×©×›×œ ×¤×¨×™×˜ ×œ× ×©×•×§×œ ×™×•×ª×¨ ×-1 ×§"×’.</li>
                    <li><b>×˜×‘×§ (××¢×œ ×’×™×œ 18):</b> 200 ×¡×™×’×¨×™×•×ª (×¤Ö¿×§×˜ ××—×“) ××• 250 ×’×¨× ××•×¦×¨×™ ×˜×‘×§ ××—×¨×™×.</li>
                    <li><b>××œ×›×•×”×•×œ (××¢×œ ×’×™×œ 18):</b> 1 ×œ×™×˜×¨ ×©×œ ××©×§×” ×—×¨×™×£ ×•-2 ×œ×™×˜×¨ ×™×™×Ÿ.</li>
                    <li><b>×—×©×•×‘:</b> ×”×¤×˜×•×¨ ×”×•× ××™×©×™ ×•×œ× × ×™×ª×Ÿ ×œ×¦×‘×™×¨×” ×œ××¡×¤×¨ ×× ×©×™×.</li>
                </ul>
            </div>
        </div>
        </div>
    </section>

    <section id="documents-and-gallery" class="my-12 scroll-mt-24 grid md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4"><i class="fa-solid fa-folder-open mr-2"></i>×ª×™×§ ××¡××›×™×</h2>
            <input type="file" id="document-upload" multiple class="hidden">
            <button id="document-upload-btn" class="btn btn-primary w-full mb-4">×”×¢×œ×” ××¡××›×™×</button>
            <div id="documents-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
        <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4"><i class="fa-solid fa-images mr-2"></i>×’×œ×¨×™×™×ª ×ª××•× ×•×ª</h2>
            <input type="file" id="image-upload" multiple accept="image/*" class="hidden">
            <button id="image-upload-btn" class="btn btn-primary w-full mb-4">×”×¢×œ×” ×ª××•× ×•×ª</button>
            <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
    </section>

  </main>
  
  <div id="add-to-day-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b"><h3 class="text-lg font-bold">×”×•×¡×£ ×¤×¢×™×œ×•×ª ×œ×™×•×...</h3></div>
        <div id="modal-day-options" class="p-4 grid grid-cols-2 gap-3"></div>
        <div class="p-4 border-t flex justify-end">
            <button onclick="window.closeModal()" class="btn btn-ghost">×‘×™×˜×•×œ</button>
        </div>
    </div>
  </div>
  <div id="camera-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex justify-between items-center"><h3 class="text-lg font-bold">×ª×¨×’× ××ª××•× ×”</h3><button id="camera-close-btn" class="text-2xl">Ã—</button></div>
        <div class="p-4 flex-grow relative">
            <video id="camera-feed" class="w-full h-full object-cover bg-black rounded-lg" playsinline autoplay></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
        </div>
        <div class="p-4 border-t flex justify-center">
            <button id="capture-btn" class="btn btn-primary w-16 h-16 rounded-full"><i class="fa-solid fa-camera fa-2x"></i></button>
        </div>
    </div>
  </div>
  <div id="alert-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 id="alert-modal-title" class="text-lg font-bold"></h3>
            <button id="alert-modal-copy-btn" class="btn btn-ghost btn-sm hidden"><i class="fa-solid fa-copy mr-1"></i>×”×¢×ª×§</button>
        </div>
        <div id="alert-modal-body" class="p-6 whitespace-pre-wrap max-h-[50vh] overflow-y-auto"></div>
        <div class="p-4 border-t flex justify-end">
            <button id="alert-modal-close" class="btn btn-primary">×”×‘× ×ª×™</button>
        </div>
    </div>
  </div>
    <div id="gemini-modal" class="modal-backdrop">
      <div class="modal">
          <div class="p-4 border-b flex justify-between items-center">
              <h3 class="text-lg font-bold">×©××œ ××ª Gemini</h3>
              <button id="gemini-close-btn" class="text-2xl">Ã—</button>
          </div>
          <div class="border-b border-gray-200 dark:border-gray-800">
              <nav class="-mb-px flex justify-center gap-4" id="gemini-tabs-nav">
                  <button class="py-3 px-4 font-semibold border-b-2 tab-button tab-active" data-content="gemini-advisor-tab">×™×•×¢×¥ ×—×›×</button>
                  <button class="py-3 px-4 font-semibold border-b-2 tab-button" data-content="gemini-free-text-tab">×©××œ×” ×—×•×¤×©×™×ª</button>
              </nav>
          </div>
          <div class="p-4 flex-grow overflow-y-auto flex flex-col">
              <!-- Smart Advisor Tab -->
              <div id="gemini-advisor-tab" class="content-section active text-center">
                  <p class="mb-4">×§×‘×œ ×”××œ×¦×” ×—×›××” ×•××•×ª×××ª ××™×©×™×ª ×¢×œ ×¡××š ×”×©×¢×”, ××–×’ ×”××•×•×™×¨ ×•×”×ª×§×¦×™×‘ ×©×œ×š.</p>
                  <button id="get-smart-advice-btn" class="btn btn-primary"><i class="fa-solid fa-robot mr-2"></i>×ª×Ÿ ×œ×™ ×”××œ×¦×” ×—×›××”</button>
              </div>
              <!-- Free Text Tab -->
              <div id="gemini-free-text-tab" class="content-section">
                  <label for="gemini-prompt" class="block text-sm font-medium mb-1">×”×›× ×¡ ×©××œ×” ××• ×‘×§×©×”:</label>
                  <textarea id="gemini-prompt" class="w-full p-2 rounded-lg border bg-white dark:bg-gray-800" rows="3" placeholder="×œ×“×•×’××”: ×ª×Ÿ ×œ×™ 3 ×”×¦×¢×•×ª ×œ××¡×¢×“×•×ª ×¨×•×× ×˜×™×•×ª ×‘×¢×¨×‘ ×‘××–×•×¨ × ×‘×™×œ×™."></textarea>
                   <button id="gemini-submit-btn" class="btn btn-primary w-full mt-2">×©×œ×— ×©××™×œ×ª×”</button>
              </div>
              
              <div class="mt-4 flex-grow flex flex-col">
                  <h4 class="font-semibold mb-2">×ª×©×•×‘×”:</h4>
                  <div id="gemini-response" class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[100px] whitespace-pre-wrap flex-grow"></div>
              </div>
          </div>
      </div>
    </div>
<div id="daily-tip-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex items-center gap-3">
            <i class="fa-solid fa-lightbulb text-yellow-400 text-xl"></i>
            <h3 class="text-lg font-bold">×˜×™×¤ ×”×™×•× ×œ××˜×™×™×œ</h3>
        </div>
        <div id="daily-tip-body" class="p-6 whitespace-pre-wrap">×˜×•×¢×Ÿ ×˜×™×¤...</div>
        <div class="p-4 border-t flex justify-end">
            <button id="daily-tip-close" class="btn btn-primary">×”×‘× ×ª×™</button>
        </div>
    </div>
</div>



  <div id="floating-nav-container" class="md:hidden fixed bottom-0 left-0 right-0 z-40">
      <div id="plan-submenu" class="floating-submenu fixed bottom-[68px] left-0 right-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm p-2 rounded-t-2xl">
          <div class="grid grid-cols-3 gap-2 text-center text-sm" id="plan-submenu-links">
              </div>
      </div>
      <div id="tools-submenu" class="floating-submenu fixed bottom-[68px] left-0 right-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm p-2 rounded-t-2xl">
          <div class="grid grid-cols-3 gap-2 text-center text-sm">
              <a href="#overview" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 col-span-3 font-bold text-brand-600">×—×–×•×¨ ×œ×¡×§×™×¨×”</a>
              <a href="#live-location-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">××™×§×•× ×—×™</a>
              <a href="#transport-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">×ª×—×‘×•×¨×”</a>
              <a href="#weather-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">××–×’ ××•×•×™×¨</a>
              <a href="#budget-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">×ª×§×¦×™×‘</a>
              <a href="#checklist-section-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">×¦'×§×œ×™×¡×˜</a>
              <a href="#translator-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">×ª×¨×’×•×</a>
              <a href="#converter-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">×××™×¨ ××˜×‘×¢</a>
              <a href="#safety-warnings-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">××–×”×¨×•×ª</a>
          </div>
      </div>

      <nav id="floating-nav" class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.1)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.3)] rounded-t-2xl">
        <div class="flex justify-around p-2 text-gray-700 dark:text-gray-300">
            <button id="floating-plan-btn" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-calendar-days fa-lg"></i>
                <span>×ª×•×›× ×™×ª</span>
            </button>
            <a href="#kosher" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-utensils fa-lg"></i>
                <span>×›×©×¨</span>
            </a>
            <button id="floating-tools-btn" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-screwdriver-wrench fa-lg"></i>
                <span>×›×œ×™×</span>
            </button>
        </div>
      </nav>
  </div>
  
  <!-- LeafletJS for Live Map -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <script type="module">
    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc, enableIndexedDbPersistence, collection, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    console.log("LOG: Script start. Initializing variables.");

    // --- UTILS ---
    const $ = (s, p = document) => p.querySelector(s);
    const $$ = (s, p = document) => Array.from(p.querySelectorAll(s));
    function toRad(x) { return x * Math.PI / 180; }
    function haversineKm(lat1, lon1, lat2, lon2) {
        if ([lat1, lon1, lat2, lon2].some(c => c === undefined || c === null)) return NaN;
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.asin(Math.sqrt(a));
        return R * c;
    }
    function formatKm(km) { return isNaN(km) ? '' : `(${km.toFixed(1)} ×§×´×)`; }
    function minsForMode(km, mode) {
        if (isNaN(km)) return 15;
        if (mode === 'walk') { const speed = 4.5; return Math.max(8, (km / speed) * 60); }
        if (mode === 'drive') { const speed = 25; return Math.max(10, (km / speed) * 60); }
        if (mode === 'transit') { const speed = 18; return Math.max(12, (km / speed) * 60 + 5); }
        return 15;
    }
    function formatMin(min) {
        min = Math.round(min);
        if (min < 60) return `${min} ×“×§×³`;
        const h = Math.floor(min / 60);
        const m = min % 60;
        return `${h} ×©×³ ${m} ×“×³`;
    }
    const fmtBold = (t) => (t || '').replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-brand-700 dark:text-brand-300">$1<\/strong>');
    const placeholderLogoUrl = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&size=80&rounded=true&background=e0e7ff&color=1e40af`;
    
    // --- Global State ---
    let db, auth, tripDocRef, locationsColRef;
    let localTripData = {}; 
    let budgetChartInstance = null;
    let cameraStream = null;
    let eurToIlsRate = 4.0; // Default rate
    let userCoords = null;
    let isFirebaseConnected = false;
    let translationHistory = JSON.parse(localStorage.getItem('milanTripTranslationHistory')) || [];
    let lastWeatherAPIData = null;
    
    // --- Live Location State ---
    let liveMap;
    let userMarkers = {};
    let watchingLocation = false;
    let watchId = null;
    let currentUserId = null;

    console.log("LOG: Global variables and utility functions defined.");


    // --- DATA ---
    const attractions = {
      duomo: { name: "×§×ª×“×¨×œ×ª ×”×“×•××•××•", type: 'attraction', address: "Piazza del Duomo, 20122 Milano MI, Italy", img: ["https://www.metailimbaolam.com/wp-content/uploads/2020/08/italy-4695974_1280.jpg"], tickets: "https://www.duomomilano.it/en/buy-tickets/", description: "×”×œ×‘ ×”×¤×•×¢× ×©×œ ××™×œ×× ×•. ×—×•×‘×” ×œ×¢×œ×•×ª ×œ×’×’ ×œ×ª×¦×¤×™×ª ×¤× ×•×¨××™×ª ××¨×”×™×‘×” ×¢×œ ×”×¢×™×¨.", coords: { lat: 45.4642, lon: 9.1916 }, cost: 20, hours: "×›×œ ×™×•×, 09:00-19:00" },
      sanSiro: { name: "××¦×˜×“×™×•×Ÿ ×¡×Ÿ ×¡×™×¨×•", type: 'attraction', address: "Piazzale Angelo Moratti, 20151 Milano MI, Italy", img: ["https://www.xn--4dbkkmip.co.il/wp-content/uploads/2023/05/san-siro-1940307_640.jpg"], tickets: "https://www.sansirostadium.com/en/stadium-tour-museum/", description: "××§×“×© ×”×›×“×•×¨×’×œ ×©×œ ××™×œ×× ×•, ×‘×™×ª×Ÿ ×©×œ ××™×œ××Ÿ ×•××™× ×˜×¨. ××•××œ×¥ ×œ×¡×™×•×¨ ××• ×œ××©×—×§.", coords: { lat: 45.4780, lon: 9.1238 }, cost: 30, hours: "×›×œ ×™×•×, 09:30-19:00 (××©×ª× ×” ×‘×™××™ ××©×—×§)" },
      primark: { name: "×¤×¨×™×™×××¨×§ (×•×™×” ×˜×•×¨×™× ×•)", type: 'attraction', address: "Via Torino, 45, 20123 Milano MI, Italy", img: ["https://www.shutterstock.com/image-photo/bordeaux-france-07-17-2024-260nw-2490117199.jpg"], info: "https://www.primark.com/it/it/negozi/milano/via-torino-45", description: "×¡× ×™×£ ×”×“×’×œ ×”×¢× ×§ ×©×œ ×¨×©×ª ×”××•×¤× ×” ×”×–×•×œ×”, ×’×Ÿ ×¢×“×Ÿ ×œ×—×•×‘×‘×™ ×§× ×™×•×ª.", coords: { lat: 45.4623, lon: 9.1861 }, cost: 0, hours: "×›×œ ×™×•×, 09:00-22:00" },
      como: { name: "××’× ×§×•××•", type: 'attraction', address: "Varenna, Italy", img: ["https://www.travelonatimebudget.co.uk/wp-content/uploads/2022/01/varenna-dp.jpg"], description: "×™×•× ×˜×™×•×œ ×œ××—×“ ×”××’××™× ×”×™×¤×™× ×‘××™×˜×œ×™×”. ××•××œ×¥ ×œ×‘×§×¨ ×‘×¢×™×™×¨×•×ª ×•××¨× ×” ×•×‘×œ××’'×™×•.", coords: { lat: 45.9863, lon: 9.2816 }, cost: 15 },
      berninaExpress: { name: "×¨×›×‘×ª ×‘×¨× ×™× ×” ×œ××œ×¤×™×", type: 'attraction', address: "Tirano, Italy", img: ["https://www.civitatis.com/f/italia/milan/excursion-alpes-suizos-589x392.jpg"], tickets: "https://www.rhb.ch/en/panoramic-trains/bernina-express", description: "× ×¡×™×¢×ª ×¨×›×‘×ª ×¤× ×•×¨××™×ª ××“×”×™××” ×“×¨×š ×”×¨×™ ×”××œ×¤×™× ×œ×©×•×•×™×¥.", coords: { lat: 46.4914, lon: 9.8683 }, cost: 70 },
      laScala: { name: "×ª×™××˜×¨×•×Ÿ ×œ×” ×¡×§××œ×”", type: 'attraction', address: "Via Filodrammatici, 2, 20121 Milano MI, Italy", img: ["https://www.hakolal.co.il/wp-content/uploads/2018/10/La-Scala.jpg"], tickets: "https://www.teatroallascala.org/en/visit-the-theatre/visits-to-the-theatre-museum.html", description: "××—×“ ××‘×ª×™ ×”××•×¤×¨×” ×”××¤×•×¨×¡××™× ×•×”×™×•×§×¨×ª×™×™× ×‘×¢×•×œ×.", coords: { lat: 45.4675, lon: 9.1895 }, cost: 12, hours: "××•×–×™××•×Ÿ: ×›×œ ×™×•×, 09:30-17:30" },
      navigli: { name: "×¨×•×‘×¢ × ×‘×™×œ×™", type: 'attraction', address: "Ripa di Porta Ticinese, 20143 Milano MI, Italy", description: "×¨×•×‘×¢ ×”×ª×¢×œ×•×ª ×”××§×¡×™× ×©×œ ××™×œ×× ×•, ××•×©×œ× ×œ×©×¢×•×ª ×”×¢×¨×‘ ×•×œ××¤×¨×˜×™×‘×•.", coords: { lat: 45.4516, lon: 9.1758 }, cost: 0 },
      ilCentro: { name: "×§× ×™×•×Ÿ Il Centro", type: 'attraction', address: "Via Giuseppe Eugenio Luraghi, 11, 20044 Arese MI, Italy", img: ["https://architizer-prod.imgix.net/media/1461230538313IL_CENTRO_WEB_RESOLUTION_231.JPG"], info: "https://centroilcentro.it/en/", description: "××—×“ ×”×§× ×™×•× ×™× ×”×’×“×•×œ×™× ×‘××™×¨×•×¤×”, × ××¦× ××—×•×¥ ×œ××™×œ×× ×•.", coords: { lat: 45.5654, lon: 9.0681 }, cost: 5, hours: "×›×œ ×™×•×, 09:00-22:00" },
      sforza: { name: "×˜×™×¨×ª ×¡×¤×•×¨×¦×”", type: 'attraction', address: "Piazza Castello, 20121 Milano MI, Italy", description: "××¦×•×“×” ×”×™×¡×˜×•×¨×™×ª ××¨×©×™××” ×¢× ××¡×¤×¨ ××•×–×™××•× ×™× ×•×’×œ×¨×™×•×ª ××× ×•×ª.", info: "https://www.milanocastello.it/en", coords: { lat: 45.4705, lon: 9.1794 }, cost: 5, hours: "×—×¦×¨×•×ª: 07:00-19:30. ××•×–×™××•× ×™×: ×’'-×', 10:00-17:30 (×¡×’×•×¨ ×‘×‘')" },
      brera: { name: "×¨×•×‘×¢ ×‘×¨×¨×”", type: 'attraction', address: "Via Brera, Milan", description: "×¨×•×‘×¢ ×”××× ×™× ×”×¦×™×•×¨×™, '×”××•× ××¨×˜×¨ ×©×œ ××™×œ×× ×•', ××œ× ×‘×¡××˜××•×ª, ×’×œ×¨×™×•×ª ×•×‘×•×˜×™×§×™×.", coords: { lat: 45.4719, lon: 9.1879 }, cost: 0 },
      lastSupper: { name: "×”×¡×¢×•×“×” ×”××—×¨×•× ×”", type: 'attraction', address: "Piazza di Santa Maria delle Grazie, 2, 20123 Milano MI", description: "×¦×™×•×¨ ×”×§×™×¨ ×”××¤×•×¨×¡× ×©×œ ×“×” ×•×™× ×¦'×™. ×—×•×‘×” ×œ×”×–××™×Ÿ ×›×¨×˜×™×¡×™× ×—×•×“×©×™× ××¨××©!", tickets: "https://cenacolovinciano.org/en/", coords: { lat: 45.4659, lon: 9.1711 }, cost: 15, hours: "×’'-×', 08:15-19:00 (×¡×’×•×¨ ×‘×‘')" },
      galleriaVittorio: { name: "×’×œ×¨×™×™×ª ×•×™×˜×•×¨×™×• ××× ×•××œ×”", type: 'attraction', address: "Piazza del Duomo, 20123 Milano MI", description: "××¨×›×– ×§× ×™×•×ª ×”×™×¡×˜×•×¨×™ ×•××¤×•××¨, ×¢× ×—× ×•×™×•×ª ×™×•×§×¨×”, ×‘×ª×™ ×§×¤×” ×•××¡×¢×“×•×ª.", coords: { lat: 45.4656, lon: 9.1905 }, cost: 0, hours: "×¤×ª×•×— 24/7 (×—× ×•×™×•×ª ×‘×©×¢×•×ª ××©×ª× ×•×ª)" },
      pinacotecaBrera: { name: "×¤×™× ×§×•×˜×§×” ×“×™ ×‘×¨×¨×”", type: 'attraction', address: "Via Brera, 28, 20121 Milano MI", description: "××—×“ ××’×œ×¨×™×•×ª ×”××× ×•×ª ×”×—×©×•×‘×•×ª ×‘××™×˜×œ×™×”, ××ª××§×“ ×‘×¦×™×•×¨ ××™×˜×œ×§×™.", tickets: "https://pinacotecabrera.org/en/visit/", coords: { lat: 45.4719, lon: 9.1879 }, cost: 15, hours: "×’'-×', 08:30-19:15 (×¡×’×•×¨ ×‘×‘')" },
      parcoSempione: { name: "×¤××¨×§ ×¡××¤×™×•× ×”", type: 'attraction', address: "Piazza Sempione, 20154 Milano MI", description: "×”×¨×™××” ×”×™×¨×•×§×” ×”×’×“×•×œ×” ×©×œ ××™×œ×× ×•, ×××—×•×¨×™ ×˜×™×¨×ª ×¡×¤×•×¨×¦×”. ××•×©×œ× ×œ×”×™×¨×’×¢×•×ª.", coords: { lat: 45.4723, lon: 9.1725 }, cost: 0, hours: "×›×œ ×™×•×, 06:30-21:00" },
      quadrilateroDellaModa: { name: "××¨×•×‘×¢ ×”××•×¤× ×”", type: 'attraction', address: "Via Monte Napoleone, 20121 Milano MI, Italy", description: "×¨×•×‘×¢ ×”×§× ×™×•×ª ×”×™×•×§×¨×ª×™ ×©×œ ××™×œ×× ×•, ×‘×™×ª ×œ××•×ª×’×™ ×”××•×¤× ×” ×”×’×“×•×œ×™× ×‘×¢×•×œ×.", coords: { lat: 45.4688, lon: 9.1950 }, cost: 0 },
      daVinciMuseum: { name: "××•×–×™××•×Ÿ ×”××“×¢ ×“×” ×•×™× ×¦'×™", type: 'attraction', address: "Via San Vittore, 21, 20123 Milano MI, Italy", description: "××•×–×™××•×Ÿ ×”××“×¢ ×•×”×˜×›× ×•×œ×•×’×™×” ×”×’×“×•×œ ×‘××™×˜×œ×™×”, ××•×§×“×© ×œ×“×” ×•×™× ×¦'×™ ×›×××¦×™×.", tickets: "https://www.museoscienza.org/en/visit/tickets", coords: { lat: 45.4627, lon: 9.1715 }, cost: 10, hours: "×’'-×•' 09:30-17:00, ×©'-×' 09:30-18:30 (×¡×’×•×¨ ×‘×‘')" },
      boscoVerticale: { name: "×‘×•×¡×§×• ×•×¨×˜×™×§×œ×”", type: 'attraction', address: "Via Gaetano de Castillia, 11, 20124 Milano MI", description: "×¦××“ ××’×“×œ×™ ××’×•×¨×™× ×—×“×©× ×™×™× ×”××›×•×¡×™× ×‘××œ×¤×™ ×¢×¦×™× ×•×¦××—×™×. ×¤×œ× ××¨×›×™×˜×§×˜×•× ×™.", coords: { lat: 45.4855, lon: 9.1901 }, cost: 0 },
      cimiteroMonumentale: { name: "×‘×™×ª ×”×§×‘×¨×•×ª ×”××•× ×•×× ×˜×œ×™", type: 'attraction', address: "Piazzale Cimitero Monumentale, 20154 Milano MI", description: "×‘×™×ª ×§×‘×¨×•×ª ×©×”×•× ×’× ××•×–×™××•×Ÿ ×¤×ª×•×—, ×¢× ×¤×¡×œ×™× ×•××‘× ×™× ××¨×›×™×˜×§×˜×•× ×™×™× ××¨×©×™××™×.", coords: { lat: 45.485, lon: 9.178 }, cost: 0, hours: "×’'-×' 08:00-18:00 (×¡×’×•×¨ ×‘×‘')" },
      museoNovecento: { name: "××•×–×™××•×Ÿ × ×•×‘×¦'× ×˜×•", type: 'attraction', address: "Piazza del Duomo, 8, 20123 Milano MI", description: "××•×–×™××•×Ÿ ×œ××× ×•×ª ×”×××” ×”-20 ×”×××•×§× ×‘×›×™×›×¨ ×”×“×•××•××•, ×¢× ×ª×¦×¤×™×ª ×™×¤×” ×¢×œ ×”×§×ª×“×¨×œ×”.", tickets: "https://www.museodelnovecento.org/en/ biglietti-e-ingressi", coords: { lat: 45.463, lon: 9.190 }, cost: 10, hours: "×’'-×' 10:00-19:30 (×¡×’×•×¨ ×‘×‘')" },
      santAmbrogio: { name: "×‘×–×™×œ×™×§×ª ×¡× ×˜'×××‘×¨×•×’'×•", type: 'attraction', address: "Piazza Sant'Ambrogio, 15, 20123 Milano MI", description: "××—×ª ×”×›× ×¡×™×•×ª ×”×¢×ª×™×§×•×ª ×•×”×—×©×•×‘×•×ª ×‘××™×œ×× ×•, ×“×•×’××” ××¨×”×™×‘×” ×œ××“×¨×™×›×œ×•×ª ×¨×•×× ×¡×§×™×ª.", coords: { lat: 45.462, lon: 9.173 }, cost: 0 },
      sanMaurizio: { name: "×›× ×¡×™×™×ª ×¡×Ÿ ×××•×¨×™×¦×™×•", type: 'attraction', address: "Corso Magenta, 15, 20123 Milano MI", description: "××›×•× ×” '×”×§×¤×œ×” ×”×¡×™×¡×˜×™× ×™×ª ×©×œ ××™×œ×× ×•' ×‘×–×›×•×ª ×¦×™×•×¨×™ ×”×§×™×¨ ×”××“×”×™××™× ×©××›×¡×™× ××•×ª×” ×œ×—×œ×•×˜×™×Ÿ.", tickets: "https://www.museoarcheologicomilano.it/en/collezioni/san-maurizio-al-monastero-maggiore", coords: { lat: 45.465, lon: 9.176 }, cost: 0, hours: "×’'-×' 10:00-17:30 (×¡×’×•×¨ ×‘×‘')" },
      piazzaMercanti: { name: "×¤×™××¦×” ×“×™×™ ××¨×§× ×˜×™", type: 'attraction', address: "Piazza dei Mercanti, 20123 Milano MI", description: "×›×™×›×¨ ×™××™-×‘×™× ×™×™××™×ª ×§×¡×•××” ×•× ×¡×ª×¨×ª, ×“×§×•×ª ×”×œ×™×›×” ××”×“×•××•××•.", coords: { lat: 45.465, lon: 9.188 }, cost: 0 },
      leonardoVineyard: { name: "×”×›×¨× ×©×œ ×œ××•× ×¨×“×•", type: 'attraction', address: "Corso Magenta, 65, 20123 Milano MI", description: "×©×—×–×•×¨ ×©×œ ×”×›×¨× ×©×”×™×” ×©×™×™×š ×œ×œ××•× ×¨×“×• ×“×” ×•×™× ×¦'×™, ××•×œ '×”×¡×¢×•×“×” ×”××—×¨×•× ×”'.", tickets: "https://www.vignadileonardo.com/en/", coords: { lat: 45.466, lon: 9.170 }, cost: 10, hours: "×’'-×' 09:00-18:00 (×¡×’×•×¨ ×‘×‘')" },
      piazzaGaeAulenti: { name: "×¤×™××¦×” ×’××” ×××•×œ× ×˜×™", type: 'attraction', address: "Piazza Gae Aulenti, 20124 Milano MI", description: "×”×œ×‘ ×”×¤×•×¢× ×©×œ ××™×œ×× ×• ×”××•×“×¨× ×™×ª. ×›×™×›×¨ ×¢×ª×™×“× ×™×ª ××•×§×¤×ª ×’×•×¨×“×™ ×©×—×§×™×.", coords: { lat: 45.483, lon: 9.191 }, cost: 0 },
      corsoComo: { name: "10 ×§×•×¨×¡×• ×§×•××•", type: 'attraction', address: "Corso Como, 10, 20154 Milano MI", description: "××ª×—× ×§×•× ×¡×¤×˜ ×”××©×œ×‘ ××•×¤× ×”, ×¢×™×¦×•×‘ ×•××× ×•×ª. ×—×•×•×™×ª ×§× ×™×•×ª ×•×‘×™×œ×•×™ ×™×™×—×•×“×™×ª.", coords: { lat: 45.482, lon: 9.189 }, cost: 0 },
      triennale: { name: "××•×–×™××•×Ÿ ×”×¢×™×¦×•×‘ ×˜×¨×™×× ×œ×”", type: 'attraction', address: "Viale Emilio Alemagna, 6, 20121 Milano MI", description: "××•×–×™××•×Ÿ ×‘×™× ×œ××•××™ ×”××•×§×“×© ×œ×¢×™×¦×•×‘, ××“×¨×™×›×œ×•×ª ×•××× ×•×ª ×—×–×•×ª×™×ª ×‘×¤××¨×§ ×¡××¤×™×•× ×”.", tickets: "https://triennale.org/en/tickets", coords: { lat: 45.470, lon: 9.168 }, cost: 15, hours: "×’'-×' 11:00-20:00 (×¡×’×•×¨ ×‘×‘')" },
      colonneSanLorenzo: { name: "×¢××•×“×™ ×¡×Ÿ ×œ×•×¨× ×¦×•", type: 'attraction', address: "Corso di Porta Ticinese, 39, 20123 Milano MI", description: "×©×¨×™×“×™× ×¨×•××™×™× ×¢×ª×™×§×™× ×©×”×¤×›×• ×œ××§×•× ××¤×’×© ×¤×•×¤×•×œ×¨×™ ×•×ª×•×¡×¡ ×‘×¢×¨×‘.", coords: { lat: 45.458, lon: 9.181 }, cost: 0 },
      qcTermemilano: { name: "QC Termemilano", type: 'attraction', address: "Piazzale Medaglie D'Oro, 2, 20135 Milano MI", tickets: "https://www.qcterme.com/en/milano/qc-termemilano", description: "×¡×¤× ×•××¨×—×¦××•×ª ×™×•×§×¨×ª×™×™× ×‘×œ×‘ ×”×¢×™×¨, ×—×•×•×™×” ××•×©×œ××ª ×©×œ ×¤×™× ×•×§ ×•×¨×’×™×¢×”.", coords: { lat: 45.4523, lon: 9.2004 }, cost: 60, hours: "×›×œ ×™×•×, 09:00-23:00" },
      interStore: { name: "×—× ×•×ª ×”×“×’×œ ×©×œ ××™× ×˜×¨", type: 'attraction', address: "Galleria Passarella, 2, 20122 Milano MI", info: "https://store.inter.it/", description: "×—× ×•×ª ×”×“×’×œ ×”×¨×©××™×ª ×©×œ ×§×‘×•×¦×ª ×”×›×“×•×¨×’×œ ××™× ×˜×¨ ××™×œ×× ×•, ×‘×œ×‘ ××–×•×¨ ×”×§× ×™×•×ª.", coords: { lat: 45.465, lon: 9.194 }, cost: 0, hours: "×›×œ ×™×•× 10:00-19:30" },
      casaMilan: { name: "×§××–×” ××™×œ××Ÿ (××•×–×™××•×Ÿ ×•×—× ×•×ª)", type: 'attraction', address: "Via Aldo Rossi, 8, 20149 Milano MI", tickets: "https://www.acmilan.com/en/club/casa-milan", description: "×”××˜×” ×”×¨××©×™ ×©×œ ×§×‘×•×¦×ª ××™×œ××Ÿ, ×›×•×œ×œ ××•×–×™××•×Ÿ ××•× ×“×• ××™×œ××Ÿ, ×—× ×•×ª ×¨×©××™×ª ×•××¡×¢×“×”.", coords: { lat: 45.489, lon: 9.155 }, cost: 15, hours: "×›×œ ×™×•× 10:00-19:00" },
      torreBranca: { name: "××’×“×œ ×‘×¨×× ×§×”", type: 'attraction', address: "Viale Luigi Camoens, 2, 20121 Milano MI", info: "http://www.museobranca.it/torre-branca-parco-sempione-milano/", description: "××’×“×œ ×ª×¦×¤×™×ª ×‘×¤××¨×§ ×¡××¤×™×•× ×” ×”××¦×™×¢ × ×•×£ ×¤× ×•×¨××™ ××¨×”×™×‘ ×©×œ ××™×œ×× ×•.", coords: { lat: 45.472, lon: 9.171 }, cost: 6, hours: "××©×ª× ×” ×œ×¤×™ ×¢×•× ×”, ×‘×“×§×• ×‘××ª×¨" },
      pinacotecaAmbrosiana: { name: "×¤×™× ×§×•×˜×§×” ×××‘×¨×•×–×™×× ×”", type: 'attraction', address: "Piazza Pio XI, 2, 20123 Milano MI", tickets: "https://www.ambrosiana.it/", description: "×’×œ×¨×™×™×ª ××× ×•×ª ×•×¡×¤×¨×™×™×” ×”×™×¡×˜×•×¨×™×ª ×”××›×™×œ×” ×™×¦×™×¨×•×ª ××•×¤×ª ×©×œ ×§××¨××•×•×’'×• ×•×“×” ×•×™× ×¦'×™.", coords: { lat: 45.464, lon: 9.186 }, cost: 15, hours: "×’'-×' 10:00-18:00 (×¡×’×•×¨ ×‘×‘')" }
    };
    
    const kosherData = {
      restaurants: [
        { name: "Denzel", type: 'dining', style: "×‘×©×¨×™", logo: "https://static.wixstatic.com/media/c6595a_0d9d7bb6473548d69681f09d18ff4247.png", address: "Via Giorgio Washington, 9, 20146 Milano MI", phone: "+390248519326", website: "https://www.denzel.it/", hours: "×'-×”' 12:00-15:00, 19:00-23:00; ×•' 12:00-15:00", coords: { lat: 45.4654, lon: 9.1555 } },
        { name: "Ba'Ghetto", type: 'dining', style: "×‘×©×¨×™", address: "Via Sardegna, 45, 20146 Milano MI", phone: "+39024694643", website: "https://www.baghetto.com/en/", hours: "×'-×”' 12:00-15:00, 19:00-23:00; ×•' 12:00-15:00", coords: { lat: 45.4665, lon: 9.1461 } },
        { name: "Re Salomone", type: 'dining', style: "×‘×©×¨×™", address: "Via Sardegna, 42, 20146 Milano MI", phone: "+39024694643", website: "https://www.resalomone.it/", hours: "×'-×”' 12:00-14:30, 19:00-23:00; ×•' 12:00-14:30", coords: { lat: 45.4665, lon: 9.1458 } },
        { name: "La's Kebab", type: 'dining', style: "×‘×©×¨×™", address: "Viale Misurata, 19, 20146 Milano MI", phone: "+393288865576", website: "https://laskebab.eatbu.com/", hours: "×'-×”' 12:00-15:00, 18:00-23:00", coords: { lat: 45.4586, lon: 9.1517 } },
        { name: "Carmel", type: 'dining', style: "×—×œ×‘×™", address: "Viale S. Gimignano, 10, 20146 Milano MI", phone: "+3902416368", website: "https://carmelkosher.it/", hours: "×'-×”' 12:00-15:00, 19:00-22:30", coords: { lat: 45.4593, lon: 9.1328 } },
        { name: "MyKafe", type: 'dining', style: "×—×œ×‘×™", logo: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/11/a2/1f/a2/my-kafe.jpg", address: "Via Luigi Soderini, 44, 20146 Milano MI", phone: "+390238232748", website: "https://www.instagram.com/mykafe2020/", hours: "×'-×”' 07:30-19:30; ×•' 07:30-16:00", coords: { lat: 45.4578, lon: 9.1337 } },
        { name: "Bet-El", type: 'dining', style: "×—×œ×‘×™", address: "Viale S. Gimignano, 2, 20146 Milano MI", phone: "+39024151336", website: "http://www.betelkosher.com/", hours: "×'-×”' 12:00-14:30, 19:00-22:30", coords: { lat: 45.4607, lon: 9.1352 } },
        { name: "Snubar", type: 'dining', style: "×¤×œ××¤×œ/×©×•×•××¨××”", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQmYC-lcBrFV75_D371aWkrfk7yd1Qu3kEIcw&s", address: "Via Leone Tolstoi, 2, 20146 Milano MI", phone: "+39024236963", website: "https://www.snubar.it/it/", hours: "×'-×”' 12:00-22:00", coords: { lat: 45.4568, lon: 9.1565 } },
        { name: "Presto", type: 'dining', style: "×˜×™×™×§-××•×•×™", address: "Via delle Forze Armate, 13, 20147 Milano MI", phone: "+39024045598", website: "https://www.presto-kosher.com/", hours: "×'-×”' 10:00-20:00; ×•' 09:00-15:00", coords: { lat: 45.4667, lon: 9.1292 } },
      ],
      markets: [
        { name: "Kosher Paradise", type: 'dining', style: "××¨×›×•×œ", address: "Viale S. Gimignano, 13, 20146 Milano MI", phone: "+39024122855", website: "https://www.kosherparadise.it/", hours: "×'-×”' 09:00-19:30; ×•' 09:00-15:00", coords: { lat: 45.4589, lon: 9.1325 } },
        { name: "Denzel's Sweet Bakery", type: 'dining', style: "×××¤×™×™×”", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVt6hxH7niOmeBunCjNdpow7Y_PfseIBonPQ&s", address: "Via Soderini, 55, 20146 Milano MI", phone: "+39024125166", website: "https://www.denzel.it/bakery", hours: "×'-×”' 07:30-19:30; ×•' 07:30-15:00", coords: { lat: 45.4570, lon: 9.1329 } },
        { name: "Kosher King", type: 'dining', style: "××¨×›×•×œ", address: "Piazza Napoli, 15, 20146 Milano MI", phone: "+390242296773", website: "https://www.facebook.com/kosherkingmilan/", hours: "×'-×”' 08:30-19:30; ×•' 08:30-16:00", coords: { lat: 45.4563, lon: 9.1492 } },
      ]
    };
    
    const dailyTips = [
      "×–×›×¨×• ×œ×ª×§×£ ××ª ×›×¨×˜×™×¡ ×”×ª×—×‘×•×¨×” ×”×¦×™×‘×•×¨×™×ª ×©×œ×›× ×‘××›×•× ×•×ª ×”×¦×”×•×‘×•×ª ×œ×¤× ×™ ×›×œ × ×¡×™×¢×” ×‘××˜×¨×•, ××•×˜×•×‘×•×¡ ××• ×˜×¨×× ×›×“×™ ×œ×× ×•×¢ ×§× ×¡×•×ª.",
      "××¤×¨×˜×™×‘×• (Aperitivo) ×”×•× ×× ×”×’ ××™×˜×œ×§×™ ×¤×•×¤×•×œ×¨×™. ×‘×™×Ÿ 18:00 ×œ-21:00, ×©×œ××• ×¢×œ ××©×§×” ×•×§×‘×œ×• ×’×™×©×” ×—×•×¤×©×™×ª ×œ××–× ×•×Ÿ ××›×•×œ ×›×¤×™ ×™×›×•×œ×ª×š. ×¨×•×‘×¢ × ×‘×™×œ×™ ×”×•× ××§×•× ××¢×•×œ×” ×œ×—×•×•×ª ×–××ª.",
      "'Coperto' ×”×•× ×—×™×•×‘ ×©×™×¨×•×ª ×§×‘×•×¢ ×©×¨×•×‘ ×”××¡×¢×“×•×ª ××•×¡×™×¤×•×ª ×œ×—×©×‘×•×Ÿ. ×–×” ×œ× ×˜×™×¤, ××œ× ×ª×©×œ×•× ×¢×œ ×”×©×™×¨×•×ª ×•×”×œ×—×. ×˜×™×¤ × ×•×¡×£ ××™× ×• ×—×•×‘×” ××š ××•×¢×¨×š.",
      "×”×¨×‘×” ××•×–×™××•× ×™× ×•×›× ×¡×™×•×ª ×“×•×¨×©×™× ×œ×‘×•×© ×¦× ×•×¢ (×›×ª×¤×™×™× ×•×‘×¨×›×™×™× ××›×•×¡×•×ª). ×›×“××™ ×œ×”×—×–×™×§ ×¦×¢×™×£ ×§×œ ×‘×ª×™×§ ×œ××§×¨×” ×”×¦×•×¨×š.",
      "××™× ××”×‘×¨×– ×‘××™×œ×× ×• ×‘×˜×•×—×™× ×•×˜×•×‘×™× ×œ×©×ª×™×™×”. ×—×¤×©×• ×‘×¨×–×™×•×ª ×¦×™×‘×•×¨×™×•×ª (fontanelle) ×›×“×™ ×œ××œ× ××ª ×‘×§×‘×•×§ ×”××™× ×©×œ×›× ×•×œ×—×¡×•×š ×›×¡×£.",
      "×× ××ª× ××ª×›× × ×™× ×œ×¨××•×ª ××ª '×”×¡×¢×•×“×” ×”××—×¨×•× ×”' ×©×œ ×“×” ×•×™× ×¦'×™, ×—×•×‘×” ×œ×”×–××™×Ÿ ×›×¨×˜×™×¡×™× ×‘××™× ×˜×¨× ×˜ ××¡×¤×¨ ×—×•×“×©×™× ××¨××©. ×”×›× ×™×¡×” ××•×’×‘×œ×ª ×××•×“."
    ];

    const tripMeta = {
        flights: {
            inbound: { date: '2025-11-23', flight: 'LY381', departureTime: '07:30', arrivalTime: '11:15', terminal: '3', baggage: '×˜×¨×•×œ×™ ×¢×“ 8 ×§"×’' },
            outbound: { date: '2025-11-26', flight: 'LY382', departureTime: '18:00', arrivalTime: '22:15', terminal: '1 (MXP)', baggage: '××–×•×•×“×” 23 ×§"×’ + ×˜×¨×•×œ×™ 8 ×§"×’' }
        },
        hotel: {
            name: 'Hotel Glam Milano', phone: '+39 02 839 840', tel: 'tel:+3902839840', address: 'Piazza Duca d\'Aosta, 4/6, 20124 Milano MI'
        },
        contacts: {
            emergency: { name: '×—×™×¨×•× (×›×œ×œ×™)', phone: '112', tel: 'tel:112' },
            embassy: { name: '×©×’×¨×™×¨×•×ª ×™×©×¨××œ', phone: '+39 06 3619 8500', tel: 'tel:+390636198500' }
        }
    };
    
    let currentLang = 'he-it'; // he-it or it-he

    console.log("LOG: Static data (attractions, kosher, etc.) loaded.");

    function getInitialTripData() {
        console.log("LOG: getInitialTripData() called. Generating default trip structure.");
        const initialPlanKeys = ['duomo', 'primark', 'sanSiro', 'como', 'berninaExpress', 'laScala', 'navigli', 'ilCentro'];
        return {
            plan: {
                day1: { name: "×™×•× 1: ×“×•××•××• ×•×“×¨×‘×™", transport: 'walk', activities: [
                    { id: 'duomo_1', time: "×‘×•×§×¨", ...attractions.duomo },
                    { id: 'primark_1', time: "×¦×”×¨×™×™×", ...attractions.primark },
                    { id: 'sanSiro_1', time: "×¢×¨×‘", ...attractions.sanSiro }
                ]},
                day2: { name: "×™×•× 2: ××’××™× ×•× ×‘×™×œ×™", transport: 'transit', activities: [
                    { id: 'como_1', time: "×™×•× ×©×œ×", ...attractions.como },
                    { id: 'navigli_1', time: "×¢×¨×‘", ...attractions.navigli },
                ]},
                day3: { name: "×™×•× 3: ×”××œ×¤×™× ×”×©×•×•×™×¦×¨×™×™×", transport: 'drive', activities: [
                    { id: 'berninaExpress_1', time: "×™×•× ×©×œ×", ...attractions.berninaExpress },
                ]},
                day4: { name: "×™×•× 4: ×ª×¨×‘×•×ª ×•×§× ×™×•×ª", transport: 'transit', activities: [
                    { id: 'laScala_1', time: "×‘×•×§×¨", ...attractions.laScala },
                    { id: 'ilCentro_1', time: "×¦×”×¨×™×™×", ...attractions.ilCentro }
                ]}
            },
            suggestions: Object.entries(attractions)
                .filter(([key]) => !initialPlanKeys.includes(key))
                .map(([key, value]) => ({...value, id: key})),
            checklist: [
                { id: 'cat1', category: '××¡××›×™×', items: [{ id: 'c1', text: '×“×¨×›×•×Ÿ', done: true }, { id: 'c2', text: '×›×¨×˜×™×¡×™ ×˜×™×¡×”', done: false }] },
                { id: 'cat2', category: '×‘×™×’×•×“', items: [{ id: 'c3', text: '××¢×™×œ ×’×©×', done: false }] },
                { id: 'cat3', category: '××œ×§×˜×¨×•× ×™×§×”', items: [{ id: 'c4', text: '××˜×¢×Ÿ × ×™×™×“', done: true }, { id: 'c5', text: '××ª×× ×œ×—×©××œ', done: false }] }
            ],
            totalBudget: 1500, expenses: [], documents: [], gallery: [], journal: {},
            theme: 'dark',
            settings: { includeEstimatedCostsInBalance: true }
        };
    }

    // --- MODAL ---
    let activityToModify = null;
    const modal = $('#add-to-day-modal');
    async function openAddToDayModal(activityId, type = 'suggestion') {
        console.log(`LOG: openAddToDayModal called for activityId: ${activityId}, type: ${type}`);
        if (type === 'suggestion') {
            activityToModify = localTripData.suggestions.find(s => s.id === activityId);
        } else {
            const allKosher = [...kosherData.restaurants, ...kosherData.markets];
            activityToModify = allKosher.find(k => k.name === activityId);
            if(activityToModify) activityToModify.id = activityId;
        }
        
        if (!activityToModify) {
            console.error(`ERROR: Could not find activity to modify with id: ${activityId}`);
            return;
        }

        const opts = $('#modal-day-options');
        opts.innerHTML = Object.entries(localTripData.plan).sort((a,b) => a[0].localeCompare(b[0])).map(([dayId, dayData]) => 
            `<button class="btn btn-primary" onclick="window.addActivityToDay('${dayId}', '${type}')">${dayData.name}</button>`
        ).join('');
        modal.classList.add('flex');
    };
    window.closeModal = () => {
        console.log("LOG: closeModal called.");
        $$('.modal-backdrop').forEach(m => m.classList.remove('flex'));
    };
    window.addActivityToDay = async (dayId, type) => {
        console.log(`LOG: addActivityToDay called for dayId: ${dayId}, type: ${type}`);
        const day = localTripData.plan[dayId];
        if (day && activityToModify) {
            const newActivity = { ...activityToModify, time: "×–××Ÿ ×’××™×©", id: (activityToModify.id || activityToModify.name) + '_' + Date.now() };
            day.activities.push(newActivity);
            
            let newSuggestions = localTripData.suggestions;
            if (type === 'suggestion') {
                newSuggestions = localTripData.suggestions.filter(s => s.id !== activityToModify.id);
            }
            
            console.log("LOG: Updating Firestore with new plan and suggestions.");
            await updateDoc(tripDocRef, {
                plan: localTripData.plan,
                suggestions: newSuggestions
            });
        }
        closeModal();
    };
    window.openAddToDayModal = openAddToDayModal;

    function showAlert(title, message, isCopyable = false) {
        console.log(`LOG: showAlert called. Title: ${title}, Message: ${message.substring(0, 50)}...`);
        $('#alert-modal-title').textContent = title;
        $('#alert-modal-body').textContent = message;
        
        const copyBtn = $('#alert-modal-copy-btn');
        if(isCopyable) {
            copyBtn.classList.remove('hidden');
        } else {
            copyBtn.classList.add('hidden');
        }

        $('#alert-modal').classList.add('flex');
    }
    
    function openTipModal() {
        console.log("LOG: openTipModal called.");
        const tip = dailyTips[Math.floor(Math.random() * dailyTips.length)];
        $('#daily-tip-body').textContent = tip;
        $('#daily-tip-modal').classList.add('flex');
    }

    function showDailyTip() {
        console.log("LOG: showDailyTip called, checking if tip should be displayed.");
        const lastTipDate = localStorage.getItem('lastTipDate');
        const today = new Date().toISOString().slice(0, 10);

        if (lastTipDate !== today) {
            console.log("LOG: Displaying daily tip.");
            openTipModal();
            localStorage.setItem('lastTipDate', today);
        } else {
            console.log("LOG: Daily tip already shown today.");
        }
    }

    // --- RENDER FUNCTIONS ---
    function renderOverview() {
        console.log("LOG: renderOverview called.");
        const { hotel, flights, contacts } = tripMeta;
        const countdownHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg text-center">
            <h3 class="font-bold text-lg mb-2">×”×–××Ÿ ×©× ×•×ª×¨ ×œ×˜×™×•×œ</h3>
            <div id="countdown" class="flex flex-row-reverse justify-around font-mono"></div>
        </div>`;
        const flightsHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2 col-span-1 sm:col-span-2">
            <h3 class="font-bold text-lg"><i class="fa-solid fa-plane-departure mr-2"></i>×¤×¨×˜×™ ×˜×™×¡×•×ª</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <div><b class="font-semibold">×”×œ×•×š:</b> ${flights.inbound.date} | ${flights.inbound.flight}</div>
                <div><b>×”××¨××”:</b> ${flights.inbound.departureTime} | <b>× ×—×™×ª×”:</b> ${flights.inbound.arrivalTime}</div>
                <div><b>×˜×¨××™× ×œ (× ×ª×‘"×’):</b> ${flights.inbound.terminal}</div>
                <div><b>×›×‘×•×“×”:</b> ${flights.inbound.baggage}</div>
                <hr class="md:col-span-2 my-1">
                <div><b class="font-semibold">×—×–×•×¨:</b> ${flights.outbound.date} | ${flights.outbound.flight}</div>
                <div><b>×”××¨××”:</b> ${flights.outbound.departureTime} | <b>× ×—×™×ª×”:</b> ${flights.outbound.arrivalTime}</div>
                <div><b>×˜×¨××™× ×œ (××™×œ×× ×•):</b> ${flights.outbound.terminal}</div>
                <div><b>×›×‘×•×“×”:</b> ${flights.outbound.baggage}</div>
            </div>
        </div>`;
        const hotelHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2">
            <h3 class="font-bold text-lg"><i class="fa-solid fa-hotel mr-2"></i>××œ×•×Ÿ</h3>
            <p><b>${hotel.name}</b></p>
            <div class="flex gap-2"><a href="${hotel.tel}" class="btn btn-ghost"><i class="fa fa-phone"></i> ×—×™×•×’</a><a href="https://maps.google.com/?q=${encodeURIComponent(hotel.address)}" target="_blank" class="btn btn-ghost"><i class="fa fa-map-location-dot"></i> × ×™×•×•×˜</a></div>
        </div>`;
        const contactsHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2">
            <h3 class="font-bold text-lg"><i class="fa-solid fa-address-book mr-2"></i>×˜×œ×¤×•× ×™× ×—×©×•×‘×™×</h3>
            <div class="flex gap-2"><a href="${contacts.emergency.tel}" class="btn btn-ghost">${contacts.emergency.name}</a><a href="${contacts.embassy.tel}" class="btn btn-ghost">${contacts.embassy.name}</a></div>
        </div>`;
        $('#overview-cards').innerHTML = countdownHtml + flightsHtml + hotelHtml + contactsHtml;
        startCountdown();
    }

    function startCountdown() {
        console.log("LOG: startCountdown called.");
        const targetDate = new Date(`${tripMeta.flights.inbound.date}T00:00:00`).getTime();
        const countdownEl = $('#countdown');
        if (!countdownEl) {
            console.error("ERROR: Countdown element not found.");
            return;
        }
        
        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance < 0) {
                clearInterval(interval);
                countdownEl.innerHTML = "<div class='text-lg font-bold w-full'>×”×˜×™×•×œ ×”×ª×—×™×œ! ×ª×”× ×•!</div>";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownEl.innerHTML = `
                <div><div class="countdown-number">${days}</div><div class="countdown-label">×™××™×</div></div>
                <div><div class="countdown-number">${hours}</div><div class="countdown-label">×©×¢×•×ª</div></div>
                <div><div class="countdown-number">${minutes}</div><div class="countdown-label">×“×§×•×ª</div></div>
                <div><div class="countdown-number">${seconds}</div><div class="countdown-label">×©× ×™×•×ª</div></div>
            `;
        }, 1000);
    }

function renderAllPlans(planData) {
    console.log("LOG: renderAllPlans called.");
    if (!planData) {
        console.warn("WARN: renderAllPlans called with no planData.");
        return;
    }
    const nav = $('#day-tabs-nav'), content = $('#plan-content-container');
    const submenu = $('#plan-submenu-links');
    
    // --- START OF FIX ---
    let navHtml = '';
    let contentHtml = '';
    let submenuHtml = '';

    const sortedDays = Object.entries(planData).sort((a, b) => a[0].localeCompare(b[0]));

    // Step 1: Build all HTML strings first
    sortedDays.forEach(([dayId, dayData], i) => {
        const active = i === 0;
        navHtml += `<button class="tab-button ${active ? 'tab-active' : ''}" data-content="${dayId}">${dayData.name}</button>`;
        contentHtml += `<div id="${dayId}" class="content-section ${active ? 'active' : ''}"></div>`;
        submenuHtml += `<a href="#plan" data-day-index="${i}" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">${dayData.name.split(':')[0]}</a>`;
    });
    submenuHtml += `<a href="#suggestions" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 col-span-3">×”×¦×¢×•×ª</a>`;

    // Step 2: Set innerHTML only ONCE for each container
    nav.innerHTML = navHtml;
    content.innerHTML = contentHtml;
    submenu.innerHTML = submenuHtml;

    // Step 3: Now that all containers exist, populate them and add listeners
    sortedDays.forEach(([dayId, dayData]) => {
        renderPlanForDay(dayId, dayData);
    });
    // --- END OF FIX ---

    // Attach event listeners for tabs (this part remains the same)
    $$('#day-tabs-nav .tab-button').forEach(b => b.addEventListener('click', (e) => {
        console.log(`LOG: Day tab clicked: ${e.currentTarget.dataset.content}`);
        $$('#day-tabs-nav .tab-button').forEach(btn => btn.classList.remove('tab-active'));
        e.currentTarget.classList.add('tab-active');
        $$('#plan-content-container .content-section').forEach(s => s.classList.remove('active'));
        $(`#${e.currentTarget.dataset.content}`).classList.add('active');
    }));
    $$('#plan-submenu-links a[data-day-index]').forEach(link => {
        link.addEventListener('click', (e) => {
            const dayIndex = parseInt(e.currentTarget.dataset.dayIndex, 10);
            console.log(`LOG: Mobile day link clicked for day index: ${dayIndex}`);
            $$('#day-tabs-nav .tab-button')[dayIndex].click();
        });
    });
}

    function renderPlanForDay(dayId, dayData) {
        console.log(`LOG: renderPlanForDay called for ${dayId}`);
        const container = $(`#${dayId}`);
        if (!container) {
            console.error(`ERROR: Container for day ${dayId} not found.`);
            return;
        }
        let content = `<div class="p-4"><div class="flex flex-wrap items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                <label class="font-semibold">××¦×‘ × ×¡×™×¢×”:</label>
                <select class="p-2 rounded-lg border bg-white dark:bg-gray-800" data-day="${dayId}" onchange="window.handleTransportChange(event)">
                    <option value="walk" ${dayData.transport === 'walk' ? 'selected' : ''}>×”×œ×™×›×”</option>
                    <option value="drive" ${dayData.transport === 'drive' ? 'selected' : ''}>×¨×›×‘/××•× ×™×ª</option>
                    <option value="transit" ${dayData.transport === 'transit' ? 'selected' : ''}>×ª×—×‘"×¦</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="window.openDayMap('${dayId}')"><i class="fa-solid fa-map-route mr-2"></i>××¤×ª ×™×•×</button>
            <button class="btn btn-ghost" onclick="window.optimizeDayRoute('${dayId}')"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>×¡×“×¨ ×œ×™ ××ª ×”×™×•×</button>
            <button class="btn btn-ghost" onclick="window.generateIcsFile('${dayId}')"><i class="fa-solid fa-calendar-plus mr-2"></i>×”×•×¡×£ ×œ×™×•××Ÿ</button>
        </div><div class="space-y-4">`;

        let previousActivity = null; 
        dayData.activities.forEach((act, i) => {
            const dist = haversineKm(previousActivity?.coords?.lat, previousActivity?.coords?.lon, act.coords?.lat, act.coords?.lon);
            const time = minsForMode(dist, dayData.transport);
            if (i > 0 && previousActivity) {
                content += `<div class="flex items-center gap-2 text-sm text-gray-500 justify-center">
                    <i class="fa-solid fa-arrow-down"></i> <span>${formatKm(dist)} / ${formatMin(time)}</span>
                </div>`;
            }
            content += renderActivityCard(dayId, act, i, dayData.activities.length, previousActivity);
            previousActivity = act;
        });
        
        content += `</div>${renderJournal(dayId, localTripData.journal ? localTripData.journal[dayId] : [])}</div>`;
        container.innerHTML = content;
        
        // Add event listener to the newly created journal form
        const journalForm = $(`#journal-form-${dayId}`);
        if (journalForm) {
            journalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                console.log(`LOG: Journal form submitted for day: ${dayId}`);
                if(!isFirebaseConnected) { 
                    showAlert('×©×’×™××ª ×¡× ×›×¨×•×Ÿ', '××™×Ÿ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.');
                    return; 
                }
                const textInput = $(`#journal-text-${dayId}`);
                const text = textInput.value.trim();
                if (text) {
                    addJournalEntry(dayId, text);
                    textInput.value = '';
                }
            });
        }
    }
    
    function renderActivityCard(dayId, activity, index, total, previousActivity) {
        const isDining = activity.type === 'dining';
        const links = [];
        if (activity.tickets) links.push(`<a href="${activity.tickets}" target="_blank" class="btn btn-primary"><i class="fa-solid fa-ticket"></i> ×›×¨×˜×™×¡×™×</a>`);
        if (activity.info) links.push(`<a href="${activity.info}" target="_blank" class="btn btn-ghost"><i class="fa-solid fa-circle-info"></i> ××™×“×¢</a>`);
        if (activity.address) {
            links.push(`<a href="https://waze.com/ul?q=${encodeURIComponent(activity.address)}" target="_blank" class="btn btn-ghost" title="Waze"><i class="fa-brands fa-waze"></i></a>`);
            links.push(`<a href="https://maps.google.com/?q=${encodeURIComponent(activity.address)}" target="_blank" class="btn btn-ghost" title="Google Maps"><i class="fa-brands fa-google"></i></a>`);
        }
        if (previousActivity && previousActivity.address && activity.address) {
            const transitUrl = `https://maps.google.com/?saddr=${encodeURIComponent(previousActivity.address)}&daddr=${encodeURIComponent(activity.address)}&travelmode=transit`;
            links.push(`<a href="${transitUrl}" target="_blank" class="btn btn-ghost" title="× ×™×•×•×˜ ×‘×ª×—×‘×´×¦"><i class="fa-solid fa-route"></i></a>`);
        }
        if(!isDining && activity.coords) {
             links.push(`<button onclick="window.findNearbyKosher(this)" data-lat="${activity.coords.lat}" data-lon="${activity.coords.lon}" data-name="${activity.name}" class="btn btn-ghost"><i class="fa-solid fa-utensils"></i> ××¡×¢×“×•×ª</button>`);
        }

        const imgHTML = activity.img ? `<div class="image-carousel" data-images='${JSON.stringify(activity.img)}' data-index="0">
            <img loading="lazy" src="${activity.img[0]}" alt="${activity.name}" class="thumb" onerror="this.style.display='none'">
            ${(activity.img.length || 0) > 1 ? `<button class="carousel-prev" onclick="window.navigateCarousel(this, -1)"><</button><button class="carousel-next" onclick="window.navigateCarousel(this, 1)">></button>` : ''}
        </div>` : '';
        
        const moveButtons = `
            <button class="p-1 ${index === 0 ? 'opacity-25' : ''}" ${index === 0 ? 'disabled' : ''} onclick="window.moveActivity('${dayId}', '${activity.id}', -1)"><i class="fa-solid fa-arrow-up"></i></button>
            <button class="p-1 ${index === total - 1 ? 'opacity-25' : ''}" ${index === total - 1 ? 'disabled' : ''} onclick="window.moveActivity('${dayId}', '${activity.id}', 1)"><i class="fa-solid fa-arrow-down"></i></button>
        `;

        return `<details class="bg-gray-50 dark:bg-gray-900 rounded-xl shadow-md overflow-hidden relative" open>
          <summary class="cursor-pointer list-none flex items-center justify-between p-4">
            <h4 class="font-bold text-lg">${isDining ? '<i class="fa-solid fa-utensils mr-2"></i>' : ''}${activity.time ? activity.time + ' - ' : ''}${activity.name}</h4>
            <div class="text-gray-400 flex items-center gap-2">
                ${moveButtons}
                <i class="fa-solid fa-chevron-down transition-transform"></i>
            </div>
          </summary>
          <button class="absolute top-3 left-3 text-red-500 hover:text-red-700 p-1 z-10" onclick="window.removeActivity('${dayId}', '${activity.id}')"><i class="fa-solid fa-trash"></i></button>
          <div class="flex flex-col md:flex-row border-t border-gray-100 dark:border-gray-800">
            ${imgHTML}
            <div class="p-4 md:p-5 flex-grow">
              <p class="text-gray-700 dark:text-gray-300">${fmtBold(activity.description)}</p>
              ${activity.hours ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-2"><i class="fa-solid fa-clock w-4 mr-1"></i> ${activity.hours}</p>` : ''}
              <div class="mt-4 flex flex-wrap items-center gap-2">${links.join('')}</div>
            </div>
          </div>
        </details>`;
    }
    
    function renderSuggestions(suggestions) {
        console.log("LOG: renderSuggestions called.");
        const container = $('#suggestions-table-container');
        if (!suggestions || suggestions.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500">×›×œ ×”×›×‘×•×“! ×›×œ ×”×¤×¢×™×œ×•×™×•×ª ×©×•×‘×¦×• ×‘×ª×•×›× ×™×ª.</div>`;
            return;
        }

        const tableRows = suggestions.map(s => `
            <tr class="border-b dark:border-gray-800">
                <td data-label="×©×" class="p-3 font-medium">${s.name}</td>
                <td data-label="×ª×™××•×¨" class="p-3 text-sm text-gray-600 dark:text-gray-400">${s.description}</td>
                <td data-label="×¤×¢×•×œ×•×ª" class="p-3">
                    <div class="flex flex-wrap gap-2 justify-end">
                        <button onclick="window.openAddToDayModal('${s.id}')" class="btn btn-primary btn-sm"><i class="fa-solid fa-plus"></i> ×”×•×¡×£</button>
                        <a href="https://maps.google.com/?q=${s.coords.lat},${s.coords.lon}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-solid fa-map-location-dot"></i> ××¤×”</a>
                    </div>
                </td>
            </tr>
        `).join('');

        container.innerHTML = `
            <table class="w-full text-sm responsive-table">
                <thead class="text-right bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="p-3 font-semibold">×©×</th>
                        <th class="p-3 font-semibold">×ª×™××•×¨</th>
                        <th class="p-3 font-semibold"></th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;
    }

    function isCurrentlyOpen(hoursString) {
        if (!hoursString) return false;
        
        const now = new Date();
        const timeZone = 'Europe/Rome';
        
        const milanParts = new Intl.DateTimeFormat('en-US', {
            timeZone,
            weekday: 'short',
            hour: 'numeric',
            minute: 'numeric',
            hour12: false,
        }).formatToParts(now);

        const milanDayStr = milanParts.find(p => p.type === 'weekday')?.value;
        const hourPart = milanParts.find(p => p.type === 'hour')?.value;
        const minutePart = milanParts.find(p => p.type === 'minute')?.value;
        
        if (!milanDayStr || !hourPart || !minutePart) {
             console.error("Could not determine Milan time");
             return false;
        }

        let currentHour = parseInt(hourPart, 10);
        if (currentHour === 24) currentHour = 0;

        const currentMinute = parseInt(minutePart, 10);
        
        const dayMapEn = {'Sun': 0, 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5, 'Sat': 6};
        const currentDay = dayMapEn[milanDayStr];
        const currentTimeInMinutes = currentHour * 60 + currentMinute;
        
        const dayMapHe = {'×': 0, '×‘': 1, '×’': 2, '×“': 3, '×”': 4, '×•': 5, '×©': 6};

        try {
            const dayEntries = hoursString.split(';').map(s => s.trim());
            for (const entry of dayEntries) {
                const firstSpaceIndex = entry.indexOf(' ');
                if (firstSpaceIndex === -1) continue;

                const daySpec = entry.substring(0, firstSpaceIndex);
                const timeSpec = entry.substring(firstSpaceIndex + 1);

                let applicableDays = [];
                const cleanedDaySpec = daySpec.replace(/'/g, '');
                if (cleanedDaySpec.includes('-')) {
                    const [startChar, endChar] = cleanedDaySpec.split('-');
                    const startDay = dayMapHe[startChar];
                    const endDay = dayMapHe[endChar];
                    if (startDay !== undefined && endDay !== undefined) {
                        for (let i = startDay; i <= endDay; i++) {
                            applicableDays.push(i);
                        }
                    }
                } else {
                    applicableDays = cleanedDaySpec.split(',').map(d => dayMapHe[d]).filter(d => d !== undefined);
                }
                
                const timeRanges = timeSpec.split(',').map(r => r.trim());

                for (const range of timeRanges) {
                    const [startStr, endStr] = range.split('-');
                    if (!startStr || !endStr) continue;

                    const [startH, startM] = startStr.split(':').map(Number);
                    const [endH, endM] = endStr.split(':').map(Number);
                    const startTotalMinutes = startH * 60 + (startM || 0);
                    let endTotalMinutes = endH * 60 + (endM || 0);
                    
                    if (endTotalMinutes < startTotalMinutes) { // Crosses midnight
                        const previousDay = currentDay === 0 ? 6 : currentDay - 1;
                        if (applicableDays.includes(currentDay) && currentTimeInMinutes >= startTotalMinutes) {
                            return true;
                        }
                        if (applicableDays.includes(previousDay) && currentTimeInMinutes < endTotalMinutes) {
                             return true;
                        }
                    } else { // Same day
                        if (applicableDays.includes(currentDay) && currentTimeInMinutes >= startTotalMinutes && currentTimeInMinutes < endTotalMinutes) {
                            return true;
                        }
                    }
                }
            }
        } catch (e) {
            console.error("Error parsing hours string:", hoursString, e);
            return false;
        }

        return false;
    }

    function renderKosher(filter = 'all') {
        console.log(`LOG: renderKosher called with filter: ${filter}`);
        let allKosher = [...kosherData.restaurants, ...kosherData.markets];
        
        if (userCoords) {
            allKosher.forEach(k => k.distance = haversineKm(userCoords.lat, userCoords.lon, k.coords.lat, k.coords.lon));
            allKosher.sort((a,b) => a.distance - b.distance);
        } else {
            allKosher.forEach(k => delete k.distance);
        }

        const filtered = allKosher.filter(r => {
            if (filter === 'open') return isCurrentlyOpen(r.hours);
            if (filter === 'all') return true;
            const style = r.style.toLowerCase();
            return style.includes(filter.toLowerCase());
        });

        const content = filtered.map(item => (item.style.includes('×‘×©×¨×™') || item.style.includes('×—×œ×‘×™') || item.style.includes('×¤×œ××¤×œ') || item.style.includes('×˜×™×™×§-××•×•×™') ? rowRestaurant(item) : rowMarket(item))).join('');
        $('#kosher-results').innerHTML = `<table class="min-w-full text-sm responsive-table"><tbody>${content || `<tr><td class="p-4 text-center">×œ× × ××¦××• ×ª×•×¦××•×ª.</td></tr>`}</tbody></table>`;
    }

    function renderKosherFilters() {
        console.log("LOG: renderKosherFilters called.");
        const filters = ['all', 'open', '×‘×©×¨×™', '×—×œ×‘×™', '×××¤×™×™×”', '××¨×›×•×œ'];
        const filterLabels = {'all': '×”×›×œ', 'open': '×¤×ª×•×— ×¢×›×©×™×•', '×‘×©×¨×™': '×‘×©×¨×™', '×—×œ×‘×™': '×—×œ×‘×™', '×××¤×™×™×”': '×××¤×™×™×”', '××¨×›×•×œ': '××¨×›×•×œ'};
        $('#kosher-filters').innerHTML = filters.map(f => `<button class="kosher-filter-btn btn btn-ghost" data-filter="${f}">${filterLabels[f]}</button>`).join('');
        $$('.kosher-filter-btn').forEach(btn => btn.addEventListener('click', e => {
            const currentFilter = e.target.dataset.filter;
            console.log(`LOG: Kosher filter button clicked: ${currentFilter}`);
            renderKosher(currentFilter);
            $$('.kosher-filter-btn').forEach(b => b.classList.remove('tab-active'));
            e.target.classList.add('tab-active');
        }));
        $('.kosher-filter-btn[data-filter="all"]').classList.add('tab-active');
    }

    const rowRestaurant = r => {
        const logoSrc = r.logo || placeholderLogoUrl(r.name);
        return `
        <tr class="align-top border-b dark:border-gray-800">
            <td data-label="×œ×•×’×•" class="p-3 logo-cell"><img class="logo" src="${logoSrc}" alt="${r.name}" onerror="this.onerror=null;this.src='${placeholderLogoUrl(r.name)}';"></td>
            <td data-label="×©×" class="p-3 font-medium">${r.name} <span class="text-xs font-normal text-gray-500">${r.distance ? formatKm(r.distance) : ''}</span></td>
            <td data-label="×¡×’× ×•×Ÿ" class="p-3">${r.style}</td>
            <td data-label="×©×¢×•×ª" class="p-3 text-xs">${r.hours || ''}</td>
            <td data-label="×¤×¢×•×œ×•×ª" class="p-3">
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.openAddToDayModal('${r.name}', 'kosher')" class="btn btn-primary btn-sm" title="×”×•×¡×£ ×œ×™×•×"><i class="fa-solid fa-plus"></i></button>
                    ${r.phone ? `<a title="×”×ª×§×©×¨" href="tel:${r.phone}" class="btn btn-ghost btn-sm"><i class="fa-solid fa-phone"></i></a>`:''}
                    <a title="Waze" href="https://waze.com/ul?q=${encodeURIComponent(r.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-waze"></i></a>
                    <a title="Google Maps" href="https://maps.google.com/?q=${encodeURIComponent(r.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-google"></i></a>
                    ${r.menu ? `<a href="${r.menu}" target="_blank" class="btn btn-ghost btn-sm" title="×ª×¤×¨×™×˜"><i class="fa-solid fa-utensils"></i></a>`:''}
                    ${r.website ? `<a href="${r.website}" target="_blank" class="btn btn-ghost btn-sm" title="××ª×¨"><i class="fa-solid fa-globe"></i></a>`:''}
                    ${r.instagram ? `<a title="××™× ×¡×˜×’×¨×" href="${r.instagram}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-instagram"></i></a>`:''}
                </div>
            </td>
        </tr>`;
    };
    const rowMarket = m => {
        const logoSrc = m.logo || placeholderLogoUrl(m.name);
        return `
        <tr class="align-top border-b dark:border-gray-800">
            <td data-label="×œ×•×’×•" class="p-3 logo-cell"><img class="logo" src="${logoSrc}" alt="${m.name}" onerror="this.onerror=null;this.src='${placeholderLogoUrl(m.name)}';"></td>
            <td data-label="×©×" class="p-3 font-medium">${m.name} <span class="text-xs font-normal text-gray-500">${m.distance ? formatKm(m.distance) : ''}</span></td>
            <td data-label="×¡×•×’" class="p-3">${m.style}</td>
            <td data-label="×©×¢×•×ª" class="p-3 text-xs">${m.hours || ''}</td>
            <td data-label="×¤×¢×•×œ×•×ª" class="p-3">
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.openAddToDayModal('${m.name}', 'kosher')" class="btn btn-primary btn-sm" title="×”×•×¡×£ ×œ×™×•×"><i class="fa-solid fa-plus"></i></button>
                    ${m.phone ? `<a title="×”×ª×§×©×¨" href="tel:${m.phone}" class="btn btn-ghost btn-sm"><i class="fa-solid fa-phone"></i></a>`:''}
                    <a title="Waze" href="https://waze.com/ul?q=${encodeURIComponent(m.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-waze"></i></a>
                    <a title="Google Maps" href="https://maps.google.com/?q=${encodeURIComponent(m.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-google"></i></a>
                    ${m.website ? `<a href="${m.website}" target="_blank" class="btn btn-ghost btn-sm" title="××ª×¨"><i class="fa-solid fa-globe"></i></a>`:''}
                    ${m.instagram ? `<a title="××™× ×¡×˜×’×¨×" href="${r.instagram}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-instagram"></i></a>`:''}
                </div>
            </td>
        </tr>`;
    };

    function renderChecklist(checklistData) {
        console.log("LOG: renderChecklist called.");
        const container = $('#checklist-container');
        const categorySelect = $('#category-select');
        container.innerHTML = '';
        categorySelect.innerHTML = '<option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”...</option>';
        (checklistData || []).forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat.category}">${cat.category}</option>`;
            let catHtml = `<div class="space-y-2"><h4 class="font-bold">${cat.category}</h4>`;
            (cat.items || []).forEach(item => {
                catHtml += `<label class="flex items-center gap-2">
                    <input type="checkbox" data-id="${item.id}" ${item.done ? 'checked' : ''} onchange="window.toggleChecklistItem(event)">
                    <span class="${item.done ? 'line-through text-gray-500' : ''}">${item.text}</span>
                    <button class="text-red-500 mr-auto hover:text-red-700 text-xs" onclick="window.removeChecklistItem('${cat.id}', '${item.id}')"><i class="fa-solid fa-trash"></i></button>
                </label>`;
            });
            container.innerHTML += catHtml + '</div>';
        });
    }

    async function fetchWeather() {
        console.log("LOG: fetchWeather called.");
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=45.46&longitude=9.19&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe/Berlin&forecast_days=7`);
            const data = await res.json();
            if (data.error) throw new Error(data.reason);
            lastWeatherAPIData = data; // Cache weather data
            console.log("LOG: Weather data fetched successfully.");
             const iconMap = {
                0: 'fa-sun', 1: 'fa-cloud-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud',
                45: 'fa-smog', 48: 'fa-smog',
                51: 'fa-cloud-rain', 53: 'fa-cloud-rain', 55: 'fa-cloud-rain',
                56: 'fa-snowflake', 57: 'fa-snowflake',
                61: 'fa-cloud-showers-heavy', 63: 'fa-cloud-showers-heavy', 65: 'fa-cloud-showers-heavy',
                66: 'fa-snowflake', 67: 'fa-snowflake',
                71: 'fa-snowflake', 73: 'fa-snowflake', 75: 'fa-snowflake', 77: 'fa-snowflake',
                80: 'fa-cloud-showers-heavy', 81: 'fa-cloud-showers-heavy', 82: 'fa-cloud-showers-heavy',
                85: 'fa-snowflake', 86: 'fa-snowflake',
                95: 'fa-cloud-bolt', 96: 'fa-cloud-bolt', 99: 'fa-cloud-bolt'
            };
            $('#weather-forecast').innerHTML = data.daily.time.slice(0, 5).map((day, i) => `
                <div class="flex justify-between items-center text-sm">
                    <span>${new Date(day).toLocaleDateString('he-IL', { weekday: 'short' })}</span>
                    <span><i class="fa-solid ${iconMap[data.daily.weathercode[i]] || 'fa-question-circle'}"></i></span>
                    <span>${Math.round(data.daily.temperature_2m_min[i])}Â°/${Math.round(data.daily.temperature_2m_max[i])}Â°</span>
                </div>`).join('');
            
            const todayTempMax = data.daily.temperature_2m_max[0];
            const todayWeatherCode = data.daily.weathercode[0];
            let recommendation = '';
            if (((todayWeatherCode >= 71 && todayWeatherCode <= 86) || (todayWeatherCode >= 56 && todayWeatherCode <= 67)) && todayTempMax < 5) {
                recommendation = '×¦×¤×•×™ ×©×œ×’/××–×’ ××•×•×™×¨ ×§×¤×•×. ×”×ª×œ×‘×©×• ×—× ×××•×“!';
            } 
            else if ((todayWeatherCode >= 51 && todayWeatherCode <= 67) || (todayWeatherCode >= 80 && todayWeatherCode <= 82)) {
                recommendation = '×¦×¤×•×™ ×’×©×. ××•××œ×¥ ×œ×§×—×ª ××˜×¨×™×” ×•×¢×œ×™×•× ×™×ª.';
            } 
            else if (todayWeatherCode >= 95) {
                 recommendation = '×¦×¤×•×™×” ×¡×•×¤×ª ×¨×¢××™×. ××•××œ×¥ ×œ××¦×•× ××—×¡×”.';
            }
            else if (todayTempMax > 28) {
                recommendation = '×—×! ××•××œ×¥ ×œ×‘×•×© ×§×¦×¨, ×›×•×‘×¢ ×•×”×¨×‘×” ××™×.';
            } else if (todayTempMax > 20) {
                recommendation = '××–×’ ××•×•×™×¨ × ×¢×™×, ×œ×‘×•×© ×§×¦×¨ ××• ××¨×•×š ×•×“×§ ×™×ª××™×.';
            } else if (todayTempMax > 12) {
                recommendation = '×§×¨×™×¨, ××•××œ×¥ ×œ×‘×•×© ××¨×•×š ×•×¢×œ×™×•× ×™×ª / ×–×³×§×˜ ×§×œ.';
            } else {
                recommendation = '×§×¨, ××•××œ×¥ ×œ×”×ª×œ×‘×© ×—× ×¢× ××¢×™×œ ×•×›×•×‘×¢.';
            }
            $('#weather-attire-recommendation').innerHTML = `<i class="fa-solid fa-shirt mr-2"></i> ${recommendation}`;

        } catch (e) { 
            console.error("ERROR: Failed to fetch weather.", e);
            $('#weather-forecast').innerHTML = `<p class="text-xs text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×—×–×™×ª. ${e.message}</p>`; 
        }
    }

    async function fetchExchangeRate() {
        console.log("LOG: fetchExchangeRate called.");
        try {
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
            const data = await response.json();
            if(data && data.rates && data.rates.ILS) {
                eurToIlsRate = data.rates.ILS;
                $('#exchange-rate-display').textContent = `×©×¢×¨ × ×•×›×—×™: 1â‚¬ = ${eurToIlsRate.toFixed(3)}â‚ª`;
                console.log(`LOG: Exchange rate updated: 1 EUR = ${eurToIlsRate} ILS`);
            }
        } catch (error) {
            console.error("ERROR: Could not fetch exchange rate:", error);
             $('#exchange-rate-display').textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×©×¢×¨ ×—×œ×™×¤×™×Ÿ.';
        }
    }
    
    function renderDocuments(documents = []) {
        console.log("LOG: renderDocuments called.");
        const grid = $('#documents-grid');
        grid.innerHTML = (documents || []).map(doc => `
            <div class="relative bg-gray-100 dark:bg-gray-800 rounded-lg flex flex-col items-center justify-center p-2 text-center">
                 <a href="${doc.dataUrl}" download="${doc.name}" class="flex flex-col items-center justify-center w-full h-full">
                    <i class="fa-solid fa-file-pdf fa-3x text-red-500"></i>
                    <span class="text-xs mt-2 break-all">${doc.name}</span>
                </a>
                <button class="delete-btn" onclick="window.removeDocument('${doc.id}')">Ã—</button>
            </div>`).join('');
    }

    function renderGallery(gallery = []) {
        console.log("LOG: renderGallery called.");
        const grid = $('#gallery-grid');
        grid.innerHTML = (gallery || []).map(img => `<div class="relative aspect-square">
            <img src="${img.dataUrl}" class="w-full h-full object-cover rounded-lg">
            <button class="delete-btn" onclick="window.removeImage('${img.id}')">Ã—</button>
        </div>`).join('');
    }

    function calculateEstimatedCosts(plan) {
        let totalCost = 0;
        if (!plan) return 0;
        Object.values(plan).forEach(day => {
            (day.activities || []).forEach(activity => {
                if(activity.cost) {
                    totalCost += activity.cost;
                }
            });
        });
        return totalCost * 2; // For a couple
    }

    function renderBudget(data) {
        console.log("LOG: renderBudget called.");
        const { totalBudget = 0, expenses = [], plan, settings = { includeEstimatedCostsInBalance: true } } = data || {};
        
        const totalBudgetInput = $('#total-budget');
        if (document.activeElement !== totalBudgetInput) {
             totalBudgetInput.value = totalBudget || '';
        }

        const includeEstimated = $('#include-estimated-costs');
        includeEstimated.checked = settings.includeEstimatedCostsInBalance;

        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        const estimatedCosts = calculateEstimatedCosts(plan);
        const balance = totalBudget - totalExpenses - (includeEstimated.checked ? estimatedCosts : 0);

        $('#total-expenses').textContent = totalExpenses.toFixed(2) + 'â‚¬';
        $('#estimated-costs').textContent = estimatedCosts.toFixed(2) + 'â‚¬';
        $('#budget-balance').textContent = balance.toFixed(2) + 'â‚¬';

        $('#expense-list').innerHTML = (expenses || []).map(exp => 
            `<div class="flex justify-between items-center py-1 group">
                <span>${exp.desc} <span class="text-xs text-gray-400">${exp.category}</span></span>
                <span class="flex items-center gap-2">
                    ${exp.amount.toFixed(2)}â‚¬
                   <button class="text-red-400 hover:text-red-600 transition-opacity" onclick="window.removeExpense('${exp.id}')">
    <i class="fa-solid fa-trash-alt fa-xs"></i>
      </button>
                </span>
            </div>`
        ).join('');
        
        renderBudgetChart(expenses);
    }
    
    function renderBudgetChart(expenses) {
        const ctx = $('#budget-chart').getContext('2d');
        const placeholder = $('#budget-chart-placeholder');
        const legendContainer = $('#budget-chart-legend');
        if (!ctx) return;

        const categoryTotals = (expenses || []).reduce((acc, exp) => {
            acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
            return acc;
        }, {});

        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const backgroundColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];

        if (budgetChartInstance) {
            budgetChartInstance.destroy();
        }
        
        legendContainer.innerHTML = '';
        if (labels.length === 0) {
            placeholder.classList.remove('hidden');
            return;
        }
        placeholder.classList.add('hidden');

        budgetChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderColor: 'var(--card)',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    title: { display: false },
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Generate custom legend
        legendContainer.innerHTML = `<h4 class="text-center font-bold mb-2">×¤×™×¨×•×˜ ×”×•×¦××•×ª</h4>`;
        labels.forEach((label, index) => {
            const amount = categoryTotals[label];
            const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(0) : 0;
            const color = backgroundColors[index % backgroundColors.length];
            legendContainer.innerHTML += `
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-sm" style="background-color: ${color};"></span>
                        <span>${label}</span>
                    </div>
                    <span class="font-semibold">${amount.toFixed(2)}â‚¬ (${percentage}%)</span>
                </div>
            `;
        });
    }

    function renderTranslationHistory() {
        console.log("LOG: renderTranslationHistory called.");
        const container = $('#translation-history');
        if (translationHistory.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400">×”×™×¡×˜×•×¨×™×™×ª ×ª×¨×’×•××™×</div>`;
            return;
        }
        container.innerHTML = translationHistory.map((item, index) => `
            <div class="p-1.5 bg-gray-100 dark:bg-gray-800 rounded-md flex justify-between items-center group">
                <div class="cursor-pointer flex-grow" onclick="window.reuseTranslation(${index})">
                    <div class="font-medium">${item.sourceText}</div>
                    <div class="text-gray-500">${item.translatedText}</div>
                </div>
                <button class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity ml-2 p-1" onclick="window.removeTranslationHistoryItem(event, ${index})">
                    <i class="fa-solid fa-trash-alt fa-xs"></i>
                </button>
            </div>
        `).join('');
    }
    // ========================= ×”×ª×—×œ×”: ×¤×•× ×§×¦×™×™×ª ×©×¢×•× ×™× =========================
function updateClocks() {
    const milanTimeEl = $('#milan-time');
    const israelTimeEl = $('#israel-time');

    if (milanTimeEl && israelTimeEl) {
        const now = new Date();
        milanTimeEl.textContent = now.toLocaleTimeString('he-IL', { timeZone: 'Europe/Rome', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        israelTimeEl.textContent = now.toLocaleTimeString('he-IL', { timeZone: 'Asia/Jerusalem', hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
}
    
// ========================= ×¡×•×£: ×¤×•× ×§×¦×™×™×ª ×©×¢×•× ×™× =========================
// ========================= ×”×ª×—×œ×”: ×¤×•× ×§×¦×™×™×ª ×—×™×¤×•×© ××”×™×¨ =========================
function findUtility(query, queryHebrew) {
    showAlert('×××ª×¨ ××™×§×•×...', `××—×¤×© ${queryHebrew} ×‘×§×¨×‘×ª×š...`);
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}&ll=${latitude},${longitude}`;
            window.open(url, '_blank');
            window.closeModal();
        }, () => {
            // Fallback in case of location error
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}+near+Milan+Cathedral`;
            window.open(url, '_blank');
            showAlert('×©×’×™××ª ××™×§×•×', '×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ××™×§×•××š. ×”×—×™×¤×•×© ×™×ª×‘×¦×¢ ×××¨×›×– ××™×œ×× ×•.');
        });
    } else {
        showAlert('×©×’×™××”', '×©×™×¨×•×ª×™ ××™×§×•× ××™× × × ×ª××›×™× ×‘×“×¤×“×¤×Ÿ ×–×”.');
    }
}
// ========================= ×¡×•×£: ×¤×•× ×§×¦×™×™×ª ×—×™×¤×•×© ××”×™×¨ =========================
    // --- State Modifiers (Write to Firestore) ---
    async function handleTransportChange(e) {
        const dayId = e.target.dataset.day;
        const newTransportMode = e.target.value;
        console.log(`LOG: handleTransportChange called for ${dayId}, new mode: ${newTransportMode}`);
        await updateDoc(tripDocRef, { [`plan.${dayId}.transport`]: newTransportMode });
    };
    async function removeActivity(dayId, actId) {
        console.log(`LOG: removeActivity called for day ${dayId}, activity ${actId}`);
        const day = localTripData.plan[dayId];
        const activityIndex = day.activities.findIndex(a => a.id === actId);
        if (activityIndex > -1) {
            const [removedActivity] = day.activities.splice(activityIndex, 1);
            let newSuggestions = localTripData.suggestions;
            if (removedActivity.type === 'attraction') {
                 const originalId = actId.split('_')[0];
                 const originalAttraction = attractions[originalId];
                 if (originalAttraction && !newSuggestions.find(s => s.id === originalId)) {
                     newSuggestions.push({ ...originalAttraction, id: originalId });
                 }
            }
            await updateDoc(tripDocRef, {
                plan: localTripData.plan,
                suggestions: newSuggestions
            });
        }
    };
    async function moveActivity(dayId, actId, direction) {
        console.log(`LOG: moveActivity called for ${actId} in day ${dayId}, direction ${direction}`);
        const day = localTripData.plan[dayId];
        const index = day.activities.findIndex(a => a.id === actId);
        if ((direction === -1 && index > 0) || (direction === 1 && index < day.activities.length - 1)) {
            const [item] = day.activities.splice(index, 1);
            day.activities.splice(index + direction, 0, item);
            await updateDoc(tripDocRef, { [`plan.${dayId}.activities`]: day.activities });
        }
    };
    window.navigateCarousel = (btn, dir) => {
        const carousel = btn.closest('.image-carousel');
        const images = JSON.parse(carousel.dataset.images);
        let index = parseInt(carousel.dataset.index, 10);
        index = (index + dir + images.length) % images.length;
        carousel.querySelector('img').src = images[index];
        carousel.dataset.index = index;
    };
    function findNearby() {
        console.log("LOG: findNearby button clicked.");
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                window.open(`https://www.google.com/maps/search/point+of+interest/@${latitude},${longitude},14z`, '_blank');
            }, () => {
                showAlert('×©×’×™××ª ××™×§×•×', '×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ××™×§×•××š. × ×¤×ª×— ××¤×” ×›×œ×œ×™×ª ×©×œ ××™×œ×× ×•.');
                window.open('https://www.google.com/maps/place/Milan', '_blank');
            });
        } else {
             window.open('https://www.google.com/maps/place/Milan', '_blank');
        }
    }
    window.findNearbyKosher = (btn) => {
        const lat = parseFloat(btn.dataset.lat), lon = parseFloat(btn.dataset.lon);
        console.log(`LOG: findNearbyKosher called for ${btn.dataset.name} at ${lat}, ${lon}`);
        $('#kosher-subtitle').innerHTML = `××¦×™×’ ××§×•××•×ª ×§×¨×•×‘×™× ×œ: <strong>${btn.dataset.name}</strong>`;
        userCoords = {lat, lon}; // Temporarily set user location
        renderKosher();
        userCoords = null; // Reset it
        $('#kosher').scrollIntoView({ behavior: 'smooth' });
        if ($('#kosher-container').classList.contains('hidden')) {
            $('#toggle-kosher-btn').click();
        }
    };
    async function toggleChecklistItem(e) {
        const itemId = e.target.dataset.id;
        const isDone = e.target.checked;
        console.log(`LOG: toggleChecklistItem called for item ${itemId}, new status: ${isDone}`);
        const labelSpan = e.target.nextElementSibling;
        if (isDone) {
            labelSpan.classList.add('line-through', 'text-gray-500');
        } else {
            labelSpan.classList.remove('line-through', 'text-gray-500');
        }

        const updatedChecklist = localTripData.checklist.map(cat => ({
            ...cat,
            items: cat.items.map(item => item.id === itemId ? { ...item, done: isDone } : item)
        }));
        if (tripDocRef) {
           await updateDoc(tripDocRef, { checklist: updatedChecklist });
        }
    };
    async function removeChecklistItem(catId, itemId) {
        console.log(`LOG: removeChecklistItem called for item ${itemId} in category ${catId}`);
        const updatedChecklist = localTripData.checklist.map(cat => {
            if (cat.id === catId) {
                return { ...cat, items: cat.items.filter(i => i.id !== itemId) };
            }
            return cat;
        }).filter(cat => cat.items.length > 0);
        await updateDoc(tripDocRef, { checklist: updatedChecklist });
    };
    
    async function removeExpense(id) {
        console.log(`LOG: removeExpense called for id ${id}`);
        const expenseToRemove = (localTripData.expenses || []).find(exp => exp.id === id);
        if (expenseToRemove) {
            await updateDoc(tripDocRef, { expenses: arrayRemove(expenseToRemove) });
        }
    };
    async function removeDocument(id) {
        console.log(`LOG: removeDocument called for id ${id}`);
        const docToRemove = (localTripData.documents || []).find(doc => doc.id === id);
        if (docToRemove) {
            await updateDoc(tripDocRef, { documents: arrayRemove(docToRemove) });
        }
    };
    async function removeImage(id) {
        console.log(`LOG: removeImage called for id ${id}`);
        const imgToRemove = (localTripData.gallery || []).find(img => img.id === id);
        if (imgToRemove) {
            await updateDoc(tripDocRef, { gallery: arrayRemove(imgToRemove) });
        }
    };
    window.reuseTranslation = (index) => {
        console.log(`LOG: Reusing translation history item at index ${index}`);
        const item = translationHistory[index];
        if (item) {
            $('#dictionary-input').value = item.sourceText;
            $('#dictionary-form').requestSubmit();
        }
    };
    window.removeTranslationHistoryItem = (event, index) => {
        event.stopPropagation(); 
        console.log(`LOG: Removing translation history item at index ${index}`);
        translationHistory.splice(index, 1);
      localStorage.setItem('milanTripTranslationHistory', JSON.stringify(translationHistory));
        renderTranslationHistory();
    };
    window.openDayMap = (dayId) => {
        console.log(`LOG: openDayMap called for ${dayId}`);
        const day = localTripData.plan[dayId];
        if (!day || !day.activities || day.activities.length === 0) {
            showAlert('××™×Ÿ ××™×§×•××™×', '××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×¢× ×›×ª×•×‘×•×ª ×‘×™×•× ×–×” ×›×“×™ ×œ×”×¦×™×’ ×¢×œ ×”××¤×”.');
            return;
        }
        const locations = day.activities
            .map(act => act.address)
            .filter(address => address); 
        
        if (locations.length < 1) {
             showAlert('××™×Ÿ ××™×§×•××™×', '××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×¢× ×›×ª×•×‘×•×ª ×‘×™×•× ×–×” ×›×“×™ ×œ×”×¦×™×’ ×¢×œ ×”××¤×”.');
             return;
        }

        const url = `https://www.google.com/maps/dir/${locations.map(encodeURIComponent).join('/')}`;
        window.open(url, '_blank');
    };

    // --- Camera Functions ---
    async function startCamera() {
        console.log("LOG: startCamera called.");
        const video = $('#camera-feed');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = cameraStream;
                video.play();
                $('#camera-modal').classList.add('flex');
            } catch (err) {
                console.error("ERROR: Error accessing camera: ", err);
                showAlert("×©×’×™××ª ××¦×œ××”", "×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××¦×œ××”. ×•×“× ×©×”×¢× ×§×ª ×”×¨×©××•×ª ×œ×“×¤×“×¤×Ÿ.");
            }
        } else {
            showAlert("××¦×œ××” ×œ× × ×ª××›×ª", "×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×’×™×©×” ×œ××¦×œ××”.");
        }
    }

    function stopCamera() {
        console.log("LOG: stopCamera called.");
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        $('#camera-modal').classList.remove('flex');
    }

    function captureFrameAndTranslate() {
        console.log("LOG: captureFrameAndTranslate called.");
        const video = $('#camera-feed');
        const canvas = $('#camera-canvas');
        const context = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const dataUrl = canvas.toDataURL('image/jpeg');
        const base64ImageData = dataUrl.split(',')[1];
        
        stopCamera();
        translateImage(base64ImageData, 'image/jpeg');
    }

    // --- Gemini Calls ---
    async function callGemini(payload, prompt, useSearch = false) {
        console.log(`LOG: callGemini called. Use search: ${useSearch}. Prompt: ${prompt.substring(0, 100)}...`);
        payload.contents[0].parts[0].text = prompt;
        if (useSearch) {
            // FIX 4: Changed 'google_search' to 'tools' with 'google_search_retrieval'
            payload.tools = [{ "google_search_retrieval": {} }];
        } else {
           if(payload.tools) delete payload.tools;
        }

        const apiKey = "AIzaSyB80v2xdhebJqhjyruJ5Ta0eyhJiq7DsI8"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) {
                console.error("ERROR: Gemini API response not OK.", result);
                throw new Error(result.error?.message || `×©×’×™××ª ×¨×©×ª: ${response.status}`);
            }
            console.log("LOG: Gemini API call successful.");
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return text || "×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×” ×-Gemini.";

        } catch (error) {
            console.error("ERROR: Gemini API Error:", error);
            return `×©×’×™××”: ${error.message}`;
        }
    }
    window.speakText = (text, lang) => {
        console.log(`LOG: speakText called for lang ${lang}. Text: ${text}`);
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        speechSynthesis.speak(utterance);
    }

    async function translateText(text) {
        console.log(`LOG: translateText called for text: ${text}`);
        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
        const targetLang = currentLang === 'he-it' ? 'Italian' : 'Hebrew';
        const prompt = `Translate the following to ${targetLang}. Provide ONLY the translated text, with no additional formatting or explanations. Text to translate: "${text}"`;
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        let responseText = await callGemini(payload, prompt, false);
        responseText = responseText.replace(/[\*\_`]/g, '').trim();
        const langCode = currentLang === 'he-it' ? 'it-IT' : 'he-IL';
        resultContainer.innerHTML = `<span>${responseText}</span> <button onclick="window.speakText('${responseText.replace(/'/g, "\\'")}', '${langCode}')" class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;
        
        translationHistory.unshift({ sourceText: text, translatedText: responseText });
        if (translationHistory.length > 5) translationHistory.pop(); // Keep last 5
      localStorage.setItem('milanTripTranslationHistory', JSON.stringify(translationHistory));
        renderTranslationHistory();
    }
    
    async function translateImage(base64ImageData, mimeType) {
        console.log(`LOG: translateImage called for mimeType: ${mimeType}`);
        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
        const targetLang = currentLang === 'he-it' ? 'Italian' : 'Hebrew';
        const prompt = `Extract any text from this image and translate it to ${targetLang}. Provide ONLY the translated text, with no additional formatting. If no text is found, respond with "×œ× × ××¦× ×˜×§×¡×˜".`;
        const payload = { contents: [{ parts: [{ text: "" }, { inlineData: { mimeType: mimeType, data: base64ImageData } }] }] };
        let responseText = await callGemini(payload, prompt, false);
        responseText = responseText.replace(/[\*\_`]/g, '').trim();
        const langCode = currentLang === 'he-it' ? 'it-IT' : 'he-IL';
        resultContainer.innerHTML = `<span>${responseText}</span> <button onclick="window.speakText('${responseText.replace(/'/g, "\\'")}', '${langCode}')" class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;
    }

    async function askGeneralGemini() {
        console.log("LOG: askGeneralGemini called.");
        const userPrompt = $('#gemini-prompt').value;
        if (!userPrompt) return;

        const responseContainer = $('#gemini-response');
        const submitBtn = $('#gemini-submit-btn');
        submitBtn.disabled = true;
        responseContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ×—×•×©×‘...`;
        
        const containsHebrew = /[\u0590-\u05FF]/.test(userPrompt);
        const finalPrompt = containsHebrew 
            ? `${userPrompt}\n\n(Please provide the answer in Hebrew)`
            : userPrompt;

        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const responseText = await callGemini(payload, finalPrompt, true);

        responseContainer.textContent = responseText;
        submitBtn.disabled = false;
    }
    
    async function fetchSafetyWarnings() {
        console.log("LOG: fetchSafetyWarnings called.");
        const container = $('#safety-warnings-content');
        container.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ×××ª×¨ ××™×“×¢ ×¢×“×›× ×™...`;
        
        const today = new Date().toLocaleDateString('en-CA');
        const prompt = `As a safety advisor, check for any significant demonstrations, public transport strikes, or specific safety warnings for tourists in Milan, Italy, specifically for today's date: ${today}. Provide a concise summary in Hebrew. If your web search finds no specific warnings, state that clearly and mention that the information is current as of today.`;
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const responseText = await callGemini(payload, prompt, true);
        
        container.textContent = responseText;
    }

    async function generateTripSummary() {
        console.log("LOG: generateTripSummary called.");
        showAlert('×™×•×¦×¨ ×¡×™×›×•×...', '××•×¡×£ ××ª ×›×œ ×”×—×•×•×™×•×ª ×•×”× ×ª×•× ×™× ×›×“×™ ×œ×™×¦×•×¨ ×¡×™×›×•× ××™×©×™... ×–×” ×¢×©×•×™ ×œ×§×—×ª ×¨×’×¢.', false);
        
        const { plan, expenses, journal } = localTripData;
        
        let placesVisited = [];
        if(plan) {
            Object.values(plan).forEach(day => {
                (day.activities || []).forEach(act => {
                    if (!placesVisited.includes(act.name)) placesVisited.push(act.name);
                });
            });
        }
        
        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        
        let journalEntries = [];
        if (journal) {
            Object.values(journal).forEach(dayEntries => {
                (dayEntries || []).forEach(entry => journalEntries.push(entry.text));
            });
        }

        const prompt = `
            Act as a creative travel blogger writing a personal trip summary. Based on the following data from a trip to Milan, create a warm, engaging, and experiential summary in Hebrew.
            The summary should feel like a personal memory, not just a list. Use paragraphs and an enthusiastic tone.
            
            Data:
            - Places Visited: ${placesVisited.join(', ')}.
            - Total Spent: Approximately ${totalExpenses.toFixed(0)} euros.
            - Personal Journal Notes: ${journalEntries.join('; ')}.
            
            Please generate the summary now.
        `;
        
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const summaryText = await callGemini(payload, prompt, false);
        
        showAlert('×¡×™×›×•× ×”×˜×™×•×œ ×©×œ×›×!', summaryText, true);
    }

    // --- NEW PWA & Smart Features ---
    window.optimizeDayRoute = async (dayId) => {
        console.log(`LOG: optimizeDayRoute called for ${dayId}`);
        const day = localTripData.plan[dayId];
        if (!day || !day.activities || day.activities.length < 2) {
            showAlert('×œ× × ×™×ª×Ÿ ×œ×‘×¦×¢ ××•×¤×˜×™××™×–×¦×™×”', '×¦×¨×™×š ×œ×¤×—×•×ª ×©×ª×™ ×¤×¢×™×œ×•×™×•×ª ×‘×™×•× ×›×“×™ ×œ×™×™×¢×œ ××ª ×”××¡×œ×•×œ.');
            return;
        }

        showAlert('××‘×¦×¢ ××•×¤×˜×™××™×–×¦×™×”...', '××¡×“×¨ ××—×“×© ××ª ×”×¤×¢×™×œ×•×™×•×ª ×›×“×™ ×œ×—×¡×•×š ×œ×š ×–××Ÿ...');
        
        let activities = [...day.activities];
        let optimizedRoute = [activities.shift()]; // Start with the first activity
        
        while (activities.length > 0) {
            let lastPoint = optimizedRoute[optimizedRoute.length - 1];
            let nearestIndex = -1;
            let minDistance = Infinity;

            activities.forEach((activity, index) => {
                const distance = haversineKm(lastPoint.coords?.lat, lastPoint.coords?.lon, activity.coords?.lat, activity.coords?.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestIndex = index;
                }
            });

            if (nearestIndex > -1) {
                optimizedRoute.push(activities.splice(nearestIndex, 1)[0]);
            } else {
                break; 
            }
        }
        
        await updateDoc(tripDocRef, { [`plan.${dayId}.activities`]: optimizedRoute });
        showAlert('×”××¡×œ×•×œ ×¢×‘×¨ ××•×¤×˜×™××™×–×¦×™×”!', '×¡×“×¨ ×”×¤×¢×™×œ×•×™×•×ª ×¢×•×“×›×Ÿ ×œ×™×•× ×–×”.');
    };

    window.generateIcsFile = (dayId) => {
        console.log(`LOG: generateIcsFile called for ${dayId}`);
        const day = localTripData.plan[dayId];
        const dayIndex = Object.keys(localTripData.plan).sort((a,b) => a.localeCompare(b[0])).indexOf(dayId);
        const tripStartDate = new Date(tripMeta.flights.inbound.date);
        const eventDate = new Date(tripStartDate.setDate(tripStartDate.getDate() + dayIndex));
        const eventDateStr = eventDate.toISOString().split('T')[0].replace(/-/g, '');

        const timeMap = { '×‘×•×§×¨': '090000', '×¦×”×¨×™×™×': '140000', '×¢×¨×‘': '190000' };
        const durationMap = { '×‘×•×§×¨': 3, '×¦×”×¨×™×™×': 4, '×¢×¨×‘': 4 };

        let icsContent = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//MilanTrip/Planner//EN',
        ];

        day.activities.forEach(activity => {
            const startTime = timeMap[activity.time] || '120000';
            const durationHours = durationMap[activity.time] || 2;
            const startDateTime = `${eventDateStr}T${startTime}`;
            const endHour = parseInt(startTime.substring(0, 2), 10) + durationHours;
            const endDateTime = `${eventDateStr}T${String(endHour).padStart(2, '0')}0000`;

            icsContent.push(
                'BEGIN:VEVENT',
                `UID:${activity.id}@milantrip.app`,
                `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '')}Z`,
                `DTSTART;TZID=Europe/Rome:${startDateTime}`,
                `DTEND;TZID=Europe/Rome:${endDateTime}`,
                `SUMMARY:${activity.name}`,
                `DESCRIPTION:${activity.description || ''}`,
                `LOCATION:${activity.address || ''}`,
                'END:VEVENT'
            );
        });
        icsContent.push('END:VCALENDAR');

        const blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${day.name}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    async function getSmartAdvice() {
        console.log("LOG: getSmartAdvice called.");
        const responseContainer = $('#gemini-response');
        const submitBtn = $('#get-smart-advice-btn');
        submitBtn.disabled = true;
        responseContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ×”×™×•×¢×¥ ×”×—×›× ×‘×•×“×§ ××ª ×”× ×ª×•× ×™×...`;
        
        const remainingBudget = (localTripData.totalBudget || 0) - (localTripData.expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        let weatherInfo = "No weather data available.";
        if(lastWeatherAPIData) {
            weatherInfo = `Today's forecast is a high of ${lastWeatherAPIData.daily.temperature_2m_max[0]}Â°C and a low of ${lastWeatherAPIData.daily.temperature_2m_min[0]}Â°C. Weather code: ${lastWeatherAPIData.daily.weathercode[0]}.`
        }
        
        const milanTime = new Date().toLocaleTimeString('en-US', { timeZone: 'Europe/Rome', hour: '2-digit', minute: '2-digit', hour12: false });
        
        const prompt = `
            As a smart travel advisor for a trip to Milan, provide a short, actionable recommendation in Hebrew based on the following context. Be friendly and helpful.
            
            Context:
            - Current time in Milan: ${milanTime}
            - Current weather situation: ${weatherInfo} (Weather codes: 0-3=Clear/Cloudy, 51-67=Rain, 71-86=Snow, 95+=Thunderstorm)
            - Remaining trip budget: â‚¬${remainingBudget.toFixed(0)}
            
            Based on this context, what is one useful suggestion you can give me right now? For example, if it's evening and raining, suggest an indoor attraction or a specific type of restaurant. If the budget is low, suggest a free activity.
        `;

        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const advice = await callGemini(payload, prompt, false);
        responseContainer.textContent = advice;
        submitBtn.disabled = false;
    }
    
    // --- LIVE LOCATION FUNCTIONS ---
    function initLiveMap() {
        console.log("LOG: initLiveMap called.");
        if (liveMap) return;
        liveMap = L.map('live-location-map').setView([45.4642, 9.1916], 12); // Milan center
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(liveMap);
    }

    async function updateLocationInFirestore(position) {
        if (!currentUserId) return;
        const { latitude, longitude } = position.coords;
        const userName = $('#user-name-input').value.trim() || `××©×ª××© ${currentUserId.substring(0,4)}`;
        const userLocationDocRef = doc(locationsColRef, currentUserId);
        
        console.log(`LOG: Updating location for ${userName} in Firestore.`);
        await setDoc(userLocationDocRef, {
            lat: latitude,
            lng: longitude,
            name: userName,
            timestamp: serverTimestamp()
        });
        $('#location-status').textContent = `××™×§×•× ×¢×•×“×›×Ÿ: ${new Date().toLocaleTimeString()}`;
    }

    function listenForLocationUpdates() {
        console.log("LOG: Setting up listener for location updates.");
        onSnapshot(locationsColRef, (snapshot) => {
            console.log("LOG: Received location snapshot update.");
            snapshot.docs.forEach(doc => {
                const locData = doc.data();
                const uid = doc.id;
                const latLng = [locData.lat, locData.lng];
                const displayName = (uid === currentUserId) ? `××ª×” (${locData.name})` : locData.name;

                if (userMarkers[uid]) {
                    userMarkers[uid].setLatLng(latLng);
                    userMarkers[uid].getPopup().setContent(displayName);
                } else {
                    userMarkers[uid] = L.marker(latLng).addTo(liveMap)
                        .bindPopup(displayName)
                        .openPopup();
                }
            });
            // Optional: remove markers for users who are no longer sharing
            const currentUids = snapshot.docs.map(d => d.id);
            Object.keys(userMarkers).forEach(uid => {
                if (!currentUids.includes(uid)) {
                    liveMap.removeLayer(userMarkers[uid]);
                    delete userMarkers[uid];
                }
            });
        });
    }

    async function toggleLocationSharing() {
        console.log("LOG: toggleLocationSharing called.");
        const btn = $('#toggle-location-sharing-btn');
        const status = $('#location-status');
        if (watchingLocation) {
            console.log("LOG: Stopping location sharing.");
            navigator.geolocation.clearWatch(watchId);
            watchingLocation = false;
            watchId = null;
            btn.innerHTML = '<i class="fa-solid fa-tower-broadcast mr-2"></i>×”×¤×¢×œ ×©×™×ª×•×£ ××™×§×•×';
            btn.classList.remove('bg-red-600', 'hover:bg-red-700');
            status.textContent = '×©×™×ª×•×£ ××™×§×•× ×›×‘×•×™.';
            if (currentUserId) {
                const userLocationDocRef = doc(locationsColRef, currentUserId);
                await deleteDoc(userLocationDocRef);
            }
        } else {
            console.log("LOG: Starting location sharing.");
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(updateLocationInFirestore, (error) => {
                    console.error("ERROR: Error getting location:", error);
                    showAlert("×©×’×™××ª ××™×§×•×", "×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ××™×§×•××š. ×•×“× ×©××™×©×¨×ª ×”×¨×©××•×ª ××™×§×•× ×œ×“×¤×“×¤×Ÿ.");
                }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
                watchingLocation = true;
                btn.innerHTML = '<i class="fa-solid fa-stop-circle mr-2"></i>×”×¤×¡×§ ×©×™×ª×•×£ ××™×§×•×';
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                status.textContent = '××©×ª×£ ××™×§×•×...';
            } else {
                showAlert("×œ× × ×ª××š", "×”×“×¤×“×¤×Ÿ ×©×œ×š ××™× ×• ×ª×•××š ×‘×©×™×ª×•×£ ××™×§×•×.");
            }
        }
    }
    
    // --- FIX 1 & 2: REWRITTEN JOURNAL FUNCTIONS ---
    async function addJournalEntry(dayId, text) {
        console.log(`LOG: addJournalEntry called for day ${dayId}`);
        if (!tripDocRef) {
            console.error("ERROR: tripDocRef is not initialized. Cannot add journal entry.");
            return;
        }
        const newEntry = {
            id: Date.now().toString(),
            text: text,
            timestamp: new Date()
        };
        await updateDoc(tripDocRef, {
            [`journal.${dayId}`]: arrayUnion(newEntry)
        });
    }

    async function removeJournalEntry(dayId, entryId) {
        console.log(`LOG: removeJournalEntry called for entry ${entryId} in day ${dayId}`);
        if (!isFirebaseConnected) {
            showAlert('××™×Ÿ ×—×™×‘×•×¨', '×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×›×¢×ª. ×× × ×”××ª×Ÿ ×œ×¡× ×›×¨×•×Ÿ ××œ× ×¢× ×”×©×¨×ª.');
            return;
        }
        if (!tripDocRef) {
             console.error("ERROR: tripDocRef is not initialized. Cannot remove journal entry.");
            return;
        }
        
        const journalForDay = localTripData.journal?.[dayId] || [];
        
        // This is the critical part: Firestore's arrayRemove needs the *exact* object to remove.
        // We find the object in our local data based on the unique ID.
        const entryToRemove = journalForDay.find(e => e.id === entryId);

        if (entryToRemove) {
             console.log("LOG: Found entry to remove locally, attempting to remove from Firestore.");
            await updateDoc(tripDocRef, {
                [`journal.${dayId}`]: arrayRemove(entryToRemove)
            });
        } else {
            console.error("ERROR: Could not find journal entry to remove. This might happen if the data is not yet synced.");
        }
    }

    function renderJournal(dayId, entries = []) {
        console.log(`LOG: renderJournal called for day ${dayId}`);
        const getTimestampDate = (ts) => {
            if (!ts) return new Date();
            if (typeof ts.toDate === 'function') return ts.toDate(); 
            if (ts.seconds) return new Date(ts.seconds * 1000); 
            return new Date(); 
        };

        const validEntries = Array.isArray(entries) ? entries : [];
        const entriesHtml = validEntries
            .sort((a, b) => getTimestampDate(b.timestamp).getTime() - getTimestampDate(a.timestamp).getTime())
            .map(entry => {
                const dateString = getTimestampDate(entry.timestamp).toLocaleString('he-IL', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                return `
                <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg relative group">
                    <p class="text-sm whitespace-pre-wrap">${entry.text}</p>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${dateString}</div>
                    <button class="absolute top-2 left-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="window.removeJournalEntry('${dayId}', '${entry.id}')">
                        <i class="fa-solid fa-trash-alt fa-xs"></i>
                    </button>
                </div>`;
        }).join('');

        return `<div class="mt-6 border-t pt-4">
            <h4 class="font-bold text-lg mb-2">×™×•××Ÿ ××¡×¢</h4>
            <div id="journal-entries-${dayId}" class="space-y-3 mb-3">${entriesHtml}</div>
            <form id="journal-form-${dayId}" class="flex gap-2">
                <input type="text" id="journal-text-${dayId}" placeholder="×”×•×¡×£ ×—×•×•×™×” ××”×™×•×..." class="w-full p-2 rounded-lg border">
                <button type="submit" class="btn btn-primary">×©×œ×—</button>
            </form>
        </div>`;
    }
// ==========================================================
// ×”×ª×—×œ×”: ×§×•×“ ××ª×•×§×Ÿ ×•××©×•×¤×¨ ×œ×ª×¨×’×•× ×§×•×œ×™
// ==========================================================
const recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let speechRecognizer = null;
let isRecognizing = false;
let activeVoiceButton = null;

if (recognition) {
    speechRecognizer = new recognition();
    speechRecognizer.continuous = false;
    speechRecognizer.interimResults = false;

    speechRecognizer.onstart = () => {
        isRecognizing = true;
        if (activeVoiceButton) {
            activeVoiceButton.innerHTML = '<i class="fa-solid fa-microphone-lines fa-beat"></i> ××§×©×™×‘...';
            activeVoiceButton.classList.add('text-red-500');
        }
        $('#translation-result-container').innerHTML = '<span>××§×©×™×‘...</span>';
    };

    speechRecognizer.onend = () => {
        isRecognizing = false;
        if (activeVoiceButton) {
            const originalText = activeVoiceButton.id.includes('he') ? '<i class="fa-solid fa-microphone"></i> ×“×‘×¨ ×‘×¢×‘×¨×™×ª' : '<i class="fa-solid fa-microphone"></i> Parla Italiano';
            activeVoiceButton.innerHTML = originalText;
            activeVoiceButton.classList.remove('text-red-500');
            activeVoiceButton = null;
        }
    };

    speechRecognizer.onerror = (event) => {
        console.error("Speech recognition error", event.error);
        $('#translation-result-container').innerHTML = `<span class="text-red-500">×©×’×™××” ×‘×–×™×”×•×™ ×”×“×™×‘×•×¨: ${event.error}</span>`;
    };

    speechRecognizer.onresult = async (event) => {
        const spokenText = event.results[0][0].transcript;
        const sourceLang = speechRecognizer.lang;
        console.log(`Speech recognized in ${sourceLang}: ${spokenText}`);

        let sourceLangFull, targetLangFull, targetLangCode;

        if (sourceLang === 'he-IL') {
            sourceLangFull = 'Hebrew';
            targetLangFull = 'Italian';
            targetLangCode = 'it-IT';
        } else { // 'it-IT'
            sourceLangFull = 'Italian';
            targetLangFull = 'Hebrew';
            targetLangCode = 'he-IL';
        }

        $('#dictionary-input').value = spokenText;

        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ××ª×¨×’×...`;

        // Prompt ××©×•×¤×¨ ×›×“×™ ×œ×”×‘×˜×™×— ×ª×¨×’×•× ×•×œ× ×ª×¢×ª×™×§
        const prompt = `Translate the meaning of the following word/phrase from ${sourceLangFull} to ${targetLangFull}. Provide ONLY the single, most common translated word/phrase, with no additional formatting or explanations. Word/phrase to translate: "${spokenText}"`;
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        let translatedText = await callGemini(payload, prompt, false);
        translatedText = translatedText.replace(/[\*\_`\.]/g, '').trim();

        // ×ª×™×§×•×Ÿ: ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×”×”×©××¢×”
        resultContainer.innerHTML = `<span>${translatedText}</span> <button onclick="window.speakText('${translatedText.replace(/'/g, "\\'")}', '${targetLangCode}')" class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;

        // ×‘×•× ×•×¡: ×”×•×¡×¤×ª ×”×ª×¨×’×•× ×œ×”×™×¡×˜×•×¨×™×”, ×‘×“×™×•×§ ×›××• ×‘×ª×¨×’×•× ×˜×§×¡×˜ ×¨×’×™×œ
        translationHistory.unshift({ sourceText: spokenText, translatedText: translatedText });
        if (translationHistory.length > 5) translationHistory.pop();
        localStorage.setItem('milanTripTranslationHistory', JSON.stringify(translationHistory));
        renderTranslationHistory();
    };

} else {
    console.warn("Web Speech API is not supported in this browser.");
}
// ==========================================================
// ×¡×•×£: ×§×•×“ ××ª×•×§×Ÿ ×•××©×•×¤×¨ ×œ×ª×¨×’×•× ×§×•×œ×™
// ==========================================================

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("LOG: DOMContentLoaded event fired. Initializing app.");
        // --- Expose functions to window for onclick attributes ---
        window.handleTransportChange = handleTransportChange;
        window.removeActivity = removeActivity;
        window.moveActivity = moveActivity;
        window.toggleChecklistItem = toggleChecklistItem;
        window.removeChecklistItem = removeChecklistItem;
        window.removeJournalEntry = removeJournalEntry;
        window.removeExpense = removeExpense;
        window.removeDocument = removeDocument;
        window.removeImage = removeImage;
        window.findUtility = findUtility;
        
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('LOG: Service Worker registered with scope:', registration.scope);
                    }).catch(error => {
                        console.log('ERROR: Service Worker registration failed:', error);
                    });
            });
        }
        
        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyB80v2xdhebJqhjyruJ5Ta0eyhJiq7DsI8",
          authDomain: "trip-to-milan.firebaseapp.com",
          projectId: "trip-to-milan",
          storageBucket: "trip-to-milan.firebasestorage.app",
          messagingSenderId: "305191186184",
          appId: "1:305191186184:web:fff1488b64a06942dfc6bd",
          measurementId: "G-P17LYZJ2H0"
        };
        
        console.log("LOG: Initializing Firebase app.");
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        enableIndexedDbPersistence(db).catch((err) => {
            console.warn(`WARN: Firestore persistence failed. Code: ${err.code}`);
        });

        // --- Caching and Sharing Logic ---
        let tripId = window.location.hash.substring(1);
        if (!tripId) {
            tripId = Math.random().toString(36).substring(2, 12);
            window.location.hash = tripId;
            console.log(`LOG: No tripId in hash, generated new one: ${tripId}`);
        } else {
            console.log(`LOG: Found tripId in hash: ${tripId}`);
        }
        $('#user-name-input').value = localStorage.getItem('userName') || '';

        const cachedData = localStorage.getItem(`tripData_${tripId}`);
        if (cachedData) {
            console.log("LOG: Found cached data in localStorage. Rendering from cache.");
            try {
                localTripData = JSON.parse(cachedData);
                // Initial render from cache for faster perceived load
                renderAllPlans(localTripData.plan);
                renderSuggestions(localTripData.suggestions);
                renderKosher();
                renderChecklist(localTripData.checklist);
                renderBudget(localTripData);
                renderDocuments(localTripData.documents);
                renderGallery(localTripData.gallery);
                if (localTripData.theme === 'dark') document.documentElement.classList.add('dark');
            } catch(e) {
                 console.error("ERROR: Failed to parse cached data.", e);
                 localStorage.removeItem(`tripData_${tripId}`);
            }
        }

        console.log("LOG: Signing in anonymously.");
        signInAnonymously(auth).catch((error) => {
            console.error("ERROR: Anonymous sign-in failed:", error);
            showAlert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×œ-Firebase", `×”×”×ª×—×‘×¨×•×ª ×”×× ×•× ×™××™×ª × ×›×©×œ×”. ×™×™×ª×›×Ÿ ×©×¦×¨×™×š ×œ××©×¨ ××ª ×”×“×•××™×™×Ÿ ×”×–×” ×‘×”×’×“×¨×•×ª ×”-Authentication.\n\n${error.message}`);
        });
        
        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log(`LOG: Auth state changed. User signed in with UID: ${user.uid}`);
            currentUserId = user.uid;
            tripDocRef = doc(db, "milantrip", tripId);
            locationsColRef = collection(db, "milantrip", tripId, "locations");
            
            initLiveMap();
            listenForLocationUpdates();

            console.log("LOG: Setting up Firestore onSnapshot listener.");
            const unsubscribe = onSnapshot(tripDocRef, async (docSnap) => {
                console.log("LOG: Firestore onSnapshot listener triggered.");
                if (!isFirebaseConnected) {
                    const statusIcon = $('#sync-status i');
                    const statusText = $('#sync-status span');
                    statusIcon.classList.remove('text-yellow-500');
                    statusIcon.classList.add('text-green-500');
                    statusText.textContent = '××—×•×‘×¨';
                    isFirebaseConnected = true;
                    console.log("LOG: Firebase connection established.");
                }

                if (docSnap.exists()) {
                    console.log("LOG: Document exists in Firestore. Updating local data.");
                    localTripData = docSnap.data();
                    localStorage.setItem(`tripData_${tripId}`, JSON.stringify(localTripData));
                } else {
                    console.log("LOG: Document does not exist in Firestore. Creating new one.");
                    localTripData = getInitialTripData();
                    await setDoc(tripDocRef, localTripData);
                }
                
                console.log("LOG: Re-rendering all components with fresh data from Firestore.");
                renderAllPlans(localTripData.plan);
                renderSuggestions(localTripData.suggestions);
                renderKosher();
                renderChecklist(localTripData.checklist);
                renderBudget(localTripData);
                renderDocuments(localTripData.documents);
                renderGallery(localTripData.gallery);
                if (localTripData.theme === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
            }, (error) => {
                console.error("ERROR: Firestore snapshot error:", error);
                const statusIcon = $('#sync-status i');
                const statusText = $('#sync-status span');
                statusIcon.classList.remove('text-green-500', 'text-yellow-500');
                statusIcon.classList.add('text-red-500');
                statusText.textContent = '×‘×¢×™×™×ª ×¡× ×›×¨×•×Ÿ';
                showAlert('×‘×¢×™×™×ª ×¡× ×›×¨×•×Ÿ', `×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ××¡×“ ×”× ×ª×•× ×™×.\n×•×“× ×©×—×•×§×™ ×”××‘×˜×—×” (Rules) ×‘-Firestore ××•×’×“×¨×™× ×›×¨××•×™.\n\n${error.message}`);
            });
          } else {
              console.log("LOG: Auth state changed. User is signed out.");
          }
        });

        console.log("LOG: Performing initial renders and fetches.");
        renderOverview();
        renderKosherFilters();
        fetchWeather();
        fetchExchangeRate();
        showDailyTip();
        fetchSafetyWarnings();
        renderTranslationHistory();
        // ×”×¤×¢×œ×ª ×”×©×¢×•× ×™×
updateClocks();
setInterval(updateClocks, 1000);
        const ctx = document.getElementById('transportChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: { labels: ['× ×¡×™×¢×” ×‘×•×“×“×ª', '×›×¨×˜×™×¡ ×™×•××™', '×›×¨×˜×™×¡ ×œ-3 ×™××™×'], datasets: [{ label: '×¢×œ×•×ª ×‘××™×¨×•', data: [2.20, 7.60, 15.50], backgroundColor: ['rgba(59,130,246,.6)','rgba(37,99,235,.6)','rgba(29,78,216,.6)'], borderColor: ['#3b82f6','#2563eb','#1d4ed8'], borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });

        // --- Event Listeners ---
        console.log("LOG: Adding main event listeners.");
        $('#theme-toggle').addEventListener('click', async () => {
            console.log("LOG: Theme toggle clicked.");
            const isDark = document.documentElement.classList.toggle('dark');
            if(tripDocRef && isFirebaseConnected) await updateDoc(tripDocRef, { theme: isDark ? 'dark' : 'light' });
        });
        
        $('#show-tip-btn').addEventListener('click', openTipModal);
        $('#create-summary-btn').addEventListener('click', generateTripSummary);
        $('#refresh-warnings-btn').addEventListener('click', fetchSafetyWarnings);
        $('#find-nearby-btn').addEventListener('click', findNearby);

        
        // --- Plan actions ---
        $('#collapse-all').addEventListener('click', () => {
            console.log("LOG: Collapse all button clicked.");
            $$('#plan-content-container details').forEach(d => d.removeAttribute('open'));
        });
        $('#expand-all').addEventListener('click', () => {
            console.log("LOG: Expand all button clicked.");
            $$('#plan-content-container details').forEach(d => d.setAttribute('open', true));
        });
        $('#print-btn').addEventListener('click', () => {
            console.log("LOG: Print button clicked.");
            window.print();
        });

        $('#add-checklist-item-form').addEventListener('submit', async e => {
            e.preventDefault();
            console.log("LOG: Add checklist item form submitted.");
            if(!isFirebaseConnected) { showAlert('×©×’×™××ª ×¡× ×›×¨×•×Ÿ', '××™×Ÿ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.'); return; }
            const text = $('#new-item-text').value.trim(); if (!text) return;
            let categoryName = $('#new-category-text').value.trim() || $('#category-select').value;
            if (!categoryName) { showAlert('×©×’×™××”', '×™×© ×œ×‘×—×•×¨ ××• ×œ×™×¦×•×¨ ×§×˜×’×•×¨×™×”.'); return; }
            
            let updatedChecklist = [...(localTripData.checklist || [])];
            let category = updatedChecklist.find(c => c.category === categoryName);
            if (!category) {
                category = { id: 'cat' + Date.now(), category: categoryName, items: [] };
                updatedChecklist.push(category);
            }
            category.items.push({ id: `c${Date.now()}`, text, done: false });
            
            await updateDoc(tripDocRef, { checklist: updatedChecklist });
            e.target.reset();
        });
        
        $('#expense-form').addEventListener('submit', async e => {
            e.preventDefault();
            console.log("LOG: Add expense form submitted.");
            if(!isFirebaseConnected) { showAlert('×©×’×™××ª ×¡× ×›×¨×•×Ÿ', '××™×Ÿ ×—×™×‘×•×¨ ×œ××¡×“ ×”× ×ª×•× ×™×. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.'); return; }
            const desc = $('#expense-desc').value.trim();
            const amount = parseFloat($('#expense-amount').value);
            const category = $('#expense-category').value;
            if(desc && !isNaN(amount) && category) {
                const newExpense = {id: Date.now().toString(), desc, amount, category};
                await updateDoc(tripDocRef, { expenses: arrayUnion(newExpense) });
                e.target.reset();
            } else {
                showAlert('×©×’×™××”', '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×›×•×œ×œ ×§×˜×’×•×¨×™×”.');
            }
        });
        
        $('#total-budget').addEventListener('input', async e => {
            if(!isFirebaseConnected) { return; }
            const newTotalBudget = parseFloat(e.target.value) || 0;
            console.log(`LOG: Total budget input changed to: ${newTotalBudget}`);
            if (tripDocRef) await updateDoc(tripDocRef, { totalBudget: newTotalBudget });
        });

        $('#include-estimated-costs').addEventListener('change', async (e) => {
            if(!isFirebaseConnected) { return; }
            const include = e.target.checked;
            console.log(`LOG: 'Include estimated costs' checkbox changed to: ${include}`);
            await updateDoc(tripDocRef, { 'settings.includeEstimatedCostsInBalance': include });
        });

        $('#calculate-estimated-btn').addEventListener('click', () => {
            console.log("LOG: Calculate estimated costs button clicked.");
            const estimatedCosts = calculateEstimatedCosts(localTripData.plan);
            showAlert('×¢×œ×•×ª ××©×•×¢×¨×ª', `×”×¢×œ×•×ª ×”××©×•×¢×¨×ª ×œ××˜×¨×§×¦×™×•×ª ×‘×ª×•×›× ×™×ª ×¢×‘×•×¨ ×–×•×’ ×”×™×: â‚¬${estimatedCosts.toFixed(2)}.\n×”×¡×›×•× ××•×¤×™×¢ ×’× ×‘×¡×™×›×•× ×”×ª×§×¦×™×‘.`);
        });
        
        $('#toggle-suggestions-btn').addEventListener('click', e => {
            const container = $('#suggestions-container');
            const isHidden = container.classList.toggle('hidden');
            console.log(`LOG: Toggle suggestions button clicked. Now ${isHidden ? 'hidden' : 'visible'}.`);
            e.target.textContent = isHidden ? '×”×¦×’ ×”×¦×¢×•×ª × ×•×¡×¤×•×ª' : '×”×¡×ª×¨ ×”×¦×¢×•×ª';
        });

        $('#toggle-kosher-btn').addEventListener('click', e => {
            const container = $('#kosher-container');
            const isHidden = container.classList.toggle('hidden');
             console.log(`LOG: Toggle kosher button clicked. Now ${isHidden ? 'hidden' : 'visible'}.`);
            e.target.textContent = isHidden ? '×”×¦×’ ××“×¨×™×š ×›×©×¨×•×ª' : '×”×¡×ª×¨ ××“×¨×™×š ×›×©×¨×•×ª';
        });

        $('#eur-input').addEventListener('input', e => {
            const eur = parseFloat(e.target.value);
            $('#ils-input').value = isNaN(eur) ? '' : (eur * eurToIlsRate).toFixed(2);
        });
        $('#ils-input').addEventListener('input', e => {
            const ils = parseFloat(e.target.value);
            $('#eur-input').value = isNaN(ils) ? '' : (ils / eurToIlsRate).toFixed(2);
        });
        
        $('#dictionary-form').addEventListener('submit', async e => { e.preventDefault(); const input = $('#dictionary-input').value.trim(); if (input) await translateText(input); });
        
        $('#swap-lang-btn').addEventListener('click', () => {
            console.log("LOG: Swap language button clicked.");
            const inputEl = $('#dictionary-input'); const labelEl = $('#lang-direction-label');
            currentLang = (currentLang === 'he-it') ? 'it-he' : 'he-it';
            inputEl.placeholder = (currentLang === 'he-it') ? '×”×§×œ×“ ××™×œ×”...' : 'Scrivi una parola...';
            labelEl.innerHTML = (currentLang === 'he-it') ? '×¢×‘×¨×™×ª <i class="fa-solid fa-arrow-right-long"></i> ××™×˜×œ×§×™×ª' : '××™×˜×œ×§×™×ª <i class="fa-solid fa-arrow-right-long"></i> ×¢×‘×¨×™×ª';
            inputEl.value = '';
        });
        
        $('#translate-upload-btn').addEventListener('click', () => { console.log("LOG: Translate from image upload button clicked."); $('#image-translate-upload').click(); });
        $('#translate-camera-btn').addEventListener('click', startCamera);
        $('#camera-close-btn').addEventListener('click', stopCamera);
        $('#capture-btn').addEventListener('click', captureFrameAndTranslate);

        $('#image-translate-upload').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            console.log(`LOG: Image selected for translation: ${file.name}`);
            const reader = new FileReader();
            reader.onload = (event) => { const base64String = event.target.result.split(',')[1]; translateImage(base64String, file.type); };
            reader.readAsDataURL(file);
        });
        
        $('#document-upload-btn').addEventListener('click', () => { console.log("LOG: Document upload button clicked."); $('#document-upload').click(); });
        $('#image-upload-btn').addEventListener('click', () => { console.log("LOG: Gallery image upload button clicked."); $('#image-upload').click(); });
        
        $('#alert-modal-close').addEventListener('click', () => $('#alert-modal').classList.remove('flex'));
        $('#alert-modal-copy-btn').addEventListener('click', (e) => {
            const textToCopy = $('#alert-modal-body').textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                e.target.textContent = '×”×•×¢×ª×§!';
                setTimeout(() => { e.target.innerHTML = '<i class="fa-solid fa-copy mr-1"></i>×”×¢×ª×§'; }, 2000);
            }).catch(err => console.error('Copy failed', err));
        });

        $('#daily-tip-close').addEventListener('click', () => $('#daily-tip-modal').classList.remove('flex'));

        $('#document-upload').addEventListener('change', (e) => {
            for (const file of e.target.files) {
                console.log(`LOG: Document selected for upload: ${file.name}`);
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const newDoc = { id: Date.now().toString(), name: file.name, dataUrl: ev.target.result };
                    if (tripDocRef) await updateDoc(tripDocRef, { documents: arrayUnion(newDoc) });
                };
                reader.readAsDataURL(file);
            }
        });

        $('#image-upload').addEventListener('change', (e) => {
            for (const file of e.target.files) {
                 console.log(`LOG: Gallery image selected for upload: ${file.name}`);
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const newImg = { id: Date.now().toString(), name: file.name, dataUrl: ev.target.result };
                    if (tripDocRef) await updateDoc(tripDocRef, { gallery: arrayUnion(newImg) });
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Gemini Modal Logic
        const geminiModal = $('#gemini-modal');
        $('#gemini-btn').addEventListener('click', () => { console.log("LOG: Gemini button clicked."); geminiModal.classList.add('flex'); });
        $('#gemini-close-btn').addEventListener('click', () => {
            geminiModal.classList.remove('flex');
            $('#gemini-response').innerHTML = '';
        });

        $$('#gemini-tabs-nav .tab-button').forEach(b => b.addEventListener('click', (e) => {
            console.log(`LOG: Gemini tab clicked: ${e.currentTarget.dataset.content}`);
            $$('#gemini-tabs-nav .tab-button').forEach(btn => btn.classList.remove('tab-active'));
            e.currentTarget.classList.add('tab-active');
            $$('#gemini-modal .content-section').forEach(s => s.classList.remove('active'));
            $(`#${e.currentTarget.dataset.content}`).classList.add('active');
            $('#gemini-response').innerHTML = '';
        }));
        
        $('#get-smart-advice-btn').addEventListener('click', getSmartAdvice);
        $('#gemini-submit-btn').addEventListener('click', askGeneralGemini);

        $('#share-btn').addEventListener('click', () => {
            console.log("LOG: Share button clicked.");
            const url = window.location.href;
            const shareData = {
                title: '×ª×•×›× ×™×ª ×”×˜×™×•×œ ×©×œ× ×• ×œ××™×œ×× ×•',
                text: '×”×¦×˜×¨×¤×• ×œ×ª×›× ×•×Ÿ ×”×˜×™×•×œ ×©×œ× ×•!',
                url: url
            };
            if (navigator.share) {
                navigator.share(shareData).catch((err) => {
                    if (err.name !== 'AbortError') {
                        console.error('Share failed:', err);
                        showAlert('×©×’×™××ª ×©×™×ª×•×£', `×œ× × ×™×ª×Ÿ ×”×™×” ×œ×©×ª×£: ${err.message}`);
                    }
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    showAlert('×”×§×™×©×•×¨ ×”×•×¢×ª×§!', '×œ× × ××¦××” ××¤×©×¨×•×ª ×©×™×ª×•×£. ×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—.');
                }).catch(err => {
                     showAlert('×©×’×™××”', '×œ× × ×™×ª×Ÿ ×”×™×” ×œ×”×¢×ª×™×§ ××ª ×”×§×™×©×•×¨.');
                });
            }
        });
// ==========================================================
// ×”×ª×—×œ×”: ×××–×™× ×™× ×œ××™×¨×•×¢×™× ×©×œ ×›×¤×ª×•×¨×™ ×”×ª×¨×’×•× ×”×§×•×œ×™
// ==========================================================
const heBtn = $('#voice-translate-he-btn');
const itBtn = $('#voice-translate-it-btn');

function startRecognition(lang) {
    if (isRecognizing) {
        speechRecognizer.stop();
    }
    speechRecognizer.lang = lang;
    speechRecognizer.start();
}

if (speechRecognizer) {
    heBtn.addEventListener('click', () => startRecognition('he-IL'));
    itBtn.addEventListener('click', () => startRecognition('it-IT'));
} else {
    if (heBtn) { heBtn.disabled = true; heBtn.innerHTML = '×œ× × ×ª××š'; }
    if (itBtn) { itBtn.disabled = true; itBtn.innerHTML = '×œ× × ×ª××š'; }
}
// ==========================================================
// ×¡×•×£: ×××–×™× ×™× ×œ××™×¨×•×¢×™× ×©×œ ×›×¤×ª×•×¨×™ ×”×ª×¨×’×•× ×”×§×•×œ×™
// ==========================================================
        
        // Live Location Listener
        $('#toggle-location-sharing-btn').addEventListener('click', toggleLocationSharing);
        $('#user-name-input').addEventListener('input', (e) => {
            localStorage.setItem('userName', e.target.value);
        });
        
        // --- FIX 3: CORRECTED Floating Nav Logic ---
        const planBtn = $('#floating-plan-btn');
        const toolsBtn = $('#floating-tools-btn');
        const planSubmenu = $('#plan-submenu');
        const toolsSubmenu = $('#tools-submenu');

        function toggleSubmenu(submenuToToggle, buttonToHighlight) {
            const isAlreadyActive = submenuToToggle && submenuToToggle.classList.contains('active');
            console.log(`LOG: toggleSubmenu called. Is already active: ${isAlreadyActive}`);
            
            // First, hide all submenus and remove highlights
            $$('.floating-submenu').forEach(sm => sm.classList.remove('active'));
            $$('#floating-nav button, #floating-nav a').forEach(btn => btn.classList.remove('text-brand-600'));
            
            // If we are opening a new/different submenu, show it
            if (submenuToToggle && !isAlreadyActive) {
                console.log("LOG: Opening a new submenu.");
                submenuToToggle.classList.add('active');
                buttonToHighlight.classList.add('text-brand-600');
            } else {
                 console.log("LOG: Closing the active submenu or no action needed.");
            }
        }
        planBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSubmenu(planSubmenu, planBtn); });
        toolsBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSubmenu(toolsSubmenu, toolsBtn); });

        document.addEventListener('click', (e) => { 
            if (!e.target.closest('#floating-nav-container')) {
                toggleSubmenu(null, null);
            }
        });
        $$('#plan-submenu a, #tools-submenu a').forEach(link => link.addEventListener('click', () => toggleSubmenu(null, null)));

        window.addEventListener('beforeunload', (event) => {
            console.log("LOG: beforeunload event. Cleaning up location sharing if active.");
            if (watchingLocation && currentUserId) {
                const userLocationDocRef = doc(locationsColRef, currentUserId);
                deleteDoc(userLocationDocRef);
            }
        });
    });
  </script>

</body>
</html>
