<!DOCTYPE html>
<html lang="he" dir="rtl" class="scroll-smooth dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>תוכנית טיול שיתופית למילאנו (v1.1)</title>
  <meta name="description" content="דשבורד אינטראקטיבי ושיתופי לתכנון חופשה במילאנו: לוז יומי, מפות, מזג אוויר, סיכום טיול חכם, מעקב תקציב ועוד." />
  <meta name="theme-color" content="#1d4ed8">
  <link rel="manifest" href="manifest.json">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Assistant', 'ui-sans-serif', 'system-ui'],
          },
          colors: {
            brand: {
              50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
              400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a'
            }
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- LeafletJS for Live Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
.image-viewer-modal .modal {
    /* הופכים את המסגרת לשקופה כדי לתת תחושה של חלל פתוח */
    background: transparent;
    box-shadow: none;
    padding: 0;
    width: 100%;
    height: 100%;
    display: flex; /* ממקמים את התמונה שבתוכה בדיוק במרכז */
    align-items: center;
    justify-content: center;
}
.image-viewer-modal img {
    /* מגבילים את גודל התמונה לגודל המסך פחות שוליים קטנים */
    max-width: 95vw;
    max-height: 95vh;
    width: auto;
    height: auto;
    border-radius: 0.5rem; /* עיגול פינות עדין */
    /* הצללה דרמטית כדי להקפיץ את התמונה מהרקע הכהה */
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}
.image-viewer-close-btn {
    /* ממקמים את הכפתור בפינה הימנית העליונה של כל המסך, לא של המסגרת */
    position: fixed;
    top: 20px;
    right: 20px;
    /* הגדלה ועיצוב מחדש לנראות מקסימלית */
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    background-color: rgba(0, 0, 0, 0.6);
    border: 2px solid white;
    color: white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    z-index: 110;
    transition: transform 0.2s ease, background-color 0.2s ease;
}
.image-viewer-close-btn:hover {
    transform: scale(1.1);
    background-color: rgba(0, 0, 0, 0.9);
}
    :root{
      --bg: #f9fafb; --fg:#1f2937; --card:#ffffff; --muted:#6b7280;
      --btn:#1d4ed8; --btn-h:#1e40af; --brd:#e5e7eb;
      --header-bg: rgba(255,255,255,0.9);
      --heading-font: 'Assistant', sans-serif;
    }
    .dark{
      --bg:#0b1220; --fg:#e5e7eb; --card:#0f172a; --muted:#9ca3af;
      --btn:#2563eb; --btn-h:#1d4ed8; --brd:#1f2937;
      --header-bg: rgba(11,18,32,0.8);
    }
    
   html { 
  scroll-padding-top: 80px; 
  overflow-x: hidden; /* Add this line */
}
body {
  background:var(--bg); 
  color:var(--fg); 
  font-family:Assistant,ui-sans-serif,system-ui; 
  overflow-x: hidden; /* Keep this line */
}
    h2, h3 { font-family: var(--heading-font); }
    #site-header { background-color: var(--header-bg); }
    
    .dark input, .dark textarea, .dark select {
        background-color: #1f2937;
        color: var(--fg);
        border-color: #374151;
    }
    .dark input::placeholder, .dark textarea::placeholder { color: var(--muted); }

    .btn{display:inline-flex;align-items:center;gap:.5rem;justify-content:center;border-radius:0.75rem;
         font-weight:600;font-size:.9rem;padding:.5rem .85rem;transition:.2s;border:1px solid transparent}
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .btn-primary{background:var(--btn);color:#fff;}
    .btn-primary:hover{background:var(--btn-h)}
    .btn-ghost{background:transparent;border-color:var(--brd);color:var(--fg);}
    .btn-ghost:hover{background:rgba(0,0,0,.04)}
    .dark .btn-ghost:hover{background:rgba(255,255,255,.06)}
    .tab-button{padding:.5rem .75rem;font-weight:700;border-bottom:2px solid transparent;border-radius:.5rem .5rem 0 0;}
    .tab-active{color:var(--btn);background:var(--card);border-color:var(--btn)}
    #gemini-tabs-nav .tab-button { border-color: transparent; }
    #gemini-tabs-nav .tab-active { border-color: var(--btn); color: var(--btn); }

    .content-section{display:none}
    .content-section.active{display:block}
    .thumb{width:100%;height:14rem;object-fit:cover}
    .logo{width:56px;height:56px;border-radius:.75rem;border:1px solid var(--brd);object-fit:contain;background:#fff}
    
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 100;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-backdrop.flex { display: flex; }
    .modal {
        background: var(--card); color: var(--fg);
        width: 90%; max-width: 500px; border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        display: flex; flex-direction: column; max-height: 80vh;
    }
    .image-carousel { position: relative; flex-shrink:0; width:100%; }
    @media (min-width: 768px) { .image-carousel { width: 33.333333%; } }
    .image-carousel button {
      position: absolute; top: 50%; transform: translateY(-50%);
      background-color: rgba(0,0,0,0.4); color: white;
      border: none; border-radius: 50%;
      width: 32px; height: 32px;
      cursor: pointer; transition: background-color 0.2s;
    }
    .image-carousel button:hover { background-color: rgba(0,0,0,0.7); }
    .carousel-prev { left: 8px; }
    .carousel-next { right: 8px; }

    .countdown-number { font-size: 1.5rem; line-height: 1; }
    .countdown-label { font-size: 0.75rem; }

    .floating-submenu {
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
    }
    .floating-submenu.active {
        transform: translateY(0);
        opacity: 1;
        pointer-events: auto;
    }

    .delete-btn {
        position: absolute; top: 4px; right: 4px;
        background-color: rgba(239, 68, 68, 0.7);
        color: white; border-radius: 50%;
        width: 24px; height: 24px;
        border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.2s; z-index: 10;
    }
    .relative:hover .delete-btn { opacity: 1; }
    
    #live-location-map {
        height: 350px;
        border-radius: 1rem;
        border: 1px solid var(--brd);
    }
    .leaflet-popup-content-wrapper {
        background: var(--card);
        color: var(--fg);
    }
    .leaflet-popup-tip {
        background: var(--card);
    }


    @media print {
        body * { visibility: hidden; }
        #plan, #plan * { visibility: visible; }
        #plan { position: absolute; left: 0; top: 0; width: 100%; }
        #plan details { page-break-inside: avoid; }
        #plan summary, .nav-link, .btn, header, main > section:not(#plan), #floating-nav-container, .day-actions { display: none !important; }
        #plan details[open] > div { display: block !important; }
        #plan-content-container { padding: 0 !important; }
        h2 { font-size: 24px !important; }
        #plan details {
            box-shadow: none !important;
            border: 1px solid #ccc;
            margin-bottom: 1rem;
        }
    }


    @media (max-width: 767px) {
      body { padding-bottom: 70px; } /* Add padding for floating nav */
      .responsive-table thead { display: none; }
      .responsive-table tr {
        display: block; margin-bottom: 1rem; border: 1px solid var(--brd);
        border-radius: 0.75rem; padding: 1rem;
      }
      .responsive-table td {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.5rem 0; border-bottom: 1px solid var(--brd);
      }
      .responsive-table td:last-child { border-bottom: none; }
      .responsive-table td::before {
        content: attr(data-label); font-weight: 600; margin-right: 1rem;
      }
      .responsive-table .logo-cell { justify-content: center; padding-bottom: 1rem; }
      .responsive-table .logo-cell::before { display: none; }
    }
    .modal-backdrop.flex { animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="dark:bg-gray-900 dark:text-gray-100">

  <header id="site-header" class="backdrop-blur shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <span class="inline-block w-2 h-6 rounded bg-brand-700"></span>
          <h1 class="text-xl md:text-2xl font-bold text-brand-800 dark:text-brand-300">החופשה במילאנו</h1>
        </div>
        <div class="hidden md:flex md:items-center md:gap-1 flex-wrap">
          <a href="#overview" class="nav-link px-3 py-2 rounded-md text-sm font-medium">סקירה</a>
          <a href="#plan" class="nav-link px-3 py-2 rounded-md text-sm font-medium">תוכנית</a>
          <a href="#suggestions" class="nav-link px-3 py-2 rounded-md text-sm font-medium">הצעות</a>
          <a href="#kosher" class="nav-link px-3 py-2 rounded-md text-sm font-medium">אוכל כשר</a>
          <a href="#tools" class="nav-link px-3 py-2 rounded-md text-sm font-medium">כלים</a>
        </div>
        <div class="flex items-center gap-2">
            <div id="sync-status" class="text-xs text-gray-400 flex items-center gap-2" title="מתחבר...">
                <i class="fa-solid fa-cloud text-yellow-500"></i> <span class="hidden sm:inline">מתחבר...</span>
            </div>
            <button id="theme-toggle" class="btn btn-ghost" aria-label="החלפת מצב"><i class="fa-solid fa-sun"></i></button>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto p-4 sm:p-6 lg:p-8">

    <section id="overview" class="my-12 scroll-mt-24">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">סקירה כללית</h2>
        <div class="flex gap-2 flex-wrap justify-center">
            <button id="share-btn" class="btn btn-primary"><i class="fa-solid fa-share-alt mr-2"></i>שתף תוכנית</button>
            <button id="gemini-btn" class="btn btn-primary"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>שאל את Gemini</button>
            <button id="show-tip-btn" class="btn btn-primary"><i class="fa-solid fa-lightbulb mr-2"></i>טיפ יומי</button>
            <button id="create-summary-btn" class="btn btn-primary bg-green-600 hover:bg-green-700"><i class="fa-solid fa-book-open mr-2"></i>צור סיכום טיול</button>
          <button id="lookup-site-btn" class="btn btn-primary bg-purple-600 hover:bg-purple-700"><i class="fa-solid fa-magnifying-glass mr-2"></i>זיהוי אתרים</button>
        </div>
      </div>
      <div id="overview-cards" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>

    <section id="plan" class="my-12 scroll-mt-24">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">תוכנית הטיול היומית</h2>
        <div class="flex gap-2 flex-wrap justify-center day-actions">
            <button id="collapse-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-compress mr-1"></i>כווץ הכל</button>
            <button id="expand-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-expand mr-1"></i>הרחב הכל</button>
            <button id="print-btn" class="btn btn-ghost btn-sm"><i class="fa-solid fa-print mr-1"></i>הדפס תוכנית</button>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-950 p-2 sm:p-6 rounded-2xl shadow-lg">
        <div class="border-b border-gray-200 dark:border-gray-800 mb-6">
          <nav class="-mb-px flex flex-wrap justify-center gap-2 sm:gap-4" aria-label="Tabs" id="day-tabs-nav"></nav>
        </div>
        <div id="plan-content-container"></div>
      </div>
    </section>
    
    <section id="suggestions" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">מאגר הצעות</h2>
        <div class="text-center">
            <button id="toggle-suggestions-btn" class="btn btn-primary">הצג הצעות נוספות</button>
        </div>
        <div id="suggestions-container" class="hidden mt-6 bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
            <div id="suggestions-table-container"></div>
        </div>
    </section>

    <section id="kosher" class="my-12 scroll-mt-24">
      <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">המדריך הקולינרי הכשר</h2>
      <div class="text-center">
        <button id="toggle-kosher-btn" class="btn btn-primary">הצג מדריך כשרות</button>
      </div>
      <div id="kosher-container" class="hidden mt-6">
        <div class="bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
          <p id="kosher-subtitle" class="text-center mb-6 text-gray-600 dark:text-gray-400">ריכוז האפשרויות בשכונות Bande Nere ו‑Washington.</p>
          <div id="kosher-filters" class="mb-4 flex flex-wrap gap-2 justify-center"></div>
          <div id="kosher-results"></div>
        </div>
      </div>
    </section>

    <section id="tools" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">כלים ומידע שימושי</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div id="scrapbook-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg md:col-span-2 lg:col-span-3">
    <details>
        <summary class="text-xl font-bold cursor-pointer"><i class="fa-solid fa-book-open mr-2"></i>סקראפבוק - יומן הטיול</summary>
        <div id="scrapbook-container" class="space-y-8 mt-4 pt-4 border-t dark:border-gray-700">
            <p class="text-center">טוען יומן...</p>
        </div>
    </details>
</div>
<div id="metro-helper-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg md:col-span-2 lg:col-span-3">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-train-subway mr-2"></i>עוזר קווי מטרו</h3>
    <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-1">
            <p class="text-sm mb-2">לחץ על קו כדי לראות תחנות ואטרקציות מרכזיות:</p>
            <div id="metro-lines-container" class="flex flex-wrap gap-2">
                </div>
            <div id="metro-line-info" class="mt-4 text-sm space-y-2 max-h-60 overflow-y-auto pr-2">
                </div>
        </div>
<div class="md:col-span-2">
    <img id="metro-map-image" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/Milano_-_mappa_rete_metropolitana_%28schematica%29.svg/1200px-Milano_-_mappa_rete_metropolitana_%28schematica%29.svg.png" alt="מפת המטרו של מילאנו" class="rounded-lg w-full h-full object-contain cursor-pointer transition-transform hover:scale-105">
</div>
    </div>
</div>
          
          <div id="pass-calculator-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg md:col-span-2 lg:col-span-3">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-calculator mr-2"></i>מחשבון כדאיות Pass</h3>
    <div class="grid md:grid-cols-2 gap-6">
        <div>
            <h4 class="font-semibold mb-2">1. סמנו את האטרקציות שאתם מתכננים לבקר:</h4>
            <div id="pass-attractions-list" class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2">
                </div>
        </div>
        <div>
            <h4 class="font-semibold mb-2">2. השוואה וחישוב:</h4>
            <div id="pass-options-info" class="text-sm space-y-2">
                </div>
            <button id="calculate-pass-btn" class="btn btn-primary w-full mt-4">חשב כדאיות</button>
            <div id="pass-result" class="mt-4 p-3 bg-gray-50 dark:bg-gray-900 rounded-lg text-center font-bold">
                ...
            </div>
        </div>
    </div>
</div>

<div id="utility-finder-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-map-signs mr-2"></i>חיפוש מהיר (פתוח עכשיו)</h3>
    <div class="grid grid-cols-1 gap-2">
      <button class="btn btn-primary" onclick="findNearbyAttractions()">
    <i class="fa-solid fa-star w-4"></i> מצא אטרקציות קרובות
</button>
        <button class="btn btn-primary" onclick="window.findUtility('bagno pubblico', 'שירותים ציבוריים')">
            <i class="fa-solid fa-restroom w-4"></i> מצא שירותים
        </button>
        <button class="btn btn-primary" onclick="window.findUtility('farmacia', 'בית מרקחת')">
            <i class="fa-solid fa-pills w-4"></i> מצא בית מרקחת
        </button>
        <button class="btn btn-primary" onclick="window.findUtility('bancomat', 'כספומט')">
            <i class="fa-solid fa-money-bill w-4"></i> מצא כספומט
        </button>
        <button class="btn btn-primary" onclick="window.findUtility('bureau de change', 'המרת כספים')">
            <i class="fa-solid fa-coins w-4"></i> מצא Change
        </button>
      <button class="btn btn-primary" onclick="window.findUtility('sinagoga', 'בתי כנסת')">
           <i class="fa-solid fa-synagogue w-4"></i> מצא בית כנסת
        </button>
    </div>
</div>
            
            <div id="live-location-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-3">
                <h3 class="text-xl font-bold mb-3 text-center"><i class="fa-solid fa-map-location-dot mr-2"></i>מפת מיקום חי</h3>
                <div class="text-center">
                    <p class="mb-4">כל משתמש עם הלינק יכול לראות את מיקום המטיילים בזמן אמת. רק המטיילים צריכים ללחוץ על "שתף מיקום".</p>
                    <div id="live-location-map" class="mb-4"></div>
                    <div class="flex flex-col sm:flex-row gap-2 justify-center">
                        <button id="toggle-location-sharing-btn" class="btn btn-primary"><i class="fa-solid fa-tower-broadcast mr-2"></i>הפעל שיתוף מיקום</button>
                        <input type="text" id="user-name-input" placeholder="הכנס את שמך (לזיהוי)" class="p-2 rounded-lg border text-center">
                    </div>
                    <p id="location-status" class="text-xs text-gray-500 mt-2 h-4"></p>
                </div>
            </div>

            <div id="transport-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-3">
                <h3 class="text-xl font-bold mb-3 text-center"><i class="fa-solid fa-bus mr-2"></i>מדריך תחבורה</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-bold text-brand-800 dark:text-brand-200 mb-3">תחבורה ציבורית (ATM)</h4>
                        <ul class="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                            <li><span class="font-semibold">איפה קונים:</span> במכונות האוטומטיות בכל תחנת מטרו, בקיוסקים (Tabacchi), או באפליקציה הרשמית <a href="https://www.atm.it/it/Pagine/default.aspx" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">ATM Milano</a>.</li>
                            <li><span class="font-semibold">המלצה:</span> כרטיס ל-3 ימים (72 שעות) הוא המשתלם ביותר לשהייה שלכם.</li>
                        </ul>
                        <div class="relative h-[280px] mt-4">
                            <canvas id="transportChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-brand-800 dark:text-brand-200 mb-3">רכבות לטיולי יום</h4>
                        <ul class="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                            <li><span class="font-semibold">איפה קונים:</span> מומלץ להזמין מראש באינטרנט כדי להבטיח מקום ומחיר טוב.</li>
                            <li><span class="font-semibold">אתרים מומלצים:</span> <a href="https://www.trenitalia.com/en.html" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">Trenitalia</a> (רשמי) או <a href="https://www.italotreno.it/en" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">Italo</a> (פרטי).</li>
                            <li><span class="font-semibold">תחנת יציאה:</span> כל הרכבות לאגמים יוצאות מתחנת **Milano Centrale**.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
<div id="weather-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-1">
    <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-cloud-sun mr-2"></i>מזג אוויר</h3>
    <div id="weather-forecast" class="space-y-3"><p>טוען תחזית...</p></div>
    <div id="weather-alert-box" class="mt-4"></div>
    <div id="weather-attire-recommendation" class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700 text-sm text-center"></div>
</div>
            <div id="budget-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 md:col-span-2 lg:col-span-2">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-euro-sign mr-2"></i>מעקב תקציב</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow">
                    <div>
                        <div class="mb-4">
                            <label for="total-budget" class="block text-sm font-medium">תקציב כללי (€)</label>
                            <input type="number" id="total-budget" placeholder="הזן תקציב" class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white">
                        </div>
                        <form id="expense-form" class="space-y-3">
                            <input type="text" id="expense-desc" placeholder="תיאור ההוצאה" class="w-full p-2 rounded-xl border" required>
                             <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="expense-amount" placeholder="סכום (€)" class="w-full p-2 rounded-xl border" required>
                                <select id="expense-category" class="w-full p-2 rounded-xl border" required>
                                    <option value="">קטגוריה</option>
                                    <option value="אוכל">אוכל</option>
                                    <option value="קניות">קניות</option>
                                    <option value="תחבורה">תחבורה</option>
                                    <option value="אטרקציות">אטרקציות</option>
                                    <option value="אחר">אחר</option>
                                </select>
                             </div>
                            <button type="submit" class="btn btn-primary w-full">הוסף הוצאה</button>
              <button type="button" id="scan-receipt-btn" class="btn btn-ghost w-full">
    <i class="fa-solid fa-camera mr-2"></i>סרוק קבלה
</button>

               
                            
                        </form>
                        <button id="calculate-estimated-btn" class="btn btn-primary w-full mt-2"><i class="fa-solid fa-calculator mr-2"></i>חשב עלות משוערת לאטרקציות</button>
                        <div id="expense-list" class="text-sm my-4 flex-grow max-h-40 overflow-y-auto pr-2"></div>
                        <div class="mt-auto pt-3 border-t font-bold space-y-2 text-md">
                             <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span>עלות משוערת</span>
                                    <input type="checkbox" id="include-estimated-costs" checked class="w-4 h-4 rounded text-brand-600 focus:ring-brand-500" title="כלול בחישוב היתרה">
                                </div>
                                <span id="estimated-costs">0.00€</span>
                            </div>
                            <div class="flex justify-between text-red-600 dark:text-red-400"><span>הוצאות בפועל:</span> <span id="total-expenses">0.00</span>€</div>
                            <div class="flex justify-between text-green-600 dark:text-green-400"><span>יתרה:</span> <span id="budget-balance">0.00</span>€</div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center min-h-[200px]">
                        <div class="relative w-full h-full max-h-[250px]">
                            <canvas id="budget-chart"></canvas>
                        </div>
                        <div id="budget-chart-placeholder" class="hidden text-center text-gray-400 text-sm">הוסיפו הוצאות כדי לראות את התרשים</div>
                        <div id="budget-chart-legend" class="mt-4 w-full space-y-1"></div>
                    </div>
                </div>
            </div>
            <div id="checklist-section-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-1">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-list-check mr-2"></i>צ'ק-ליסט</h3>
                <form id="add-checklist-item-form" class="grid sm:grid-cols-3 gap-2 mb-4">
                    <input type="text" id="new-item-text" placeholder="פריט חדש" class="sm:col-span-2 w-full p-2 rounded-lg border" required>
                    <select id="category-select" class="w-full p-2 rounded-lg border"></select>
                    <input type="text" id="new-category-text" placeholder="קטגוריה חדשה (אופציונלי)" class="sm:col-span-2 w-full p-2 rounded-lg border">
                    <button type="submit" class="btn btn-primary">הוסף</button>
                </form>
                <div id="checklist-container" class="space-y-4 max-h-96 overflow-y-auto"></div>
            </div>
            <div id="translator-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 lg:col-span-1">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-language mr-2"></i>תרגומון</h3>
                <div class="text-xs text-center text-gray-500 mb-2" id="lang-direction-label">עברית <i class="fa-solid fa-arrow-right-long"></i> איטלקית</div>
<form id="dictionary-form" class="grid grid-cols-6 gap-2 mb-3">
   <input type="text" id="dictionary-input" placeholder="הקלד לתרגום..." class="col-span-6 w-full p-2 rounded-lg border">

   <button type="button" id="swap-lang-btn" class="btn btn-ghost" title="החלף שפות"><i class="fa-solid fa-exchange-alt"></i></button>
   <button type="submit" class="btn btn-primary col-span-2">תרגם</button>
   <button type="button" id="translate-upload-btn" class="btn btn-ghost" title="העלה תמונה"><i class="fa-solid fa-file-image"></i></button>
   <button type="button" id="translate-camera-btn" class="btn btn-ghost" title="פתח מצלמה"><i class="fa-solid fa-camera"></i></button>
   <input type="file" id="image-translate-upload" class="hidden" accept="image/*">

   <button type="button" id="voice-translate-he-btn" class="btn btn-primary col-span-3"><i class="fa-solid fa-microphone"></i> דבר בעברית</button>
   <button type="button" id="voice-translate-it-btn" class="btn btn-ghost col-span-3"><i class="fa-solid fa-microphone"></i> Parla Italiano</button>
</form>
                <div id="translation-result-container" class="mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[60px] text-center flex items-center justify-center gap-3">
                   <span class="text-gray-500">התרגום יופיע כאן...</span>
                </div>
                <div id="translation-history" class="mt-3 pt-3 border-t text-xs space-y-2 max-h-24 overflow-y-auto">
                    <div class="text-center text-gray-400">היסטוריית תרגומים</div>
                </div>
           </div>
           <div id="converter-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 lg:col-span-1">
             <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-right-left mr-2"></i>ממיר מטבע</h3>
             <div class="space-y-4">
                 <div>
                     <label for="eur-input" class="block text-sm font-medium">אירו (€)</label>
                     <input type="number" id="eur-input" placeholder="EUR" class="w-full p-2 mt-1 rounded-xl border">
                 </div>
                 <div>
                     <label for="ils-input" class="block text-sm font-medium">שקל (₪)</label>
                     <input type="number" id="ils-input" placeholder="ILS" class="w-full p-2 mt-1 rounded-xl border">
                 </div>
             </div>
             <p id="exchange-rate-display" class="text-xs text-gray-500 mt-auto pt-3 text-center">טוען שער חליפין...</p>
         </div>
         <div id="safety-warnings-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 lg:col-span-1">
            <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-triangle-exclamation mr-2"></i>אזהרות ועדכונים</h3>
            <div id="safety-warnings-content" class="text-sm space-y-2 max-h-48 overflow-y-auto">טוען מידע...</div>
            <button id="refresh-warnings-btn" class="btn btn-ghost w-full mt-3">רענן מידע</button>
        </div>
        <div id="customs-info-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24 md:col-span-2 lg:col-span-2">
            <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-suitcase-rolling mr-2"></i>מידע על מכס וכבודה</h3>
            <div class="text-sm space-y-2">
                <p><b><i class="fa-solid fa-right-to-bracket"></i> מכס בכניסה לאיטליה (לנוסע, מחוץ לאיחוד):</b></p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 text-xs">
                    <li><b>טבק:</b> 200 סיגריות או 50 סיגרים.</li>
                    <li><b>אלכוהול:</b> 1 ליטר של אלכוהול מעל 22% (כמו וודקה) או 2 ליטר יין.</li>
                    <li><b>מזומן:</b> יש להצהיר על סכומים מעל 10,000 אירו.</li>
                    <li><b>איסורים:</b> אסור להכניס מוצרי בשר וחלב מחוץ לאיחוד האירופי.</li>
                </ul>
                <p class="mt-3"><b><i class="fa-solid fa-left-to-bracket"></i> מכס בחזרה לישראל (לנוסע):</b></p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 text-xs">
                    <li><b>פטור אישי:</b> ניתן להכניס מתנות וחפצים אישיים בשווי כולל של עד 200$ לנוסע (מעל גיל שנתיים).</li>
                    <li><b>מזון:</b> עד 3 ק"ג מזון, בתנאי שכל פריט לא שוקל יותר מ-1 ק"ג.</li>
                    <li><b>טבק (מעל גיל 18):</b> 200 סיגריות (פֿקט אחד) או 250 גרם מוצרי טבק אחרים.</li>
                    <li><b>אלכוהול (מעל גיל 18):</b> 1 ליטר של משקה חריף ו-2 ליטר יין.</li>
                    <li><b>חשוב:</b> הפטור הוא אישי ולא ניתן לצבירה למספר אנשים.</li>
                </ul>
            </div>
        </div>
        </div>
    </section>
    <section id="documents-and-gallery" class="my-12 scroll-mt-24 grid md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4"><i class="fa-solid fa-folder-open mr-2"></i>תיק מסמכים</h2>
            <input type="file" id="document-upload" multiple class="hidden">
            <button id="document-upload-btn" class="btn btn-primary w-full mb-4">העלה מסמכים</button>
            <div id="documents-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
        <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4"><i class="fa-solid fa-images mr-2"></i>גלריית תמונות</h2>
            <input type="file" id="image-upload" multiple accept="image/*" class="hidden">
            <button id="image-upload-btn" class="btn btn-primary w-full mb-4">העלה תמונות</button>
            <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
    </section>

  </main>
  <div id="lightbox-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[200]" style="display: none;">
    <img id="lightbox-image" src="" alt="תצוגה מוגדלת" class="max-w-[95vw] max-h-[95vh] rounded-lg shadow-2xl">
    <button id="lightbox-close-btn" class="absolute top-5 right-5 text-white text-4xl font-bold">&times;</button>
</div>

  
 
  <div id="select-day-for-upload-modal" class="modal-backdrop">
  <div class="modal">
    	  <div class="p-4 border-b"><h3 class="text-lg font-bold">לאיזה יום לשייך את התמונות?</h3></div>
      <div id="modal-upload-day-options" class="p-4 grid grid-cols-2 gap-3"></div>
      <div class="p-4 border-t flex justify-end">
          <button onclick="window.closeModal()" class="btn btn-ghost">ביטול</button>
      </div>
  </div>
</div>
  <div id="add-to-day-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b"><h3 class="text-lg font-bold">הוסף פעילות ליום...</h3></div>
        <div id="modal-day-options" class="p-4 grid grid-cols-2 gap-3"></div>
        <div class="p-4 border-t flex justify-end">
            <button onclick="window.closeModal()" class="btn btn-ghost">ביטול</button>
        </div>
    </div>
  </div>
  <div id="camera-modal" class="modal-backdrop">
    <div class="modal">
      <div class="p-4 border-b flex justify-between items-center"><h3 id="camera-title" class="text-lg font-bold">תרגם מתמונה</h3><button id="camera-close-btn" class="text-2xl">×</button></div>
        <div class="p-4 flex-grow relative">
            <video id="camera-feed" class="w-full h-full object-cover bg-black rounded-lg" playsinline autoplay></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
        </div>
<div class="p-4 border-t flex justify-center items-center gap-4">
    <button id="torch-btn" class="btn btn-ghost w-16 h-16 rounded-full text-2xl"><i class="fa-solid fa-lightbulb"></i></button>
    <button id="capture-btn" class="btn btn-primary w-16 h-16 rounded-full"><i class="fa-solid fa-camera fa-2x"></i></button>
    <div class="w-16"></div> </div>
    </div>
  </div>
  <div id="alert-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 id="alert-modal-title" class="text-lg font-bold"></h3>
            <button id="alert-modal-copy-btn" class="btn btn-ghost btn-sm hidden"><i class="fa-solid fa-copy mr-1"></i>העתק</button>
        </div>
        <div id="alert-modal-body" class="p-6 whitespace-pre-wrap max-h-[50vh] overflow-y-auto"></div>
        <div class="p-4 border-t flex justify-end">
            <button id="alert-modal-close" class="btn btn-primary">הבנתי</button>
        </div>
    </div>
  </div>
    <div id="gemini-modal" class="modal-backdrop">
      <div class="modal">
          <div class="p-4 border-b flex justify-between items-center">
              <h3 class="text-lg font-bold">שאל את Gemini</h3>
              <button id="gemini-close-btn" class="text-2xl">×</button>
          </div>
          <div class="border-b border-gray-200 dark:border-gray-800">
              <nav class="-mb-px flex justify-center gap-4" id="gemini-tabs-nav">
                  <button class="py-3 px-4 font-semibold border-b-2 tab-button tab-active" data-content="gemini-advisor-tab">יועץ חכם</button>
                  <button class="py-3 px-4 font-semibold border-b-2 tab-button" data-content="gemini-free-text-tab">שאלה חופשית</button>
              </nav>
          </div>
          <div class="p-4 flex-grow overflow-y-auto flex flex-col">
              <!-- Smart Advisor Tab -->
              <div id="gemini-advisor-tab" class="content-section active text-center">
                  <p class="mb-4">קבל המלצה חכמה ומותאמת אישית על סמך השעה, מזג האוויר והתקציב שלך.</p>
                  <button id="get-smart-advice-btn" class="btn btn-primary"><i class="fa-solid fa-robot mr-2"></i>תן לי המלצה חכמה</button>
              </div>
              <!-- Free Text Tab -->
              <div id="gemini-free-text-tab" class="content-section">
                  <label for="gemini-prompt" class="block text-sm font-medium mb-1">הכנס שאלה או בקשה:</label>
                  <textarea id="gemini-prompt" class="w-full p-2 rounded-lg border bg-white dark:bg-gray-800" rows="3" placeholder="לדוגמה: תן לי 3 הצעות למסעדות רומנטיות בערב באזור נבילי."></textarea>
                   <button id="gemini-submit-btn" class="btn btn-primary w-full mt-2">שלח שאילתה</button>
              </div>
              
              <div class="mt-4 flex-grow flex flex-col">
                  <h4 class="font-semibold mb-2">תשובה:</h4>
                  <div id="gemini-response" class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[100px] whitespace-pre-wrap flex-grow"></div>
              </div>
          </div>
      </div>
    </div>
<div id="daily-tip-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex items-center gap-3">
            <i class="fa-solid fa-lightbulb text-yellow-400 text-xl"></i>
            <h3 class="text-lg font-bold">טיפ היום למטייל</h3>
        </div>
        <div id="daily-tip-body" class="p-6 whitespace-pre-wrap">טוען טיפ...</div>
        <div class="p-4 border-t flex justify-end">
            <button id="daily-tip-close" class="btn btn-primary">הבנתי</button>
        </div>
    </div>
</div>



  <div id="floating-nav-container" class="md:hidden fixed bottom-0 left-0 right-0 z-40">
      <div id="plan-submenu" class="floating-submenu fixed bottom-[68px] left-0 right-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm p-2 rounded-t-2xl">
          <div class="grid grid-cols-3 gap-2 text-center text-sm" id="plan-submenu-links">
              </div>
      </div>
<div id="tools-submenu" class="floating-submenu fixed bottom-[68px] left-0 right-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm p-2 rounded-t-2xl">
    <div id="tools-submenu-links" class="grid grid-cols-3 gap-2 text-center text-sm">
        </div>
</div>

      <nav id="floating-nav" class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.1)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.3)] rounded-t-2xl">
        <div class="flex justify-around p-2 text-gray-700 dark:text-gray-300">
            <button id="floating-plan-btn" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-calendar-days fa-lg"></i>
                <span>תוכנית</span>
            </button>
            <a href="#kosher" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-utensils fa-lg"></i>
                <span>כשר</span>
            </a>
            <button id="floating-tools-btn" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-screwdriver-wrench fa-lg"></i>
                <span>כלים</span>
            </button>
        </div>
      </nav>
  </div>
  
  
  <script type="module">
    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc, enableIndexedDbPersistence, collection, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    console.log("LOG: Script start. Initializing variables.");

    // --- UTILS ---
    const $ = (s, p = document) => p.querySelector(s);
    const $$ = (s, p = document) => Array.from(p.querySelectorAll(s));
    function toRad(x) { return x * Math.PI / 180; }
    function haversineKm(lat1, lon1, lat2, lon2) {
        if ([lat1, lon1, lat2, lon2].some(c => c === undefined || c === null)) return NaN;
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.asin(Math.sqrt(a));
        return R * c;
    }
    function formatKm(km) { return isNaN(km) ? '' : `(${km.toFixed(1)} ק״מ)`; }
    function minsForMode(km, mode) {
        if (isNaN(km)) return 15;
        if (mode === 'walk') { const speed = 4.5; return Math.max(8, (km / speed) * 60); }
        if (mode === 'drive') { const speed = 25; return Math.max(10, (km / speed) * 60); }
        if (mode === 'transit') { const speed = 18; return Math.max(12, (km / speed) * 60 + 5); }
        return 15;
    }
    function formatMin(min) {
        min = Math.round(min);
        if (min < 60) return `${min} דק׳`;
        const h = Math.floor(min / 60);
        const m = min % 60;
        return `${h} ש׳ ${m} ד׳`;
    }
    const fmtBold = (t) => (t || '').replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-brand-700 dark:text-brand-300">$1<\/strong>');
    const placeholderLogoUrl = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&size=80&rounded=true&background=e0e7ff&color=1e40af`;
    
    // --- Global State ---
    let db, auth, tripDocRef, locationsColRef;

    let cameraMode = 'translate';
    let activeVideoTrack = null;
    let localTripData = {}; 
    let budgetChartInstance = null;
    let cameraStream = null;
    let eurToIlsRate = 4.0; // Default rate
    let userCoords = null;
    let isFirebaseConnected = false;
    let translationHistory = JSON.parse(localStorage.getItem('milanTripTranslationHistory')) || [];
    let lastWeatherAPIData = null;
    
    // --- Live Location State ---
    let liveMap;
    let userMarkers = {};
    let watchingLocation = false;
    let watchId = null;
    let currentUserId = null;

    console.log("LOG: Global variables and utility functions defined.");


    // --- DATA ---
const attractions = {
  duomo: { name: "קתדרלת הדואומו", isOutdoor: false, type: 'attraction', address: "Piazza del Duomo, 20122 Milano MI, Italy", img: ["https://www.metailimbaolam.com/wp-content/uploads/2020/08/italy-4695974_1280.jpg"], tickets: "https://www.duomomilano.it/en/buy-tickets/", description: "הלב הפועם של מילאנו. חובה לעלות לגג לתצפית פנורמית מרהיבה על העיר.", coords: { lat: 45.4642, lon: 9.1916 }, cost: 20, hours: "כל יום, 09:00-19:00" },
  sanSiro: { name: "אצטדיון סן סירו", isOutdoor: true, type: 'attraction', address: "Piazzale Angelo Moratti, 20151 Milano MI, Italy", img: ["https://www.xn--4dbkkmip.co.il/wp-content/uploads/2023/05/san-siro-1940307_640.jpg"], tickets: "https://www.sansirostadium.com/en/stadium-tour-museum/", description: "מקדש הכדורגל של מילאנו, ביתן של מילאן ואינטר. מומלץ לסיור או למשחק.", coords: { lat: 45.4780, lon: 9.1238 }, cost: 30, hours: "כל יום, 09:30-19:00 (משתנה בימי משחק)" },
  primark: { name: "פריימארק (ויה טורינו)", isOutdoor: false, type: 'attraction', address: "Via Torino, 45, 20123 Milano MI, Italy", img: ["https://www.shutterstock.com/image-photo/bordeaux-france-07-17-2024-260nw-2490117199.jpg"], info: "https://www.primark.com/it/it/negozi/milano/via-torino-45", description: "סניף הדגל הענק של רשת האופנה הזולה, גן עדן לחובבי קניות.", coords: { lat: 45.4623, lon: 9.1861 }, cost: 0, hours: "כל יום, 09:00-22:00" },
  como: { name: "אגם קומו", isOutdoor: true, type: 'attraction', address: "Varenna, Italy", img: ["https://www.travelonatimebudget.co.uk/wp-content/uploads/2022/01/varenna-dp.jpg"], description: "יום טיול לאחד האגמים היפים באיטליה. מומלץ לבקר בעיירות וארנה ובלאג'יו.", coords: { lat: 45.9863, lon: 9.2816 }, cost: 15 },
  berninaExpress: { name: "רכבת ברנינה לאלפים", isOutdoor: true, type: 'attraction', address: "Tirano, Italy", img: ["https://www.civitatis.com/f/italia/milan/excursion-alpes-suizos-589x392.jpg"], tickets: "https://www.rhb.ch/en/panoramic-trains/bernina-express", description: "נסיעת רכבת פנורמית מדהימה דרך הרי האלפים לשוויץ.", coords: { lat: 46.4914, lon: 9.8683 }, cost: 70 },
  laScala: { name: "תיאטרון לה סקאלה", isOutdoor: false, type: 'attraction', address: "Via Filodrammatici, 2, 20121 Milano MI, Italy", img: ["https://www.hakolal.co.il/wp-content/uploads/2018/10/La-Scala.jpg"], tickets: "https://www.teatroallascala.org/en/visit-the-theatre/visits-to-the-theatre-museum.html", description: "אחד מבתי האופרה המפורסמים והיוקרתיים בעולם.", coords: { lat: 45.4675, lon: 9.1895 }, cost: 12, hours: "מוזיאון: כל יום, 09:30-17:30" },
  navigli: { name: "רובע נבילי", isOutdoor: true, type: 'attraction', address: "Ripa di Porta Ticinese, 20143 Milano MI, Italy", description: "רובע התעלות המקסים של מילאנו, מושלם לשעות הערב ולאפרטיבו.", coords: { lat: 45.4516, lon: 9.1758 }, cost: 0 },
  ilCentro: { name: "קניון Il Centro", isOutdoor: false, type: 'attraction', address: "Via Giuseppe Eugenio Luraghi, 11, 20044 Arese MI, Italy", img: ["https://architizer-prod.imgix.net/media/1461230538313IL_CENTRO_WEB_RESOLUTION_231.JPG"], info: "https://centroilcentro.it/en/", description: "אחד הקניונים הגדולים באירופה, נמצא מחוץ למילאנו.", coords: { lat: 45.5654, lon: 9.0681 }, cost: 5, hours: "כל יום, 09:00-22:00" },
  sforza: { name: "טירת ספורצה", isOutdoor: false, type: 'attraction', address: "Piazza Castello, 20121 Milano MI, Italy", description: "מצודה היסטורית מרשימה עם מספר מוזיאונים וגלריות אמנות.", info: "https://www.milanocastello.it/en", coords: { lat: 45.4705, lon: 9.1794 }, cost: 5, hours: "חצרות: 07:00-19:30. מוזיאונים: ג'-א', 10:00-17:30 (סגור בב')" },
  brera: { name: "רובע בררה", isOutdoor: true, type: 'attraction', address: "Via Brera, Milan", description: "רובע האמנים הציורי, 'המונמרטר של מילאנו', מלא בסמטאות, גלריות ובוטיקים.", coords: { lat: 45.4719, lon: 9.1879 }, cost: 0 },
  lastSupper: { name: "הסעודה האחרונה", isOutdoor: false, type: 'attraction', address: "Piazza di Santa Maria delle Grazie, 2, 20123 Milano MI", description: "ציור הקיר המפורסם של דה וינצ'י. חובה להזמין כרטיסים חודשים מראש!", tickets: "https://cenacolovinciano.org/en/", coords: { lat: 45.4659, lon: 9.1711 }, cost: 15, hours: "ג'-א', 08:15-19:00 (סגור בב')" },
  galleriaVittorio: { name: "גלריית ויטוריו אמנואלה", isOutdoor: false, type: 'attraction', address: "Piazza del Duomo, 20123 Milano MI", description: "מרכז קניות היסטורי ומפואר, עם חנויות יוקרה, בתי קפה ומסעדות.", coords: { lat: 45.4656, lon: 9.1905 }, cost: 0, hours: "פתוח 24/7 (חנויות בשעות משתנות)" },
  pinacotecaBrera: { name: "פינקוטקה די בררה", isOutdoor: false, type: 'attraction', address: "Via Brera, 28, 20121 Milano MI", description: "אחד מגלריות האמנות החשובות באיטליה, מתמקד בציור איטלקי.", tickets: "https://pinacotecabrera.org/en/visit/", coords: { lat: 45.4719, lon: 9.1879 }, cost: 15, hours: "ג'-א', 08:30-19:15 (סגור בב')" },
  parcoSempione: { name: "פארק סמפיונה", isOutdoor: true, type: 'attraction', address: "Piazza Sempione, 20154 Milano MI", description: "הריאה הירוקה הגדולה של מילאנו, מאחורי טירת ספורצה. מושלם להירגעות.", coords: { lat: 45.4723, lon: 9.1725 }, cost: 0, hours: "כל יום, 06:30-21:00" },
  quadrilateroDellaModa: { name: "מרובע האופנה", isOutdoor: true, type: 'attraction', address: "Via Monte Napoleone, 20121 Milano MI, Italy", description: "רובע הקניות היוקרתי של מילאנו, בית למותגי האופנה הגדולים בעולם.", coords: { lat: 45.4688, lon: 9.1950 }, cost: 0 },
  daVinciMuseum: { name: "מוזיאון המדע דה וינצ'י", isOutdoor: false, type: 'attraction', address: "Via San Vittore, 21, 20123 Milano MI, Italy", description: "מוזיאון המדע והטכנולוגיה הגדול באיטליה, מוקדש לדה וינצ'י כממציא.", tickets: "https://www.museoscienza.org/en/visit/tickets", coords: { lat: 45.4627, lon: 9.1715 }, cost: 10, hours: "ג'-ו' 09:30-17:00, ש'-א' 09:30-18:30 (סגור בב')" },
  boscoVerticale: { name: "בוסקו ורטיקלה", isOutdoor: true, type: 'attraction', address: "Via Gaetano de Castillia, 11, 20124 Milano MI", description: "צמד מגדלי מגורים חדשניים המכוסים באלפי עצים וצמחים. פלא ארכיטקטוני.", coords: { lat: 45.4855, lon: 9.1901 }, cost: 0 },
  cimiteroMonumentale: { name: "בית הקברות המונומנטלי", isOutdoor: true, type: 'attraction', address: "Piazzale Cimitero Monumentale, 20154 Milano MI", description: "בית קברות שהוא גם מוזיאון פתוח, עם פסלים ומבנים ארכיטקטוניים מרשימים.", coords: { lat: 45.485, lon: 9.178 }, cost: 0, hours: "ג'-א' 08:00-18:00 (סגור בב')" },
  museoNovecento: { name: "מוזיאון נובצ'נטו", isOutdoor: false, type: 'attraction', address: "Piazza del Duomo, 8, 20123 Milano MI", description: "מוזיאון לאמנות המאה ה-20 הממוקם בכיכר הדואומו, עם תצפית יפה על הקתדרלה.", tickets: "https://www.museodelnovecento.org/en/ biglietti-e-ingressi", coords: { lat: 45.463, lon: 9.190 }, cost: 10, hours: "ג'-א' 10:00-19:30 (סגור בב')" },
  santAmbrogio: { name: "בזיליקת סנט'אמברוג'ו", isOutdoor: false, type: 'attraction', address: "Piazza Sant'Ambrogio, 15, 20123 Milano MI", description: "אחת הכנסיות העתיקות והחשובות במילאנו, דוגמה מרהיבה לאדריכלות רומנסקית.", coords: { lat: 45.462, lon: 9.173 }, cost: 0 },
  sanMaurizio: { name: "כנסיית סן מאוריציו", isOutdoor: false, type: 'attraction', address: "Corso Magenta, 15, 20123 Milano MI", description: "מכונה 'הקפלה הסיסטינית של מילאנו' בזכות ציורי הקיר המדהימים שמכסים אותה לחלוטין.", tickets: "https://www.museoarcheologicomilano.it/en/collezioni/san-maurizio-al-monastero-maggiore", coords: { lat: 45.465, lon: 9.176 }, cost: 0, hours: "ג'-א' 10:00-17:30 (סגור בב')" },
  piazzaMercanti: { name: "פיאצה דיי מרקנטי", isOutdoor: true, type: 'attraction', address: "Piazza dei Mercanti, 20123 Milano MI", description: "כיכר ימי-ביניימית קסומה ונסתרת, דקות הליכה מהדואומו.", coords: { lat: 45.465, lon: 9.188 }, cost: 0 },
  leonardoVineyard: { name: "הכרם של לאונרדו", isOutdoor: true, type: 'attraction', address: "Corso Magenta, 65, 20123 Milano MI", description: "שחזור של הכרם שהיה שייך ללאונרדו דה וינצ'י, מול 'הסעודה האחרונה'.", tickets: "https://www.vignadileonardo.com/en/", coords: { lat: 45.466, lon: 9.170 }, cost: 10, hours: "ג'-א' 09:00-18:00 (סגור בב')" },
  piazzaGaeAulenti: { name: "פיאצה גאה אאולנטי", isOutdoor: true, type: 'attraction', address: "Piazza Gae Aulenti, 20124 Milano MI", description: "הלב הפועם של מילאנו המודרנית. כיכר עתידנית מוקפת גורדי שחקים.", coords: { lat: 45.483, lon: 9.191 }, cost: 0 },
  corsoComo: { name: "10 קורסו קומו", isOutdoor: false, type: 'attraction', address: "Corso Como, 10, 20154 Milano MI", description: "מתחם קונספט המשלב אופנה, עיצוב ואמנות. חווית קניות ובילוי ייחודית.", coords: { lat: 45.482, lon: 9.189 }, cost: 0 },
  triennale: { name: "מוזיאון העיצוב טריאנלה", isOutdoor: false, type: 'attraction', address: "Viale Emilio Alemagna, 6, 20121 Milano MI", description: "מוזיאון בינלאומי המוקדש לעיצוב, אדריכלות ואמנות חזותית בפארק סמפיונה.", tickets: "https://triennale.org/en/tickets", coords: { lat: 45.470, lon: 9.168 }, cost: 15, hours: "ג'-א' 11:00-20:00 (סגור בב')" },
  colonneSanLorenzo: { name: "עמודי סן לורנצו", isOutdoor: true, type: 'attraction', address: "Corso di Porta Ticinese, 39, 20123 Milano MI", description: "שרידים רומיים עתיקים שהפכו למקום מפגש פופולרי ותוסס בערב.", coords: { lat: 45.458, lon: 9.181 }, cost: 0 },
  qcTermemilano: { name: "QC Termemilano", isOutdoor: false, type: 'attraction', address: "Piazzale Medaglie D'Oro, 2, 20135 Milano MI", tickets: "https://www.qcterme.com/en/milano/qc-termemilano", description: "ספא ומרחצאות יוקרתיים בלב העיר, חוויה מושלמת של פינוק ורגיעה.", coords: { lat: 45.4523, lon: 9.2004 }, cost: 60, hours: "כל יום, 09:00-23:00" },
  interStore: { name: "חנות הדגל של אינטר", isOutdoor: false, type: 'attraction', address: "Galleria Passarella, 2, 20122 Milano MI", info: "https://store.inter.it/", description: "חנות הדגל הרשמית של קבוצת הכדורגל אינטר מילאנו, בלב אזור הקניות.", coords: { lat: 45.465, lon: 9.194 }, cost: 0, hours: "כל יום 10:00-19:30" },
  casaMilan: { name: "קאזה מילאן (מוזיאון וחנות)", isOutdoor: false, type: 'attraction', address: "Via Aldo Rossi, 8, 20149 Milano MI", tickets: "https://www.acmilan.com/en/club/casa-milan", description: "המטה הראשי של קבוצת מילאן, כולל מוזיאון מונדו מילאן, חנות רשמית ומסעדה.", coords: { lat: 45.489, lon: 9.155 }, cost: 15, hours: "כל יום 10:00-19:00" },
  torreBranca: { name: "מגדל בראנקה", isOutdoor: true, type: 'attraction', address: "Viale Luigi Camoens, 2, 20121 Milano MI", info: "http://www.museobranca.it/torre-branca-parco-sempione-milano/", description: "מגדל תצפית בפארק סמפיונה המציע נוף פנורמי מרהיב של מילאנו.", coords: { lat: 45.472, lon: 9.171 }, cost: 6, hours: "משתנה לפי עונה, בדקו באתר" },
  pinacotecaAmbrosiana: { name: "פינקוטקה אמברוזיאנה", isOutdoor: false, type: 'attraction', address: "Piazza Pio XI, 2, 20123 Milano MI", tickets: "https://www.ambrosiana.it/", description: "גלריית אמנות וספרייה היסטורית המכילה יצירות מופת של קאראווג'ו ודה וינצ'י.", coords: { lat: 45.464, lon: 9.186 }, cost: 15, hours: "ג'-א' 10:00-18:00 (סגור בב')" }
};
    
    const kosherData = {
      restaurants: [
        { name: "Denzel", type: 'dining', style: "בשרי", logo: "https://static.wixstatic.com/media/c6595a_0d9d7bb6473548d69681f09d18ff4247.png", address: "Via Giorgio Washington, 9, 20146 Milano MI", phone: "+390248519326", website: "https://www.denzel.it/", hours: "א'-ה' 12:00-15:00, 19:00-23:00; ו' 12:00-15:00", coords: { lat: 45.4654, lon: 9.1555 } },
        { name: "Ba'Ghetto", type: 'dining', style: "בשרי", address: "Via Sardegna, 45, 20146 Milano MI", phone: "+39024694643", website: "https://www.baghetto.com/en/", hours: "א'-ה' 12:00-15:00, 19:00-23:00; ו' 12:00-15:00", coords: { lat: 45.4665, lon: 9.1461 } },
        { name: "Re Salomone", type: 'dining', style: "בשרי", address: "Via Sardegna, 42, 20146 Milano MI", phone: "+39024694643", website: "https://www.resalomone.it/", hours: "א'-ה' 12:00-14:30, 19:00-23:00; ו' 12:00-14:30", coords: { lat: 45.4665, lon: 9.1458 } },
        { name: "La's Kebab", type: 'dining', style: "בשרי", address: "Viale Misurata, 19, 20146 Milano MI", phone: "+393288865576", website: "https://laskebab.eatbu.com/", hours: "א'-ה' 12:00-15:00, 18:00-23:00", coords: { lat: 45.4586, lon: 9.1517 } },
        { name: "Carmel", type: 'dining', style: "חלבי", address: "Viale S. Gimignano, 10, 20146 Milano MI", phone: "+3902416368", website: "https://carmelkosher.it/", hours: "א'-ה' 12:00-15:00, 19:00-22:30", coords: { lat: 45.4593, lon: 9.1328 } },
        { name: "MyKafe", type: 'dining', style: "חלבי", logo: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/11/a2/1f/a2/my-kafe.jpg", address: "Via Luigi Soderini, 44, 20146 Milano MI", phone: "+390238232748", website: "https://www.instagram.com/mykafe2020/", hours: "א'-ה' 07:30-19:30; ו' 07:30-16:00", coords: { lat: 45.4578, lon: 9.1337 } },
        { name: "Bet-El", type: 'dining', style: "חלבי", address: "Viale S. Gimignano, 2, 20146 Milano MI", phone: "+39024151336", website: "http://www.betelkosher.com/", hours: "א'-ה' 12:00-14:30, 19:00-22:30", coords: { lat: 45.4607, lon: 9.1352 } },
        { name: "Snubar", type: 'dining', style: "פלאפל/שווארמה", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQmYC-lcBrFV75_D371aWkrfk7yd1Qu3kEIcw&s", address: "Via Leone Tolstoi, 2, 20146 Milano MI", phone: "+39024236963", website: "https://www.snubar.it/it/", hours: "א'-ה' 12:00-22:00", coords: { lat: 45.4568, lon: 9.1565 } },
        { name: "Presto", type: 'dining', style: "טייק-אווי", address: "Via delle Forze Armate, 13, 20147 Milano MI", phone: "+39024045598", website: "https://www.presto-kosher.com/", hours: "א'-ה' 10:00-20:00; ו' 09:00-15:00", coords: { lat: 45.4667, lon: 9.1292 } },
      ],
      markets: [
        { name: "Kosher Paradise", type: 'dining', style: "מרכול", address: "Viale S. Gimignano, 13, 20146 Milano MI", phone: "+39024122855", website: "https://www.kosherparadise.it/", hours: "א'-ה' 09:00-19:30; ו' 09:00-15:00", coords: { lat: 45.4589, lon: 9.1325 } },
        { name: "Denzel's Sweet Bakery", type: 'dining', style: "מאפייה", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVt6hxH7niOmeBunCjNdpow7Y_PfseIBonPQ&s", address: "Via Soderini, 55, 20146 Milano MI", phone: "+39024125166", website: "https://www.denzel.it/bakery", hours: "א'-ה' 07:30-19:30; ו' 07:30-15:00", coords: { lat: 45.4570, lon: 9.1329 } },
        { name: "Kosher King", type: 'dining', style: "מרכול", address: "Piazza Napoli, 15, 20146 Milano MI", phone: "+390242296773", website: "https://www.facebook.com/kosherkingmilan/", hours: "א'-ה' 08:30-19:30; ו' 08:30-16:00", coords: { lat: 45.4563, lon: 9.1492 } },
      ]
    };
    
    const dailyTips = [
      "זכרו לתקף את כרטיס התחבורה הציבורית שלכם במכונות הצהובות לפני כל נסיעה במטרו, אוטובוס או טראם כדי למנוע קנסות.",
      "אפרטיבו (Aperitivo) הוא מנהג איטלקי פופולרי. בין 18:00 ל-21:00, שלמו על משקה וקבלו גישה חופשית למזנון אכול כפי יכולתך. רובע נבילי הוא מקום מעולה לחוות זאת.",
      "'Coperto' הוא חיוב שירות קבוע שרוב המסעדות מוסיפות לחשבון. זה לא טיפ, אלא תשלום על השירות והלחם. טיפ נוסף אינו חובה אך מוערך.",
      "הרבה מוזיאונים וכנסיות דורשים לבוש צנוע (כתפיים וברכיים מכוסות). כדאי להחזיק צעיף קל בתיק למקרה הצורך.",
      "מים מהברז במילאנו בטוחים וטובים לשתייה. חפשו ברזיות ציבוריות (fontanelle) כדי למלא את בקבוק המים שלכם ולחסוך כסף.",
      "אם אתם מתכננים לראות את 'הסעודה האחרונה' של דה וינצ'י, חובה להזמין כרטיסים באינטרנט מספר חודשים מראש. הכניסה מוגבלת מאוד."
    ];

    const tripMeta = {
        flights: {
            inbound: { date: '2025-11-23', flight: 'LY381', departureTime: '07:30', arrivalTime: '11:15', terminal: '3', baggage: 'טרולי עד 8 ק"ג' },
            outbound: { date: '2025-11-26', flight: 'LY382', departureTime: '18:00', arrivalTime: '22:15', terminal: '1 (MXP)', baggage: 'מזוודה 23 ק"ג + טרולי 8 ק"ג' }
        },
        hotel: {
            name: 'Hotel Glam Milano', phone: '+39 02 839 840', tel: 'tel:+3902839840', address: 'Piazza Duca d\'Aosta, 4/6, 20124 Milano MI'
        },
        contacts: {
            emergency: { name: 'חירום (כללי)', phone: '112', tel: 'tel:112' },
            embassy: { name: 'שגרירות ישראל', phone: '+39 06 3619 8500', tel: 'tel:+390636198500' }
        }
    };
    
    let currentLang = 'he-it'; // he-it or it-he

    console.log("LOG: Static data (attractions, kosher, etc.) loaded.");

    function getInitialTripData() {
        console.log("LOG: getInitialTripData() called. Generating default trip structure.");
        const initialPlanKeys = ['duomo', 'primark', 'sanSiro', 'como', 'berninaExpress', 'laScala', 'navigli', 'ilCentro'];
        return {
            plan: {
                day1: { name: "יום 1: דואומו ודרבי", transport: 'walk', activities: [
                    { id: 'duomo_1', time: "בוקר", ...attractions.duomo },
                    { id: 'primark_1', time: "צהריים", ...attractions.primark },
                    { id: 'sanSiro_1', time: "ערב", ...attractions.sanSiro }
                ]},
                day2: { name: "יום 2: אגמים ונבילי", transport: 'transit', activities: [
                    { id: 'como_1', time: "יום שלם", ...attractions.como },
                    { id: 'navigli_1', time: "ערב", ...attractions.navigli },
                ]},
                day3: { name: "יום 3: האלפים השוויצריים", transport: 'drive', activities: [
                    { id: 'berninaExpress_1', time: "יום שלם", ...attractions.berninaExpress },
                ]},
                day4: { name: "יום 4: תרבות וקניות", transport: 'transit', activities: [
                    { id: 'laScala_1', time: "בוקר", ...attractions.laScala },
                    { id: 'ilCentro_1', time: "צהריים", ...attractions.ilCentro }
                ]}
            },
            suggestions: Object.entries(attractions)
                .filter(([key]) => !initialPlanKeys.includes(key))
                .map(([key, value]) => ({...value, id: key})),
            checklist: [
                { id: 'cat1', category: 'מסמכים', items: [{ id: 'c1', text: 'דרכון', done: true }, { id: 'c2', text: 'כרטיסי טיסה', done: false }] },
                { id: 'cat2', category: 'ביגוד', items: [{ id: 'c3', text: 'מעיל גשם', done: false }] },
                { id: 'cat3', category: 'אלקטרוניקה', items: [{ id: 'c4', text: 'מטען נייד', done: true }, { id: 'c5', text: 'מתאם לחשמל', done: false }] }
            ],
            totalBudget: 1500, expenses: [], documents: [], gallery: [], journal: {},
            theme: 'dark',
            settings: { includeEstimatedCostsInBalance: true }
        };
    }

    // --- MODAL ---
    let activityToModify = null;
    const modal = $('#add-to-day-modal');
    async function openAddToDayModal(activityId, type = 'suggestion') {
        console.log(`LOG: openAddToDayModal called for activityId: ${activityId}, type: ${type}`);
        if (type === 'suggestion') {
            activityToModify = localTripData.suggestions.find(s => s.id === activityId);
        } else {
            const allKosher = [...kosherData.restaurants, ...kosherData.markets];
            activityToModify = allKosher.find(k => k.name === activityId);
            if(activityToModify) activityToModify.id = activityId;
        }
        
        if (!activityToModify) {
            console.error(`ERROR: Could not find activity to modify with id: ${activityId}`);
            return;
        }

        const opts = $('#modal-day-options');
        opts.innerHTML = Object.entries(localTripData.plan).sort((a,b) => a[0].localeCompare(b[0])).map(([dayId, dayData]) => 
            `<button class="btn btn-primary" onclick="window.addActivityToDay('${dayId}', '${type}')">${dayData.name}</button>`
        ).join('');
        modal.classList.add('flex');
    };
    window.closeModal = () => {
        console.log("LOG: closeModal called.");
        $$('.modal-backdrop').forEach(m => m.classList.remove('flex'));
    };
    window.addActivityToDay = async (dayId, type) => {
        console.log(`LOG: addActivityToDay called for dayId: ${dayId}, type: ${type}`);
        const day = localTripData.plan[dayId];
        if (day && activityToModify) {
            const newActivity = { ...activityToModify, time: "זמן גמיש", id: (activityToModify.id || activityToModify.name) + '_' + Date.now() };
            day.activities.push(newActivity);
            
            let newSuggestions = localTripData.suggestions;
            if (type === 'suggestion') {
                newSuggestions = localTripData.suggestions.filter(s => s.id !== activityToModify.id);
            }
            
            console.log("LOG: Updating Firestore with new plan and suggestions.");
            await updateDoc(tripDocRef, {
                plan: localTripData.plan,
                suggestions: newSuggestions
            });
        }
        closeModal();
    };
    window.openAddToDayModal = openAddToDayModal;

function showAlert(title, message, isCopyable = false, speechOptions = null) {
    console.log(`LOG: showAlert called. Title: ${title}`);
    $('#alert-modal-title').textContent = title;
    $('#alert-modal-body').innerHTML = message;

    $('#alert-modal-copy-btn').classList.toggle('hidden', !isCopyable);

    const buttonContainer = $('#alert-modal-close').parentNode;

    // Remove old dynamic buttons to prevent duplicates
    ['#alert-modal-play-pause-btn', '#alert-modal-stop-btn', '#alert-modal-speak-btn'].forEach(selector => {
        const oldBtn = $(selector);
        if (oldBtn) oldBtn.remove();
    });

    if (speechOptions && speechOptions.text) {
        // --- START OF NEW PLAY/PAUSE/STOP LOGIC ---

        // Create Play/Pause Button
        const playPauseBtn = document.createElement('button');
        playPauseBtn.id = 'alert-modal-play-pause-btn';
        playPauseBtn.className = 'btn btn-ghost';
        playPauseBtn.innerHTML = '<i class="fa-solid fa-play mr-1"></i> הפעל';

        // Create Stop Button
        const stopBtn = document.createElement('button');
        stopBtn.id = 'alert-modal-stop-btn';
        stopBtn.className = 'btn btn-ghost text-red-500';
        stopBtn.innerHTML = '<i class="fa-solid fa-stop mr-1"></i> עצור';
        stopBtn.style.display = 'none'; // Initially hidden

        // Event handler for the Play/Pause button
        playPauseBtn.onclick = () => {
            if (speechSynthesis.paused) {
                // If paused, resume playback
                speechSynthesis.resume();
                playPauseBtn.innerHTML = '<i class="fa-solid fa-pause mr-1"></i> השהה';
            } else if (speechSynthesis.speaking) {
                // If currently speaking, pause playback
                speechSynthesis.pause();
                playPauseBtn.innerHTML = '<i class="fa-solid fa-play mr-1"></i> המשך';
            } else {
                // If not speaking, start from the beginning
                speechSynthesis.cancel(); // Clear any previous speech
                const utterance = new SpeechSynthesisUtterance(speechOptions.text);
                utterance.lang = speechOptions.lang || 'he-IL';

                utterance.onend = () => {
                    // When speech finishes naturally
                    playPauseBtn.innerHTML = '<i class="fa-solid fa-play mr-1"></i> הפעל';
                    stopBtn.style.display = 'none';
                };

                speechSynthesis.speak(utterance);
                playPauseBtn.innerHTML = '<i class="fa-solid fa-pause mr-1"></i> השהה';
                stopBtn.style.display = 'inline-flex';
            }
        };

        // Event handler for the Stop button
        stopBtn.onclick = () => {
            speechSynthesis.cancel(); // Stop and reset everything
            playPauseBtn.innerHTML = '<i class="fa-solid fa-play mr-1"></i> הפעל';
            stopBtn.style.display = 'none';
        };

        // Add new buttons to the modal
        buttonContainer.insertBefore(playPauseBtn, $('#alert-modal-close'));
        buttonContainer.insertBefore(stopBtn, playPauseBtn);
        // --- END OF NEW LOGIC ---
    }

    $('#alert-modal').classList.add('flex');
}
    function openTipModal() {
    console.log("LOG: openTipModal called.");
    const tip = dailyTips[Math.floor(Math.random() * dailyTips.length)];
    $('#daily-tip-body').textContent = tip;
    $('#daily-tip-modal').classList.add('flex');
}
    function showDailyTip() {
        console.log("LOG: showDailyTip called, checking if tip should be displayed.");
        const lastTipDate = localStorage.getItem('lastTipDate');
        const today = new Date().toISOString().slice(0, 10);

        if (lastTipDate !== today) {
            console.log("LOG: Displaying daily tip.");
           
            localStorage.setItem('lastTipDate', today);
        } else {
            console.log("LOG: Daily tip already shown today.");
        }
    }

    // --- RENDER FUNCTIONS ---
function renderOverview() {
    console.log("LOG: renderOverview called.");
    const { hotel, flights, contacts } = tripMeta;
    const countdownHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg text-center">
        <h3 class="font-bold text-lg mb-2">הזמן שנותר לטיול</h3>
        <div id="countdown" class="flex flex-row-reverse justify-around font-mono"></div>
    </div>`;

const clocksHtml = `<div class="bg-white dark:bg-gray-950 p-4 rounded-lg shadow-lg">
    <h3 class="text-xl font-bold mb-3 text-center"><i class="fa-solid fa-clock mr-2"></i>זמן מקומי</h3>
    <div class="space-y-2">
        <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-900 rounded-lg">
            <span class="font-semibold text-sm">מילאנו 🇮🇹</span>
            <span id="milan-time" class="font-mono text-lg font-bold">--:--:--</span>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-900 rounded-lg">
            <span class="font-semibold text-sm">ישראל 🇮🇱</span>
            <span id="israel-time" class="font-mono text-lg font-bold">--:--:--</span>
        </div>
    </div>
    <details class="mt-2">
        <summary class="cursor-pointer text-xs text-center text-gray-500">הצג את זמני היום במילאנו</summary>
        <div id="zmanim-container" class="text-xs pt-2 mt-2 border-t dark:border-gray-700 text-center">
            טוען זמנים...
        </div>
    </details>
</div>`;

    const flightsHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2 col-span-1 sm:col-span-2 lg:col-span-1">
        <h3 class="font-bold text-lg"><i class="fa-solid fa-plane-departure mr-2"></i>פרטי טיסות</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-x-4 gap-y-2 text-sm">
            <div><b class="font-semibold">הלוך:</b> ${flights.inbound.date} | ${flights.inbound.flight}</div>
            <div><b>המראה:</b> ${flights.inbound.departureTime} | <b>נחיתה:</b> ${flights.inbound.arrivalTime}</div>
            <hr class="md:col-span-2 lg:col-span-1 my-1">
            <div><b class="font-semibold">חזור:</b> ${flights.outbound.date} | ${flights.outbound.flight}</div>
            <div><b>המראה:</b> ${flights.outbound.departureTime} | <b>נחיתה:</b> ${flights.outbound.arrivalTime}</div>
        </div>
    </div>`;
    const hotelHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2">
        <h3 class="font-bold text-lg"><i class="fa-solid fa-hotel mr-2"></i>מלון</h3>
        <p><b>${hotel.name}</b></p>
        <div class="flex gap-2"><a href="${hotel.tel}" class="btn btn-ghost"><i class="fa fa-phone"></i> חיוג</a><a href="https://maps.google.com/?q=${encodeURIComponent(hotel.address)}" target="_blank" class="btn btn-ghost"><i class="fa fa-map-location-dot"></i> ניווט</a></div>
    </div>`;

    $('#overview-cards').innerHTML = countdownHtml + clocksHtml + flightsHtml + hotelHtml;
    startCountdown();
}

    function startCountdown() {
        console.log("LOG: startCountdown called.");
        const targetDate = new Date(`${tripMeta.flights.inbound.date}T00:00:00`).getTime();
        const countdownEl = $('#countdown');
        if (!countdownEl) {
            console.error("ERROR: Countdown element not found.");
            return;
        }
        
        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance < 0) {
                clearInterval(interval);
                countdownEl.innerHTML = "<div class='text-lg font-bold w-full'>הטיול התחיל! תהנו!</div>";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownEl.innerHTML = `
                <div><div class="countdown-number">${days}</div><div class="countdown-label">ימים</div></div>
                <div><div class="countdown-number">${hours}</div><div class="countdown-label">שעות</div></div>
                <div><div class="countdown-number">${minutes}</div><div class="countdown-label">דקות</div></div>
                <div><div class="countdown-number">${seconds}</div><div class="countdown-label">שניות</div></div>
            `;
        }, 1000);
    }

function renderAllPlans(planData) {
    console.log("LOG: renderAllPlans called.");
    if (!planData) {
        console.warn("WARN: renderAllPlans called with no planData.");
        return;
    }
    const nav = $('#day-tabs-nav'), content = $('#plan-content-container');
    const submenu = $('#plan-submenu-links');
    
    // --- START OF FIX ---
    let navHtml = '';
    let contentHtml = '';
    let submenuHtml = '';

    const sortedDays = Object.entries(planData).sort((a, b) => a[0].localeCompare(b[0]));

    // Step 1: Build all HTML strings first
    sortedDays.forEach(([dayId, dayData], i) => {
        const active = i === 0;
        navHtml += `<button class="tab-button ${active ? 'tab-active' : ''}" data-content="${dayId}">${dayData.name}</button>`;
        contentHtml += `<div id="${dayId}" class="content-section ${active ? 'active' : ''}"></div>`;
        submenuHtml += `<a href="#plan" data-day-index="${i}" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">${dayData.name.split(':')[0]}</a>`;
    });
    submenuHtml += `<a href="#suggestions" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 col-span-3">הצעות</a>`;

    // Step 2: Set innerHTML only ONCE for each container
    nav.innerHTML = navHtml;
    content.innerHTML = contentHtml;
    submenu.innerHTML = submenuHtml;

    // Step 3: Now that all containers exist, populate them and add listeners
    sortedDays.forEach(([dayId, dayData]) => {
        renderPlanForDay(dayId, dayData);
    });
    // --- END OF FIX ---

    // Attach event listeners for tabs (this part remains the same)
    $$('#day-tabs-nav .tab-button').forEach(b => b.addEventListener('click', (e) => {
        console.log(`LOG: Day tab clicked: ${e.currentTarget.dataset.content}`);
        $$('#day-tabs-nav .tab-button').forEach(btn => btn.classList.remove('tab-active'));
        e.currentTarget.classList.add('tab-active');
        $$('#plan-content-container .content-section').forEach(s => s.classList.remove('active'));
        $(`#${e.currentTarget.dataset.content}`).classList.add('active');
    }));
    $$('#plan-submenu-links a[data-day-index]').forEach(link => {
        link.addEventListener('click', (e) => {
            const dayIndex = parseInt(e.currentTarget.dataset.dayIndex, 10);
            console.log(`LOG: Mobile day link clicked for day index: ${dayIndex}`);
            $$('#day-tabs-nav .tab-button')[dayIndex].click();
        });
    });
}
// ========================= התחלה: פונקציה ליצירת תפריטי ניווט מהיר =========================
function renderMobileNavSubmenus() {
    const toolsContainer = $('#tools-submenu-links');
    if (toolsContainer) {
        let toolsHtml = '<a href="#overview" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 col-span-3 font-bold text-brand-600">חזור לסקירה</a>';
        $$('#tools > div > div').forEach(toolElement => {
            const toolId = toolElement.id;
            const toolTitleElement = toolElement.querySelector('h3');
            if (toolId && toolTitleElement) {
                const toolTitle = toolTitleElement.textContent || 'כלי';
                // לוקחים רק את הטקסט, בלי האייקון
                const cleanTitle = toolTitleElement.childNodes.length > 1 ? toolTitleElement.lastChild.textContent.trim() : toolTitle.trim();
                toolsHtml += `<a href="#${toolId}" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">${cleanTitle}</a>`;
            }
        });
        toolsContainer.innerHTML = toolsHtml;
    }
}
// ========================= סוף: פונקציה ליצירת תפריטי ניווט מהיר =========================
    function renderPlanForDay(dayId, dayData) {
        console.log(`LOG: renderPlanForDay called for ${dayId}`);
        const container = $(`#${dayId}`);
        if (!container) {
            console.error(`ERROR: Container for day ${dayId} not found.`);
            return;
        }
        let content = `<div class="p-4"><div class="flex flex-wrap items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                <label class="font-semibold">מצב נסיעה:</label>
                <select class="p-2 rounded-lg border bg-white dark:bg-gray-800" data-day="${dayId}" onchange="window.handleTransportChange(event)">
                    <option value="walk" ${dayData.transport === 'walk' ? 'selected' : ''}>הליכה</option>
                    <option value="drive" ${dayData.transport === 'drive' ? 'selected' : ''}>רכב/מונית</option>
                    <option value="transit" ${dayData.transport === 'transit' ? 'selected' : ''}>תחב"צ</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="window.openDayMap('${dayId}')"><i class="fa-solid fa-map-route mr-2"></i>מפת יום</button>
            <button class="btn btn-ghost" onclick="window.optimizeDayRoute('${dayId}')"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>סדר לי את היום</button>
            <button class="btn btn-ghost" onclick="window.generateIcsFile('${dayId}')"><i class="fa-solid fa-calendar-plus mr-2"></i>הוסף ליומן</button>
        </div><div class="space-y-4">`;

        let previousActivity = null; 
        dayData.activities.forEach((act, i) => {
            const dist = haversineKm(previousActivity?.coords?.lat, previousActivity?.coords?.lon, act.coords?.lat, act.coords?.lon);
            const time = minsForMode(dist, dayData.transport);
            if (i > 0 && previousActivity) {
                content += `<div class="flex items-center gap-2 text-sm text-gray-500 justify-center">
                    <i class="fa-solid fa-arrow-down"></i> <span>${formatKm(dist)} / ${formatMin(time)}</span>
                </div>`;
            }
            content += renderActivityCard(dayId, act, i, dayData.activities.length, previousActivity);
            previousActivity = act;
        });
        
        content += `</div>${renderJournal(dayId, localTripData.journal ? localTripData.journal[dayId] : [])}</div>`;
        container.innerHTML = content;
        
        // Add event listener to the newly created journal form
        const journalForm = $(`#journal-form-${dayId}`);
        if (journalForm) {
            journalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                console.log(`LOG: Journal form submitted for day: ${dayId}`);
                if(!isFirebaseConnected) { 
                    showAlert('שגיאת סנכרון', 'אין חיבור למסד הנתונים. אנא בדוק את החיבור לאינטרנט.');
                    return; 
                }
                const textInput = $(`#journal-text-${dayId}`);
                const text = textInput.value.trim();
                if (text) {
                    addJournalEntry(dayId, text);
                    textInput.value = '';
                }
            });
        }
    }
    
    function renderActivityCard(dayId, activity, index, total, previousActivity) {
        const isDining = activity.type === 'dining';
        const links = [];


if (activity.type === 'attraction') {
    links.push(`<button onclick="window.getAudioGuide('${activity.name}')" class="btn btn-primary bg-purple-600 hover:bg-purple-700"><i class="fa-solid fa-headphones"></i> מדריך</button>`);
}
        if (activity.tickets) links.push(`<a href="${activity.tickets}" target="_blank" class="btn btn-primary"><i class="fa-solid fa-ticket"></i> כרטיסים</a>`);
        if (activity.info) links.push(`<a href="${activity.info}" target="_blank" class="btn btn-ghost"><i class="fa-solid fa-circle-info"></i> מידע</a>`);
        if (activity.address) {
            links.push(`<a href="https://waze.com/ul?q=${encodeURIComponent(activity.address)}" target="_blank" class="btn btn-ghost" title="Waze"><i class="fa-brands fa-waze"></i></a>`);
            links.push(`<a href="https://maps.google.com/?q=${encodeURIComponent(activity.address)}" target="_blank" class="btn btn-ghost" title="Google Maps"><i class="fa-brands fa-google"></i></a>`);
        }
        if (previousActivity && previousActivity.address && activity.address) {
            const transitUrl = `https://maps.google.com/?saddr=${encodeURIComponent(previousActivity.address)}&daddr=${encodeURIComponent(activity.address)}&travelmode=transit`;
            links.push(`<a href="${transitUrl}" target="_blank" class="btn btn-ghost" title="ניווט בתחב״צ"><i class="fa-solid fa-route"></i></a>`);
        }
        if(!isDining && activity.coords) {
             links.push(`<button onclick="window.findNearbyKosher(this)" data-lat="${activity.coords.lat}" data-lon="${activity.coords.lon}" data-name="${activity.name}" class="btn btn-ghost"><i class="fa-solid fa-utensils"></i> מסעדות</button>`);
        }

        const imgHTML = activity.img ? `<div class="image-carousel" data-images='${JSON.stringify(activity.img)}' data-index="0">
            <img loading="lazy" src="${activity.img[0]}" alt="${activity.name}" class="thumb" onerror="this.style.display='none'">
            ${(activity.img.length || 0) > 1 ? `<button class="carousel-prev" onclick="window.navigateCarousel(this, -1)"><</button><button class="carousel-next" onclick="window.navigateCarousel(this, 1)">></button>` : ''}
        </div>` : '';
        
        const moveButtons = `
            <button class="p-1 ${index === 0 ? 'opacity-25' : ''}" ${index === 0 ? 'disabled' : ''} onclick="window.moveActivity('${dayId}', '${activity.id}', -1)"><i class="fa-solid fa-arrow-up"></i></button>
            <button class="p-1 ${index === total - 1 ? 'opacity-25' : ''}" ${index === total - 1 ? 'disabled' : ''} onclick="window.moveActivity('${dayId}', '${activity.id}', 1)"><i class="fa-solid fa-arrow-down"></i></button>
        `;

        return `<details class="bg-gray-50 dark:bg-gray-900 rounded-xl shadow-md overflow-hidden relative" open>
          <summary class="cursor-pointer list-none flex items-center justify-between p-4">
            <h4 class="font-bold text-lg">${isDining ? '<i class="fa-solid fa-utensils mr-2"></i>' : ''}${activity.time ? activity.time + ' - ' : ''}${activity.name}</h4>
            <div class="text-gray-400 flex items-center gap-2">
                ${moveButtons}
                <i class="fa-solid fa-chevron-down transition-transform"></i>
            </div>
          </summary>
          <button class="absolute top-3 left-3 text-red-500 hover:text-red-700 p-1 z-10" onclick="window.removeActivity('${dayId}', '${activity.id}')"><i class="fa-solid fa-trash"></i></button>
          <div class="flex flex-col md:flex-row border-t border-gray-100 dark:border-gray-800">
            ${imgHTML}
            <div class="p-4 md:p-5 flex-grow">
              <p class="text-gray-700 dark:text-gray-300">${fmtBold(activity.description)}</p>
              ${activity.hours ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-2"><i class="fa-solid fa-clock w-4 mr-1"></i> ${activity.hours}</p>` : ''}
              <div class="mt-4 flex flex-wrap items-center gap-2">${links.join('')}</div>
            </div>
          </div>
        </details>`;
    }
    
    function renderSuggestions(suggestions) {
        console.log("LOG: renderSuggestions called.");
        const container = $('#suggestions-table-container');
        if (!suggestions || suggestions.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500">כל הכבוד! כל הפעילויות שובצו בתוכנית.</div>`;
            return;
        }

        const tableRows = suggestions.map(s => `
            <tr class="border-b dark:border-gray-800">
                <td data-label="שם" class="p-3 font-medium">${s.name}</td>
                <td data-label="תיאור" class="p-3 text-sm text-gray-600 dark:text-gray-400">${s.description}</td>
                <td data-label="פעולות" class="p-3">
                    <div class="flex flex-wrap gap-2 justify-end">
                        <button onclick="window.openAddToDayModal('${s.id}')" class="btn btn-primary btn-sm"><i class="fa-solid fa-plus"></i> הוסף</button>
                        <a href="https://maps.google.com/?q=${s.coords.lat},${s.coords.lon}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-solid fa-map-location-dot"></i> מפה</a>
                    </div>
                </td>
            </tr>
        `).join('');

        container.innerHTML = `
            <table class="w-full text-sm responsive-table">
                <thead class="text-right bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="p-3 font-semibold">שם</th>
                        <th class="p-3 font-semibold">תיאור</th>
                        <th class="p-3 font-semibold"></th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;
    }

    function isCurrentlyOpen(hoursString) {
        if (!hoursString) return false;
        
        const now = new Date();
        const timeZone = 'Europe/Rome';
        
        const milanParts = new Intl.DateTimeFormat('en-US', {
            timeZone,
            weekday: 'short',
            hour: 'numeric',
            minute: 'numeric',
            hour12: false,
        }).formatToParts(now);

        const milanDayStr = milanParts.find(p => p.type === 'weekday')?.value;
        const hourPart = milanParts.find(p => p.type === 'hour')?.value;
        const minutePart = milanParts.find(p => p.type === 'minute')?.value;
        
        if (!milanDayStr || !hourPart || !minutePart) {
             console.error("Could not determine Milan time");
             return false;
        }

        let currentHour = parseInt(hourPart, 10);
        if (currentHour === 24) currentHour = 0;

        const currentMinute = parseInt(minutePart, 10);
        
        const dayMapEn = {'Sun': 0, 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5, 'Sat': 6};
        const currentDay = dayMapEn[milanDayStr];
        const currentTimeInMinutes = currentHour * 60 + currentMinute;
        
        const dayMapHe = {'א': 0, 'ב': 1, 'ג': 2, 'ד': 3, 'ה': 4, 'ו': 5, 'ש': 6};

        try {
            const dayEntries = hoursString.split(';').map(s => s.trim());
            for (const entry of dayEntries) {
                const firstSpaceIndex = entry.indexOf(' ');
                if (firstSpaceIndex === -1) continue;

                const daySpec = entry.substring(0, firstSpaceIndex);
                const timeSpec = entry.substring(firstSpaceIndex + 1);

                let applicableDays = [];
                const cleanedDaySpec = daySpec.replace(/'/g, '');
                if (cleanedDaySpec.includes('-')) {
                    const [startChar, endChar] = cleanedDaySpec.split('-');
                    const startDay = dayMapHe[startChar];
                    const endDay = dayMapHe[endChar];
                    if (startDay !== undefined && endDay !== undefined) {
                        for (let i = startDay; i <= endDay; i++) {
                            applicableDays.push(i);
                        }
                    }
                } else {
                    applicableDays = cleanedDaySpec.split(',').map(d => dayMapHe[d]).filter(d => d !== undefined);
                }
                
                const timeRanges = timeSpec.split(',').map(r => r.trim());

                for (const range of timeRanges) {
                    const [startStr, endStr] = range.split('-');
                    if (!startStr || !endStr) continue;

                    const [startH, startM] = startStr.split(':').map(Number);
                    const [endH, endM] = endStr.split(':').map(Number);
                    const startTotalMinutes = startH * 60 + (startM || 0);
                    let endTotalMinutes = endH * 60 + (endM || 0);
                    
                    if (endTotalMinutes < startTotalMinutes) { // Crosses midnight
                        const previousDay = currentDay === 0 ? 6 : currentDay - 1;
                        if (applicableDays.includes(currentDay) && currentTimeInMinutes >= startTotalMinutes) {
                            return true;
                        }
                        if (applicableDays.includes(previousDay) && currentTimeInMinutes < endTotalMinutes) {
                             return true;
                        }
                    } else { // Same day
                        if (applicableDays.includes(currentDay) && currentTimeInMinutes >= startTotalMinutes && currentTimeInMinutes < endTotalMinutes) {
                            return true;
                        }
                    }
                }
            }
        } catch (e) {
            console.error("Error parsing hours string:", hoursString, e);
            return false;
        }

        return false;
    }

    function renderKosher(filter = 'all') {
        console.log(`LOG: renderKosher called with filter: ${filter}`);
        let allKosher = [...kosherData.restaurants, ...kosherData.markets];
        
        if (userCoords) {
            allKosher.forEach(k => k.distance = haversineKm(userCoords.lat, userCoords.lon, k.coords.lat, k.coords.lon));
            allKosher.sort((a,b) => a.distance - b.distance);
        } else {
            allKosher.forEach(k => delete k.distance);
        }

        const filtered = allKosher.filter(r => {
            if (filter === 'open') return isCurrentlyOpen(r.hours);
            if (filter === 'all') return true;
            const style = r.style.toLowerCase();
            return style.includes(filter.toLowerCase());
        });

        const content = filtered.map(item => (item.style.includes('בשרי') || item.style.includes('חלבי') || item.style.includes('פלאפל') || item.style.includes('טייק-אווי') ? rowRestaurant(item) : rowMarket(item))).join('');
        $('#kosher-results').innerHTML = `<table class="min-w-full text-sm responsive-table"><tbody>${content || `<tr><td class="p-4 text-center">לא נמצאו תוצאות.</td></tr>`}</tbody></table>`;
    }

    function renderKosherFilters() {
        console.log("LOG: renderKosherFilters called.");
        const filters = ['all', 'open', 'בשרי', 'חלבי', 'מאפייה', 'מרכול'];
        const filterLabels = {'all': 'הכל', 'open': 'פתוח עכשיו', 'בשרי': 'בשרי', 'חלבי': 'חלבי', 'מאפייה': 'מאפייה', 'מרכול': 'מרכול'};
        $('#kosher-filters').innerHTML = filters.map(f => `<button class="kosher-filter-btn btn btn-ghost" data-filter="${f}">${filterLabels[f]}</button>`).join('');
        $$('.kosher-filter-btn').forEach(btn => btn.addEventListener('click', e => {
            const currentFilter = e.target.dataset.filter;
            console.log(`LOG: Kosher filter button clicked: ${currentFilter}`);
            renderKosher(currentFilter);
            $$('.kosher-filter-btn').forEach(b => b.classList.remove('tab-active'));
            e.target.classList.add('tab-active');
        }));
        $('.kosher-filter-btn[data-filter="all"]').classList.add('tab-active');
    }

    const rowRestaurant = r => {
        const logoSrc = r.logo || placeholderLogoUrl(r.name);
        return `
        <tr class="align-top border-b dark:border-gray-800">
            <td data-label="לוגו" class="p-3 logo-cell"><img class="logo" src="${logoSrc}" alt="${r.name}" onerror="this.onerror=null;this.src='${placeholderLogoUrl(r.name)}';"></td>
            <td data-label="שם" class="p-3 font-medium">${r.name} <span class="text-xs font-normal text-gray-500">${r.distance ? formatKm(r.distance) : ''}</span></td>
            <td data-label="סגנון" class="p-3">${r.style}</td>
            <td data-label="שעות" class="p-3 text-xs">${r.hours || ''}</td>
            <td data-label="פעולות" class="p-3">
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.openAddToDayModal('${r.name}', 'kosher')" class="btn btn-primary btn-sm" title="הוסף ליום"><i class="fa-solid fa-plus"></i></button>
                    ${r.phone ? `<a title="התקשר" href="tel:${r.phone}" class="btn btn-ghost btn-sm"><i class="fa-solid fa-phone"></i></a>`:''}
                    <a title="Waze" href="https://waze.com/ul?q=${encodeURIComponent(r.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-waze"></i></a>
                    <a title="Google Maps" href="https://maps.google.com/?q=${encodeURIComponent(r.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-google"></i></a>
                    ${r.menu ? `<a href="${r.menu}" target="_blank" class="btn btn-ghost btn-sm" title="תפריט"><i class="fa-solid fa-utensils"></i></a>`:''}
                    ${r.website ? `<a href="${r.website}" target="_blank" class="btn btn-ghost btn-sm" title="אתר"><i class="fa-solid fa-globe"></i></a>`:''}
                    ${r.instagram ? `<a title="אינסטגרם" href="${r.instagram}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-instagram"></i></a>`:''}
                </div>
            </td>
        </tr>`;
    };
    const rowMarket = m => {
        const logoSrc = m.logo || placeholderLogoUrl(m.name);
        return `
        <tr class="align-top border-b dark:border-gray-800">
            <td data-label="לוגו" class="p-3 logo-cell"><img class="logo" src="${logoSrc}" alt="${m.name}" onerror="this.onerror=null;this.src='${placeholderLogoUrl(m.name)}';"></td>
            <td data-label="שם" class="p-3 font-medium">${m.name} <span class="text-xs font-normal text-gray-500">${m.distance ? formatKm(m.distance) : ''}</span></td>
            <td data-label="סוג" class="p-3">${m.style}</td>
            <td data-label="שעות" class="p-3 text-xs">${m.hours || ''}</td>
            <td data-label="פעולות" class="p-3">
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.openAddToDayModal('${m.name}', 'kosher')" class="btn btn-primary btn-sm" title="הוסף ליום"><i class="fa-solid fa-plus"></i></button>
                    ${m.phone ? `<a title="התקשר" href="tel:${m.phone}" class="btn btn-ghost btn-sm"><i class="fa-solid fa-phone"></i></a>`:''}
                    <a title="Waze" href="https://waze.com/ul?q=${encodeURIComponent(m.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-waze"></i></a>
                    <a title="Google Maps" href="https://maps.google.com/?q=${encodeURIComponent(m.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-google"></i></a>
                    ${m.website ? `<a href="${m.website}" target="_blank" class="btn btn-ghost btn-sm" title="אתר"><i class="fa-solid fa-globe"></i></a>`:''}
                    ${m.instagram ? `<a title="אינסטגרם" href="${r.instagram}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-instagram"></i></a>`:''}
                </div>
            </td>
        </tr>`;
    };

    function renderChecklist(checklistData) {
        console.log("LOG: renderChecklist called.");
        const container = $('#checklist-container');
        const categorySelect = $('#category-select');
        container.innerHTML = '';
        categorySelect.innerHTML = '<option value="">בחר קטגוריה...</option>';
        (checklistData || []).forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat.category}">${cat.category}</option>`;
            let catHtml = `<div class="space-y-2"><h4 class="font-bold">${cat.category}</h4>`;
            (cat.items || []).forEach(item => {
                catHtml += `<label class="flex items-center gap-2">
                    <input type="checkbox" data-id="${item.id}" ${item.done ? 'checked' : ''} onchange="window.toggleChecklistItem(event)">
                    <span class="${item.done ? 'line-through text-gray-500' : ''}">${item.text}</span>
                    <button class="text-red-500 mr-auto hover:text-red-700 text-xs" onclick="window.removeChecklistItem('${cat.id}', '${item.id}')"><i class="fa-solid fa-trash"></i></button>
                </label>`;
            });
            container.innerHTML += catHtml + '</div>';
        });
    }

    async function fetchWeather() {
        console.log("LOG: fetchWeather called.");
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=45.46&longitude=9.19&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe/Berlin&forecast_days=7`);
            const data = await res.json();
            if (data.error) throw new Error(data.reason);
            lastWeatherAPIData = data; // Cache weather data
            console.log("LOG: Weather data fetched successfully.");
            checkWeatherAlerts();
             const iconMap = {
                0: 'fa-sun', 1: 'fa-cloud-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud',
                45: 'fa-smog', 48: 'fa-smog',
                51: 'fa-cloud-rain', 53: 'fa-cloud-rain', 55: 'fa-cloud-rain',
                56: 'fa-snowflake', 57: 'fa-snowflake',
                61: 'fa-cloud-showers-heavy', 63: 'fa-cloud-showers-heavy', 65: 'fa-cloud-showers-heavy',
                66: 'fa-snowflake', 67: 'fa-snowflake',
                71: 'fa-snowflake', 73: 'fa-snowflake', 75: 'fa-snowflake', 77: 'fa-snowflake',
                80: 'fa-cloud-showers-heavy', 81: 'fa-cloud-showers-heavy', 82: 'fa-cloud-showers-heavy',
                85: 'fa-snowflake', 86: 'fa-snowflake',
                95: 'fa-cloud-bolt', 96: 'fa-cloud-bolt', 99: 'fa-cloud-bolt'
            };
            $('#weather-forecast').innerHTML = data.daily.time.slice(0, 5).map((day, i) => `
                <div class="flex justify-between items-center text-sm">
                    <span>${new Date(day).toLocaleDateString('he-IL', { weekday: 'short' })}</span>
                    <span><i class="fa-solid ${iconMap[data.daily.weathercode[i]] || 'fa-question-circle'}"></i></span>
                    <span>${Math.round(data.daily.temperature_2m_min[i])}°/${Math.round(data.daily.temperature_2m_max[i])}°</span>
                </div>`).join('');
            
            const todayTempMax = data.daily.temperature_2m_max[0];
            const todayWeatherCode = data.daily.weathercode[0];
            let recommendation = '';
            if (((todayWeatherCode >= 71 && todayWeatherCode <= 86) || (todayWeatherCode >= 56 && todayWeatherCode <= 67)) && todayTempMax < 5) {
                recommendation = 'צפוי שלג/מזג אוויר קפוא. התלבשו חם מאוד!';
            } 
            else if ((todayWeatherCode >= 51 && todayWeatherCode <= 67) || (todayWeatherCode >= 80 && todayWeatherCode <= 82)) {
                recommendation = 'צפוי גשם. מומלץ לקחת מטריה ועליונית.';
            } 
            else if (todayWeatherCode >= 95) {
                 recommendation = 'צפויה סופת רעמים. מומלץ למצוא מחסה.';
            }
            else if (todayTempMax > 28) {
                recommendation = 'חם! מומלץ לבוש קצר, כובע והרבה מים.';
            } else if (todayTempMax > 20) {
                recommendation = 'מזג אוויר נעים, לבוש קצר או ארוך ודק יתאים.';
            } else if (todayTempMax > 12) {
                recommendation = 'קריר, מומלץ לבוש ארוך ועליונית / ז׳קט קל.';
            } else {
                recommendation = 'קר, מומלץ להתלבש חם עם מעיל וכובע.';
            }
            $('#weather-attire-recommendation').innerHTML = `<i class="fa-solid fa-shirt mr-2"></i> ${recommendation}`;

        } catch (e) { 
            console.error("ERROR: Failed to fetch weather.", e);
            $('#weather-forecast').innerHTML = `<p class="text-xs text-red-500">שגיאה בטעינת תחזית. ${e.message}</p>`; 
        }
    }

    async function fetchExchangeRate() {
        console.log("LOG: fetchExchangeRate called.");
        try {
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
            const data = await response.json();
            if(data && data.rates && data.rates.ILS) {
                eurToIlsRate = data.rates.ILS;
                $('#exchange-rate-display').textContent = `שער נוכחי: 1€ = ${eurToIlsRate.toFixed(3)}₪`;
                console.log(`LOG: Exchange rate updated: 1 EUR = ${eurToIlsRate} ILS`);
            }
        } catch (error) {
            console.error("ERROR: Could not fetch exchange rate:", error);
             $('#exchange-rate-display').textContent = 'שגיאה בטעינת שער חליפין.';
        }
    }
    
    function renderDocuments(documents = []) {
        console.log("LOG: renderDocuments called.");
        const grid = $('#documents-grid');
        grid.innerHTML = (documents || []).map(doc => `
            <div class="relative bg-gray-100 dark:bg-gray-800 rounded-lg flex flex-col items-center justify-center p-2 text-center">
                 <a href="${doc.dataUrl}" download="${doc.name}" class="flex flex-col items-center justify-center w-full h-full">
                    <i class="fa-solid fa-file-pdf fa-3x text-red-500"></i>
                    <span class="text-xs mt-2 break-all">${doc.name}</span>
                </a>
                <button class="delete-btn" onclick="window.removeDocument('${doc.id}')">×</button>
            </div>`).join('');
    }

    function renderGallery(gallery = []) {
        console.log("LOG: renderGallery called.");
        const grid = $('#gallery-grid');
        grid.innerHTML = (gallery || []).map(img => `<div class="relative aspect-square">
            <img src="${img.dataUrl}" class="w-full h-full object-cover rounded-lg">
            <button class="delete-btn" onclick="window.removeImage('${img.id}')">×</button>
        </div>`).join('');
    }

    function calculateEstimatedCosts(plan) {
        let totalCost = 0;
        if (!plan) return 0;
        Object.values(plan).forEach(day => {
            (day.activities || []).forEach(activity => {
                if(activity.cost) {
                    totalCost += activity.cost;
                }
            });
        });
        return totalCost * 2; // For a couple
    }

    function renderBudget(data) {
        console.log("LOG: renderBudget called.");
        const { totalBudget = 0, expenses = [], plan, settings = { includeEstimatedCostsInBalance: true } } = data || {};
        
        const totalBudgetInput = $('#total-budget');
        if (document.activeElement !== totalBudgetInput) {
             totalBudgetInput.value = totalBudget || '';
        }

        const includeEstimated = $('#include-estimated-costs');
        includeEstimated.checked = settings.includeEstimatedCostsInBalance;

        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        const estimatedCosts = calculateEstimatedCosts(plan);
        const balance = totalBudget - totalExpenses - (includeEstimated.checked ? estimatedCosts : 0);

        $('#total-expenses').textContent = totalExpenses.toFixed(2) + '€';
        $('#estimated-costs').textContent = estimatedCosts.toFixed(2) + '€';
        $('#budget-balance').textContent = balance.toFixed(2) + '€';

        $('#expense-list').innerHTML = (expenses || []).map(exp => 
            `<div class="flex justify-between items-center py-1 group">
                <span>${exp.desc} <span class="text-xs text-gray-400">${exp.category}</span></span>
                <span class="flex items-center gap-2">
                    ${exp.amount.toFixed(2)}€
                   <button class="text-red-400 hover:text-red-600 transition-opacity" onclick="window.removeExpense('${exp.id}')">
    <i class="fa-solid fa-trash-alt fa-xs"></i>
      </button>
                </span>
            </div>`
        ).join('');
        
        renderBudgetChart(expenses);
    }
    
    function renderBudgetChart(expenses) {
        const ctx = $('#budget-chart').getContext('2d');
        const placeholder = $('#budget-chart-placeholder');
        const legendContainer = $('#budget-chart-legend');
        if (!ctx) return;

        const categoryTotals = (expenses || []).reduce((acc, exp) => {
            acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
            return acc;
        }, {});

        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const backgroundColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];

        if (budgetChartInstance) {
            budgetChartInstance.destroy();
        }
        
        legendContainer.innerHTML = '';
        if (labels.length === 0) {
            placeholder.classList.remove('hidden');
            return;
        }
        placeholder.classList.add('hidden');

        budgetChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderColor: 'var(--card)',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    title: { display: false },
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Generate custom legend
        legendContainer.innerHTML = `<h4 class="text-center font-bold mb-2">פירוט הוצאות</h4>`;
        labels.forEach((label, index) => {
            const amount = categoryTotals[label];
            const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(0) : 0;
            const color = backgroundColors[index % backgroundColors.length];
            legendContainer.innerHTML += `
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-sm" style="background-color: ${color};"></span>
                        <span>${label}</span>
                    </div>
                    <span class="font-semibold">${amount.toFixed(2)}€ (${percentage}%)</span>
                </div>
            `;
        });
    }

    function renderTranslationHistory() {
        console.log("LOG: renderTranslationHistory called.");
        const container = $('#translation-history');
        if (translationHistory.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400">היסטוריית תרגומים</div>`;
            return;
        }
        container.innerHTML = translationHistory.map((item, index) => `
            <div class="p-1.5 bg-gray-100 dark:bg-gray-800 rounded-md flex justify-between items-center group">
                <div class="cursor-pointer flex-grow" onclick="window.reuseTranslation(${index})">
                    <div class="font-medium">${item.sourceText}</div>
                    <div class="text-gray-500">${item.translatedText}</div>
                </div>
                <button class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity ml-2 p-1" onclick="window.removeTranslationHistoryItem(event, ${index})">
                    <i class="fa-solid fa-trash-alt fa-xs"></i>
                </button>
            </div>
        `).join('');
    }
    // ========================= התחלה: פונקציית שעונים =========================
function updateClocks() {
    const milanTimeEl = $('#milan-time');
    const israelTimeEl = $('#israel-time');

    if (milanTimeEl && israelTimeEl) {
        const now = new Date();
        milanTimeEl.textContent = now.toLocaleTimeString('he-IL', { timeZone: 'Europe/Rome', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        israelTimeEl.textContent = now.toLocaleTimeString('he-IL', { timeZone: 'Asia/Jerusalem', hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
}
    // ========================= התחלה: פונקציה לשליפת זמני היום =========================
async function fetchZmanim() {
    const container = $('#zmanim-container');
    try {
        const response = await fetch('https://www.hebcal.com/zmanim?cfg=json&latitude=45.46&longitude=9.19&tzid=Europe/Rome');
        const data = await response.json();
        const formatTime = (isoTime) => new Date(isoTime).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });

        container.innerHTML = `
            <div class="grid grid-cols-2 gap-1 text-right">
                <span>עלות השחר:</span> <span class="font-semibold text-left">${formatTime(data.times.alotHaShachar)}</span>
                <span>זריחה:</span> <span class="font-semibold text-left">${formatTime(data.times.sunrise)}</span>
                <span>סוף זמן ק"ש:</span> <span class="font-semibold text-left">${formatTime(data.times.sofZmanShma)}</span>
                <span>סוף זמן תפילה:</span> <span class="font-semibold text-left">${formatTime(data.times.sofZmanTfilla)}</span>
                <span>חצות היום:</span> <span class="font-semibold text-left">${formatTime(data.times.chatzot)}</span>
                <span>שקיעה:</span> <span class="font-semibold text-left">${formatTime(data.times.sunset)}</span>
            </div>
        `;
    } catch (e) {
        container.innerHTML = 'שגיאה בטעינת זמנים';
        console.error("Error fetching zmanim:", e);
    }
}
// ========================= סוף: פונקציה לשליפת זמני היום =========================
    
// ========================= סוף: פונקציית שעונים =========================
// ========================= התחלה: פונקציית חיפוש מהיר =========================
function findUtility(query, queryHebrew) {
    // הוספת "open now" לחיפוש כדי לסנן תוצאות
    const searchQuery = `${query} open now`;

    showAlert('מאתר מיקום...', `מחפש ${queryHebrew} שפתוחים כעת בקרבתך...`);
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}&ll=${latitude},${longitude}`;
            window.open(url, '_blank');
            window.closeModal();
        }, () => {
            // Fallback in case of location error
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}+near+Milan+Cathedral`;
            window.open(url, '_blank');
            showAlert('שגיאת מיקום', 'לא ניתן היה לקבל את מיקומך. החיפוש יתבצע ממרכז מילאנו.');
        });
    } else {
        showAlert('שגיאה', 'שירותי מיקום אינם נתמכים בדפדפן זה.');
    }
}
    // ========================= התחלה: פונקציה למדריך קולי =========================
async function getAudioGuide(placeName) {
    showAlert('טוען מדריך...', `<div class="text-center"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p class="mt-2">מכין עבורך סקירה על ${placeName}...</p></div>`);

    const prompt = `Act as an expert tour guide. Create an engaging and detailed audio guide script in Hebrew for "${placeName}" in Milan. The script should be about 2-3 paragraphs long and feel like a natural, spoken guide. Cover key history, interesting architectural or artistic details, and a unique anecdote that most tourists don't know.`;
    const payload = { contents: [{ parts: [{ text: "" }] }] };
    const summaryText = await callGemini(payload, prompt, false);

    showAlert(`מדריך ל${placeName}`, summaryText, true, { text: summaryText, lang: 'he-IL' });
}

    // ========================= התחלה: לוגיקה לעוזר המטרו =========================
function initMetroHelper() {
    const metroData = {
        M1: { name: 'M1', color: '#E4001A', stops: { 'Duomo': 'קתדרלת הדואומו, גלריה ויטוריו', 'Cadorna': 'טירת ספורצה, פארק סמפיונה', 'San Babila': 'מרובע האופנה' } },
        M2: { name: 'M2', color: '#009B4E', stops: { 'Centrale FS': 'תחנה מרכזית (רכבות לאגמים)', 'Garibaldi FS': 'פיאצה גאה אאולנטי, בוסקו ורטיקלה' } },
        M3: { name: 'M3', color: '#FFD200', stops: { 'Duomo': 'קתדרלת הדואומו', 'Centrale FS': 'תחנה מרכזית' } },
        M5: { name: 'M5', color: '#6E2C91', stops: { 'San Siro Stadio': 'אצטדיון סן סירו', 'Garibaldi FS': 'פיאצה גאה אאולנטי' } }
    };

    const linesContainer = $('#metro-lines-container');
    const infoContainer = $('#metro-line-info');

    Object.keys(metroData).forEach(key => {
        const line = metroData[key];
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm font-bold';
        btn.textContent = line.name;
        btn.style.backgroundColor = line.color;
        btn.style.color = '#fff';
        btn.onclick = () => {
            $$('#metro-lines-container button').forEach(b => b.classList.remove('ring-2', 'ring-offset-2', 'dark:ring-offset-gray-900', 'ring-blue-500'));
            btn.classList.add('ring-2', 'ring-offset-2', 'dark:ring-offset-gray-900', 'ring-blue-500');

            let infoHtml = `<h4 class="font-bold text-lg" style="color:${line.color};">תחנות מרכזיות בקו ${line.name}</h4>`;
            for(const stop in line.stops) {
                infoHtml += `<div><b class="font-semibold">${stop}:</b> ${line.stops[stop]}</div>`;
            }
            infoContainer.innerHTML = infoHtml;
        };
        linesContainer.appendChild(btn);
    });
}
// ========================= סוף: לוגיקה לעוזר המטרו =========================
    // ========================= התחלה: לוגיקה לסקראפבוק =========================
function renderScrapbook() {
    const container = $('#scrapbook-container');
    if (!localTripData.plan) {
        container.innerHTML = '<p class="text-center">עדיין אין תוכנית טיול.</p>';
        return;
    }

    let scrapbookHtml = '';
    const sortedDays = Object.entries(localTripData.plan).sort((a, b) => a[0].localeCompare(b[0]));

    for (const [dayId, dayData] of sortedDays) {
        const journalEntries = (localTripData.journal && localTripData.journal[dayId]) || [];
        const galleryImages = (localTripData.gallery && localTripData.gallery[dayId]) || [];

        scrapbookHtml += `
        <div class="bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2">${dayData.name}</h3>

            <h4 class="font-semibold mt-4 mb-2">היומן שלי:</h4>
            ${journalEntries.length > 0 ? journalEntries.map(entry => `<p class="text-sm mb-2 p-2 bg-gray-50 dark:bg-gray-900 rounded-md">${entry.text}</p>`).join('') : '<p class="text-xs text-gray-500">לא נכתבו רשומות ביומן ליום זה.</p>'}

            <h4 class="font-semibold mt-4 mb-2">התמונות שלי:</h4>
            ${galleryImages.length > 0 ? `
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    ${galleryImages.map(img => `<img src="${img.dataUrl}" class="w-full h-32 object-cover rounded-lg">`).join('')}
                </div>` : '<p class="text-xs text-gray-500">לא הועלו תמונות ליום זה.</p>'}
        </div>
        `;
    }
    container.innerHTML = scrapbookHtml || '<p class="text-center">היומן ריק. התחילו להוסיף רשומות ותמונות!</p>';
}
// ========================= סוף: לוגיקה לסקראפבוק =========================
    // ========================= התחלה: פונקציה להתראות מזג אוויר חכמות =========================
async function checkWeatherAlerts() {
    if (!lastWeatherAPIData || !localTripData.plan) return;

    const alertBox = $('#weather-alert-box');
    alertBox.innerHTML = ''; // ניקוי התראות ישנות

    // קודים של מזג אוויר גרוע (גשם, סופות רעמים)
    const badWeatherCodes = [51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99];

    // מציאת התאריך של מחר
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowString = tomorrow.toISOString().split('T')[0];

    // מציאת האינדקס של מחר בתחזית (בדרך כלל 1)
    const tomorrowIndex = lastWeatherAPIData.daily.time.findIndex(day => day === tomorrowString);
    if (tomorrowIndex === -1) return; // לא נמצאה תחזית למחר

    const tomorrowsWeatherCode = lastWeatherAPIData.daily.weathercode[tomorrowIndex];

    // בדיקה אם מזג האוויר של מחר גרוע
    if (badWeatherCodes.includes(tomorrowsWeatherCode)) {
        // מציאת התוכנית של מחר
        const tripStartDate = new Date(tripMeta.flights.inbound.date);
        const diffTime = Math.abs(tomorrow - tripStartDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const planKey = `day${diffDays}`;

        if (localTripData.plan[planKey]) {
            const tomorrowsPlan = localTripData.plan[planKey];
            const outdoorActivities = tomorrowsPlan.activities.filter(act => {
                const originalAttraction = attractions[act.id.split('_')[0]];
                return originalAttraction && originalAttraction.isOutdoor;
            });

            if (outdoorActivities.length > 0) {
                const activityNames = outdoorActivities.map(act => act.name).join(', ');
                const alertMessage = `
                    <div class="bg-yellow-100 dark:bg-yellow-900/30 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300 p-3 rounded-lg">
                        <p class="font-bold">התראה חכמה למחר!</p>
                        <p class="text-sm">צפוי גשם מחר, והתוכנית שלכם כוללת פעילויות בחוץ (${activityNames}). אולי כדאי לשקול להחליף אותן בפעילות מממאגר ההצעות.</p>
                    </div>
                `;
                alertBox.innerHTML = alertMessage;
            }
        }
    }
}
    // ========================= התחלה: פונקציה למחשבון כדאיות Pass =========================
function initPassCalculator() {
    const passes = {
        duomoPass: { name: 'Duomo Pass (גג + מוזיאון)', price: 20, keys: ['duomo'] },
        milanoCard: { name: 'MilanoCard (3 ימים)', price: 15.50, keys: ['transport'] } // מחיר תחב"צ בלבד
    };

    const attractionsList = $('#pass-attractions-list');
    const plannedAttractionKeys = Object.values(localTripData.plan || {}).flatMap(day => day.activities.map(act => act.id.split('_')[0]));

    let attractionsHtml = '';
    for (const key in attractions) {
        if (attractions[key].cost > 0) {
            const isChecked = plannedAttractionKeys.includes(key) ? 'checked' : '';
            attractionsHtml += `
                <label class="flex items-center gap-2">
                    <input type="checkbox" class="pass-attraction-checkbox rounded" value="${attractions[key].cost}" data-key="${key}" ${isChecked}>
                    ${attractions[key].name} (${attractions[key].cost}€)
                </label>
            `;
        }
    }
    attractionsList.innerHTML = attractionsHtml;

    let passInfoHtml = '';
    for (const passKey in passes) {
        passInfoHtml += `<div>${passes[passKey].name} - <b>${passes[passKey].price.toFixed(2)}€</b></div>`;
    }
    $('#pass-options-info').innerHTML = passInfoHtml;

    $('#calculate-pass-btn').addEventListener('click', () => {
        let individualCost = 0;
        const selectedKeys = [];
        $$('.pass-attraction-checkbox:checked').forEach(cb => {
            individualCost += parseFloat(cb.value);
            selectedKeys.push(cb.dataset.key);
        });

        // נוסיף עלות תחב"צ ל-3 ימים לחישוב הכללי
        individualCost += passes.milanoCard.price;

        let resultHtml = `עלות אישית כולל תחב"צ: <b class="text-red-500">${individualCost.toFixed(2)}€</b><br><hr class="my-2">`;

        // בדיקת כדאיות לדואומו פאס
        let duomoRelatedCost = 0;
        if (selectedKeys.includes('duomo')) {
            duomoRelatedCost += attractions.duomo.cost;
        }
        // (ניתן להוסיף כאן עוד אתרים שכלולים בפאס)

        if (duomoRelatedCost > passes.duomoPass.price) {
            resultHtml += `<span class="text-green-600">מומלץ לקנות את ה-Duomo Pass!</span><br>`;
        } else {
            resultHtml += `<span>עבור הדואוμο, יותר זול לקנות כרטיס בודד.</span><br>`;
        }

        $('#pass-result').innerHTML = resultHtml;
    });
}
// ========================= סוף: פונקציה למחשבון כדאיות Pass =========================
// ========================= סוף: פונקציה להתראות מזג אוויר חכמות =========================
// ========================= סוף: פונקציה לעיצוב אוטומטי לפי שעה =========================
// ========================= סוף: פונקציה למדריך קולי =========================
// ========================= סוף: פונקציית חיפוש מהיר =========================
    // --- State Modifiers (Write to Firestore) ---
    async function handleTransportChange(e) {
        const dayId = e.target.dataset.day;
        const newTransportMode = e.target.value;
        console.log(`LOG: handleTransportChange called for ${dayId}, new mode: ${newTransportMode}`);
        await updateDoc(tripDocRef, { [`plan.${dayId}.transport`]: newTransportMode });
    };
    async function removeActivity(dayId, actId) {
        console.log(`LOG: removeActivity called for day ${dayId}, activity ${actId}`);
        const day = localTripData.plan[dayId];
        const activityIndex = day.activities.findIndex(a => a.id === actId);
        if (activityIndex > -1) {
            const [removedActivity] = day.activities.splice(activityIndex, 1);
            let newSuggestions = localTripData.suggestions;
            if (removedActivity.type === 'attraction') {
                 const originalId = actId.split('_')[0];
                 const originalAttraction = attractions[originalId];
                 if (originalAttraction && !newSuggestions.find(s => s.id === originalId)) {
                     newSuggestions.push({ ...originalAttraction, id: originalId });
                 }
            }
            await updateDoc(tripDocRef, {
                plan: localTripData.plan,
                suggestions: newSuggestions
            });
        }
    };
    async function moveActivity(dayId, actId, direction) {
        console.log(`LOG: moveActivity called for ${actId} in day ${dayId}, direction ${direction}`);
        const day = localTripData.plan[dayId];
        const index = day.activities.findIndex(a => a.id === actId);
        if ((direction === -1 && index > 0) || (direction === 1 && index < day.activities.length - 1)) {
            const [item] = day.activities.splice(index, 1);
            day.activities.splice(index + direction, 0, item);
            await updateDoc(tripDocRef, { [`plan.${dayId}.activities`]: day.activities });
        }
    };
    window.navigateCarousel = (btn, dir) => {
        const carousel = btn.closest('.image-carousel');
        const images = JSON.parse(carousel.dataset.images);
        let index = parseInt(carousel.dataset.index, 10);
        index = (index + dir + images.length) % images.length;
        carousel.querySelector('img').src = images[index];
        carousel.dataset.index = index;
    };
function findNearbyAttractions() {
    showAlert('מאתר מיקום...', 'מחפש אטרקציות מומלצות בקרבתך...');
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            const url = `https://www.google.com/maps/search/tourist+attractions/@${latitude},${longitude},15z`;
            window.open(url, '_blank');
            window.closeModal();
        }, () => {
            showAlert('שגיאת מיקום', 'לא ניתן היה לקבל את מיקומך. החיפוש יתבצע ממרכז מילאנו.');
            const url = `https://www.google.com/maps/search/tourist+attractions/Duomo+di+Milano`;
            window.open(url, '_blank');
        });
    } else {
        showAlert('שגיאה', 'שירותי מיקום אינם נתמכים בדפדפן זה.');
    }
}
// And assign it to the window object
window.findNearbyAttractions = findNearbyAttractions;
    window.findNearbyKosher = (btn) => {
        const lat = parseFloat(btn.dataset.lat), lon = parseFloat(btn.dataset.lon);
        console.log(`LOG: findNearbyKosher called for ${btn.dataset.name} at ${lat}, ${lon}`);
        $('#kosher-subtitle').innerHTML = `מציג מקומות קרובים ל: <strong>${btn.dataset.name}</strong>`;
        userCoords = {lat, lon}; // Temporarily set user location
        renderKosher();
        userCoords = null; // Reset it
        $('#kosher').scrollIntoView({ behavior: 'smooth' });
        if ($('#kosher-container').classList.contains('hidden')) {
            $('#toggle-kosher-btn').click();
        }
    };
    async function toggleChecklistItem(e) {
        const itemId = e.target.dataset.id;
        const isDone = e.target.checked;
        console.log(`LOG: toggleChecklistItem called for item ${itemId}, new status: ${isDone}`);
        const labelSpan = e.target.nextElementSibling;
        if (isDone) {
            labelSpan.classList.add('line-through', 'text-gray-500');
        } else {
            labelSpan.classList.remove('line-through', 'text-gray-500');
        }

        const updatedChecklist = localTripData.checklist.map(cat => ({
            ...cat,
            items: cat.items.map(item => item.id === itemId ? { ...item, done: isDone } : item)
        }));
        if (tripDocRef) {
           await updateDoc(tripDocRef, { checklist: updatedChecklist });
        }
    };
    async function removeChecklistItem(catId, itemId) {
        console.log(`LOG: removeChecklistItem called for item ${itemId} in category ${catId}`);
        const updatedChecklist = localTripData.checklist.map(cat => {
            if (cat.id === catId) {
                return { ...cat, items: cat.items.filter(i => i.id !== itemId) };
            }
            return cat;
        }).filter(cat => cat.items.length > 0);
        await updateDoc(tripDocRef, { checklist: updatedChecklist });
    };
    
    async function removeExpense(id) {
        console.log(`LOG: removeExpense called for id ${id}`);
        const expenseToRemove = (localTripData.expenses || []).find(exp => exp.id === id);
        if (expenseToRemove) {
            await updateDoc(tripDocRef, { expenses: arrayRemove(expenseToRemove) });
        }
    };
    async function removeDocument(id) {
        console.log(`LOG: removeDocument called for id ${id}`);
        const docToRemove = (localTripData.documents || []).find(doc => doc.id === id);
        if (docToRemove) {
            await updateDoc(tripDocRef, { documents: arrayRemove(docToRemove) });
        }
    };
    async function removeImage(id) {
        console.log(`LOG: removeImage called for id ${id}`);
        const imgToRemove = (localTripData.gallery || []).find(img => img.id === id);
        if (imgToRemove) {
            await updateDoc(tripDocRef, { gallery: arrayRemove(imgToRemove) });
        }
    };
    window.reuseTranslation = (index) => {
        console.log(`LOG: Reusing translation history item at index ${index}`);
        const item = translationHistory[index];
        if (item) {
            $('#dictionary-input').value = item.sourceText;
            $('#dictionary-form').requestSubmit();
        }
    };
    window.removeTranslationHistoryItem = (event, index) => {
        event.stopPropagation(); 
        console.log(`LOG: Removing translation history item at index ${index}`);
        translationHistory.splice(index, 1);
      localStorage.setItem('milanTripTranslationHistory', JSON.stringify(translationHistory));
        renderTranslationHistory();
    };
    window.openDayMap = (dayId) => {
        console.log(`LOG: openDayMap called for ${dayId}`);
        const day = localTripData.plan[dayId];
        if (!day || !day.activities || day.activities.length === 0) {
            showAlert('אין מיקומים', 'אין פעילויות עם כתובות ביום זה כדי להציג על המפה.');
            return;
        }
        const locations = day.activities
            .map(act => act.address)
            .filter(address => address); 
        
        if (locations.length < 1) {
             showAlert('אין מיקומים', 'אין פעילויות עם כתובות ביום זה כדי להציג על המפה.');
             return;
        }

        const url = `https://www.google.com/maps/dir/${locations.map(encodeURIComponent).join('/')}`;
        window.open(url, '_blank');
    };

    // --- Camera Functions ---
async function startCamera() {
    console.log("LOG: startCamera called.");
    const video = $('#camera-feed');
    const titles = { translate: "תרגם מתמונה", receipt: "סרוק קבלה", lookup: "זיהוי אובייקט" };
    $('#camera-title').textContent = titles[cameraMode] || "מצלמה";

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = cameraStream;
            video.play();
            activeVideoTrack = cameraStream.getVideoTracks()[0]; // Store the track globally
            $('#torch-btn').classList.remove('text-yellow-400'); // Reset torch button
            $('#camera-modal').classList.add('flex');
        } catch (err) {
            console.error("ERROR: Error accessing camera: ", err);
            showAlert("שגיאת מצלמה", "לא ניתן לגשת למצלמה. ודא שהענקת הרשאות לדפדפן.");
        }
    } else {
        showAlert("מצלמה לא נתמכת", "הדפדפן שלך לא תומך בגישה למצלמה.");
    }
}
// ========================= התחלה: קוד מתוקן ומשופר להפעלת הפנס =========================
async function toggleTorch() {
    const torchBtn = $('#torch-btn');
    if (!activeVideoTrack) {
        console.error("Torch Error: Video track not available.");
        showAlert('שגיאת פנס', 'נתיב הוידאו של המצלמה אינו פעיל.');
        return;
    }

    // בדיקה אם הדפדפן/מכשיר בכלל תומך ביכולת הזו
    if (typeof activeVideoTrack.getCapabilities !== 'function' || !activeVideoTrack.getCapabilities().torch) {
        showAlert('פנס לא נתמך', 'נראה שהמכשיר או הדפדפן אינם תומכים בשליטה על הפנס דרך האתר.');
        return;
    }

    try {
        // קובעים את המצב הרצוי (ההפך מהמצב הנוכחי)
        const currentTorchState = activeVideoTrack.getSettings().torch || false;
        const desiredState = !currentTorchState;

        // שולחים בקשה מסודרת לשינוי המצב
        await activeVideoTrack.applyConstraints({
            advanced: [{ torch: desiredState }]
        });

        // מעדכנים את הכפתור רק לאחר שהפעולה הצליחה
        torchBtn.classList.toggle('text-yellow-400', desiredState);
        console.log(`LOG: Torch state successfully changed to ${desiredState}`);

    } catch (err) {
        console.error('Error controlling torch:', err);
        showAlert('שגיאת פנס', `לא הצלחנו לשנות את מצב הפנס. שגיאה: ${err.name}`);
    }
}
// ========================= סוף: קוד מתוקן ומשופר להפעלת הפנס =========================
function stopCamera() {
    console.log("LOG: stopCamera called.");
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
    }
    activeVideoTrack = null; // Clear the stored track
    $('#camera-modal').classList.remove('flex');
}
function captureFrame() {
    console.log(`LOG: Capturing frame for mode: ${cameraMode}`);
    const video = $('#camera-feed');
    const canvas = $('#camera-canvas');
    const context = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const dataUrl = canvas.toDataURL('image/jpeg');
    const base64ImageData = dataUrl.split(',')[1];

    stopCamera();

    if (cameraMode === 'translate') {
        translateImage(base64ImageData, 'image/jpeg');
    } else if (cameraMode === 'receipt') {
        processReceiptImage(base64ImageData);
    } else if (cameraMode === 'lookup') {
        processLookupImage(base64ImageData);
    }
}

async function processReceiptImage(base64ImageData) {
    showAlert('מעבד קבלה...', '<div class="text-center"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p class="mt-2">קורא את הפרטים מהקבלה בעזרת AI...</p></div>');

   const prompt = `You are an expert receipt-scanning AI. Analyze this image of a receipt, which could be in any language (like Italian or Hebrew). Your goal is to identify the final, total amount paid and the name of the store/vendor. Respond ONLY with a valid JSON object in the format {"amount": NUMBER, "description": "STRING"}. The 'amount' should be the single, final, total sum. The 'description' should be the most likely name of the vendor. If you cannot reliably determine both values, return {"error": "Could not read receipt clearly"}.`;
    const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: 'image/jpeg', data: base64ImageData } }] }] };

    const responseText = await callGemini(payload, '', false);

    try {
        const result = JSON.parse(responseText);
        if (result.error) {
            showAlert('שגיאה', 'לא הצלחנו לקרוא את הפרטים מהקבלה. נסו שוב בתאורה טובה יותר.');
        } else {
            $('#expense-amount').value = result.amount || '';
            $('#expense-desc').value = result.description || '';
            window.closeModal();
        }
    } catch (e) {
        console.error("Error parsing Gemini receipt response:", e);
        showAlert('שגיאה', 'התקבלה תשובה לא תקינה מהשרת. נסו שוב.');
    }
}
async function processLookupImage(base64ImageData) {
    showAlert('מזהה אובייקט...', '<div class="text-center"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p class="mt-2">מנתח את התמונה ושולח לזיהוי...</p></div>');
    const prompt = "Analyze this image. Identify the main landmark, artwork, or object. Provide a short, interesting paragraph about it in Hebrew. If you can't identify it, say so. Respond only with the Hebrew text.";
    const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: 'image/jpeg', data: base64ImageData } }] }] };
    const description = await callGemini(payload, '', false);
    showAlert('זיהוי אובייקט', description, true, { text: description, lang: 'he-IL' });
}



    // --- Gemini Calls ---
    async function callGemini(payload, prompt, useSearch = false) {
        console.log(`LOG: callGemini called. Use search: ${useSearch}. Prompt: ${prompt.substring(0, 100)}...`);
        payload.contents[0].parts[0].text = prompt;
        if (useSearch) {
            // FIX 4: Changed 'google_search' to 'tools' with 'google_search_retrieval'
            payload.tools = [{ "google_search_retrieval": {} }];
        } else {
           if(payload.tools) delete payload.tools;
        }

        const apiKey = "AIzaSyB80v2xdhebJqhjyruJ5Ta0eyhJiq7DsI8"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) {
                console.error("ERROR: Gemini API response not OK.", result);
                throw new Error(result.error?.message || `שגיאת רשת: ${response.status}`);
            }
            console.log("LOG: Gemini API call successful.");
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return text || "לא התקבלה תשובה מ-Gemini.";

        } catch (error) {
            console.error("ERROR: Gemini API Error:", error);
            return `שגיאה: ${error.message}`;
        }
    }
    window.speakText = (text, lang) => {
        console.log(`LOG: speakText called for lang ${lang}. Text: ${text}`);
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        speechSynthesis.speak(utterance);
    }

    async function translateText(text) {
        console.log(`LOG: translateText called for text: ${text}`);
        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
        const targetLang = currentLang === 'he-it' ? 'Italian' : 'Hebrew';
        const prompt = `Translate the following to ${targetLang}. Provide ONLY the translated text, with no additional formatting or explanations. Text to translate: "${text}"`;
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        let responseText = await callGemini(payload, prompt, false);
        responseText = responseText.replace(/[\*\_`]/g, '').trim();
        const langCode = currentLang === 'he-it' ? 'it-IT' : 'he-IL';
        resultContainer.innerHTML = `<span>${responseText}</span> <button onclick="window.speakText('${responseText.replace(/'/g, "\\'")}', '${langCode}')" class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;
        
        translationHistory.unshift({ sourceText: text, translatedText: responseText });
        if (translationHistory.length > 5) translationHistory.pop(); // Keep last 5
      localStorage.setItem('milanTripTranslationHistory', JSON.stringify(translationHistory));
        renderTranslationHistory();
    }
    
    async function translateImage(base64ImageData, mimeType) {
        console.log(`LOG: translateImage called for mimeType: ${mimeType}`);
        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
        const targetLang = currentLang === 'he-it' ? 'Italian' : 'Hebrew';
        const prompt = `Extract any text from this image and translate it to ${targetLang}. Provide ONLY the translated text, with no additional formatting. If no text is found, respond with "לא נמצא טקסט".`;
        const payload = { contents: [{ parts: [{ text: "" }, { inlineData: { mimeType: mimeType, data: base64ImageData } }] }] };
        let responseText = await callGemini(payload, prompt, false);
        responseText = responseText.replace(/[\*\_`]/g, '').trim();
        const langCode = currentLang === 'he-it' ? 'it-IT' : 'he-IL';
        resultContainer.innerHTML = `<span>${responseText}</span> <button onclick="window.speakText('${responseText.replace(/'/g, "\\'")}', '${langCode}')" class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;
    }

    async function askGeneralGemini() {
        console.log("LOG: askGeneralGemini called.");
        const userPrompt = $('#gemini-prompt').value;
        if (!userPrompt) return;

        const responseContainer = $('#gemini-response');
        const submitBtn = $('#gemini-submit-btn');
        submitBtn.disabled = true;
        responseContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> חושב...`;
        
        const containsHebrew = /[\u0590-\u05FF]/.test(userPrompt);
        const finalPrompt = containsHebrew 
            ? `${userPrompt}\n\n(Please provide the answer in Hebrew)`
            : userPrompt;

        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const responseText = await callGemini(payload, finalPrompt, true);

        responseContainer.textContent = responseText;
        submitBtn.disabled = false;
    }
    
    async function fetchSafetyWarnings() {
        console.log("LOG: fetchSafetyWarnings called.");
        const container = $('#safety-warnings-content');
        container.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> מאתר מידע עדכני...`;
        
        const today = new Date().toLocaleDateString('en-CA');
        const prompt = `As a safety advisor, check for any significant demonstrations, public transport strikes, or specific safety warnings for tourists in Milan, Italy, specifically for today's date: ${today}. Provide a concise summary in Hebrew. If your web search finds no specific warnings, state that clearly and mention that the information is current as of today.`;
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const responseText = await callGemini(payload, prompt, true);
        
        container.textContent = responseText;
    }

    async function generateTripSummary() {
        console.log("LOG: generateTripSummary called.");
        showAlert('יוצר סיכום...', 'אוסף את כל החוויות והנתונים כדי ליצור סיכום אישי... זה עשוי לקחת רגע.', false);
        
        const { plan, expenses, journal } = localTripData;
        
        let placesVisited = [];
        if(plan) {
            Object.values(plan).forEach(day => {
                (day.activities || []).forEach(act => {
                    if (!placesVisited.includes(act.name)) placesVisited.push(act.name);
                });
            });
        }
        
        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        
        let journalEntries = [];
        if (journal) {
            Object.values(journal).forEach(dayEntries => {
                (dayEntries || []).forEach(entry => journalEntries.push(entry.text));
            });
        }

        const prompt = `
            Act as a creative travel blogger writing a personal trip summary. Based on the following data from a trip to Milan, create a warm, engaging, and experiential summary in Hebrew.
            The summary should feel like a personal memory, not just a list. Use paragraphs and an enthusiastic tone.
            
            Data:
            - Places Visited: ${placesVisited.join(', ')}.
            - Total Spent: Approximately ${totalExpenses.toFixed(0)} euros.
            - Personal Journal Notes: ${journalEntries.join('; ')}.
            
            Please generate the summary now.
        `;
        
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const summaryText = await callGemini(payload, prompt, false);
        
        showAlert('סיכום הטיול שלכם!', summaryText, true);
    }

    // --- NEW PWA & Smart Features ---
    window.optimizeDayRoute = async (dayId) => {
        console.log(`LOG: optimizeDayRoute called for ${dayId}`);
        const day = localTripData.plan[dayId];
        if (!day || !day.activities || day.activities.length < 2) {
            showAlert('לא ניתן לבצע אופטימיזציה', 'צריך לפחות שתי פעילויות ביום כדי לייעל את המסלול.');
            return;
        }

        showAlert('מבצע אופטימיזציה...', 'מסדר מחדש את הפעילויות כדי לחסוך לך זמן...');
        
        let activities = [...day.activities];
        let optimizedRoute = [activities.shift()]; // Start with the first activity
        
        while (activities.length > 0) {
            let lastPoint = optimizedRoute[optimizedRoute.length - 1];
            let nearestIndex = -1;
            let minDistance = Infinity;

            activities.forEach((activity, index) => {
                const distance = haversineKm(lastPoint.coords?.lat, lastPoint.coords?.lon, activity.coords?.lat, activity.coords?.lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestIndex = index;
                }
            });

            if (nearestIndex > -1) {
                optimizedRoute.push(activities.splice(nearestIndex, 1)[0]);
            } else {
                break; 
            }
        }
        
        await updateDoc(tripDocRef, { [`plan.${dayId}.activities`]: optimizedRoute });
        showAlert('המסלול עבר אופטימיזציה!', 'סדר הפעילויות עודכן ליום זה.');
    };

    window.generateIcsFile = (dayId) => {
        console.log(`LOG: generateIcsFile called for ${dayId}`);
        const day = localTripData.plan[dayId];
        const dayIndex = Object.keys(localTripData.plan).sort((a,b) => a.localeCompare(b[0])).indexOf(dayId);
        const tripStartDate = new Date(tripMeta.flights.inbound.date);
        const eventDate = new Date(tripStartDate.setDate(tripStartDate.getDate() + dayIndex));
        const eventDateStr = eventDate.toISOString().split('T')[0].replace(/-/g, '');

        const timeMap = { 'בוקר': '090000', 'צהריים': '140000', 'ערב': '190000' };
        const durationMap = { 'בוקר': 3, 'צהריים': 4, 'ערב': 4 };

        let icsContent = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//MilanTrip/Planner//EN',
        ];

        day.activities.forEach(activity => {
            const startTime = timeMap[activity.time] || '120000';
            const durationHours = durationMap[activity.time] || 2;
            const startDateTime = `${eventDateStr}T${startTime}`;
            const endHour = parseInt(startTime.substring(0, 2), 10) + durationHours;
            const endDateTime = `${eventDateStr}T${String(endHour).padStart(2, '0')}0000`;

            icsContent.push(
                'BEGIN:VEVENT',
                `UID:${activity.id}@milantrip.app`,
                `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '')}Z`,
                `DTSTART;TZID=Europe/Rome:${startDateTime}`,
                `DTEND;TZID=Europe/Rome:${endDateTime}`,
                `SUMMARY:${activity.name}`,
                `DESCRIPTION:${activity.description || ''}`,
                `LOCATION:${activity.address || ''}`,
                'END:VEVENT'
            );
        });
        icsContent.push('END:VCALENDAR');

        const blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${day.name}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    async function getSmartAdvice() {
        console.log("LOG: getSmartAdvice called.");
        const responseContainer = $('#gemini-response');
        const submitBtn = $('#get-smart-advice-btn');
        submitBtn.disabled = true;
        responseContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> היועץ החכם בודק את הנתונים...`;
        
        const remainingBudget = (localTripData.totalBudget || 0) - (localTripData.expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        let weatherInfo = "No weather data available.";
        if(lastWeatherAPIData) {
            weatherInfo = `Today's forecast is a high of ${lastWeatherAPIData.daily.temperature_2m_max[0]}°C and a low of ${lastWeatherAPIData.daily.temperature_2m_min[0]}°C. Weather code: ${lastWeatherAPIData.daily.weathercode[0]}.`
        }
        
        const milanTime = new Date().toLocaleTimeString('en-US', { timeZone: 'Europe/Rome', hour: '2-digit', minute: '2-digit', hour12: false });
        
        const prompt = `
            As a smart travel advisor for a trip to Milan, provide a short, actionable recommendation in Hebrew based on the following context. Be friendly and helpful.
            
            Context:
            - Current time in Milan: ${milanTime}
            - Current weather situation: ${weatherInfo} (Weather codes: 0-3=Clear/Cloudy, 51-67=Rain, 71-86=Snow, 95+=Thunderstorm)
            - Remaining trip budget: €${remainingBudget.toFixed(0)}
            
            Based on this context, what is one useful suggestion you can give me right now? For example, if it's evening and raining, suggest an indoor attraction or a specific type of restaurant. If the budget is low, suggest a free activity.
        `;

        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const advice = await callGemini(payload, prompt, false);
        responseContainer.textContent = advice;
        submitBtn.disabled = false;
    }
    // ========================= התחלה: קוד למפה במצב בהיר קבוע =========================
function initLiveMap() {
    console.log("LOG: initLiveMap called.");
    if (liveMap) return;
    liveMap = L.map('live-location-map').setView([45.4642, 9.1916], 12);

    // הגדרה של שכבת המפה הבהירה בלבד
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(liveMap);
}
// ========================= סוף: קוד למפה במצב בהיר קבוע =========================
    // --- LIVE LOCATION FUNCTIONS ---

    async function updateLocationInFirestore(position) {
        if (!currentUserId) return;
        const { latitude, longitude } = position.coords;
        const userName = $('#user-name-input').value.trim() || `משתמש ${currentUserId.substring(0,4)}`;
        const userLocationDocRef = doc(locationsColRef, currentUserId);
        
        console.log(`LOG: Updating location for ${userName} in Firestore.`);
        await setDoc(userLocationDocRef, {
            lat: latitude,
            lng: longitude,
            name: userName,
            timestamp: serverTimestamp()
        });
        $('#location-status').textContent = `מיקום עודכן: ${new Date().toLocaleTimeString()}`;
    }

    function listenForLocationUpdates() {
        console.log("LOG: Setting up listener for location updates.");
        onSnapshot(locationsColRef, (snapshot) => {
            console.log("LOG: Received location snapshot update.");
            snapshot.docs.forEach(doc => {
                const locData = doc.data();
                const uid = doc.id;
                const latLng = [locData.lat, locData.lng];
                const displayName = (uid === currentUserId) ? `אתה (${locData.name})` : locData.name;

                if (userMarkers[uid]) {
                    userMarkers[uid].setLatLng(latLng);
                    userMarkers[uid].getPopup().setContent(displayName);
                } else {
                    userMarkers[uid] = L.marker(latLng).addTo(liveMap)
                        .bindPopup(displayName)
                        .openPopup();
                }
            });
            // Optional: remove markers for users who are no longer sharing
            const currentUids = snapshot.docs.map(d => d.id);
            Object.keys(userMarkers).forEach(uid => {
                if (!currentUids.includes(uid)) {
                    liveMap.removeLayer(userMarkers[uid]);
                    delete userMarkers[uid];
                }
            });
        });
    }

    async function toggleLocationSharing() {
        console.log("LOG: toggleLocationSharing called.");
        const btn = $('#toggle-location-sharing-btn');
        const status = $('#location-status');
        if (watchingLocation) {
            console.log("LOG: Stopping location sharing.");
            navigator.geolocation.clearWatch(watchId);
            watchingLocation = false;
            watchId = null;
            btn.innerHTML = '<i class="fa-solid fa-tower-broadcast mr-2"></i>הפעל שיתוף מיקום';
            btn.classList.remove('bg-red-600', 'hover:bg-red-700');
            status.textContent = 'שיתוף מיקום כבוי.';
            if (currentUserId) {
                const userLocationDocRef = doc(locationsColRef, currentUserId);
                await deleteDoc(userLocationDocRef);
            }
        } else {
            console.log("LOG: Starting location sharing.");
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(updateLocationInFirestore, (error) => {
                    console.error("ERROR: Error getting location:", error);
                    showAlert("שגיאת מיקום", "לא ניתן היה לקבל את מיקומך. ודא שאישרת הרשאות מיקום לדפדפן.");
                }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
                watchingLocation = true;
                btn.innerHTML = '<i class="fa-solid fa-stop-circle mr-2"></i>הפסק שיתוף מיקום';
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                status.textContent = 'משתף מיקום...';
            } else {
                showAlert("לא נתמך", "הדפדפן שלך אינו תומך בשיתוף מיקום.");
            }
        }
    }
    
    // --- FIX 1 & 2: REWRITTEN JOURNAL FUNCTIONS ---
    async function addJournalEntry(dayId, text) {
        console.log(`LOG: addJournalEntry called for day ${dayId}`);
        if (!tripDocRef) {
            console.error("ERROR: tripDocRef is not initialized. Cannot add journal entry.");
            return;
        }
        const newEntry = {
            id: Date.now().toString(),
            text: text,
            timestamp: new Date()
        };
        await updateDoc(tripDocRef, {
            [`journal.${dayId}`]: arrayUnion(newEntry)
        });
    }

    async function removeJournalEntry(dayId, entryId) {
        console.log(`LOG: removeJournalEntry called for entry ${entryId} in day ${dayId}`);
        if (!isFirebaseConnected) {
            showAlert('אין חיבור', 'לא ניתן למחוק כעת. אנא המתן לסנכרון מלא עם השרת.');
            return;
        }
        if (!tripDocRef) {
             console.error("ERROR: tripDocRef is not initialized. Cannot remove journal entry.");
            return;
        }
        
        const journalForDay = localTripData.journal?.[dayId] || [];
        
        // This is the critical part: Firestore's arrayRemove needs the *exact* object to remove.
        // We find the object in our local data based on the unique ID.
        const entryToRemove = journalForDay.find(e => e.id === entryId);

        if (entryToRemove) {
             console.log("LOG: Found entry to remove locally, attempting to remove from Firestore.");
            await updateDoc(tripDocRef, {
                [`journal.${dayId}`]: arrayRemove(entryToRemove)
            });
        } else {
            console.error("ERROR: Could not find journal entry to remove. This might happen if the data is not yet synced.");
        }
    }

    function renderJournal(dayId, entries = []) {
        console.log(`LOG: renderJournal called for day ${dayId}`);
        const getTimestampDate = (ts) => {
            if (!ts) return new Date();
            if (typeof ts.toDate === 'function') return ts.toDate(); 
            if (ts.seconds) return new Date(ts.seconds * 1000); 
            return new Date(); 
        };

        const validEntries = Array.isArray(entries) ? entries : [];
        const entriesHtml = validEntries
            .sort((a, b) => getTimestampDate(b.timestamp).getTime() - getTimestampDate(a.timestamp).getTime())
            .map(entry => {
                const dateString = getTimestampDate(entry.timestamp).toLocaleString('he-IL', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                return `
                <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg relative group">
                    <p class="text-sm whitespace-pre-wrap">${entry.text}</p>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${dateString}</div>
                    <button class="absolute top-2 left-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="window.removeJournalEntry('${dayId}', '${entry.id}')">
                        <i class="fa-solid fa-trash-alt fa-xs"></i>
                    </button>
                </div>`;
        }).join('');

        return `<div class="mt-6 border-t pt-4">
            <h4 class="font-bold text-lg mb-2">יומן מסע</h4>
            <div id="journal-entries-${dayId}" class="space-y-3 mb-3">${entriesHtml}</div>
            <form id="journal-form-${dayId}" class="flex gap-2">
                <input type="text" id="journal-text-${dayId}" placeholder="הוסף חוויה מהיום..." class="w-full p-2 rounded-lg border">
                <button type="submit" class="btn btn-primary">שלח</button>
            </form>
        </div>`;
    }
// ==========================================================
// התחלה: קוד מתוקן ומשופר לתרגום קולי
// ==========================================================
const recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let speechRecognizer = null;
let isRecognizing = false;
let activeVoiceButton = null;

if (recognition) {
    speechRecognizer = new recognition();
    speechRecognizer.continuous = false;
    speechRecognizer.interimResults = false;

    speechRecognizer.onstart = () => {
        isRecognizing = true;
        if (activeVoiceButton) {
            activeVoiceButton.innerHTML = '<i class="fa-solid fa-microphone-lines fa-beat"></i> מקשיב...';
            activeVoiceButton.classList.add('text-red-500');
        }
        $('#translation-result-container').innerHTML = '<span>מקשיב...</span>';
    };

    speechRecognizer.onend = () => {
        isRecognizing = false;
        if (activeVoiceButton) {
            const originalText = activeVoiceButton.id.includes('he') ? '<i class="fa-solid fa-microphone"></i> דבר בעברית' : '<i class="fa-solid fa-microphone"></i> Parla Italiano';
            activeVoiceButton.innerHTML = originalText;
            activeVoiceButton.classList.remove('text-red-500');
            activeVoiceButton = null;
        }
    };

    speechRecognizer.onerror = (event) => {
        console.error("Speech recognition error", event.error);
        $('#translation-result-container').innerHTML = `<span class="text-red-500">שגיאה בזיהוי הדיבור: ${event.error}</span>`;
    };

    speechRecognizer.onresult = async (event) => {
        const spokenText = event.results[0][0].transcript;
        const sourceLang = speechRecognizer.lang;
        console.log(`Speech recognized in ${sourceLang}: ${spokenText}`);

        let sourceLangFull, targetLangFull, targetLangCode;

        if (sourceLang === 'he-IL') {
            sourceLangFull = 'Hebrew';
            targetLangFull = 'Italian';
            targetLangCode = 'it-IT';
        } else { // 'it-IT'
            sourceLangFull = 'Italian';
            targetLangFull = 'Hebrew';
            targetLangCode = 'he-IL';
        }

        $('#dictionary-input').value = spokenText;

        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> מתרגם...`;

        // Prompt משופר כדי להבטיח תרגום ולא תעתיק
        const prompt = `Translate the meaning of the following word/phrase from ${sourceLangFull} to ${targetLangFull}. Provide ONLY the single, most common translated word/phrase, with no additional formatting or explanations. Word/phrase to translate: "${spokenText}"`;
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        let translatedText = await callGemini(payload, prompt, false);
        translatedText = translatedText.replace(/[\*\_`\.]/g, '').trim();

        // תיקון: הוספת כפתור ההשמעה
        resultContainer.innerHTML = `<span>${translatedText}</span> <button onclick="window.speakText('${translatedText.replace(/'/g, "\\'")}', '${targetLangCode}')" class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;

        // בונוס: הוספת התרגום להיסטוריה, בדיוק כמו בתרגום טקסט רגיל
        translationHistory.unshift({ sourceText: spokenText, translatedText: translatedText });
        if (translationHistory.length > 5) translationHistory.pop();
        localStorage.setItem('milanTripTranslationHistory', JSON.stringify(translationHistory));
        renderTranslationHistory();
    };

} else {
    console.warn("Web Speech API is not supported in this browser.");
}
// ==========================================================
// סוף: קוד מתוקן ומשופר לתרגום קולי
// ==========================================================

    // --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("LOG: DOMContentLoaded event fired. Initializing app.");

    // --- Expose functions to window for onclick attributes ---
    window.handleTransportChange = handleTransportChange;
    window.removeActivity = removeActivity;
    window.moveActivity = moveActivity;
    window.toggleChecklistItem = toggleChecklistItem;
    window.removeChecklistItem = removeChecklistItem;
    window.removeJournalEntry = removeJournalEntry;
    window.removeExpense = removeExpense;
    window.removeDocument = removeDocument;
    window.removeImage = removeImage;
    window.findUtility = findUtility;
    window.getAudioGuide = getAudioGuide;
    initMetroHelper();

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(registration => console.log('LOG: Service Worker registered with scope:', registration.scope))
                .catch(error => console.log('ERROR: Service Worker registration failed:', error));
        });
    }

    // --- Firebase Initialization ---
    const firebaseConfig = {
      apiKey: "AIzaSyB80v2xdhebJqhjyruJ5Ta0eyhJiq7DsI8",
      authDomain: "trip-to-milan.firebaseapp.com",
      projectId: "trip-to-milan",
      storageBucket: "trip-to-milan.firebasestorage.app",
      messagingSenderId: "305191186184",
      appId: "1:305191186184:web:fff1488b64a06942dfc6bd",
      measurementId: "G-P17LYZJ2H0"
    };

    const app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(err => console.warn(`WARN: Firestore persistence failed. Code: ${err.code}`));

    // --- Caching and Sharing Logic ---
    let tripId = window.location.hash.substring(1);
    if (!tripId) {
        tripId = Math.random().toString(36).substring(2, 12);
        window.location.hash = tripId;
    }
    $('#user-name-input').value = localStorage.getItem('userName') || '';

    const cachedData = localStorage.getItem(`tripData_${tripId}`);
    if (cachedData) {
        try {
            localTripData = JSON.parse(cachedData);
          
        } catch(e) {
             console.error("ERROR: Failed to parse cached data.", e);
             localStorage.removeItem(`tripData_${tripId}`);
        }
    }

    signInAnonymously(auth).catch(error => showAlert("שגיאת התחברות ל-Firebase", `ההתחברות האנונימית נכשלה. ${error.message}`));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        tripDocRef = doc(db, "milantrip", tripId);
        locationsColRef = collection(db, "milantrip", tripId, "locations");

        initLiveMap();
        listenForLocationUpdates();

        onSnapshot(tripDocRef, async (docSnap) => {
            if (!isFirebaseConnected) {
                const statusIcon = $('#sync-status i');
                const statusText = $('#sync-status span');
                statusIcon.classList.replace('text-yellow-500', 'text-green-500');
                statusText.textContent = 'מחובר';
                isFirebaseConnected = true;
            }
            if (docSnap.exists()) {
                localTripData = docSnap.data();
            } else {
                localTripData = getInitialTripData();
                await setDoc(tripDocRef, localTripData);
            }
            localStorage.setItem(`tripData_${tripId}`, JSON.stringify(localTripData));

            // --- Render all components with fresh data ---
            renderAllPlans(localTripData.plan);
            renderSuggestions(localTripData.suggestions);
            renderKosher();
            renderChecklist(localTripData.checklist);
            renderBudget(localTripData);
            renderDocuments(localTripData.documents);
            renderGallery(localTripData.gallery);
            initPassCalculator();
            renderScrapbook();
        }, (error) => {
            console.error("ERROR: Firestore snapshot error:", error);
            const statusIcon = $('#sync-status i');
            const statusText = $('#sync-status span');
            statusIcon.classList.remove('text-green-500', 'text-yellow-500');
            statusIcon.classList.add('text-red-500');
            statusText.textContent = 'בעיית סנכרון';
        });
      }
    });

    // --- Initial Renders & Fetches ---
    console.log("LOG: Performing initial renders and fetches.");
    renderOverview();
    renderKosherFilters();
    fetchWeather();
    fetchExchangeRate();
    showDailyTip();
    fetchSafetyWarnings();
    renderTranslationHistory();
    renderMobileNavSubmenus();
    fetchZmanim();
    updateClocks();
    setInterval(updateClocks, 1000);

    const ctx = document.getElementById('transportChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: { labels: ['נסיעה בודדת', 'כרטיס יומי', 'כרטיס ל-3 ימים'], datasets: [{ label: 'עלות באירו', data: [2.20, 7.60, 15.50], backgroundColor: ['rgba(59,130,246,.6)','rgba(37,99,235,.6)','rgba(29,78,216,.6)'], borderColor: ['#3b82f6','#2563eb','#1d4ed8'], borderWidth: 1 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
    });

    // --- Event Listeners ---
    console.log("LOG: Adding main event listeners.");
    $('#theme-toggle').addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        if(tripDocRef && isFirebaseConnected) updateDoc(tripDocRef, { theme: isDark ? 'dark' : 'light' });
    });

    $('#show-tip-btn').addEventListener('click', openTipModal);
    $('#create-summary-btn').addEventListener('click', generateTripSummary);
    $('#refresh-warnings-btn').addEventListener('click', fetchSafetyWarnings);

    $('#collapse-all').addEventListener('click', () => $$('#plan-content-container details').forEach(d => d.removeAttribute('open')));
    $('#expand-all').addEventListener('click', () => $$('#plan-content-container details').forEach(d => d.setAttribute('open', true)));
    $('#print-btn').addEventListener('click', () => window.print());

    $('#add-checklist-item-form').addEventListener('submit', async e => {
        e.preventDefault();
        if(!isFirebaseConnected) { showAlert('שגיאת סנכרון', 'אין חיבור למסד הנתונים.'); return; }
        const text = $('#new-item-text').value.trim(); if (!text) return;
        let categoryName = $('#new-category-text').value.trim() || $('#category-select').value;
        if (!categoryName) { showAlert('שגיאה', 'יש לבחור או ליצור קטגוריה.'); return; }

        let updatedChecklist = [...(localTripData.checklist || [])];
        let category = updatedChecklist.find(c => c.category === categoryName);
        if (!category) {
            category = { id: 'cat' + Date.now(), category: categoryName, items: [] };
            updatedChecklist.push(category);
        }
        category.items.push({ id: `c${Date.now()}`, text, done: false });

        await updateDoc(tripDocRef, { checklist: updatedChecklist });
        e.target.reset();
    });

    $('#expense-form').addEventListener('submit', async e => {
        e.preventDefault();
        if(!isFirebaseConnected) { showAlert('שגיאת סנכרון', 'אין חיבור למסד הנתונים.'); return; }
        const desc = $('#expense-desc').value.trim();
        const amount = parseFloat($('#expense-amount').value);
        const category = $('#expense-category').value;
        if(desc && !isNaN(amount) && category) {
            const newExpense = {id: Date.now().toString(), desc, amount, category};
            await updateDoc(tripDocRef, { expenses: arrayUnion(newExpense) });
            e.target.reset();
        } else {
            showAlert('שגיאה', 'יש למלא את כל השדות כולל קטגוריה.');
        }
    });

    $('#total-budget').addEventListener('input', async e => {
        if(!isFirebaseConnected) { return; }
        const newTotalBudget = parseFloat(e.target.value) || 0;
        if (tripDocRef) await updateDoc(tripDocRef, { totalBudget: newTotalBudget });
    });

    $('#include-estimated-costs').addEventListener('change', async e => {
        if(!isFirebaseConnected) { return; }
        const include = e.target.checked;
        await updateDoc(tripDocRef, { 'settings.includeEstimatedCostsInBalance': include });
    });

    $('#calculate-estimated-btn').addEventListener('click', () => {
        const estimatedCosts = calculateEstimatedCosts(localTripData.plan);
        showAlert('עלות משוערת', `העלות המשוערת לאטרקציות בתוכנית עבור זוג היא: €${estimatedCosts.toFixed(2)}.`);
    });

    $('#toggle-suggestions-btn').addEventListener('click', e => {
        const container = $('#suggestions-container');
        const isHidden = container.classList.toggle('hidden');
        e.target.textContent = isHidden ? 'הצג הצעות נוספות' : 'הסתר הצעות';
    });

    $('#toggle-kosher-btn').addEventListener('click', e => {
        const container = $('#kosher-container');
        const isHidden = container.classList.toggle('hidden');
        e.target.textContent = isHidden ? 'הצג מדריך כשרות' : 'הסתר מדריך כשרות';
    });

    $('#eur-input').addEventListener('input', e => {
        const eur = parseFloat(e.target.value);
        $('#ils-input').value = isNaN(eur) ? '' : (eur * eurToIlsRate).toFixed(2);
    });
    $('#ils-input').addEventListener('input', e => {
        const ils = parseFloat(e.target.value);
        $('#eur-input').value = isNaN(ils) ? '' : (ils / eurToIlsRate).toFixed(2);
    });

    $('#dictionary-form').addEventListener('submit', async e => { e.preventDefault(); const input = $('#dictionary-input').value.trim(); if (input) await translateText(input); });

    $('#swap-lang-btn').addEventListener('click', () => {
        const inputEl = $('#dictionary-input'); const labelEl = $('#lang-direction-label');
        currentLang = (currentLang === 'he-it') ? 'it-he' : 'he-it';
        inputEl.placeholder = (currentLang === 'he-it') ? 'הקלד מילה...' : 'Scrivi una parola...';
        labelEl.innerHTML = (currentLang === 'he-it') ? 'עברית <i class="fa-solid fa-arrow-right-long"></i> איטלקית' : 'איטלקית <i class="fa-solid fa-arrow-right-long"></i> עברית';
        inputEl.value = '';
    });


    $('#image-translate-upload').addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => { const base64String = event.target.result.split(',')[1]; translateImage(base64String, file.type); };
        reader.readAsDataURL(file);
    });

    $('#document-upload-btn').addEventListener('click', () => $('#document-upload').click());
    $('#image-upload-btn').addEventListener('click', () => {
    const opts = $('#modal-upload-day-options');
    opts.innerHTML = Object.entries(localTripData.plan).sort((a,b) => a[0].localeCompare(b[0])).map(([dayId, dayData]) => 
        `<button class="btn btn-primary" data-day-id="${dayId}">${dayData.name}</button>`
    ).join('');

    $$('#modal-upload-day-options button').forEach(btn => {
        btn.onclick = () => {
            const selectedDayId = btn.dataset.dayId;
            window.closeModal();
            $('#image-upload').setAttribute('data-day-id', selectedDayId);
            $('#image-upload').click();
        };
    });

    $('#select-day-for-upload-modal').classList.add('flex');
});

    $('#alert-modal-close').addEventListener('click', () => $('#alert-modal').classList.remove('flex'));
    $('#alert-modal-copy-btn').addEventListener('click', (e) => {
        navigator.clipboard.writeText($('#alert-modal-body').textContent).then(() => {
            e.target.textContent = 'הועתק!';
            setTimeout(() => e.target.innerHTML = '<i class="fa-solid fa-copy mr-1"></i>העתק', 2000);
        });
    });

    $('#daily-tip-close').addEventListener('click', () => $('#daily-tip-modal').classList.remove('flex'));

    $('#document-upload').addEventListener('change', (e) => {
        for (const file of e.target.files) {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const newDoc = { id: Date.now().toString(), name: file.name, dataUrl: ev.target.result };
                if (tripDocRef) await updateDoc(tripDocRef, { documents: arrayUnion(newDoc) });
            };
            reader.readAsDataURL(file);
        }
    });

    $('#image-upload').addEventListener('change', (e) => {
        for (const file of e.target.files) {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const newImg = { id: Date.now().toString(), name: file.name, dataUrl: ev.target.result };
                if (tripDocRef) await updateDoc(tripDocRef, { gallery: arrayUnion(newImg) });
            };
            reader.readAsDataURL(file);
        }
    });

    const geminiModal = $('#gemini-modal');
    $('#gemini-btn').addEventListener('click', () => geminiModal.classList.add('flex'));
    $('#gemini-close-btn').addEventListener('click', () => geminiModal.classList.remove('flex'));
    $$('#gemini-tabs-nav .tab-button').forEach(b => b.addEventListener('click', (e) => {
        $$('#gemini-tabs-nav .tab-button').forEach(btn => btn.classList.remove('tab-active'));
        e.currentTarget.classList.add('tab-active');
        $$('#gemini-modal .content-section').forEach(s => s.classList.remove('active'));
        $(`#${e.currentTarget.dataset.content}`).classList.add('active');
    }));

    $('#get-smart-advice-btn').addEventListener('click', getSmartAdvice);
    $('#gemini-submit-btn').addEventListener('click', askGeneralGemini);

    $('#share-btn').addEventListener('click', () => {
        const url = window.location.href;
        if (navigator.share) {
            navigator.share({ title: 'תוכנית הטיול שלנו למילאנו', url: url });
        } else {
            navigator.clipboard.writeText(url).then(() => showAlert('הקישור הועתק!', 'הקישור הועתק ללוח.'));
        }
    });
$('#lookup-site-btn').addEventListener('click', () => {
    cameraMode = 'lookup';
    startCamera();
});
// --- Camera Button Listeners ---
$('#translate-camera-btn').addEventListener('click', () => {
    cameraMode = 'translate';
    startCamera();
});
$('#scan-receipt-btn').addEventListener('click', () => {
    cameraMode = 'receipt';
    startCamera();
});
$('#torch-btn').addEventListener('click', toggleTorch);
$('#camera-close-btn').addEventListener('click', stopCamera);
$('#capture-btn').addEventListener('click', captureFrame);
    const heBtn = $('#voice-translate-he-btn');
    const itBtn = $('#voice-translate-it-btn');
    function startRecognition(lang, btn) {
        if (isRecognizing) speechRecognizer.stop();
        activeVoiceButton = btn;
        speechRecognizer.lang = lang;
        speechRecognizer.start();
    }
    if (speechRecognizer) {
        heBtn.addEventListener('click', (e) => startRecognition('he-IL', e.currentTarget));
        itBtn.addEventListener('click', (e) => startRecognition('it-IT', e.currentTarget));
    } else {
        if (heBtn) { heBtn.disabled = true; heBtn.innerHTML = 'לא נתמך'; }
        if (itBtn) { itBtn.disabled = true; itBtn.innerHTML = 'לא נתמך'; }
    }

    $('#toggle-location-sharing-btn').addEventListener('click', toggleLocationSharing);
    $('#user-name-input').addEventListener('input', (e) => localStorage.setItem('userName', e.target.value));

    const planBtn = $('#floating-plan-btn');
    const toolsBtn = $('#floating-tools-btn');
    const planSubmenu = $('#plan-submenu');
    const toolsSubmenu = $('#tools-submenu');
    function toggleSubmenu(submenuToToggle, buttonToHighlight) {
        const isAlreadyActive = submenuToToggle && submenuToToggle.classList.contains('active');
        $$('.floating-submenu').forEach(sm => sm.classList.remove('active'));
        $$('#floating-nav button, #floating-nav a').forEach(btn => btn.classList.remove('text-brand-600'));
        if (submenuToToggle && !isAlreadyActive) {
            submenuToToggle.classList.add('active');
            buttonToHighlight.classList.add('text-brand-600');
        }
    }
    planBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSubmenu(planSubmenu, planBtn); });
    toolsBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSubmenu(toolsSubmenu, toolsBtn); });

    document.addEventListener('click', (e) => { 
        if (!e.target.closest('#floating-nav-container')) toggleSubmenu(null, null);
    });
    $$('#plan-submenu a, #tools-submenu a').forEach(link => link.addEventListener('click', () => toggleSubmenu(null, null)));

    window.addEventListener('beforeunload', () => {
        if (watchingLocation && currentUserId) deleteDoc(doc(locationsColRef, currentUserId));
    });

    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'class') {
                const isDark = document.documentElement.classList.contains('dark');
                if (liveMap) {
                    if (isDark) {
                        if (liveMap.hasLayer(lightMapLayer)) liveMap.removeLayer(lightMapLayer);
                        if (!liveMap.hasLayer(darkMapLayer)) liveMap.addLayer(darkMapLayer);
                    } else {
                        if (liveMap.hasLayer(darkMapLayer)) liveMap.removeLayer(darkMapLayer);
                        if (!liveMap.hasLayer(lightMapLayer)) liveMap.addLayer(lightMapLayer);
                    }
                }
            }
        });
    });
    observer.observe(document.documentElement, { attributes: true });
// ========================= התחלה: לוגיקה לחלון הגדלת תמונות (Lightbox) =========================
const lightboxModal = $('#lightbox-modal');
const lightboxImage = $('#lightbox-image');
const lightboxCloseBtn = $('#lightbox-close-btn');

function openLightbox(imageUrl, imageAlt) {
    lightboxImage.src = imageUrl;
    lightboxImage.alt = imageAlt;
    lightboxModal.style.display = 'flex';
}

function closeLightbox() {
    lightboxModal.style.display = 'none';
}

// מאזין לחיצה על מפת המטרו
$('#metro-map-image').addEventListener('click', (e) => {
    openLightbox(e.target.src, e.target.alt);
});

// מאזינים לסגירת החלון
lightboxCloseBtn.addEventListener('click', closeLightbox);
lightboxModal.addEventListener('click', (e) => {
    // סוגר רק אם לחצו על הרקע השחור ולא על התמונה עצמה
    if (e.target === lightboxModal) {
        closeLightbox();
    }
});
// ========================= סוף: לוגיקה לחלון הגדלת תמונות (Lightbox) =========================


});

  </script>

</body>
</html>
