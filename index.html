<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Trip-to-milan - Debug Firebase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style> body{font-family:Arial,Helvetica,sans-serif;padding:16px} pre{background:#f6f6f6;padding:8px;border-radius:6px;overflow:auto} </style>
</head>
<body>
  <h1>בדיקות Firebase — trip-to-milan</h1>
  <p id="status">ממתין...</p>

  <script type="module">
    // ======= החלף כאן את הערכים ב־firebaseConfig שקיבלת מה־Firebase Console ========
    const firebaseConfig = {
      apiKey: "AIzaSyD47-qHc8vmGQt4n4LluKW64LEMB-UYrfk",
      authDomain: "trip-to-milan.firebaseapp.com",
      projectId: "trip-to-milan",
      storageBucket: "PROJECT_ID.appspot.com", // או מה שמופיע בקונסול
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID",
      measurementId: "MEASUREMENT_ID"
    };
    // =============================================================================

    // ה־SDK שנשתמש בו (גירסה שהזכרת — 12.2.1)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const statusEl = document.getElementById('status');
    function log(msg){ console.log(msg); statusEl.innerText = msg; }

    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      log("Firebase initialized. Project ID: " + (firebaseConfig.projectId || "—לא הוגדר—"));

      // TripId מה־hash או קביעה אוטומטית
      let tripId = window.location.hash.replace('#', '');
      if (!tripId) {
        tripId = 'trip_' + Math.random().toString(36).substring(2,8);
        window.location.hash = tripId;
      }
      console.log("TripId:", tripId);

      // בדיקות ראשוניות של config
      console.group("Config check");
      console.log("apiKey:", firebaseConfig.apiKey ? "ok" : "MISSING");
      console.log("projectId:", firebaseConfig.projectId);
      console.log("authDomain:", firebaseConfig.authDomain);
      console.log("storageBucket:", firebaseConfig.storageBucket);
      console.groupEnd();

      // התחברות אנונימית
      signInAnonymously(auth)
        .then(cred => {
          console.log("Signed in anonymously, uid:", cred.user.uid);
          log("Signed in anonymously: " + cred.user.uid);
        })
        .catch(err => {
          console.error("Anonymous sign-in failed:", err.code, err.message);
          log("Sign-in failed: " + err.message);
        });

      onAuthStateChanged(auth, (user) => {
        console.log("onAuthStateChanged:", user ? "User UID=" + user.uid : "No user");
      });

      // הפניה למסמך בקולקשן "milantrip" — זה השם שכתבת
      const tripDocRef = doc(db, "milantrip", tripId);
      console.log("Attempting Firestore operations on collection 'milantrip'...");

      // פונקציה שבודקת אם יש מסמך וקוראת/כותבת
      async function checkOrUpdateDocument() {
        try {
          console.log("Trying getDoc...");
          const snap = await getDoc(tripDocRef);
          if (snap.exists()) {
            console.log("Document exists, data:", snap.data());
            log("Document exists — כתבתי שדה updated=true");
            await updateDoc(tripDocRef, { updatedAt: Date.now() });
            console.log("updateDoc success");
          } else {
            console.log("Document does not exist — will create with testField");
            log("Doc not found — יצירת doc חדש בשם " + tripId);
            await setDoc(tripDocRef, { testField: Date.now() });
            console.log("setDoc success");
          }
        } catch (err) {
          console.error("Firestore error code:", err.code, "message:", err.message);
          log("Firestore error: " + (err.message || err.code));
        }
      }

      // תריץ את הבדיקה אחרי התחברות קצרה
      setTimeout(checkOrUpdateDocument, 500);

    } catch (e) {
      console.error("Init error:", e);
      log("Init error: " + e.message);
    }
  </script>
</body>
</html>
