<!-- Version 1.4 - Complete and Fully Fixed -->
<!DOCTYPE html>
<html lang="he" dir="rtl" class="scroll-smooth dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>תוכנית טיול שיתופית למילאנו (v1.4)</title>
  <meta name="description" content="דשבורד אינטראקטיבי ושיתופי לתכנון חופשה במילאנו: לוז יומי, מפות, מזג אוויר, סיכום טיול חכם, מעקב תקציב ועוד." />
  <meta name="theme-color" content="#1d4ed8">
  <link rel="manifest" href="manifest.json">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Assistant', 'ui-sans-serif', 'system-ui'],
          },
          colors: {
            brand: {
              50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
              400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a'
            }
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- FIX: Replaced broken Chart.js CDN link with a working one from cdnjs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" xintegrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgM6az8UlcT8I+sJw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- LeafletJS for Live Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
    :root{
      --bg: #f9fafb; --fg:#1f2937; --card:#ffffff; --muted:#6b7280;
      --btn:#1d4ed8; --btn-h:#1e40af; --brd:#e5e7eb;
      --header-bg: rgba(255,255,255,0.9);
      --heading-font: 'Assistant', sans-serif;
    }
    .dark{
      --bg:#0b1220; --fg:#e5e7eb; --card:#0f172a; --muted:#9ca3af;
      --btn:#2563eb; --btn-h:#1d4ed8; --brd:#1f2937;
      --header-bg: rgba(11,18,32,0.8);
    }
    
    html { scroll-padding-top: 80px; }
    body{background:var(--bg); color:var(--fg); font-family:Assistant,ui-sans-serif,system-ui;}
    h2, h3 { font-family: var(--heading-font); }
    #site-header { background-color: var(--header-bg); }
    
    .dark input, .dark textarea, .dark select {
        background-color: #1f2937;
        color: var(--fg);
        border-color: #374151;
    }
    .dark input::placeholder, .dark textarea::placeholder { color: var(--muted); }

    .btn{display:inline-flex;align-items:center;gap:.5rem;justify-content:center;border-radius:0.75rem;
         font-weight:600;font-size:.9rem;padding:.5rem .85rem;transition:.2s;border:1px solid transparent}
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .btn-primary{background:var(--btn);color:#fff;}
    .btn-primary:hover{background:var(--btn-h)}
    .btn-ghost{background:transparent;border-color:var(--brd);color:var(--fg);}
    .btn-ghost:hover{background:rgba(0,0,0,.04)}
    .dark .btn-ghost:hover{background:rgba(255,255,255,.06)}
    .tab-button{padding:.5rem .75rem;font-weight:700;border-bottom:2px solid transparent;border-radius:.5rem .5rem 0 0;}
    .tab-active{color:var(--btn);background:var(--card);border-color:var(--btn)}
    #gemini-tabs-nav .tab-button { border-color: transparent; }
    #gemini-tabs-nav .tab-active { border-color: var(--btn); color: var(--btn); }

    .content-section{display:none}
    .content-section.active{display:block}
    .thumb{width:100%;height:14rem;object-fit:cover}
    .logo{width:56px;height:56px;border-radius:.75rem;border:1px solid var(--brd);object-fit:contain;background:#fff}
    
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 100;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-backdrop.flex { display: flex; }
    .modal {
        background: var(--card); color: var(--fg);
        width: 90%; max-width: 500px; border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        display: flex; flex-direction: column; max-height: 80vh;
    }
    .image-carousel { position: relative; flex-shrink:0; width:100%; }
    @media (min-width: 768px) { .image-carousel { width: 33.333333%; } }
    .image-carousel button {
      position: absolute; top: 50%; transform: translateY(-50%);
      background-color: rgba(0,0,0,0.4); color: white;
      border: none; border-radius: 50%;
      width: 32px; height: 32px;
      cursor: pointer; transition: background-color 0.2s;
    }
    .image-carousel button:hover { background-color: rgba(0,0,0,0.7); }
    .carousel-prev { left: 8px; }
    .carousel-next { right: 8px; }

    .countdown-number { font-size: 1.5rem; line-height: 1; }
    .countdown-label { font-size: 0.75rem; }

    .floating-submenu {
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
    }
    .floating-submenu.active {
        transform: translateY(0);
        opacity: 1;
        pointer-events: auto;
    }

    .delete-btn {
        position: absolute; top: 4px; right: 4px;
        background-color: rgba(239, 68, 68, 0.7);
        color: white; border-radius: 50%;
        width: 24px; height: 24px;
        border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.2s; z-index: 10;
    }
    .relative:hover .delete-btn { opacity: 1; }
    
    #live-location-map {
        height: 350px;
        border-radius: 1rem;
        border: 1px solid var(--brd);
    }
    .leaflet-popup-content-wrapper {
        background: var(--card);
        color: var(--fg);
    }
    .leaflet-popup-tip {
        background: var(--card);
    }


    @media print {
        body * { visibility: hidden; }
        #plan, #plan * { visibility: visible; }
        #plan { position: absolute; left: 0; top: 0; width: 100%; }
        #plan details { page-break-inside: avoid; }
        #plan summary, .nav-link, .btn, header, main > section:not(#plan), #floating-nav-container, .day-actions { display: none !important; }
        #plan details[open] > div { display: block !important; }
        #plan-content-container { padding: 0 !important; }
        h2 { font-size: 24px !important; }
        #plan details {
            box-shadow: none !important;
            border: 1px solid #ccc;
            margin-bottom: 1rem;
        }
    }


    @media (max-width: 767px) {
      body { padding-bottom: 70px; } /* Add padding for floating nav */
      .responsive-table thead { display: none; }
      .responsive-table tr {
        display: block; margin-bottom: 1rem; border: 1px solid var(--brd);
        border-radius: 0.75rem; padding: 1rem;
      }
      .responsive-table td {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.5rem 0; border-bottom: 1px solid var(--brd);
      }
      .responsive-table td:last-child { border-bottom: none; }
      .responsive-table td::before {
        content: attr(data-label); font-weight: 600; margin-right: 1rem;
      }
      .responsive-table .logo-cell { justify-content: center; padding-bottom: 1rem; }
      .responsive-table .logo-cell::before { display: none; }
    }
  </style>
</head>
<body class="dark:bg-gray-900 dark:text-gray-100">

  <header id="site-header" class="backdrop-blur shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <span class="inline-block w-2 h-6 rounded bg-brand-700"></span>
          <h1 class="text-xl md:text-2xl font-bold text-brand-800 dark:text-brand-300">החופשה במילאנו</h1>
        </div>
        <div class="hidden md:flex md:items-center md:gap-1 flex-wrap">
          <a href="#overview" class="nav-link px-3 py-2 rounded-md text-sm font-medium">סקירה</a>
          <a href="#plan" class="nav-link px-3 py-2 rounded-md text-sm font-medium">תוכנית</a>
          <a href="#suggestions" class="nav-link px-3 py-2 rounded-md text-sm font-medium">הצעות</a>
          <a href="#kosher" class="nav-link px-3 py-2 rounded-md text-sm font-medium">אוכל כשר</a>
          <a href="#tools" class="nav-link px-3 py-2 rounded-md text-sm font-medium">כלים</a>
        </div>
        <div class="flex items-center gap-2">
            <div id="sync-status" class="text-xs text-gray-400 flex items-center gap-2" title="מתחבר...">
                <i class="fa-solid fa-cloud text-yellow-500"></i> <span class="hidden sm:inline">מתחבר...</span>
            </div>
            <button id="theme-toggle" class="btn btn-ghost" aria-label="החלפת מצב"><i class="fa-solid fa-sun"></i></button>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto p-4 sm:p-6 lg:p-8">

    <section id="overview" class="my-12 scroll-mt-24">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">סקירה כללית</h2>
        <div class="flex gap-2 flex-wrap justify-center">
            <button id="share-btn" class="btn btn-primary"><i class="fa-solid fa-share-alt mr-2"></i>שתף תוכנית</button>
            <button id="gemini-btn" class="btn btn-primary"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>שאל את Gemini</button>
            <button id="find-nearby-btn" class="btn btn-primary"><i class="fa-solid fa-location-crosshairs mr-2"></i>מצא מקומות קרובים</button>
            <button id="show-tip-btn" class="btn btn-primary"><i class="fa-solid fa-lightbulb mr-2"></i>טיפ יומי</button>
            <button id="create-summary-btn" class="btn btn-primary bg-green-600 hover:bg-green-700"><i class="fa-solid fa-book-open mr-2"></i>צור סיכום טיול</button>
        </div>
      </div>
      <div id="overview-cards" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>

    <section id="plan" class="my-12 scroll-mt-24">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">תוכנית הטיול היומית</h2>
        <div class="flex gap-2 flex-wrap justify-center day-actions">
            <button id="collapse-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-compress mr-1"></i>כווץ הכל</button>
            <button id="expand-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-expand mr-1"></i>הרחב הכל</button>
            <button id="print-btn" class="btn btn-ghost btn-sm"><i class="fa-solid fa-print mr-1"></i>הדפס תוכנית</button>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-950 p-2 sm:p-6 rounded-2xl shadow-lg">
        <div class="border-b border-gray-200 dark:border-gray-800 mb-6">
          <nav class="-mb-px flex flex-wrap justify-center gap-2 sm:gap-4" aria-label="Tabs" id="day-tabs-nav"></nav>
        </div>
        <div id="plan-content-container"></div>
      </div>
    </section>

