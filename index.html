<!DOCTYPE html>
<html lang="he" dir="rtl" class="scroll-smooth dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>תוכנית טיול שיתופית למילאנו</title>
  <meta name="description" content="דשבורד אינטראקטיבי ושיתופי לתכנון חופשה במילאנו: לוז יומי, אוכל כשר, מפה, מזג אוויר, מעקב תקציב, צ'קליסט וגלריית תמונות." />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Assistant', 'ui-sans-serif', 'system-ui'],
          },
          colors: {
            brand: {
              50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
              400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a'
            }
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="httpshttps://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #f9fafb; --fg:#1f2937; --card:#ffffff; --muted:#6b7280;
      --btn:#1d4ed8; --btn-h:#1e40af; --brd:#e5e7eb;
      --header-bg: rgba(255,255,255,0.9);
      --heading-font: 'Assistant', sans-serif;
    }
    .dark{
      --bg:#0b1220; --fg:#e5e7eb; --card:#0f172a; --muted:#9ca3af;
      --btn:#2563eb; --btn-h:#1d4ed8; --brd:#1f2937;
      --header-bg: rgba(11,18,32,0.8);
    }
    
    html { scroll-padding-top: 80px; }
    body{background:var(--bg); color:var(--fg); font-family:Assistant,ui-sans-serif,system-ui;}
    h2, h3 { font-family: var(--heading-font); }
    #site-header { background-color: var(--header-bg); }
    
    .dark input, .dark textarea, .dark select {
        background-color: #1f2937;
        color: var(--fg);
        border-color: #374151;
    }
    .dark input::placeholder, .dark textarea::placeholder { color: var(--muted); }

    .btn{display:inline-flex;align-items:center;gap:.5rem;justify-content:center;border-radius:0.75rem;
         font-weight:600;font-size:.9rem;padding:.5rem .85rem;transition:.2s;border:1px solid transparent}
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .btn-primary{background:var(--btn);color:#fff;}
    .btn-primary:hover{background:var(--btn-h)}
    .btn-ghost{background:transparent;border-color:var(--brd);color:var(--fg);}
    .btn-ghost:hover{background:rgba(0,0,0,.04)}
    .dark .btn-ghost:hover{background:rgba(255,255,255,.06)}
    .tab-button{padding:.5rem .75rem;font-weight:700;border-bottom:2px solid transparent;border-radius:.5rem .5rem 0 0;}
    .tab-active{color:var(--btn);background:var(--card);border-color:var(--btn)}
    .content-section{display:none}
    .content-section.active{display:block}
    .thumb{width:100%;height:14rem;object-fit:cover}
    .logo{width:56px;height:56px;border-radius:.75rem;border:1px solid var(--brd);object-fit:contain;background:#fff}
    
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 100;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-backdrop.flex { display: flex; }
    .modal {
        background: var(--card); color: var(--fg);
        width: 90%; max-width: 500px; border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        display: flex; flex-direction: column; max-height: 80vh;
    }
    .image-carousel { position: relative; flex-shrink:0; width:100%; }
    @media (min-width: 768px) { .image-carousel { width: 33.333333%; } }
    .image-carousel button {
      position: absolute; top: 50%; transform: translateY(-50%);
      background-color: rgba(0,0,0,0.4); color: white;
      border: none; border-radius: 50%;
      width: 32px; height: 32px;
      cursor: pointer; transition: background-color 0.2s;
    }
    .image-carousel button:hover { background-color: rgba(0,0,0,0.7); }
    .carousel-prev { left: 8px; }
    .carousel-next { right: 8px; }

    .countdown-number { font-size: 1.5rem; line-height: 1; }
    .countdown-label { font-size: 0.75rem; }

    .floating-submenu {
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        transform: translateY(100%);
        opacity: 0;
        pointer-events: none;
    }
    .floating-submenu.active {
        transform: translateY(0);
        opacity: 1;
        pointer-events: auto;
    }

    .delete-btn {
        position: absolute; top: 4px; right: 4px;
        background-color: rgba(239, 68, 68, 0.7);
        color: white; border-radius: 50%;
        width: 24px; height: 24px;
        border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.2s; z-index: 10;
    }
    .relative:hover .delete-btn { opacity: 1; }

    @media print {
        body * { visibility: hidden; }
        #plan, #plan * { visibility: visible; }
        #plan { position: absolute; left: 0; top: 0; width: 100%; }
        #plan details { page-break-inside: avoid; }
        #plan summary, .nav-link, .btn, header, main > section:not(#plan), #floating-nav-container, .day-actions { display: none !important; }
        #plan details[open] > div { display: block !important; }
        #plan-content-container { padding: 0 !important; }
        h2 { font-size: 24px !important; }
        #plan details {
            box-shadow: none !important;
            border: 1px solid #ccc;
            margin-bottom: 1rem;
        }
    }


    @media (max-width: 767px) {
      body { padding-bottom: 70px; } /* Add padding for floating nav */
      .responsive-table thead { display: none; }
      .responsive-table tr {
        display: block; margin-bottom: 1rem; border: 1px solid var(--brd);
        border-radius: 0.75rem; padding: 1rem;
      }
      .responsive-table td {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.5rem 0; border-bottom: 1px solid var(--brd);
      }
      .responsive-table td:last-child { border-bottom: none; }
      .responsive-table td::before {
        content: attr(data-label); font-weight: 600; margin-right: 1rem;
      }
      .responsive-table .logo-cell { justify-content: center; padding-bottom: 1rem; }
      .responsive-table .logo-cell::before { display: none; }
    }
  </style>
</head>
<body class="dark:bg-gray-900 dark:text-gray-100">

  <header id="site-header" class="backdrop-blur shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <span class="inline-block w-2 h-6 rounded bg-brand-700"></span>
          <h1 class="text-xl md:text-2xl font-bold text-brand-800 dark:text-brand-300">החופשה במילאנו</h1>
        </div>
        <div class="hidden md:flex md:items-center md:gap-1 flex-wrap">
          <a href="#overview" class="nav-link px-3 py-2 rounded-md text-sm font-medium">סקירה</a>
          <a href="#plan" class="nav-link px-3 py-2 rounded-md text-sm font-medium">תוכנית</a>
          <a href="#suggestions" class="nav-link px-3 py-2 rounded-md text-sm font-medium">הצעות</a>
          <a href="#transport-guide" class="nav-link px-3 py-2 rounded-md text-sm font-medium">תחבורה</a>
          <a href="#kosher" class="nav-link px-3 py-2 rounded-md text-sm font-medium">אוכל כשר</a>
          <a href="#tools" class="nav-link px-3 py-2 rounded-md text-sm font-medium">כלים</a>
        </div>
        <div class="flex items-center gap-2">
            <div id="sync-status" class="text-xs text-gray-400 flex items-center gap-2" title="מתחבר...">
                <i class="fa-solid fa-cloud text-yellow-500"></i> <span class="hidden sm:inline">מתחבר...</span>
            </div>
            <button id="theme-toggle" class="btn btn-ghost" aria-label="החלפת מצב"><i class="fa-solid fa-sun"></i></button>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto p-4 sm:p-6 lg:p-8">

    <section id="overview" class="my-12 scroll-mt-24">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">סקירה כללית</h2>
        <div class="flex gap-2 flex-wrap justify-center">
            <button id="share-btn" class="btn btn-primary"><i class="fa-solid fa-share-alt mr-2"></i>שתף תוכנית</button>
            <button id="gemini-btn" class="btn btn-primary"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>שאל את Gemini</button>
            <button id="find-nearby-btn" class="btn btn-primary"><i class="fa-solid fa-location-crosshairs mr-2"></i>מצא מקומות קרובים אליי</button>
        </div>
      </div>
      <div id="overview-cards" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>

    <section id="plan" class="my-12 scroll-mt-24">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300">תוכנית הטיול היומית</h2>
        <div class="flex gap-2 flex-wrap justify-center day-actions">
            <button id="collapse-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-compress mr-1"></i>כווץ הכל</button>
            <button id="expand-all" class="btn btn-ghost btn-sm"><i class="fa-solid fa-expand mr-1"></i>הרחב הכל</button>
            <button id="print-btn" class="btn btn-ghost btn-sm"><i class="fa-solid fa-print mr-1"></i>הדפס תוכנית</button>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-950 p-2 sm:p-6 rounded-2xl shadow-lg">
        <div class="border-b border-gray-200 dark:border-gray-800 mb-6">
          <nav class="-mb-px flex flex-wrap justify-center gap-2 sm:gap-4" aria-label="Tabs" id="day-tabs-nav"></nav>
        </div>
        <div id="plan-content-container"></div>
      </div>
    </section>

    <section id="master-map-section" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">מפה ראשית</h2>
        <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg text-center">
            <p class="mb-4">פתח מפה ויזואלית עם כל האתרים המרכזיים בתוכנית שלך.</p>
            <button id="open-master-map-btn" class="btn btn-primary"><i class="fa-solid fa-map-marked-alt mr-2"></i>פתח מפה ראשית</button>
        </div>
    </section>

    <section id="suggestions" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">מאגר הצעות</h2>
        <div class="text-center">
            <button id="toggle-suggestions-btn" class="btn btn-primary">הצג הצעות נוספות</button>
        </div>
        <div id="suggestions-container" class="hidden mt-6 bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
            <div id="suggestions-table-container"></div>
        </div>
    </section>

    <section id="transport-guide" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">מדריך תחבורה</h2>
        <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-brand-800 dark:text-brand-200 mb-3">תחבורה ציבורית (ATM)</h3>
                <ul class="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                    <li><span class="font-semibold">איפה קונים:</span> במכונות האוטומטיות בכל תחנת מטרו, בקיוסקים (Tabacchi), או באפליקציה הרשמית <a href="https://www.atm.it/it/Pagine/default.aspx" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">ATM Milano</a>.</li>
                    <li><span class="font-semibold">המלצה:</span> כרטיס ל-3 ימים (72 שעות) הוא המשתלם ביותר לשהייה שלכם.</li>
                </ul>
                <div class="relative h-[280px] mt-4">
                    <canvas id="transportChart"></canvas>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
                <h3 class="text-2xl font-bold text-brand-800 dark:text-brand-200 mb-3">רכבות לטיולי יום</h3>
                <ul class="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                    <li><span class="font-semibold">איפה קונים:</span> מומלץ להזמין מראש באינטרנט כדי להבטיח מקום ומחיר טוב.</li>
                    <li><span class="font-semibold">אתרים מומלצים:</span> <a href="https://www.trenitalia.com/en.html" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">Trenitalia</a> (רשמי) או <a href="https://www.italotreno.it/en" target="_blank" class="text-brand-600 dark:text-brand-400 hover:underline">Italo</a> (פרטי).</li>
                    <li><span class="font-semibold">תחנת יציאה:</span> כל הרכבות לאגמים יוצאות מתחנת **Milano Centrale**.</li>
                </ul>
            </div>
        </div>
    </section>

    <section id="kosher" class="my-12 scroll-mt-24">
      <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">המדריך הקולינרי הכשר</h2>
      <div class="text-center">
        <button id="toggle-kosher-btn" class="btn btn-primary">הצג מדריך כשרות</button>
      </div>
      <div id="kosher-container" class="hidden mt-6">
        <div class="bg-white dark:bg-gray-950 p-4 sm:p-6 rounded-2xl shadow-lg">
          <p id="kosher-subtitle" class="text-center mb-6 text-gray-600 dark:text-gray-400">ריכוז האפשרויות בשכונות Bande Nere ו‑Washington.</p>
          <div id="kosher-filters" class="mb-4 flex flex-wrap gap-2 justify-center"></div>
          <div id="kosher-results"></div>
        </div>
      </div>
    </section>
    
    <section id="tools" class="my-12 scroll-mt-24">
        <h2 class="text-3xl font-bold text-center text-brand-900 dark:text-brand-300 mb-6">כלים ומידע שימושי</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-6">
            <div id="weather-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-cloud-sun mr-2"></i>מזג אוויר</h3>
                <div id="weather-forecast" class="space-y-3"><p>טוען תחזית...</p></div>
            </div>
            <div id="budget-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24 md:col-span-2 lg:col-span-2">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-euro-sign mr-2"></i>מעקב תקציב</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow">
                    <div>
                        <div class="mb-4">
                            <label for="total-budget" class="block text-sm font-medium">תקציב כללי (€)</label>
                            <input type="number" id="total-budget" placeholder="הזן תקציב" class="w-full p-2 mt-1 rounded-xl border border-gray-300 bg-white">
                        </div>
                        <form id="expense-form" class="space-y-3">
                            <input type="text" id="expense-desc" placeholder="תיאור ההוצאה" class="w-full p-2 rounded-xl border" required>
                             <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="expense-amount" placeholder="סכום (€)" class="w-full p-2 rounded-xl border" required>
                                <select id="expense-category" class="w-full p-2 rounded-xl border" required>
                                    <option value="">קטגוריה</option>
                                    <option value="אוכל">אוכל</option>
                                    <option value="קניות">קניות</option>
                                    <option value="תחבורה">תחבורה</option>
                                    <option value="אטרקציות">אטרקציות</option>
                                    <option value="אחר">אחר</option>
                                </select>
                             </div>
                            <button type="submit" class="btn btn-primary w-full">הוסף הוצאה</button>
                        </form>
                        <button id="calculate-estimated-btn" class="btn btn-primary w-full mt-2"><i class="fa-solid fa-calculator mr-2"></i>חשב עלות משוערת לאטרקציות</button>
                        <div id="expense-list" class="text-sm my-4 flex-grow max-h-40 overflow-y-auto pr-2"></div>
                        <div class="mt-auto pt-3 border-t font-bold space-y-2 text-md">
                             <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span>עלות משוערת</span>
                                    <input type="checkbox" id="include-estimated-costs" checked class="w-4 h-4 rounded text-brand-600 focus:ring-brand-500" title="כלול בחישוב היתרה">
                                </div>
                                <span id="estimated-costs">0.00€</span>
                            </div>
                            <div class="flex justify-between text-red-600 dark:text-red-400"><span>הוצאות בפועל:</span> <span id="total-expenses">0.00</span>€</div>
                            <div class="flex justify-between text-green-600 dark:text-green-400"><span>יתרה:</span> <span id="budget-balance">0.00</span>€</div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center min-h-[200px]">
                        <div class="relative w-full h-full max-h-[250px]">
                            <canvas id="budget-chart"></canvas>
                        </div>
                        <div id="budget-chart-placeholder" class="hidden text-center text-gray-400 text-sm">הוסיפו הוצאות כדי לראות את התרשים</div>
                        <div id="budget-chart-legend" class="mt-4 w-full space-y-1"></div>
                    </div>
                </div>
            </div>
            <div id="checklist-section-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg scroll-mt-24">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-list-check mr-2"></i>צ'ק-ליסט</h3>
                <form id="add-checklist-item-form" class="grid sm:grid-cols-3 gap-2 mb-4">
                    <input type="text" id="new-item-text" placeholder="פריט חדש" class="sm:col-span-2 w-full p-2 rounded-lg border" required>
                    <select id="category-select" class="w-full p-2 rounded-lg border"></select>
                    <input type="text" id="new-category-text" placeholder="קטגוריה חדשה (אופציונלי)" class="sm:col-span-2 w-full p-2 rounded-lg border">
                    <button type="submit" class="btn btn-primary">הוסף</button>
                </form>
                <div id="checklist-container" class="space-y-4 max-h-96 overflow-y-auto"></div>
            </div>
             <div id="translator-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24">
                <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-language mr-2"></i>תרגום וקהילה</h3>
                 <div class="text-xs text-center text-gray-500 mb-2" id="lang-direction-label">עברית <i class="fa-solid fa-arrow-right-long"></i> איטלקית</div>
                 <form id="dictionary-form" class="grid grid-cols-4 gap-2 mb-3">
                    <input type="text" id="dictionary-input" placeholder="הקלד לתרגום..." class="col-span-4 w-full p-2 rounded-lg border">
                    <button type="button" id="swap-lang-btn" class="btn btn-ghost" title="החלף שפות"><i class="fa-solid fa-exchange-alt"></i></button>
                    <button type="submit" class="btn btn-primary col-span-1">תרגם</button>
                    <button type="button" id="translate-upload-btn" class="btn btn-ghost" title="העלה תמונה"><i class="fa-solid fa-file-image"></i></button>
                    <button type="button" id="translate-camera-btn" class="btn btn-ghost" title="פתח מצלמה"><i class="fa-solid fa-camera"></i></button>
                    <input type="file" id="image-translate-upload" class="hidden" accept="image/*">
                 </form>
                 <div id="translation-result-container" class="mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[60px] text-center flex items-center justify-center gap-3">
                    <span class="text-gray-500">התרגום יופיע כאן...</span>
                 </div>
                 <div class="space-y-3 mt-4">
                    <a href="https://www.facebook.com/groups/milan.for.travelers" target="_blank" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"><i class="fa-brands fa-facebook fa-2x text-blue-600"></i> <div><div class="font-semibold">מילאנו למטיילים</div><div class="text-xs text-gray-500">קבוצת פייסבוק</div></div></a>
                    <a href="https://chat.whatsapp.com/your-group-invite" target="_blank" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"><i class="fa-brands fa-whatsapp fa-2x text-green-500"></i> <div><div class="font-semibold">מטיילים במילאנו</div><div class="text-xs text-gray-500">קבוצת וואטסאפ</div></div></a>
                 </div>
            </div>
            <div id="converter-tool" class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg flex flex-col scroll-mt-24">
              <h3 class="text-xl font-bold mb-3"><i class="fa-solid fa-right-left mr-2"></i>ממיר מטבע</h3>
              <div class="space-y-4">
                  <div>
                      <label for="eur-input" class="block text-sm font-medium">אירו (€)</label>
                      <input type="number" id="eur-input" placeholder="EUR" class="w-full p-2 mt-1 rounded-xl border">
                  </div>
                  <div>
                      <label for="ils-input" class="block text-sm font-medium">שקל (₪)</label>
                      <input type="number" id="ils-input" placeholder="ILS" class="w-full p-2 mt-1 rounded-xl border">
                  </div>
              </div>
              <p id="exchange-rate-display" class="text-xs text-gray-500 mt-auto pt-3 text-center">טוען שער חליפין...</p>
          </div>
        </div>
    </section>

    <section id="documents-and-gallery" class="my-12 scroll-mt-24 grid md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4"><i class="fa-solid fa-folder-open mr-2"></i>תיק מסמכים</h2>
            <input type="file" id="document-upload" multiple class="hidden">
            <button id="document-upload-btn" class="btn btn-primary w-full mb-4">העלה מסמכים</button>
            <div id="documents-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
        <div class="bg-white dark:bg-gray-950 p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4"><i class="fa-solid fa-images mr-2"></i>גלריית תמונות</h2>
            <input type="file" id="image-upload" multiple accept="image/*" class="hidden">
            <button id="image-upload-btn" class="btn btn-primary w-full mb-4">העלה תמונות</button>
            <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
    </section>

  </main>
  
  <div id="add-to-day-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b"><h3 class="text-lg font-bold">הוסף פעילות ליום...</h3></div>
        <div id="modal-day-options" class="p-4 grid grid-cols-2 gap-3"></div>
        <div class="p-4 border-t flex justify-end">
            <button onclick="window.closeModal()" class="btn btn-ghost">ביטול</button>
        </div>
    </div>
  </div>
  <div id="camera-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex justify-between items-center"><h3 class="text-lg font-bold">תרגם מתמונה</h3><button id="camera-close-btn" class="text-2xl">×</button></div>
        <div class="p-4 flex-grow relative">
            <video id="camera-feed" class="w-full h-full object-cover bg-black rounded-lg" playsinline autoplay></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
        </div>
        <div class="p-4 border-t flex justify-center">
            <button id="capture-btn" class="btn btn-primary w-16 h-16 rounded-full"><i class="fa-solid fa-camera fa-2x"></i></button>
        </div>
    </div>
  </div>
  <div id="alert-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b"><h3 id="alert-modal-title" class="text-lg font-bold"></h3></div>
        <div id="alert-modal-body" class="p-6 text-center whitespace-pre-wrap"></div>
        <div class="p-4 border-t flex justify-end">
            <button id="alert-modal-close" class="btn btn-primary">הבנתי</button>
        </div>
    </div>
  </div>
  <div id="gemini-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-bold">שאל את Gemini</h3>
            <button id="gemini-close-btn" class="text-2xl">×</button>
        </div>
        <div class="p-4 flex-grow overflow-y-auto">
            <label for="gemini-prompt" class="block text-sm font-medium mb-1">הכנס שאלה או בקשה:</label>
            <textarea id="gemini-prompt" class="w-full p-2 rounded-lg border bg-white dark:bg-gray-800" rows="4" placeholder="לדוגמה: תן לי 3 הצעות למסעדות רומנטיות בערב באזור נבילי."></textarea>
            <div class="mt-4">
                <h4 class="font-semibold mb-2">תשובה:</h4>
                <div id="gemini-response" class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
            </div>
        </div>
        <div class="p-4 border-t flex justify-end">
            <button id="gemini-submit-btn" class="btn btn-primary">שלח שאילתה</button>
        </div>
    </div>
</div>
<div id="daily-tip-modal" class="modal-backdrop">
    <div class="modal">
        <div class="p-4 border-b flex items-center gap-3">
            <i class="fa-solid fa-lightbulb text-yellow-400 text-xl"></i>
            <h3 class="text-lg font-bold">טיפ היום למטייל</h3>
        </div>
        <div id="daily-tip-body" class="p-6 whitespace-pre-wrap">טוען טיפ...</div>
        <div class="p-4 border-t flex justify-end">
            <button id="daily-tip-close" class="btn btn-primary">הבנתי</button>
        </div>
    </div>
</div>



  <div id="floating-nav-container" class="md:hidden fixed bottom-0 left-0 right-0 z-40">
      <div id="plan-submenu" class="floating-submenu hidden fixed bottom-[68px] left-0 right-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm p-2 rounded-t-2xl">
          <div class="grid grid-cols-3 gap-2 text-center text-sm" id="plan-submenu-links">
              </div>
      </div>
      <div id="tools-submenu" class="floating-submenu hidden fixed bottom-[68px] left-0 right-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm p-2 rounded-t-2xl">
          <div class="grid grid-cols-3 gap-2 text-center text-sm">
              <a href="#weather-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">מזג אוויר</a>
              <a href="#budget-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">תקציב</a>
              <a href="#checklist-section-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">צ'קליסט</a>
              <a href="#translator-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">תרגום</a>
              <a href="#converter-tool" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">ממיר מטבע</a>
          </div>
      </div>

      <nav id="floating-nav" class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.1)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.3)] rounded-t-2xl">
        <div class="flex justify-around p-2 text-gray-700 dark:text-gray-300">
            <button id="floating-plan-btn" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-calendar-days fa-lg"></i>
                <span>תוכנית</span>
            </button>
            <a href="#kosher" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-utensils fa-lg"></i>
                <span>כשר</span>
            </a>
            <a href="#transport-guide" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-bus fa-lg"></i>
                <span>תחבורה</span>
            </a>
            <button id="floating-tools-btn" class="flex flex-col items-center text-xs gap-1 p-1 hover:text-brand-600 w-1/4">
                <i class="fa-solid fa-screwdriver-wrench fa-lg"></i>
                <span>כלים</span>
            </button>
        </div>
      </nav>
  </div>
  
  <script type="module">
    // --- Firebase SDK ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- UTILS ---
    const $ = (s, p = document) => p.querySelector(s);
    const $$ = (s, p = document) => Array.from(p.querySelectorAll(s));
    function toRad(x) { return x * Math.PI / 180; }
    function haversineKm(lat1, lon1, lat2, lon2) {
        if ([lat1, lon1, lat2, lon2].some(c => c === undefined || c === null)) return NaN;
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.asin(Math.sqrt(a));
        return R * c;
    }
    function formatKm(km) { return isNaN(km) ? '' : `(${km.toFixed(1)} ק״מ)`; }
    function minsForMode(km, mode) {
        if (isNaN(km)) return 15;
        if (mode === 'walk') { const speed = 4.5; return Math.max(8, (km / speed) * 60); }
        if (mode === 'drive') { const speed = 25; return Math.max(10, (km / speed) * 60); }
        if (mode === 'transit') { const speed = 18; return Math.max(12, (km / speed) * 60 + 5); }
        return 15;
    }
    function formatMin(min) {
        min = Math.round(min);
        if (min < 60) return `${min} דק׳`;
        const h = Math.floor(min / 60);
        const m = min % 60;
        return `${h} ש׳ ${m} ד׳`;
    }
    const fmtBold = (t) => (t || '').replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-brand-700 dark:text-brand-300">$1<\/strong>');
    const placeholderLogoUrl = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&size=80&rounded=true&background=e0e7ff&color=1e40af`;
    
    // --- Global State ---
    let db, auth, tripDocRef;
    let localTripData = {}; 
    let budgetChartInstance = null;
    let cameraStream = null;
    let eurToIlsRate = 4.0; // Default rate
    let userCoords = null;
    let isFirebaseConnected = false;
    
    // --- DATA ---
    const attractions = {
      duomo: { name: "קתדרלת הדואומו", type: 'attraction', address: "Piazza del Duomo, 20122 Milano MI, Italy", img: ["https://www.metailimbaolam.com/wp-content/uploads/2020/08/italy-4695974_1280.jpg"], tickets: "https://www.duomomilano.it/en/buy-tickets/", description: "הלב הפועם של מילאנו. חובה לעלות לגג לתצפית פנורמית מרהיבה על העיר.", coords: { lat: 45.4642, lon: 9.1916 }, cost: 20, hours: "כל יום, 09:00-19:00" },
      sanSiro: { name: "אצטדיון סן סירו", type: 'attraction', address: "Piazzale Angelo Moratti, 20151 Milano MI, Italy", img: ["https://www.xn--4dbkkmip.co.il/wp-content/uploads/2023/05/san-siro-1940307_640.jpg"], tickets: "https://www.sansirostadium.com/en/stadium-tour-museum/", description: "מקדש הכדורגל של מילאנו, ביתן של מילאן ואינטר. מומלץ לסיור או למשחק.", coords: { lat: 45.4780, lon: 9.1238 }, cost: 30, hours: "כל יום, 09:30-19:00 (משתנה בימי משחק)" },
      primark: { name: "פריימארק (ויה טורינו)", type: 'attraction', address: "Via Torino, 45, 20123 Milano MI, Italy", img: ["https://www.shutterstock.com/image-photo/bordeaux-france-07-17-2024-260nw-2490117199.jpg"], info: "https://www.primark.com/it/it/negozi/milano/via-torino-45", description: "סניף הדגל הענק של רשת האופנה הזולה, גן עדן לחובבי קניות.", coords: { lat: 45.4623, lon: 9.1861 }, cost: 0, hours: "כל יום, 09:00-22:00" },
      como: { name: "אגם קומו", type: 'attraction', address: "Varenna, Italy", img: ["https://www.travelonatimebudget.co.uk/wp-content/uploads/2022/01/varenna-dp.jpg"], description: "יום טיול לאחד האגמים היפים באיטליה. מומלץ לבקר בעיירות וארנה ובלאג'יו.", coords: { lat: 45.9863, lon: 9.2816 }, cost: 15 },
      berninaExpress: { name: "רכבת ברנינה לאלפים", type: 'attraction', address: "Tirano, Italy", img: ["https://www.civitatis.com/f/italia/milan/excursion-alpes-suizos-589x392.jpg"], tickets: "https://www.rhb.ch/en/panoramic-trains/bernina-express", description: "נסיעת רכבת פנורמית מדהימה דרך הרי האלפים לשוויץ.", coords: { lat: 46.4914, lon: 9.8683 }, cost: 70 },
      laScala: { name: "תיאטרון לה סקאלה", type: 'attraction', address: "Via Filodrammatici, 2, 20121 Milano MI, Italy", img: ["https://www.hakolal.co.il/wp-content/uploads/2018/10/La-Scala.jpg"], tickets: "https://www.teatroallascala.org/en/visit-the-theatre/visits-to-the-theatre-museum.html", description: "אחד מבתי האופרה המפורסמים והיוקרתיים בעולם.", coords: { lat: 45.4675, lon: 9.1895 }, cost: 12, hours: "מוזיאון: כל יום, 09:30-17:30" },
      navigli: { name: "רובע נבילי", type: 'attraction', address: "Ripa di Porta Ticinese, 20143 Milano MI, Italy", description: "רובע התעלות המקסים של מילאנו, מושלם לשעות הערב ולאפרטיבו.", coords: { lat: 45.4516, lon: 9.1758 }, cost: 0 },
      ilCentro: { name: "קניון Il Centro", type: 'attraction', address: "Via Giuseppe Eugenio Luraghi, 11, 20044 Arese MI, Italy", img: ["https://architizer-prod.imgix.net/media/1461230538313IL_CENTRO_WEB_RESOLUTION_231.JPG"], info: "https://centroilcentro.it/en/", description: "אחד הקניונים הגדולים באירופה, נמצא מחוץ למילאנו.", coords: { lat: 45.5654, lon: 9.0681 }, cost: 5, hours: "כל יום, 09:00-22:00" },
      sforza: { name: "טירת ספורצה", type: 'attraction', address: "Piazza Castello, 20121 Milano MI, Italy", description: "מצודה היסטורית מרשימה עם מספר מוזיאונים וגלריות אמנות.", info: "https://www.milanocastello.it/en", coords: { lat: 45.4705, lon: 9.1794 }, cost: 5, hours: "חצרות: 07:00-19:30. מוזיאונים: ג'-א', 10:00-17:30 (סגור בב')" },
      brera: { name: "רובע בררה", type: 'attraction', address: "Via Brera, Milan", description: "רובע האמנים הציורי, 'המונמרטר של מילאנו', מלא בסמטאות, גלריות ובוטיקים.", coords: { lat: 45.4719, lon: 9.1879 }, cost: 0 },
      lastSupper: { name: "הסעודה האחרונה", type: 'attraction', address: "Piazza di Santa Maria delle Grazie, 2, 20123 Milano MI", description: "ציור הקיר המפורסם של דה וינצ'י. חובה להזמין כרטיסים חודשים מראש!", tickets: "https://cenacolovinciano.org/en/", coords: { lat: 45.4659, lon: 9.1711 }, cost: 15, hours: "ג'-א', 08:15-19:00 (סגור בב')" },
      galleriaVittorio: { name: "גלריית ויטוריו אמנואלה", type: 'attraction', address: "Piazza del Duomo, 20123 Milano MI", description: "מרכז קניות היסטורי ומפואר, עם חנויות יוקרה, בתי קפה ומסעדות.", coords: { lat: 45.4656, lon: 9.1905 }, cost: 0, hours: "פתוח 24/7 (חנויות בשעות משתנות)" },
      pinacotecaBrera: { name: "פינקוטקה די בררה", type: 'attraction', address: "Via Brera, 28, 20121 Milano MI", description: "אחד מגלריות האמנות החשובות באיטליה, מתמקד בציור איטלקי.", tickets: "https://pinacotecabrera.org/en/visit/", coords: { lat: 45.4719, lon: 9.1879 }, cost: 15, hours: "ג'-א', 08:30-19:15 (סגור בב')" },
      parcoSempione: { name: "פארק סמפיונה", type: 'attraction', address: "Piazza Sempione, 20154 Milano MI", description: "הריאה הירוקה הגדולה של מילאנו, מאחורי טירת ספורצה. מושלם להירגעות.", coords: { lat: 45.4723, lon: 9.1725 }, cost: 0, hours: "כל יום, 06:30-21:00" },
      quadrilateroDellaModa: { name: "מרובע האופנה", type: 'attraction', address: "Via Monte Napoleone, 20121 Milano MI, Italy", description: "רובע הקניות היוקרתי של מילאנו, בית למותגי האופנה הגדולים בעולם.", coords: { lat: 45.4688, lon: 9.1950 }, cost: 0 },
      daVinciMuseum: { name: "מוזיאון המדע דה וינצ'י", type: 'attraction', address: "Via San Vittore, 21, 20123 Milano MI, Italy", description: "מוזיאון המדע והטכנולוגיה הגדול באיטליה, מוקדש לדה וינצ'י כממציא.", tickets: "https://www.museoscienza.org/en/visit/tickets", coords: { lat: 45.4627, lon: 9.1715 }, cost: 10, hours: "ג'-ו' 09:30-17:00, ש'-א' 09:30-18:30 (סגור בב')" },
      boscoVerticale: { name: "בוסקו ורטיקלה", type: 'attraction', address: "Via Gaetano de Castillia, 11, 20124 Milano MI", description: "צמד מגדלי מגורים חדשניים המכוסים באלפי עצים וצמחים. פלא ארכיטקטוני.", coords: { lat: 45.4855, lon: 9.1901 }, cost: 0 },
      cimiteroMonumentale: { name: "בית הקברות המונומנטלי", type: 'attraction', address: "Piazzale Cimitero Monumentale, 20154 Milano MI", description: "בית קברות שהוא גם מוזיאון פתוח, עם פסלים ומבנים ארכיטקטוניים מרשימים.", coords: { lat: 45.485, lon: 9.178 }, cost: 0, hours: "ג'-א' 08:00-18:00 (סגור בב')" },
      museoNovecento: { name: "מוזיאון נובצ'נטו", type: 'attraction', address: "Piazza del Duomo, 8, 20123 Milano MI", description: "מוזיאון לאמנות המאה ה-20 הממוקם בכיכר הדואומו, עם תצפית יפה על הקתדרלה.", tickets: "https://www.museodelnovecento.org/en/ biglietti-e-ingressi", coords: { lat: 45.463, lon: 9.190 }, cost: 10, hours: "ג'-א' 10:00-19:30 (סגור בב')" },
      santAmbrogio: { name: "בזיליקת סנט'אמברוג'ו", type: 'attraction', address: "Piazza Sant'Ambrogio, 15, 20123 Milano MI", description: "אחת הכנסיות העתיקות והחשובות במילאנו, דוגמה מרהיבה לאדריכלות רומנסקית.", coords: { lat: 45.462, lon: 9.173 }, cost: 0 },
      sanMaurizio: { name: "כנסיית סן מאוריציו", type: 'attraction', address: "Corso Magenta, 15, 20123 Milano MI", description: "מכונה 'הקפלה הסיסטינית של מילאנו' בזכות ציורי הקיר המדהימים שמכסים אותה לחלוטין.", tickets: "https://www.museoarcheologicomilano.it/en/collezioni/san-maurizio-al-monastero-maggiore", coords: { lat: 45.465, lon: 9.176 }, cost: 0, hours: "ג'-א' 10:00-17:30 (סגור בב')" },
      piazzaMercanti: { name: "פיאצה דיי מרקנטי", type: 'attraction', address: "Piazza dei Mercanti, 20123 Milano MI", description: "כיכר ימי-ביניימית קסומה ונסתרת, דקות הליכה מהדואומו.", coords: { lat: 45.465, lon: 9.188 }, cost: 0 },
      leonardoVineyard: { name: "הכרם של לאונרדו", type: 'attraction', address: "Corso Magenta, 65, 20123 Milano MI", description: "שחזור של הכרם שהיה שייך ללאונרדו דה וינצ'י, מול 'הסעודה האחרונה'.", tickets: "https://www.vignadileonardo.com/en/", coords: { lat: 45.466, lon: 9.170 }, cost: 10, hours: "ג'-א' 09:00-18:00 (סגור בב')" },
      piazzaGaeAulenti: { name: "פיאצה גאה אאולנטי", type: 'attraction', address: "Piazza Gae Aulenti, 20124 Milano MI", description: "הלב הפועם של מילאנו המודרנית. כיכר עתידנית מוקפת גורדי שחקים.", coords: { lat: 45.483, lon: 9.191 }, cost: 0 },
      corsoComo: { name: "10 קורסו קומו", type: 'attraction', address: "Corso Como, 10, 20154 Milano MI", description: "מתחם קונספט המשלב אופנה, עיצוב ואמנות. חווית קניות ובילוי ייחודית.", coords: { lat: 45.482, lon: 9.189 }, cost: 0 },
      triennale: { name: "מוזיאון העיצוב טריאנלה", type: 'attraction', address: "Viale Emilio Alemagna, 6, 20121 Milano MI", description: "מוזיאון בינלאומי המוקדש לעיצוב, אדריכלות ואמנות חזותית בפארק סמפיונה.", tickets: "https://triennale.org/en/tickets", coords: { lat: 45.470, lon: 9.168 }, cost: 15, hours: "ג'-א' 11:00-20:00 (סגור בב')" },
      colonneSanLorenzo: { name: "עמודי סן לורנצו", type: 'attraction', address: "Corso di Porta Ticinese, 39, 20123 Milano MI", description: "שרידים רומיים עתיקים שהפכו למקום מפגש פופולרי ותוסס בערב.", coords: { lat: 45.458, lon: 9.181 }, cost: 0 },
      qcTermemilano: { name: "QC Termemilano", type: 'attraction', address: "Piazzale Medaglie D'Oro, 2, 20135 Milano MI", tickets: "https://www.qcterme.com/en/milano/qc-termemilano", description: "ספא ומרחצאות יוקרתיים בלב העיר, חוויה מושלמת של פינוק ורגיעה.", coords: { lat: 45.4523, lon: 9.2004 }, cost: 60, hours: "כל יום, 09:00-23:00" },
      interStore: { name: "חנות הדגל של אינטר", type: 'attraction', address: "Galleria Passarella, 2, 20122 Milano MI", info: "https://store.inter.it/", description: "חנות הדגל הרשמית של קבוצת הכדורגל אינטר מילאנו, בלב אזור הקניות.", coords: { lat: 45.465, lon: 9.194 }, cost: 0, hours: "כל יום 10:00-19:30" },
      casaMilan: { name: "קאזה מילאן (מוזיאון וחנות)", type: 'attraction', address: "Via Aldo Rossi, 8, 20149 Milano MI", tickets: "https://www.acmilan.com/en/club/casa-milan", description: "המטה הראשי של קבוצת מילאן, כולל מוזיאון מונדו מילאן, חנות רשמית ומסעדה.", coords: { lat: 45.489, lon: 9.155 }, cost: 15, hours: "כל יום 10:00-19:00" },
      torreBranca: { name: "מגדל בראנקה", type: 'attraction', address: "Viale Luigi Camoens, 2, 20121 Milano MI", info: "http://www.museobranca.it/torre-branca-parco-sempione-milano/", description: "מגדל תצפית בפארק סמפיונה המציע נוף פנורמי מרהיב של מילאנו.", coords: { lat: 45.472, lon: 9.171 }, cost: 6, hours: "משתנה לפי עונה, בדקו באתר" },
      pinacotecaAmbrosiana: { name: "פינקוטקה אמברוזיאנה", type: 'attraction', address: "Piazza Pio XI, 2, 20123 Milano MI", tickets: "https://www.ambrosiana.it/", description: "גלריית אמנות וספרייה היסטורית המכילה יצירות מופת של קאראווג'ו ודה וינצ'י.", coords: { lat: 45.464, lon: 9.186 }, cost: 15, hours: "ג'-א' 10:00-18:00 (סגור בב')" }
    };
    
    const kosherData = {
      restaurants: [
        { name: "Denzel", type: 'dining', style: "בשרי", address: "Via Giorgio Washington, 9", phone: "+390248519326", menu: "https://www.denzel.it/menu", website: "https://www.denzel.it/", logo: "https://static.wixstatic.com/media/c6595a_0d9d7bb6473548d69681f09d18ff4247.png", instagram: "https://www.instagram.com/denzelburger?igsh=bXRqcTNuZnlnMWF6", hours: "א'-ה' 12:00-15:00, 19:00-23:00; ו' 12:00-15:00", coords: { lat: 45.4654, lon: 9.1555 } },
        { name: "Ba'Ghetto", type: 'dining', style: "בשרי", address: "Via Sardegna, 45", phone: "+39024694643", menu: "https://www.baghetto.com/en/menu/", website: "https://www.baghetto.com/en/", instagram: "https://www.instagram.com/baghettorestaurants?igsh=MTA3enRyMTdwMmF4dQ==", hours: "א'-ה' 12:00-15:00, 19:00-23:00; ו' 12:00-15:00", coords: { lat: 45.4665, lon: 9.1461 } },
        { name: "Carmel", type: 'dining', style: "חלבי", address: "Viale S. Gimignano, 10", phone: "+3902416368", menu: "https://carmelkosher.it/wp-content/uploads/2022/10/menu-ing.pdf", website: "https://carmelkosher.it/", instagram: "https://www.instagram.com/carmelbylolita?igsh=MWZ2MXFseGVwYzlnZA==", hours: "א'-ה' 12:00-15:00, 19:00-22:30", coords: { lat: 45.4593, lon: 9.1328 } },
        { name: "MyKafe", type: 'dining', style: "חלבי", address: "Via Luigi Soderini, 44", phone: "+390238232748", website: "https://www.instagram.com/mykafe2020/", logo: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/11/a2/1f/a2/my-kafe.jpg", instagram: "https://www.instagram.com/mykafe2020?igsh=OGl5N3R5YTVtaTRj", hours: "א'-ה' 07:30-19:30; ו' 07:30-16:00", coords: { lat: 45.4578, lon: 9.1337 } },
      ],
      markets: [
        { name: "Kosher Paradise", type: 'dining', style: "מרכול", address: "Viale S. Gimignano, 13", phone: "+39024122855", website: "https://www.kosherparadise.it/", instagram: "https://www.instagram.com/kosherparadise_milano?igsh=MXU1eHlhdDhxNTFjMg==", hours: "א'-ה' 09:00-19:30; ו' 09:00-15:00", coords: { lat: 45.4589, lon: 9.1325 } },
        { name: "Denzel's Sweet Bakery", type: 'dining', style: "מאפייה", address: "Via Soderini, 55", phone: "+39024125166", website: "https://www.denzel.it/bakery", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSVt6hxH7niOmeBunCjNdpow7Y_PfseIBonPQ&s", instagram: "https://www.instagram.com/denzelsweetbakery?igsh=b2Fpa2x5dWc4anI5", hours: "א'-ה' 07:30-19:30; ו' 07:30-15:00", coords: { lat: 45.4570, lon: 9.1329 } },
      ]
    };
    
    const dailyTips = [
      "זכרו לתקף את כרטיס התחבורה הציבורית שלכם במכונות הצהובות לפני כל נסיעה במטרו, אוטובוס או טראם כדי למנוע קנסות.",
      "אפרטיבו (Aperitivo) הוא מנהג איטלקי פופולרי. בין 18:00 ל-21:00, שלמו על משקה וקבלו גישה חופשית למזנון אכול כפי יכולתך. רובע נבילי הוא מקום מעולה לחוות זאת.",
      "'Coperto' הוא חיוב שירות קבוע שרוב המסעדות מוסיפות לחשבון. זה לא טיפ, אלא תשלום על השירות והלחם. טיפ נוסף אינו חובה אך מוערך.",
      "הרבה מוזיאונים וכנסיות דורשים לבוש צנוע (כתפיים וברכיים מכוסות). כדאי להחזיק צעיף קל בתיק למקרה הצורך.",
      "מים מהברז במילאנו בטוחים וטובים לשתייה. חפשו ברזיות ציבוריות (fontanelle) כדי למלא את בקבוק המים שלכם ולחסוך כסף.",
      "אם אתם מתכננים לראות את 'הסעודה האחרונה' של דה וינצ'י, חובה להזמין כרטיסים באינטרנט מספר חודשים מראש. הכניסה מוגבלת מאוד."
    ];

    const tripMeta = {
        flights: {
            inbound: { date: '2025-11-23', arrivalLocal: '11:15', flight: 'LY381' },
            outbound: { date: '2025-11-26', departureLocal: '18:00', flight: 'LY382' }
        },
        hotel: {
            name: 'Hotel Glam Milano', phone: '+39 02 839 840', tel: 'tel:+3902839840', address: 'Piazza Duca d\'Aosta, 4/6, 20124 Milano MI'
        },
        contacts: {
            emergency: { name: 'חירום (כללי)', phone: '112', tel: 'tel:112' },
            embassy: { name: 'שגרירות ישראל', phone: '+39 06 3619 8500', tel: 'tel:+390636198500' }
        }
    };
    
    let currentLang = 'he-it'; // he-it or it-he

    function getInitialTripData() {
        const initialPlanKeys = ['duomo', 'primark', 'sanSiro', 'como', 'berninaExpress', 'laScala', 'navigli', 'ilCentro'];
        return {
            plan: {
                day1: { name: "יום 1: דואומו ודרבי", transport: 'walk', activities: [
                    { id: 'duomo_1', time: "בוקר", ...attractions.duomo },
                    { id: 'primark_1', time: "צהריים", ...attractions.primark },
                    { id: 'sanSiro_1', time: "ערב", ...attractions.sanSiro }
                ]},
                day2: { name: "יום 2: אגמים ונבילי", transport: 'transit', activities: [
                    { id: 'como_1', time: "יום שלם", ...attractions.como },
                    { id: 'navigli_1', time: "ערב", ...attractions.navigli },
                ]},
                day3: { name: "יום 3: האלפים השוויצריים", transport: 'drive', activities: [
                    { id: 'berninaExpress_1', time: "יום שלם", ...attractions.berninaExpress },
                ]},
                day4: { name: "יום 4: תרבות וקניות", transport: 'transit', activities: [
                    { id: 'laScala_1', time: "בוקר", ...attractions.laScala },
                    { id: 'ilCentro_1', time: "צהריים", ...attractions.ilCentro }
                ]}
            },
            suggestions: Object.entries(attractions)
                .filter(([key]) => !initialPlanKeys.includes(key))
                .map(([key, value]) => ({...value, id: key})),
            checklist: [
                { id: 'cat1', category: 'מסמכים', items: [{ id: 'c1', text: 'דרכון', done: true }, { id: 'c2', text: 'כרטיסי טיסה', done: false }] },
                { id: 'cat2', category: 'ביגוד', items: [{ id: 'c3', text: 'מעיל גשם', done: false }] },
                { id: 'cat3', category: 'אלקטרוניקה', items: [{ id: 'c4', text: 'מטען נייד', done: true }, { id: 'c5', text: 'מתאם לחשמל', done: false }] }
            ],
            totalBudget: 1500, expenses: [], documents: [], gallery: [], journal: {}, theme: 'dark',
            settings: { includeEstimatedCostsInBalance: true }
        };
    }

    // --- MODAL ---
    let activityToModify = null;
    const modal = $('#add-to-day-modal');
    async function openAddToDayModal(activityId, type = 'suggestion') {
        if (type === 'suggestion') {
            activityToModify = localTripData.suggestions.find(s => s.id === activityId);
        } else {
            const allKosher = [...kosherData.restaurants, ...kosherData.markets];
            activityToModify = allKosher.find(k => k.name === activityId);
            if(activityToModify) activityToModify.id = activityId;
        }
        
        if (!activityToModify) return;

        const opts = $('#modal-day-options');
        opts.innerHTML = Object.entries(localTripData.plan).map(([dayId, dayData]) => 
            `<button class="btn btn-primary" onclick="window.addActivityToDay('${dayId}', '${type}')">${dayData.name}</button>`
        ).join('');
        modal.classList.add('flex');
    };
    window.closeModal = () => {
        $$('.modal-backdrop').forEach(m => m.classList.remove('flex'));
    };
    window.addActivityToDay = async (dayId, type) => {
        const day = localTripData.plan[dayId];
        if (day && activityToModify) {
            const newActivity = { ...activityToModify, time: "זמן גמיש", id: (activityToModify.id || activityToModify.name) + '_' + Date.now() };
            day.activities.push(newActivity);
            
            let newSuggestions = localTripData.suggestions;
            if (type === 'suggestion') {
                newSuggestions = localTripData.suggestions.filter(s => s.id !== activityToModify.id);
            }
            
            await updateDoc(tripDocRef, {
                plan: localTripData.plan,
                suggestions: newSuggestions
            });
        }
        closeModal();
    };
    window.openAddToDayModal = openAddToDayModal;

    function showAlert(title, message) {
        $('#alert-modal-title').textContent = title;
        $('#alert-modal-body').textContent = message;
        $('#alert-modal').classList.add('flex');
    }
    
    function showDailyTip() {
        const lastTipDate = localStorage.getItem('lastTipDate');
        const today = new Date().toISOString().slice(0, 10);

        if (lastTipDate !== today) {
            const tip = dailyTips[Math.floor(Math.random() * dailyTips.length)];
            $('#daily-tip-body').textContent = tip;
            $('#daily-tip-modal').classList.add('flex');
            localStorage.setItem('lastTipDate', today);
        }
    }

    // --- RENDER FUNCTIONS ---
    function renderOverview() {
        const { hotel, flights, contacts } = tripMeta;
        const countdownHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg text-center">
            <h3 class="font-bold text-lg mb-2">הזמן שנותר לטיול</h3>
            <div id="countdown" class="flex flex-row-reverse justify-around font-mono"></div>
        </div>`;
        const flightsHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2">
            <h3 class="font-bold text-lg"><i class="fa-solid fa-plane-departure mr-2"></i>טיסות</h3>
            <p><b>הלוך:</b> ${flights.inbound.date} | ${flights.inbound.flight} | נחיתה: <b>${flights.inbound.arrivalLocal}</b></p>
            <p><b>חזור:</b> ${flights.outbound.date} | ${flights.outbound.flight} | המראה: <b>${flights.outbound.departureLocal}</b></p>
        </div>`;
        const hotelHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2">
            <h3 class="font-bold text-lg"><i class="fa-solid fa-hotel mr-2"></i>מלון</h3>
            <p><b>${hotel.name}</b></p>
            <div class="flex gap-2"><a href="${hotel.tel}" class="btn btn-ghost"><i class="fa fa-phone"></i> חיוג</a><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hotel.address)}" target="_blank" class="btn btn-ghost"><i class="fa fa-map-location-dot"></i> ניווט</a></div>
        </div>`;
        const contactsHtml = `<div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg space-y-2">
            <h3 class="font-bold text-lg"><i class="fa-solid fa-address-book mr-2"></i>טלפונים חשובים</h3>
            <div class="flex gap-2"><a href="${contacts.emergency.tel}" class="btn btn-ghost">${contacts.emergency.name}</a><a href="${contacts.embassy.tel}" class="btn btn-ghost">${contacts.embassy.name}</a></div>
        </div>`;
        $('#overview-cards').innerHTML = countdownHtml + flightsHtml + hotelHtml + contactsHtml;
        startCountdown();
    }

    function startCountdown() {
        const targetDate = new Date(`${tripMeta.flights.inbound.date}T00:00:00`).getTime();
        const countdownEl = $('#countdown');
        if (!countdownEl) return;
        
        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance < 0) {
                clearInterval(interval);
                countdownEl.innerHTML = "<div class='text-lg font-bold w-full'>הטיול התחיל! תהנו!</div>";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownEl.innerHTML = `
                <div><div class="countdown-number">${days}</div><div class="countdown-label">ימים</div></div>
                <div><div class="countdown-number">${hours}</div><div class="countdown-label">שעות</div></div>
                <div><div class="countdown-number">${minutes}</div><div class="countdown-label">דקות</div></div>
                <div><div class="countdown-number">${seconds}</div><div class="countdown-label">שניות</div></div>
            `;
        }, 1000);
    }

    function renderAllPlans(planData) {
      const nav = $('#day-tabs-nav'), content = $('#plan-content-container');
      const submenu = $('#plan-submenu-links');
      nav.innerHTML = ''; content.innerHTML = ''; submenu.innerHTML = '';
      
      Object.entries(planData).sort((a, b) => a[0].localeCompare(b[0])).forEach(([dayId, dayData], i) => {
        const active = i === 0;
        nav.innerHTML += `<button class="tab-button ${active ? 'tab-active' : ''}" data-content="${dayId}">${dayData.name}</button>`;
        content.innerHTML += `<div id="${dayId}" class="content-section ${active ? 'active' : ''}"></div>`;
        submenu.innerHTML += `<a href="#plan" data-day-index="${i}" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">${dayData.name.split(':')[0]}</a>`;
        renderPlanForDay(dayId, dayData);
      });
      submenu.innerHTML += `<a href="#suggestions" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 col-span-3">הצעות</a>`;

      $$('#day-tabs-nav .tab-button').forEach(b => b.addEventListener('click', (e) => {
        $$('#day-tabs-nav .tab-button').forEach(btn => btn.classList.remove('tab-active'));
        e.currentTarget.classList.add('tab-active');
        $$('#plan-content-container .content-section').forEach(s => s.classList.remove('active'));
        $(`#${e.currentTarget.dataset.content}`).classList.add('active');
      }));
      $$('#plan-submenu-links a[data-day-index]').forEach(link => {
        link.addEventListener('click', (e) => {
            const dayIndex = parseInt(e.currentTarget.dataset.dayIndex, 10);
            $$('#day-tabs-nav .tab-button')[dayIndex].click();
        });
      });
    }

    function renderPlanForDay(dayId, dayData) {
        const container = $(`#${dayId}`);
        if (!container) return;
        let content = `<div class="p-4"><div class="flex items-center gap-2 mb-4">
            <label class="font-semibold">מצב נסיעה:</label>
            <select class="p-2 rounded-lg border bg-white dark:bg-gray-800" data-day="${dayId}" onchange="window.handleTransportChange(event)">
                <option value="walk" ${dayData.transport === 'walk' ? 'selected' : ''}>הליכה</option>
                <option value="drive" ${dayData.transport === 'drive' ? 'selected' : ''}>רכב/מונית</option>
                <option value="transit" ${dayData.transport === 'transit' ? 'selected' : ''}>תחב"צ</option>
            </select>
        </div><div class="space-y-4">`;

        let previousActivity = null; 
        dayData.activities.forEach((act, i) => {
            const dist = haversineKm(previousActivity?.coords?.lat, previousActivity?.coords?.lon, act.coords?.lat, act.coords?.lon);
            const time = minsForMode(dist, dayData.transport);
            if (i > 0 && previousActivity) {
                content += `<div class="flex items-center gap-2 text-sm text-gray-500 justify-center">
                    <i class="fa-solid fa-arrow-down"></i> <span>${formatKm(dist)} / ${formatMin(time)}</span>
                </div>`;
            }
            content += renderActivityCard(dayId, act, i, dayData.activities.length, previousActivity);
            previousActivity = act;
        });
        
        content += `</div>${renderJournal(dayId, localTripData.journal ? localTripData.journal[dayId] : [])}</div>`;
        container.innerHTML = content;
    }
    
    function renderActivityCard(dayId, activity, index, total, previousActivity) {
        const isDining = activity.type === 'dining';
        const links = [];
        if (activity.tickets) links.push(`<a href="${activity.tickets}" target="_blank" class="btn btn-primary"><i class="fa-solid fa-ticket"></i> כרטיסים</a>`);
        if (activity.info) links.push(`<a href="${activity.info}" target="_blank" class="btn btn-ghost"><i class="fa-solid fa-circle-info"></i> מידע</a>`);
        if (activity.address) {
            links.push(`<a href="https://waze.com/ul?q=${encodeURIComponent(activity.address)}" target="_blank" class="btn btn-ghost" title="Waze"><i class="fa-brands fa-waze"></i></a>`);
            links.push(`<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(activity.address)}" target="_blank" class="btn btn-ghost" title="Google Maps"><i class="fa-brands fa-google"></i></a>`);
        }
        if (previousActivity && previousActivity.address && activity.address) {
            const transitUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(previousActivity.address)}&destination=${encodeURIComponent(activity.address)}&travelmode=transit`;
            links.push(`<a href="${transitUrl}" target="_blank" class="btn btn-ghost" title="ניווט בתחב״צ"><i class="fa-solid fa-route"></i></a>`);
        }
        if(!isDining && activity.coords) {
             links.push(`<button onclick="window.findNearbyKosher(this)" data-lat="${activity.coords.lat}" data-lon="${activity.coords.lon}" data-name="${activity.name}" class="btn btn-ghost"><i class="fa-solid fa-utensils"></i> מסעדות</button>`);
        }

        const imgHTML = activity.img ? `<div class="image-carousel" data-images='${JSON.stringify(activity.img)}' data-index="0">
            <img loading="lazy" src="${activity.img[0]}" alt="${activity.name}" class="thumb" onerror="this.style.display='none'">
            ${(activity.img.length || 0) > 1 ? `<button class="carousel-prev" onclick="window.navigateCarousel(this, -1)"><</button><button class="carousel-next" onclick="window.navigateCarousel(this, 1)">></button>` : ''}
        </div>` : '';
        
        const moveButtons = `
            <button class="p-1 ${index === 0 ? 'opacity-25' : ''}" ${index === 0 ? 'disabled' : ''} onclick="window.moveActivity('${dayId}', '${activity.id}', -1)"><i class="fa-solid fa-arrow-up"></i></button>
            <button class="p-1 ${index === total - 1 ? 'opacity-25' : ''}" ${index === total - 1 ? 'disabled' : ''} onclick="window.moveActivity('${dayId}', '${activity.id}', 1)"><i class="fa-solid fa-arrow-down"></i></button>
        `;

        return `<details class="bg-gray-50 dark:bg-gray-900 rounded-xl shadow-md overflow-hidden relative" open>
          <summary class="cursor-pointer list-none flex items-center justify-between p-4">
            <h4 class="font-bold text-lg">${isDining ? '<i class="fa-solid fa-utensils mr-2"></i>' : ''}${activity.time ? activity.time + ' - ' : ''}${activity.name}</h4>
            <div class="text-gray-400 flex items-center gap-2">
                ${moveButtons}
                <i class="fa-solid fa-chevron-down transition-transform"></i>
            </div>
          </summary>
          <button class="absolute top-3 left-3 text-red-500 hover:text-red-700 p-1 z-10" onclick="window.removeActivity('${dayId}', '${activity.id}')"><i class="fa-solid fa-trash"></i></button>
          <div class="flex flex-col md:flex-row border-t border-gray-100 dark:border-gray-800">
            ${imgHTML}
            <div class="p-4 md:p-5 flex-grow">
              <p class="text-gray-700 dark:text-gray-300">${fmtBold(activity.description)}</p>
              ${activity.hours ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-2"><i class="fa-solid fa-clock w-4 mr-1"></i> ${activity.hours}</p>` : ''}
              <div class="mt-4 flex flex-wrap items-center gap-2">${links.join('')}</div>
            </div>
          </div>
        </details>`;
    }
    
    function renderSuggestions(suggestions) {
        const container = $('#suggestions-table-container');
        if (!suggestions || suggestions.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500">כל הכבוד! כל הפעילויות שובצו בתוכנית.</div>`;
            return;
        }

        const tableRows = suggestions.map(s => `
            <tr class="border-b dark:border-gray-800">
                <td data-label="שם" class="p-3 font-medium">${s.name}</td>
                <td data-label="תיאור" class="p-3 text-sm text-gray-600 dark:text-gray-400">${s.description}</td>
                <td data-label="פעולות" class="p-3">
                    <div class="flex flex-wrap gap-2 justify-end">
                        <button onclick="window.openAddToDayModal('${s.id}')" class="btn btn-primary btn-sm"><i class="fa-solid fa-plus"></i> הוסף</button>
                        <a href="https://www.google.com/maps/search/?api=1&query=${s.coords.lat},${s.coords.lon}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-solid fa-map-location-dot"></i> מפה</a>
                    </div>
                </td>
            </tr>
        `).join('');

        container.innerHTML = `
            <table class="w-full text-sm responsive-table">
                <thead class="text-right bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="p-3 font-semibold">שם</th>
                        <th class="p-3 font-semibold">תיאור</th>
                        <th class="p-3 font-semibold"></th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;
    }

    function isCurrentlyOpen(hoursString) {
        if (!hoursString) return false;
        
        const now = new Date();
        const timeZone = 'Europe/Rome';
        const milanTime = new Date(now.toLocaleString('en-US', { timeZone }));
        const currentDay = milanTime.getDay(); // Sunday: 0, Monday: 1, ..., Saturday: 6
        const currentHour = milanTime.getHours();
        const currentMinute = milanTime.getMinutes();
        const currentTimeInMinutes = currentHour * 60 + currentMinute;
        
        const dayMap = {'א': 0, 'ב': 1, 'ג': 2, 'ד': 3, 'ה': 4, 'ו': 5, 'ש': 6};

        try {
            const dayParts = hoursString.split(';').map(s => s.trim());
            for (const part of dayParts) {
                const [daySpec, ...timeSpecs] = part.split(' ');
                const timeStr = timeSpecs.join('');

                let days = [];
                if (daySpec.includes('-')) {
                    const [startDay, endDay] = daySpec.split('-').map(d => dayMap[d]);
                    for (let i = startDay; i <= endDay; i++) {
                        days.push(i);
                    }
                } else {
                    days = daySpec.split(',').map(d => dayMap[d]);
                }
                
                if (days.includes(currentDay)) {
                    const timeRanges = timeStr.split(',');
                    for (const range of timeRanges) {
                        const [start, end] = range.split('-').map(t => {
                            const [h, m] = t.split(':').map(Number);
                            return h * 60 + (m || 0);
                        });

                        if (currentTimeInMinutes >= start && currentTimeInMinutes < end) {
                            return true;
                        }
                    }
                }
            }
        } catch (e) {
            console.error("Error parsing hours string:", hoursString, e);
            return false;
        }

        return false;
    }

    function renderKosher(filter = 'all') {
        let allKosher = [...kosherData.restaurants, ...kosherData.markets];
        
        if (userCoords) {
            allKosher.forEach(k => k.distance = haversineKm(userCoords.lat, userCoords.lon, k.coords.lat, k.coords.lon));
            allKosher.sort((a,b) => a.distance - b.distance);
        } else {
            allKosher.forEach(k => delete k.distance);
        }

        const filtered = allKosher.filter(r => {
            if (filter === 'open') return isCurrentlyOpen(r.hours);
            if (filter === 'all') return true;
            const style = r.style.toLowerCase();
            return style.includes(filter.toLowerCase());
        });

        const content = filtered.map(item => (item.style.includes('בשרי') || item.style.includes('חלבי') ? rowRestaurant(item) : rowMarket(item))).join('');
        $('#kosher-results').innerHTML = `<table class="min-w-full text-sm responsive-table"><tbody>${content || `<tr><td class="p-4 text-center">לא נמצאו תוצאות.</td></tr>`}</tbody></table>`;
    }

    function renderKosherFilters() {
        const filters = ['all', 'open', 'בשרי', 'חלבי', 'מאפייה', 'מרכול'];
        const filterLabels = {'all': 'הכל', 'open': 'פתוח עכשיו', 'בשרי': 'בשרי', 'חלבי': 'חלבי', 'מאפייה': 'מאפייה', 'מרכול': 'מרכול'};
        $('#kosher-filters').innerHTML = filters.map(f => `<button class="kosher-filter-btn btn btn-ghost" data-filter="${f}">${filterLabels[f]}</button>`).join('');
        $$('.kosher-filter-btn').forEach(btn => btn.addEventListener('click', e => {
            const currentFilter = e.target.dataset.filter;
            renderKosher(currentFilter);
            $$('.kosher-filter-btn').forEach(b => b.classList.remove('tab-active'));
            e.target.classList.add('tab-active');
        }));
        $('.kosher-filter-btn[data-filter="all"]').classList.add('tab-active');
    }

    const rowRestaurant = r => {
        const logoSrc = r.logo || placeholderLogoUrl(r.name);
        return `
        <tr class="align-top border-b dark:border-gray-800">
            <td data-label="לוגו" class="p-3 logo-cell"><img class="logo" src="${logoSrc}" alt="${r.name}" onerror="this.onerror=null;this.src='${placeholderLogoUrl(r.name)}';"></td>
            <td data-label="שם" class="p-3 font-medium">${r.name} <span class="text-xs font-normal text-gray-500">${r.distance ? formatKm(r.distance) : ''}</span></td>
            <td data-label="סגנון" class="p-3">${r.style}</td>
            <td data-label="שעות" class="p-3 text-xs">${r.hours || ''}</td>
            <td data-label="פעולות" class="p-3">
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.openAddToDayModal('${r.name}', 'kosher')" class="btn btn-primary btn-sm" title="הוסף ליום"><i class="fa-solid fa-plus"></i></button>
                    ${r.phone ? `<a title="התקשר" href="tel:${r.phone}" class="btn btn-ghost btn-sm"><i class="fa-solid fa-phone"></i></a>`:''}
                    <a title="Waze" href="https://waze.com/ul?q=${encodeURIComponent(r.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-waze"></i></a>
                    <a title="Google Maps" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-google"></i></a>
                    ${r.menu ? `<a href="${r.menu}" target="_blank" class="btn btn-ghost btn-sm" title="תפריט"><i class="fa-solid fa-utensils"></i></a>`:''}
                    ${r.website ? `<a href="${r.website}" target="_blank" class="btn btn-ghost btn-sm" title="אתר"><i class="fa-solid fa-globe"></i></a>`:''}
                    ${r.instagram ? `<a title="אינסטגרם" href="${r.instagram}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-instagram"></i></a>`:''}
                </div>
            </td>
        </tr>`;
    };
    const rowMarket = m => {
        const logoSrc = m.logo || placeholderLogoUrl(m.name);
        return `
        <tr class="align-top border-b dark:border-gray-800">
            <td data-label="לוגו" class="p-3 logo-cell"><img class="logo" src="${logoSrc}" alt="${m.name}" onerror="this.onerror=null;this.src='${placeholderLogoUrl(m.name)}';"></td>
            <td data-label="שם" class="p-3 font-medium">${m.name} <span class="text-xs font-normal text-gray-500">${m.distance ? formatKm(m.distance) : ''}</span></td>
            <td data-label="סוג" class="p-3">${m.style}</td>
            <td data-label="שעות" class="p-3 text-xs">${m.hours || ''}</td>
            <td data-label="פעולות" class="p-3">
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.openAddToDayModal('${m.name}', 'kosher')" class="btn btn-primary btn-sm" title="הוסף ליום"><i class="fa-solid fa-plus"></i></button>
                    ${m.phone ? `<a title="התקשר" href="tel:${m.phone}" class="btn btn-ghost btn-sm"><i class="fa-solid fa-phone"></i></a>`:''}
                    <a title="Waze" href="https://waze.com/ul?q=${encodeURIComponent(m.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-waze"></i></a>
                    <a title="Google Maps" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(m.address)}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-google"></i></a>
                    ${m.website ? `<a href="${m.website}" target="_blank" class="btn btn-ghost btn-sm" title="אתר"><i class="fa-solid fa-globe"></i></a>`:''}
                    ${m.instagram ? `<a title="אינסטגרם" href="${m.instagram}" target="_blank" class="btn btn-ghost btn-sm"><i class="fa-brands fa-instagram"></i></a>`:''}
                </div>
            </td>
        </tr>`;
    };

    function renderChecklist(checklistData) {
        const container = $('#checklist-container');
        const categorySelect = $('#category-select');
        container.innerHTML = '';
        categorySelect.innerHTML = '<option value="">בחר קטגוריה...</option>';
        (checklistData || []).forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat.category}">${cat.category}</option>`;
            let catHtml = `<div class="space-y-2"><h4 class="font-bold">${cat.category}</h4>`;
            (cat.items || []).forEach(item => {
                catHtml += `<label class="flex items-center gap-2">
                    <input type="checkbox" data-id="${item.id}" ${item.done ? 'checked' : ''} onchange="window.toggleChecklistItem(event)">
                    <span class="${item.done ? 'line-through text-gray-500' : ''}">${item.text}</span>
                    <button class="text-red-500 mr-auto hover:text-red-700 text-xs" onclick="window.removeChecklistItem('${cat.id}', '${item.id}')"><i class="fa-solid fa-trash"></i></button>
                </label>`;
            });
            container.innerHTML += catHtml + '</div>';
        });
    }

    function renderJournal(dayId, entries = []) {
        const entriesHtml = entries.sort((a,b) => a.timestamp - b.timestamp).map(entry => `
            <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg relative group">
                <p class="text-sm">${entry.text}</p>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date(entry.timestamp).toLocaleString('he-IL', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}</div>
                <button class="absolute top-2 left-2 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="window.removeJournalEntry('${dayId}', '${entry.id}')">
                    <i class="fa-solid fa-trash-alt fa-xs"></i>
                </button>
            </div>
        `).join('');
        return `<div class="mt-6 border-t pt-4">
            <h4 class="font-bold text-lg mb-2">יומן מסע</h4>
            <div id="journal-entries-${dayId}" class="space-y-3 mb-3">${entriesHtml}</div>
            <form id="journal-form-${dayId}" class="flex gap-2">
                <input type="text" id="journal-text-${dayId}" placeholder="הוסף חוויה מהיום..." class="w-full p-2 rounded-lg border">
                <button type="submit" class="btn btn-primary">שלח</button>
            </form>
        </div>`;
    }
    
    async function fetchWeather() {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=45.46&longitude=9.19&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe/Berlin&forecast_days=7`);
            const data = await res.json();
            if (data.error) throw new Error(data.reason);
             const iconMap = {
                0: 'fa-sun', 1: 'fa-cloud-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud',
                45: 'fa-smog', 48: 'fa-smog',
                51: 'fa-cloud-rain', 53: 'fa-cloud-rain', 55: 'fa-cloud-rain',
                56: 'fa-snowflake', 57: 'fa-snowflake',
                61: 'fa-cloud-showers-heavy', 63: 'fa-cloud-showers-heavy', 65: 'fa-cloud-showers-heavy',
                66: 'fa-snowflake', 67: 'fa-snowflake',
                71: 'fa-snowflake', 73: 'fa-snowflake', 75: 'fa-snowflake', 77: 'fa-snowflake',
                80: 'fa-cloud-showers-heavy', 81: 'fa-cloud-showers-heavy', 82: 'fa-cloud-showers-heavy',
                85: 'fa-snowflake', 86: 'fa-snowflake',
                95: 'fa-cloud-bolt', 96: 'fa-cloud-bolt', 99: 'fa-cloud-bolt'
            };
            $('#weather-forecast').innerHTML = data.daily.time.map((day, i) => `
                <div class="flex justify-between items-center text-sm">
                    <span>${new Date(day).toLocaleDateString('he-IL', { weekday: 'long' })}</span>
                    <span><i class="fa-solid ${iconMap[data.daily.weathercode[i]] || 'fa-question-circle'}"></i></span>
                    <span>${Math.round(data.daily.temperature_2m_min[i])}°/${Math.round(data.daily.temperature_2m_max[i])}°</span>
                </div>`).join('');
        } catch (e) { $('#weather-forecast').innerHTML = `<p class="text-xs text-red-500">שגיאה בטעינת תחזית. ${e.message}</p>`; }
    }

    async function fetchExchangeRate() {
        try {
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
            const data = await response.json();
            if(data && data.rates && data.rates.ILS) {
                eurToIlsRate = data.rates.ILS;
                $('#exchange-rate-display').textContent = `שער נוכחי: 1€ = ${eurToIlsRate.toFixed(3)}₪`;
            }
        } catch (error) {
            console.error("Could not fetch exchange rate:", error);
             $('#exchange-rate-display').textContent = 'שגיאה בטעינת שער חליפין.';
        }
    }
    
    function renderDocuments(documents = []) {
        const grid = $('#documents-grid');
        grid.innerHTML = documents.map(doc => `
            <div class="relative bg-gray-100 dark:bg-gray-800 rounded-lg flex flex-col items-center justify-center p-2 text-center">
                 <a href="${doc.dataUrl}" download="${doc.name}" class="flex flex-col items-center justify-center w-full h-full">
                    <i class="fa-solid fa-file-pdf fa-3x text-red-500"></i>
                    <span class="text-xs mt-2 break-all">${doc.name}</span>
                </a>
                <button class="delete-btn" onclick="window.removeDocument('${doc.id}')">×</button>
            </div>`).join('');
    }

    function renderGallery(gallery = []) {
        const grid = $('#gallery-grid');
        grid.innerHTML = gallery.map(img => `<div class="relative aspect-square">
            <img src="${img.dataUrl}" class="w-full h-full object-cover rounded-lg">
            <button class="delete-btn" onclick="window.removeImage('${img.id}')">×</button>
        </div>`).join('');
    }

    function calculateEstimatedCosts(plan) {
        let totalCost = 0;
        if (!plan) return 0;
        Object.values(plan).forEach(day => {
            (day.activities || []).forEach(activity => {
                if(activity.cost) {
                    totalCost += activity.cost;
                }
            });
        });
        return totalCost * 2; // For a couple
    }

    function renderBudget(data) {
        const { totalBudget = 0, expenses = [], plan, settings = { includeEstimatedCostsInBalance: true } } = data;
        
        const totalBudgetInput = $('#total-budget');
        if (document.activeElement !== totalBudgetInput) {
             totalBudgetInput.value = totalBudget || '';
        }

        const includeEstimated = $('#include-estimated-costs');
        includeEstimated.checked = settings.includeEstimatedCostsInBalance;

        const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
        const estimatedCosts = calculateEstimatedCosts(plan);
        const balance = totalBudget - totalExpenses - (includeEstimated.checked ? estimatedCosts : 0);

        $('#total-expenses').textContent = totalExpenses.toFixed(2) + '€';
        $('#estimated-costs').textContent = estimatedCosts.toFixed(2) + '€';
        $('#budget-balance').textContent = balance.toFixed(2) + '€';

        $('#expense-list').innerHTML = expenses.map(exp => 
            `<div class="flex justify-between items-center py-1 group">
                <span>${exp.desc} <span class="text-xs text-gray-400">${exp.category}</span></span>
                <span class="flex items-center gap-2">
                    ${exp.amount.toFixed(2)}€
                    <button class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="window.removeExpense('${exp.id}')">
                        <i class="fa-solid fa-trash-alt fa-xs"></i>
                    </button>
                </span>
            </div>`
        ).join('');
        
        renderBudgetChart(expenses);
    }
    
    function renderBudgetChart(expenses) {
        const ctx = $('#budget-chart').getContext('2d');
        const placeholder = $('#budget-chart-placeholder');
        const legendContainer = $('#budget-chart-legend');
        if (!ctx) return;

        const categoryTotals = (expenses || []).reduce((acc, exp) => {
            acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
            return acc;
        }, {});

        const totalExpenses = (expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const backgroundColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];

        if (budgetChartInstance) {
            budgetChartInstance.destroy();
        }
        
        legendContainer.innerHTML = '';
        if (labels.length === 0) {
            placeholder.classList.remove('hidden');
            return;
        }
        placeholder.classList.add('hidden');

        budgetChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderColor: 'var(--card)',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    title: { display: false },
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Generate custom legend
        legendContainer.innerHTML = `<h4 class="text-center font-bold mb-2">פירוט הוצאות</h4>`;
        labels.forEach((label, index) => {
            const amount = categoryTotals[label];
            const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(0) : 0;
            const color = backgroundColors[index % backgroundColors.length];
            legendContainer.innerHTML += `
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-sm" style="background-color: ${color};"></span>
                        <span>${label}</span>
                    </div>
                    <span class="font-semibold">${amount.toFixed(2)}€ (${percentage}%)</span>
                </div>
            `;
        });
    }


    // --- State Modifiers (Write to Firestore) ---
    async function handleTransportChange(e) {
        const dayId = e.target.dataset.day;
        const newTransportMode = e.target.value;
        await updateDoc(tripDocRef, { [`plan.${dayId}.transport`]: newTransportMode });
    };
    async function removeActivity(dayId, actId) {
        const day = localTripData.plan[dayId];
        const activityIndex = day.activities.findIndex(a => a.id === actId);
        if (activityIndex > -1) {
            const [removedActivity] = day.activities.splice(activityIndex, 1);
            let newSuggestions = localTripData.suggestions;
            if (removedActivity.type === 'attraction') {
                 const originalId = actId.split('_')[0];
                 const originalAttraction = attractions[originalId];
                 if (originalAttraction && !newSuggestions.find(s => s.id === originalId)) {
                     newSuggestions.push({ ...originalAttraction, id: originalId });
                 }
            }
            await updateDoc(tripDocRef, {
                plan: localTripData.plan,
                suggestions: newSuggestions
            });
        }
    };
    async function moveActivity(dayId, actId, direction) {
        const day = localTripData.plan[dayId];
        const index = day.activities.findIndex(a => a.id === actId);
        if ((direction === -1 && index > 0) || (direction === 1 && index < day.activities.length - 1)) {
            const [item] = day.activities.splice(index, 1);
            day.activities.splice(index + direction, 0, item);
            await updateDoc(tripDocRef, { [`plan.${dayId}.activities`]: day.activities });
        }
    };
    window.navigateCarousel = (btn, dir) => {
        const carousel = btn.closest('.image-carousel');
        const images = JSON.parse(carousel.dataset.images);
        let index = parseInt(carousel.dataset.index, 10);
        index = (index + dir + images.length) % images.length;
        carousel.querySelector('img').src = images[index];
        carousel.dataset.index = index;
    };
    function findNearby() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                window.open(`https://www.google.com/maps/search/tourist+attractions/@${latitude},${longitude},14z`, '_blank');
            }, () => {
                showAlert('שגיאת מיקום', 'לא ניתן היה לקבל את מיקומך. נפתח מפה כללית של מילאנו.');
                window.open('https://www.google.com/maps/search/tourist+attractions+in+milan', '_blank');
            });
        } else {
             window.open('https://www.google.com/maps/search/tourist+attractions+in+milan', '_blank');
        }
    }
    window.findNearbyKosher = (btn) => {
        const lat = parseFloat(btn.dataset.lat), lon = parseFloat(btn.dataset.lon);
        $('#kosher-subtitle').innerHTML = `מציג מקומות קרובים ל: <strong>${btn.dataset.name}</strong>`;
        userCoords = {lat, lon}; // Temporarily set user location
        renderKosher();
        userCoords = null; // Reset it
        $('#kosher').scrollIntoView({ behavior: 'smooth' });
        $('#toggle-kosher-btn').click();
    };
    async function toggleChecklistItem(e) {
        const itemId = e.target.dataset.id;
        const isDone = e.target.checked;
        const updatedChecklist = localTripData.checklist.map(cat => ({
            ...cat,
            items: cat.items.map(item => item.id === itemId ? { ...item, done: isDone } : item)
        }));
        await updateDoc(tripDocRef, { checklist: updatedChecklist });
    };
    async function removeChecklistItem(catId, itemId) {
        const updatedChecklist = localTripData.checklist.map(cat => {
            if (cat.id === catId) {
                return { ...cat, items: cat.items.filter(i => i.id !== itemId) };
            }
            return cat;
        }).filter(cat => cat.items.length > 0);
        await updateDoc(tripDocRef, { checklist: updatedChecklist });
    };
    async function addJournalEntry(dayId, text) {
        const newEntry = { id: Date.now().toString(), text, timestamp: Date.now() };
        await updateDoc(tripDocRef, { [`journal.${dayId}`]: arrayUnion(newEntry) });
    }
    async function removeJournalEntry(dayId, entryId) {
        const entryToRemove = (localTripData.journal[dayId] || []).find(e => e.id === entryId);
        if (entryToRemove) {
            await updateDoc(tripDocRef, { [`journal.${dayId}`]: arrayRemove(entryToRemove) });
        }
    };
    async function removeExpense(id) {
        const expenseToRemove = localTripData.expenses.find(exp => exp.id === id);
        if (expenseToRemove) {
            await updateDoc(tripDocRef, { expenses: arrayRemove(expenseToRemove) });
        }
    };
    async function removeDocument(id) {
        const docToRemove = localTripData.documents.find(doc => doc.id === id);
        if (docToRemove) {
            await updateDoc(tripDocRef, { documents: arrayRemove(docToRemove) });
        }
    };
    async function removeImage(id) {
        const imgToRemove = localTripData.gallery.find(img => img.id === id);
        if (imgToRemove) {
            await updateDoc(tripDocRef, { gallery: arrayRemove(imgToRemove) });
        }
    };

    // Assign functions to window scope so inline event handlers can find them
    Object.assign(window, {
      handleTransportChange, removeActivity, moveActivity, removeExpense, toggleChecklistItem,
      removeChecklistItem, addJournalEntry, removeJournalEntry, removeDocument, removeImage
    });

    // --- Camera Functions ---
    async function startCamera() {
        const video = $('#camera-feed');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = cameraStream;
                video.play();
                $('#camera-modal').classList.add('flex');
            } catch (err) {
                console.error("Error accessing camera: ", err);
                showAlert("שגיאת מצלמה", "לא ניתן לגשת למצלמה. ודא שהענקת הרשאות לדפדפן.");
            }
        } else {
            showAlert("מצלמה לא נתמכת", "מצטערים, הדפדפן שלך לא תומך בגישה למצלמה.");
        }
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        $('#camera-modal').classList.remove('flex');
    }

    function captureFrameAndTranslate() {
        const video = $('#camera-feed');
        const canvas = $('#camera-canvas');
        const context = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const dataUrl = canvas.toDataURL('image/jpeg');
        const base64ImageData = dataUrl.split(',')[1];
        
        stopCamera();
        translateImage(base64ImageData, 'image/jpeg');
    }

    // --- Gemini Translation ---
    async function callGemini(payload, prompt, useSearch = false) {
        payload.contents[0].parts[0].text = prompt;
        if (useSearch) {
            payload.tools = [{ "google_search": {} }];
        } else {
            delete payload.tools;
        }

        const apiKey = "AIzaSyB80v2xdhebJqhjyruJ5Ta0eyhJiq7DsI8"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-preview-0514:generateContent?key=${apiKey}`;
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error.message || `שגיאת רשת: ${response.status}`);
            }
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return text || "לא התקבלה תשובה מ-Gemini.";

        } catch (error) {
            console.error("Gemini API Error:", error);
            return `שגיאה: ${error.message}`;
        }
    }
    window.speakText = (text, lang) => {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        speechSynthesis.speak(utterance);
    }

    async function translateText(text) {
        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
        const targetLang = currentLang === 'he-it' ? 'Italian' : 'Hebrew';
        const prompt = `Translate the following to ${targetLang}. Provide ONLY the translated text, with no additional formatting or explanations. Text to translate: "${text}"`;
        const payload = { contents: [{ parts: [{ text: "" }] }] };
        let responseText = await callGemini(payload, prompt, false);
        responseText = responseText.replace(/[\*\_`]/g, '').trim();
        const langCode = currentLang === 'he-it' ? 'it-IT' : 'he-IL';
        resultContainer.innerHTML = `<span>${responseText}</span> <button onclick="window.speakText('${responseText.replace(/'/g, "\\'")}', '${langCode}')" class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;
    }
    
    async function translateImage(base64ImageData, mimeType) {
        const resultContainer = $('#translation-result-container');
        resultContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
        const targetLang = currentLang === 'he-it' ? 'Italian' : 'Hebrew';
        const prompt = `Extract any text from this image and translate it to ${targetLang}. Provide ONLY the translated text, with no additional formatting. If no text is found, respond with "לא נמצא טקסט".`;
        const payload = { contents: [{ parts: [{ text: "" }, { inlineData: { mimeType: mimeType, data: base64ImageData } }] }] };
        let responseText = await callGemini(payload, prompt, false);
        responseText = responseText.replace(/[\*\_`]/g, '').trim();
        const langCode = currentLang === 'he-it' ? 'it-IT' : 'he-IL';
        resultContainer.innerHTML = `<span>${responseText}</span> <button onclick="window.speakText('${responseText.replace(/'/g, "\\'")}', '${langCode}')" class="btn btn-ghost p-1 h-auto"><i class="fa-solid fa-volume-high"></i></button>`;
    }

    async function askGeneralGemini() {
        const prompt = $('#gemini-prompt').value;
        if (!prompt) return;

        const responseContainer = $('#gemini-response');
        const submitBtn = $('#gemini-submit-btn');
        submitBtn.disabled = true;
        responseContainer.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> חושב...`;

        const payload = { contents: [{ parts: [{ text: "" }] }] };
        const responseText = await callGemini(payload, prompt, true);

        responseContainer.textContent = responseText;
        submitBtn.disabled = false;
    }
    
    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyB80v2xdhebJqhjyruJ5Ta0eyhJiq7DsI8",
          authDomain: "trip-to-milan.firebaseapp.com",
          projectId: "trip-to-milan",
          storageBucket: "trip-to-milan.firebasestorage.app",
          messagingSenderId: "305191186184",
          appId: "1:305191186184:web:fff1488b64a06942dfc6bd",
          measurementId: "G-P17LYZJ2H0"
        };
        
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        // --- Caching and Sharing Logic ---
        let tripId = window.location.hash.substring(1);
        if (!tripId) {
            tripId = Math.random().toString(36).substring(2, 12);
            window.location.hash = tripId;
        }

        const cachedData = localStorage.getItem(`tripData_${tripId}`);
        if (cachedData) {
            localTripData = JSON.parse(cachedData);
            renderAllPlans(localTripData.plan);
            renderSuggestions(localTripData.suggestions);
            renderKosher();
            renderChecklist(localTripData.checklist);
            renderBudget(localTripData);
            renderDocuments(localTripData.documents);
            renderGallery(localTripData.gallery);
            if (localTripData.theme === 'dark') document.documentElement.classList.add('dark');
        }

        signInAnonymously(auth).catch((error) => {
            console.error("Anonymous sign-in failed:", error);
            showAlert("שגיאת התחברות ל-Firebase", `ההתחברות האנונימית נכשלה. ייתכן שצריך לאשר את הדומיין הזה בהגדרות ה-Authentication.\n\n${error.message}`);
        });
        
        onAuthStateChanged(auth, (user) => {
          if (user) {
            tripDocRef = doc(db, "milantrip", tripId);
            
            const unsubscribe = onSnapshot(tripDocRef, async (docSnap) => {
                if (!isFirebaseConnected) {
                    const statusIcon = $('#sync-status i');
                    const statusText = $('#sync-status span');
                    statusIcon.classList.remove('text-yellow-500');
                    statusIcon.classList.add('text-green-500');
                    statusText.textContent = 'מחובר';
                    isFirebaseConnected = true;
                }

                if (docSnap.exists()) {
                    localTripData = docSnap.data();
                    localStorage.setItem(`tripData_${tripId}`, JSON.stringify(localTripData));
                } else if(!cachedData) {
                    localTripData = getInitialTripData();
                    await setDoc(tripDocRef, localTripData);
                }
                
                renderAllPlans(localTripData.plan);
                renderSuggestions(localTripData.suggestions);
                renderKosher();
                renderChecklist(localTripData.checklist);
                renderBudget(localTripData);
                renderDocuments(localTripData.documents);
                renderGallery(localTripData.gallery);
                if (localTripData.theme === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                const statusIcon = $('#sync-status i');
                const statusText = $('#sync-status span');
                statusIcon.classList.remove('text-green-500', 'text-yellow-500');
                statusIcon.classList.add('text-red-500');
                statusText.textContent = 'בעיית סנכרון';
                showAlert('בעיית סנכרון', `לא ניתן להתחבר למסד הנתונים.\nודא שחוקי האבטחה (Rules) ב-Firestore מוגדרים כראוי.\n\n${error.message}`);
            });
          }
        });

        renderOverview();
        renderKosherFilters();
        fetchWeather();
        fetchExchangeRate();
        showDailyTip();
        
        const ctx = document.getElementById('transportChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: { labels: ['נסיעה בודדת', 'כרטיס יומי', 'כרטיס ל-3 ימים'], datasets: [{ label: 'עלות באירו', data: [2.20, 7.60, 15.50], backgroundColor: ['rgba(59,130,246,.6)','rgba(37,99,235,.6)','rgba(29,78,216,.6)'], borderColor: ['#3b82f6','#2563eb','#1d4ed8'], borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });

        // --- Event Listeners ---
        $('#theme-toggle').addEventListener('click', async () => {
            const isDark = document.documentElement.classList.toggle('dark');
            if(tripDocRef && isFirebaseConnected) await updateDoc(tripDocRef, { theme: isDark ? 'dark' : 'light' });
        });
        
        // --- Plan actions ---
        $('#collapse-all').addEventListener('click', () => {
            $$('#plan-content-container details').forEach(d => d.removeAttribute('open'));
        });
        $('#expand-all').addEventListener('click', () => {
            $$('#plan-content-container details').forEach(d => d.setAttribute('open', true));
        });
        $('#print-btn').addEventListener('click', () => {
            window.print();
        });

        $('#add-checklist-item-form').addEventListener('submit', async e => {
            e.preventDefault();
            if(!isFirebaseConnected) { showAlert('שגיאת סנכרון', 'אין חיבור למסד הנתונים. אנא בדוק את החיבור לאינטרנט.'); return; }
            const text = $('#new-item-text').value.trim(); if (!text) return;
            let categoryName = $('#new-category-text').value.trim() || $('#category-select').value;
            if (!categoryName) { showAlert('שגיאה', 'יש לבחור או ליצור קטגוריה.'); return; }
            
            let updatedChecklist = [...(localTripData.checklist || [])];
            let category = updatedChecklist.find(c => c.category === categoryName);
            if (!category) {
                category = { id: 'cat' + Date.now(), category: categoryName, items: [] };
                updatedChecklist.push(category);
            }
            category.items.push({ id: `c${Date.now()}`, text, done: false });
            
            await updateDoc(tripDocRef, { checklist: updatedChecklist });
            e.target.reset();
        });
        
        $('#expense-form').addEventListener('submit', async e => {
            e.preventDefault();
            if(!isFirebaseConnected) { showAlert('שגיאת סנכרון', 'אין חיבור למסד הנתונים. אנא בדוק את החיבור לאינטרנט.'); return; }
            const desc = $('#expense-desc').value.trim();
            const amount = parseFloat($('#expense-amount').value);
            const category = $('#expense-category').value;
            if(desc && !isNaN(amount) && category) {
                const newExpense = {id: Date.now().toString(), desc, amount, category};
                await updateDoc(tripDocRef, { expenses: arrayUnion(newExpense) });
                e.target.reset();
            } else {
                showAlert('שגיאה', 'יש למלא את כל השדות כולל קטגוריה.');
            }
        });
        
        $('#total-budget').addEventListener('input', async e => {
            if(!isFirebaseConnected) { return; }
            const newTotalBudget = parseFloat(e.target.value) || 0;
            if (tripDocRef) await updateDoc(tripDocRef, { totalBudget: newTotalBudget });
        });

        $('#include-estimated-costs').addEventListener('change', async (e) => {
            if(!isFirebaseConnected) { return; }
            const include = e.target.checked;
            await updateDoc(tripDocRef, { 'settings.includeEstimatedCostsInBalance': include });
        });

        $('#calculate-estimated-btn').addEventListener('click', () => {
            const estimatedCosts = calculateEstimatedCosts(localTripData.plan);
            showAlert('עלות משוערת', `העלות המשוערת לאטרקציות בתוכנית עבור זוג היא: €${estimatedCosts.toFixed(2)}.\nהסכום מופיע גם בסיכום התקציב.`);
        });
        
        $('#toggle-suggestions-btn').addEventListener('click', e => {
            const container = $('#suggestions-container');
            const isHidden = container.classList.toggle('hidden');
            e.target.textContent = isHidden ? 'הצג הצעות נוספות' : 'הסתר הצעות';
        });

        $('#toggle-kosher-btn').addEventListener('click', e => {
            const container = $('#kosher-container');
            const isHidden = container.classList.toggle('hidden');
            e.target.textContent = isHidden ? 'הצג מדריך כשרות' : 'הסתר מדריך כשרות';
        });

        $('#eur-input').addEventListener('input', e => {
            const eur = parseFloat(e.target.value);
            $('#ils-input').value = isNaN(eur) ? '' : (eur * eurToIlsRate).toFixed(2);
        });
        $('#ils-input').addEventListener('input', e => {
            const ils = parseFloat(e.target.value);
            $('#eur-input').value = isNaN(ils) ? '' : (ils / eurToIlsRate).toFixed(2);
        });

        $('#plan-content-container').addEventListener('submit', (e) => {
            if (e.target.matches('form[id^="journal-form-"]')) {
                e.preventDefault();
                if(!isFirebaseConnected) { showAlert('שגיאת סנכרון', 'אין חיבור למסד הנתונים. אנא בדוק את החיבור לאינטרנט.'); return; }
                const form = e.target;
                const dayId = form.id.replace('journal-form-', '');
                const textInput = form.querySelector('input[type="text"]');
                const text = textInput.value.trim();
                if (text) {
                    addJournalEntry(dayId, text);
                    textInput.value = '';
                }
            }
        });
        
        $('#dictionary-form').addEventListener('submit', async e => { e.preventDefault(); const input = $('#dictionary-input').value.trim(); if (input) await translateText(input); });
        $('#swap-lang-btn').addEventListener('click', () => {
            const inputEl = $('#dictionary-input'); const labelEl = $('#lang-direction-label');
            currentLang = (currentLang === 'he-it') ? 'it-he' : 'he-it';
            inputEl.placeholder = (currentLang === 'he-it') ? 'הקלד מילה...' : 'Scrivi una parola...';
            labelEl.innerHTML = (currentLang === 'he-it') ? 'עברית <i class="fa-solid fa-arrow-right-long"></i> איטלקית' : 'איטלקית <i class="fa-solid fa-arrow-right-long"></i> עברית';
            inputEl.value = '';
        });
        
        $('#translate-upload-btn').addEventListener('click', () => $('#image-translate-upload').click());
        $('#translate-camera-btn').addEventListener('click', startCamera);
        $('#camera-close-btn').addEventListener('click', stopCamera);
        $('#capture-btn').addEventListener('click', captureFrameAndTranslate);

        $('#image-translate-upload').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => { const base64String = event.target.result.split(',')[1]; translateImage(base64String, file.type); };
            reader.readAsDataURL(file);
        });
        
        $('#document-upload-btn').addEventListener('click', () => $('#document-upload').click());
        $('#image-upload-btn').addEventListener('click', () => $('#image-upload').click());
        $('#alert-modal-close').addEventListener('click', () => $('#alert-modal').classList.remove('flex'));
        $('#daily-tip-close').addEventListener('click', () => $('#daily-tip-modal').classList.remove('flex'));

        $('#document-upload').addEventListener('change', (e) => {
            for (const file of e.target.files) {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const newDoc = { id: Date.now().toString(), name: file.name, dataUrl: ev.target.result };
                    if (tripDocRef) await updateDoc(tripDocRef, { documents: arrayUnion(newDoc) });
                };
                reader.readAsDataURL(file);
            }
        });

        $('#image-upload').addEventListener('change', (e) => {
            for (const file of e.target.files) {
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const newImg = { id: Date.now().toString(), name: file.name, dataUrl: ev.target.result };
                    if (tripDocRef) await updateDoc(tripDocRef, { gallery: arrayUnion(newImg) });
                };
                reader.readAsDataURL(file);
            }
        });
        
        $('#find-nearby-btn').addEventListener('click', findNearby);
        $('#gemini-btn').addEventListener('click', () => $('#gemini-modal').classList.add('flex'));
        $('#gemini-close-btn').addEventListener('click', () => $('#gemini-modal').classList.remove('flex'));
        $('#gemini-submit-btn').addEventListener('click', askGeneralGemini);

        $('#share-btn').addEventListener('click', () => {
            const url = window.location.href;
            const shareData = {
                title: 'תוכנית הטיול שלנו למילאנו',
                text: 'הצטרפו לתכנון הטיול שלנו!',
                url: url
            };
            if (navigator.share) {
                navigator.share(shareData).catch((err) => {
                    if (err.name !== 'AbortError') {
                        console.error('Share failed:', err);
                        showAlert('שגיאת שיתוף', `לא ניתן היה לשתף: ${err.message}`);
                    }
                });
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showAlert('הקישור הועתק!', 'לא נמצאה אפשרות שיתוף. הקישור הועתק ללוח.');
                } catch (err) {
                    showAlert('שגיאה', 'לא ניתן היה להעתיק את הקישור.');
                }
                document.body.removeChild(textArea);
            }
        });

        $('#open-master-map-btn').addEventListener('click', () => {
            const locations = [];
            if (!localTripData.plan) return;
            Object.values(localTripData.plan).forEach(day => {
                day.activities.forEach(act => {
                    if(act.address && !locations.includes(act.address)) {
                        locations.push(encodeURIComponent(`${act.name}, ${act.address}`));
                    }
                });
            });
            if (locations.length > 0) {
                 const url = `https://www.google.com/maps/dir/${locations.join('/')}`;
                 window.open(url, '_blank');
            } else { showAlert('שגיאה', 'אין מיקומים בתוכנית כדי להציג על המפה.'); }
        });

        // Floating Nav Logic
        const planBtn = $('#floating-plan-btn'); const toolsBtn = $('#floating-tools-btn');
        const planSubmenu = $('#plan-submenu'); const toolsSubmenu = $('#tools-submenu');
        
        function toggleSubmenu(submenuToToggle, buttonToHighlight) {
            const isAlreadyActive = submenuToToggle && submenuToToggle.classList.contains('active');
            
            $$('.floating-submenu').forEach(sm => {
                sm.classList.remove('active');
                sm.classList.add('hidden');
            });
            $$('#floating-nav button').forEach(btn => btn.classList.remove('text-brand-600'));
            
            if (submenuToToggle && !isAlreadyActive) {
                submenuToToggle.classList.remove('hidden');
                setTimeout(() => submenuToToggle.classList.add('active'), 10);
                buttonToHighlight.classList.add('text-brand-600');
            }
        }
        planBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSubmenu(planSubmenu, planBtn); });
        toolsBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleSubmenu(toolsSubmenu, toolsBtn); });
        document.addEventListener('click', (e) => { 
            if (!e.target.closest('#floating-nav-container')) {
                toggleSubmenu(null, null);
            }
        });
        $$('#plan-submenu a, #tools-submenu a').forEach(link => link.addEventListener('click', () => toggleSubmenu(null, null)));
    });
  </script>
</body>
</html>
